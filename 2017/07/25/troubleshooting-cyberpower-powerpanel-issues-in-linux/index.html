<!doctype html><html lang=en-us><head><meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://major.io/favicon.ico><title>Troubleshooting CyberPower PowerPanel issues in Linux | Major Hayden's Blog ðŸ¤ </title><meta name=title content="Troubleshooting CyberPower PowerPanel issues in Linux"><meta name=description content="I have a CyberPower BRG1350AVRLCD at home and I&rsquo;ve just connected it to a new device. However, the pwrstat command doesn&rsquo;t retrieve any useful data on the new system:
# pwrstat -status The UPS information shows as following: Current UPS status: State........................ Normal Power Supply by.............. Utility Power Last Power Event............. None I disconnected the USB cable and ran pwrstat again. Same output. I disconnected power from the UPS itself and ran pwrstat again."><meta name=keywords content="cyberpower,fedora,linux,serial,ups,usb,"><meta property="og:title" content="Troubleshooting CyberPower PowerPanel issues in Linux"><meta property="og:description" content="I have a CyberPower BRG1350AVRLCD at home and I&rsquo;ve just connected it to a new device. However, the pwrstat command doesn&rsquo;t retrieve any useful data on the new system:
# pwrstat -status The UPS information shows as following: Current UPS status: State........................ Normal Power Supply by.............. Utility Power Last Power Event............. None I disconnected the USB cable and ran pwrstat again. Same output. I disconnected power from the UPS itself and ran pwrstat again."><meta property="og:type" content="article"><meta property="og:url" content="https://major.io/2017/07/25/troubleshooting-cyberpower-powerpanel-issues-in-linux/"><meta property="og:image" content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-07-25T18:16:11+00:00"><meta property="article:modified_time" content="2020-02-12T16:36:14-06:00"><meta property="og:site_name" content="Major Hayden's Blog ðŸ¤ "><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta name=twitter:title content="Troubleshooting CyberPower PowerPanel issues in Linux"><meta name=twitter:description content="I have a CyberPower BRG1350AVRLCD at home and I&rsquo;ve just connected it to a new device. However, the pwrstat command doesn&rsquo;t retrieve any useful data on the new system:
# pwrstat -status The UPS information shows as following: Current UPS status: State........................ Normal Power Supply by.............. Utility Power Last Power Event............. None I disconnected the USB cable and ran pwrstat again. Same output. I disconnected power from the UPS itself and ran pwrstat again."><meta name=twitter:site content="@mhayden"><meta itemprop=name content="Troubleshooting CyberPower PowerPanel issues in Linux"><meta itemprop=description content="I have a CyberPower BRG1350AVRLCD at home and I&rsquo;ve just connected it to a new device. However, the pwrstat command doesn&rsquo;t retrieve any useful data on the new system:
# pwrstat -status The UPS information shows as following: Current UPS status: State........................ Normal Power Supply by.............. Utility Power Last Power Event............. None I disconnected the USB cable and ran pwrstat again. Same output. I disconnected power from the UPS itself and ran pwrstat again."><meta itemprop=datePublished content="2017-07-25T18:16:11+00:00"><meta itemprop=dateModified content="2020-02-12T16:36:14-06:00"><meta itemprop=wordCount content="903"><meta itemprop=image content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta itemprop=keywords content="cyberpower,fedora,linux,serial,ups,usb,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:820px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px}div.highlight code{background-color:unset;color:initial}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style></head><body><header><a href=../../../../ class=title><h2>Major Hayden's Blog ðŸ¤ </h2></a><nav><a href=../../../../>Home</a>
<a href=../../../../ham-radio-faq>Ham Radio</a>
<a href=../../../../icanhazip-com-faq>icanhazip FAQ</a>
<a href=../../../../posts>Posts</a></nav><script async src=https://media.ethicalads.io/media/client/ethicalads.min.js></script><div class="adaptive raised" data-ea-publisher=major-io data-ea-type=text></div></header><main><h1>Troubleshooting CyberPower PowerPanel issues in Linux</h1><i><time datetime=2017-07-25 pubdate>2017-07-25</time></i>
<content><p><img src=../../../../wp-content/uploads/2017/07/1024px-Sierra_Blanca_and_electricity_pole-e1501006440664.jpg alt=1></p><p>I have a <a href=https://www.cyberpowersystems.com/product/ups/brg1350avrlcd/>CyberPower BRG1350AVRLCD</a> at home and I&rsquo;ve just connected it to a new device. However, the <code>pwrstat</code> command doesn&rsquo;t retrieve any useful data on the new system:</p><pre><code># pwrstat -status

The UPS information shows as following:


    Current UPS status:
        State........................ Normal
        Power Supply by.............. Utility Power
        Last Power Event............. None
</code></pre><p>I disconnected the USB cable and ran <code>pwrstat</code> again. <strong>Same output.</strong> I disconnected power from the UPS itself and ran <code>pwrstat</code> again. <strong>Same output.</strong> This can&rsquo;t be right.</p><h2 id=checking-the-basics>Checking the basics</h2><p>A quick look at <code>dmesg</code> output shows that the UPS is connected and the kernel recognizes it:</p><pre><code>[   65.661489] usb 3-1: new full-speed USB device number 7 using xhci_hcd
[   65.830769] usb 3-1: New USB device found, idVendor=0764, idProduct=0501
[   65.830771] usb 3-1: New USB device strings: Mfr=3, Product=1, SerialNumber=2
[   65.830772] usb 3-1: Product: BRG1350AVRLCD
[   65.830773] usb 3-1: Manufacturer: CPS
[   65.830773] usb 3-1: SerialNumber: xxxxxxxxx
[   65.837801] hid-generic 0003:0764:0501.0004: hiddev0,hidraw0: USB HID v1.10 Device [CPS BRG1350AVRLCD] on usb-0000:00:14.0-1/input0
</code></pre><p>I checked the <code>/var/log/pwrstatd.log</code> file to see if there were any errors:</p><pre><code>2017/07/25 12:01:17 PM  Daemon startups.
2017/07/25 12:01:24 PM  Communication is established.
2017/07/25 12:01:27 PM  Low Battery capacity is restored.
2017/07/25 12:05:19 PM  Daemon stops its service.
2017/07/25 12:05:19 PM  Daemon startups.
2017/07/25 12:05:19 PM  Communication is established.
2017/07/25 12:05:22 PM  Low Battery capacity is restored.
2017/07/25 12:06:27 PM  Daemon stops its service.
</code></pre><p>The <code>pwrstatd</code> daemon can see the device and communicate with it. This is unusual.</p><h2 id=digging-into-the-daemon>Digging into the daemon</h2><p>If the daemon can truly see the UPS, then what is it talking to? I used <code>lsof</code> to examine what the <code>pwrstatd</code> daemon is doing:</p><pre><code># lsof -p 3975
COMMAND   PID USER   FD   TYPE             DEVICE SIZE/OFF      NODE NAME
pwrstatd 3975 root  cwd    DIR               8,68      224        96 /
pwrstatd 3975 root  rtd    DIR               8,68      224        96 /
pwrstatd 3975 root  txt    REG               8,68   224175 134439879 /usr/sbin/pwrstatd
pwrstatd 3975 root  mem    REG               8,68  2163104 134218946 /usr/lib64/libc-2.25.so
pwrstatd 3975 root  mem    REG               8,68  1226368 134218952 /usr/lib64/libm-2.25.so
pwrstatd 3975 root  mem    REG               8,68    19496 134218950 /usr/lib64/libdl-2.25.so
pwrstatd 3975 root  mem    REG               8,68   187552 134218939 /usr/lib64/ld-2.25.so
pwrstatd 3975 root    0r   CHR                1,3      0t0      1028 /dev/null
pwrstatd 3975 root    1u  unix 0xffff9e395e137400      0t0     37320 type=STREAM
pwrstatd 3975 root    2u  unix 0xffff9e395e137400      0t0     37320 type=STREAM
pwrstatd 3975 root    3u  unix 0xffff9e392f0c0c00      0t0     39485 /var/pwrstatd.ipc type=STREAM
pwrstatd 3975 root    4u   CHR             180,96      0t0     50282 /dev/ttyS1
</code></pre><p><strong>Wait a minute.</strong> The last line of the <code>lsof</code> output shows that <code>pwrstatd</code> is talking to <code>/dev/ttyS1</code>, but the device is supposed to be a <code>hiddev</code> device over USB. If you remember, we had this line in <code>dmesg</code> when the UPS was plugged in:</p><pre><code>hid-generic 0003:0764:0501.0004: hiddev0,hidraw0: USB HID v1.10 Device [CPS BRG1350AVRLCD] on usb-0000:00:14.0-1/input0
</code></pre><p>Things are beginning to make more sense now. I have a USB-to-serial device that allows my server to talk to the console port on my Cisco switch:</p><pre><code>[   80.389533] usb 3-1: new full-speed USB device number 9 using xhci_hcd
[   80.558025] usb 3-1: New USB device found, idVendor=067b, idProduct=2303
[   80.558027] usb 3-1: New USB device strings: Mfr=1, Product=2, SerialNumber=0
[   80.558028] usb 3-1: Product: USB-Serial Controller D
[   80.558029] usb 3-1: Manufacturer: Prolific Technology Inc.
[   80.558308] pl2303 3-1:1.0: pl2303 converter detected
[   80.559937] usb 3-1: pl2303 converter now attached to ttyUSB0
</code></pre><p>It appears that <code>pwrstatd</code> is trying to talk to my Cisco switch (through the USB-to-serial adapter) rather than my UPS! I&rsquo;m sure they could have a great conversation together, but it&rsquo;s hardly productive.</p><h2 id=fixing-it>Fixing it</h2><p>The <code>/etc/pwrstatd.conf</code> has a relevant section:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#93a1a1;font-style:italic># The pwrstatd accepts four types of device node which includes the &#39;ttyS&#39;,</span>
<span style=color:#93a1a1;font-style:italic># &#39;ttyUSB&#39;, &#39;hiddev&#39;, and &#39;libusb&#39; for communication with UPS. The pwrstatd</span>
<span style=color:#93a1a1;font-style:italic># defaults to enumerate all acceptable device nodes and pick up to use an</span>
<span style=color:#93a1a1;font-style:italic># available device node automatically. But this may cause a disturbance to the</span>
<span style=color:#93a1a1;font-style:italic># device node which is occupied by other software. Therefore, you can restrict</span>
<span style=color:#93a1a1;font-style:italic># this enumerate behave by using allowed-device-nodes option. You can assign</span>
<span style=color:#93a1a1;font-style:italic># the single device node path or multiple device node paths divided by a</span>
<span style=color:#93a1a1;font-style:italic># semicolon at this option. All groups of &#39;ttyS&#39;, &#39;ttyUSB&#39;, &#39;hiddev&#39;, or</span>
<span style=color:#93a1a1;font-style:italic># &#39;libusb&#39; device node are enumerated without a suffix number assignment.</span>
<span style=color:#93a1a1;font-style:italic># Note, the &#39;libusb&#39; does not support suffix number only.</span>
<span style=color:#93a1a1;font-style:italic>#</span>
<span style=color:#93a1a1;font-style:italic># For example: restrict to use ttyS1, ttyS2 and hiddev1 device nodes at /dev</span>
<span style=color:#93a1a1;font-style:italic># path only.</span>
<span style=color:#93a1a1;font-style:italic># allowed-device-nodes = /dev/ttyS1;/dev/ttyS2;/dev/hiddev1</span>
<span style=color:#93a1a1;font-style:italic>#</span>
<span style=color:#93a1a1;font-style:italic># For example: restrict to use ttyS and ttyUSB two groups of device node at</span>
<span style=color:#93a1a1;font-style:italic># /dev,/dev/usb, and /dev/usb/hid paths(includes ttyS0 to ttySN and ttyUSB0 to</span>
<span style=color:#93a1a1;font-style:italic># ttyUSBN, N is number).</span>
<span style=color:#93a1a1;font-style:italic># allowed-device-nodes = ttyS;ttyUSB</span>
<span style=color:#93a1a1;font-style:italic>#</span>
<span style=color:#93a1a1;font-style:italic># For example: restrict to use hiddev group of device node at /dev,/dev/usb,</span>
<span style=color:#93a1a1;font-style:italic># and /dev/usb/hid paths(includes hiddev0 to hiddevN, N is number).</span>
<span style=color:#93a1a1;font-style:italic># allowed-device-nodes = hiddev</span>
<span style=color:#93a1a1;font-style:italic>#</span>
<span style=color:#93a1a1;font-style:italic># For example: restrict to use libusb device.</span>
<span style=color:#93a1a1;font-style:italic># allowed-device-nodes = libusb</span>
<span style=color:#268bd2>allowed-device-nodes</span> =
</code></pre></div><p>We need to explicitly tell <code>pwrstatd</code> to talk to the UPS on <code>/dev/hid/hiddev0</code>:</p><pre><code>allowed-device-nodes = /dev/usb/hiddev0
</code></pre><p>Let&rsquo;s restart the <code>pwrstatd</code> daemon and see what we get:</p><pre><code># systemctl restart pwrstatd
# pwrstat -status

The UPS information shows as following:

    Properties:
        Model Name................... BRG1350AVRLCD
        Firmware Number..............
        Rating Voltage............... 120 V
        Rating Power................. 810 Watt(1350 VA)

    Current UPS status:
        State........................ Normal
        Power Supply by.............. Utility Power
        Utility Voltage.............. 121 V
        Output Voltage............... 121 V
        Battery Capacity............. 100 %
        Remaining Runtime............ 133 min.
        Load......................... 72 Watt(9 %)
        Line Interaction............. None
        Test Result.................. Unknown
        Last Power Event............. None
</code></pre><p>Success!</p><p><em>Photo credit: <a href=https://commons.wikimedia.org/wiki/File%3ASierra_Blanca_and_electricity_pole.jpg>Wikipedia</a></em></p></content><p><a href=https://major.io/tags/cyberpower/>#cyberpower</a>
<a href=https://major.io/tags/fedora/>#fedora</a>
<a href=https://major.io/tags/linux/>#linux</a>
<a href=https://major.io/tags/serial/>#serial</a>
<a href=https://major.io/tags/ups/>#ups</a>
<a href=https://major.io/tags/usb/>#usb</a></p></main><footer><hr>CC-BY-SA 4.0 &#187;
Made with <a href=https://gohugo.io/>Hugo</a> &#187;
Theme based on <a href=https://github.com/janraasch/hugo-bearblog/>Hugo Ê•â€¢á´¥â€¢Ê” Bear</a> &#187;
<a href=https://github.com/major/major.io/commit/84372fb2198913a5e498b8d32ffc77fb813f0a48>84372fb2</a></footer></body></html>