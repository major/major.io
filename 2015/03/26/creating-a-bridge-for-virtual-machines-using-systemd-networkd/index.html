<!doctype html><html lang=en-us><head><meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://major.io/favicon.ico><title>Creating a bridge for virtual machines using systemd-networkd | Major Hayden's Blog ðŸ¤ </title><meta name=title content="Creating a bridge for virtual machines using systemd-networkd"><meta name=description content="There are plenty of guides out there for making ethernet bridges in Linux to support virtual machines using built-in network scripts or NetworkManager. I decided to try my hand with creating a bridge using only systemd-networkd and it was surprisingly easy.
First off, you&rsquo;ll need a version of systemd with networkd support. Fedora 20 and 21 will work just fine. RHEL/CentOS 7 and Arch Linux should also work. Much of the networkd support has been in systemd for quite a while, but if you&rsquo;re looking for fancier network settings, like bonding, you&rsquo;ll want at least systemd 216."><meta name=keywords content="centos,fedora,network,red hat,systemd,"><meta property="og:title" content="Creating a bridge for virtual machines using systemd-networkd"><meta property="og:description" content="There are plenty of guides out there for making ethernet bridges in Linux to support virtual machines using built-in network scripts or NetworkManager. I decided to try my hand with creating a bridge using only systemd-networkd and it was surprisingly easy.
First off, you&rsquo;ll need a version of systemd with networkd support. Fedora 20 and 21 will work just fine. RHEL/CentOS 7 and Arch Linux should also work. Much of the networkd support has been in systemd for quite a while, but if you&rsquo;re looking for fancier network settings, like bonding, you&rsquo;ll want at least systemd 216."><meta property="og:type" content="article"><meta property="og:url" content="https://major.io/2015/03/26/creating-a-bridge-for-virtual-machines-using-systemd-networkd/"><meta property="og:image" content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-03-26T13:17:08+00:00"><meta property="article:modified_time" content="2015-03-26T13:17:08+00:00"><meta property="og:site_name" content="Major Hayden's Blog ðŸ¤ "><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta name=twitter:title content="Creating a bridge for virtual machines using systemd-networkd"><meta name=twitter:description content="There are plenty of guides out there for making ethernet bridges in Linux to support virtual machines using built-in network scripts or NetworkManager. I decided to try my hand with creating a bridge using only systemd-networkd and it was surprisingly easy.
First off, you&rsquo;ll need a version of systemd with networkd support. Fedora 20 and 21 will work just fine. RHEL/CentOS 7 and Arch Linux should also work. Much of the networkd support has been in systemd for quite a while, but if you&rsquo;re looking for fancier network settings, like bonding, you&rsquo;ll want at least systemd 216."><meta name=twitter:site content="@mhayden"><meta itemprop=name content="Creating a bridge for virtual machines using systemd-networkd"><meta itemprop=description content="There are plenty of guides out there for making ethernet bridges in Linux to support virtual machines using built-in network scripts or NetworkManager. I decided to try my hand with creating a bridge using only systemd-networkd and it was surprisingly easy.
First off, you&rsquo;ll need a version of systemd with networkd support. Fedora 20 and 21 will work just fine. RHEL/CentOS 7 and Arch Linux should also work. Much of the networkd support has been in systemd for quite a while, but if you&rsquo;re looking for fancier network settings, like bonding, you&rsquo;ll want at least systemd 216."><meta itemprop=datePublished content="2015-03-26T13:17:08+00:00"><meta itemprop=dateModified content="2015-03-26T13:17:08+00:00"><meta itemprop=wordCount content="612"><meta itemprop=image content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta itemprop=keywords content="centos,fedora,network,red hat,systemd,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:820px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px}div.highlight code{background-color:unset;color:initial}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style></head><body><header><a href=../../../../ class=title><h2>Major Hayden's Blog ðŸ¤ </h2></a><nav><a href=../../../../>Home</a>
<a href=../../../../ham-radio-faq>Ham Radio</a>
<a href=../../../../icanhazip-com-faq>icanhazip FAQ</a>
<a href=../../../../posts>Posts</a></nav></header><main><h1>Creating a bridge for virtual machines using systemd-networkd</h1><i><time datetime=2015-03-26 pubdate>2015-03-26</time></i>
<content><p>There are plenty of guides out there for making ethernet bridges in Linux to support virtual machines using built-in network scripts or NetworkManager. I decided to try my hand with creating a bridge using only systemd-networkd and it was surprisingly easy.</p><p>First off, you&rsquo;ll need a version of systemd with networkd support. Fedora 20 and 21 will work just fine. RHEL/CentOS 7 and Arch Linux should also work. Much of the networkd support has been in systemd for quite a while, but if you&rsquo;re looking for fancier network settings, like bonding, you&rsquo;ll want at least systemd 216.</p><h3 id=getting-our-daemons-in-order>Getting our daemons in order</h3><p>Before we get started, ensure that systemd-networkd will run on a reboot and NetworkManager is disabled. We also need to make a config file director for systemd-networkd if it doesn&rsquo;t exist already. In addition, let&rsquo;s enable the caching resolver and make a symlink to systemd&rsquo;s <code>resolv.conf</code>:</p><pre><code>systemctl enable systemd-networkd
systemctl disable NetworkManager
systemctl enable systemd-resolved
ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf
mkdir /etc/systemd/network
</code></pre><h3 id=configure-the-physical-network-adapter>Configure the physical network adapter</h3><p>In my case, the network adapter connected to my external network is <em>enp4s0</em> but yours will vary. Run <code>ip addr</code> to get a list of your network cards. Let&rsquo;s create <code>/etc/systemd/network/uplink.network</code> and put the following in it:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#859900>[Match]</span>
<span style=color:#268bd2>Name</span>=<span style=color:#2aa198>enp4s0</span>

<span style=color:#859900>[Network]</span>
<span style=color:#268bd2>Bridge</span>=<span style=color:#2aa198>br0</span>
</code></pre></div><p>I&rsquo;m telling systemd to look for a device called <em>enp4s0</em> and then add it to a bridge called <em>br0</em> that we haven&rsquo;t configured yet. Be sure to change <em>enp4s0</em> to match your ethernet card.</p><h3 id=make-the-bridge>Make the bridge</h3><p>We need to tell systemd about our new bridge network device and we also need to specify the IP configuration for it. We start by creating <code>/etc/systemd/network/br0.netdev</code> to specify the device:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#859900>[NetDev]</span>
<span style=color:#268bd2>Name</span>=<span style=color:#2aa198>br0</span>
<span style=color:#268bd2>Kind</span>=<span style=color:#2aa198>bridge</span>
</code></pre></div><p>This file is fairly self-explanatory. We&rsquo;re telling systemd that we want a device called <em>br0</em> that functions as an ethernet bridge. Now create <code>/etc/systemd/network/br0.network</code> to specify the IP configuration for the <em>br0</em> interface:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#859900>[Match]</span>
<span style=color:#268bd2>Name</span>=<span style=color:#2aa198>br0</span>

<span style=color:#859900>[Network]</span>
<span style=color:#268bd2>DNS</span>=<span style=color:#2aa198>192.168.250.1</span>
<span style=color:#268bd2>Address</span>=<span style=color:#2aa198>192.168.250.33/24</span>
<span style=color:#268bd2>Gateway</span>=<span style=color:#2aa198>192.168.250.1</span>
</code></pre></div><p>This file tells systemd that we want to apply a simple static network configuration to <em>br0</em> with a single IPv4 address. If you want to add additional DNS servers or IPv4/IPv6 addresses, just add more <code>DNS=</code> and <code>Address</code> lines right below the ones you see above. Yes, it&rsquo;s just that easy.</p><h3 id=lets-do-this>Let&rsquo;s do this</h3><p>Some folks are brave enough to stop NetworkManager and start all of the systemd services here but I prefer to reboot so that everything comes up cleanly. That will also allow you to verify that future reboots will cause the server to come back online with the right configuration. After the reboot, run <code>networkctl</code> and you&rsquo;ll get something like this (with color):</p><p><img src=../../../../wp-content/uploads/2015/03/networkctl_screenshot.png alt=1></p><p>Here&rsquo;s what&rsquo;s in the screenshot:</p><pre><code>IDX LINK             TYPE               OPERATIONAL SETUP
  1 lo               loopback           carrier     unmanaged
  2 enp2s0           ether              off         unmanaged
  3 enp3s0           ether              off         unmanaged
  4 enp4s0           ether              degraded    configured
  5 enp5s0           ether              off         unmanaged
  6 br0              ether              routable    configured
  7 virbr0           ether              no-carrier  unmanaged

7 links listed.
</code></pre><p>My ethernet card has four ports and only <em>enp4s0</em> is in use. It has a <em>degraded</em> status because there is no IP address assigned to <em>enp4s0</em>. You can ignore that for now but it would be nice to see this made more clear in a future systemd release.</p><p>Look at <em>br0</em> and you&rsquo;ll notice that it&rsquo;s <em>configured</em> and <em>routable</em>. That&rsquo;s the best status you can get for an interface. You&rsquo;ll also see that my other ethernet devices are in the <em>unmanaged</em> state. I could easily add more <code>.network</code> files to <code>/etc/systemd/network</code> to configure those interfaces later.</p><h3 id=further-reading>Further reading</h3><p>As usual, the <a href=https://wiki.archlinux.org/index.php/systemd-networkd>Arch Linux wiki page on systemd-networkd</a> is a phenomenal resource. There&rsquo;s a detailed overview of all of the available systemd-networkd configuration file options over at <a href=http://www.freedesktop.org/software/systemd/man/systemd.network.html>systemd&rsquo;s documentation site</a>.</p></content><p><a href=https://major.io/tags/centos/>#centos</a>
<a href=https://major.io/tags/fedora/>#fedora</a>
<a href=https://major.io/tags/network/>#network</a>
<a href=https://major.io/tags/red-hat/>#red hat</a>
<a href=https://major.io/tags/systemd/>#systemd</a></p></main><footer><hr>CC-BY-SA 4.0 &#187;
Made with <a href=https://gohugo.io/>Hugo</a> &#187;
Theme based on <a href=https://github.com/janraasch/hugo-bearblog/>Hugo Ê•â€¢á´¥â€¢Ê” Bear</a><br></footer></body></html>