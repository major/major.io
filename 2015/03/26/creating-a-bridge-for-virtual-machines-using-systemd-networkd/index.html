<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Major Hayden"><meta name=description content="There are plenty of guides out there for making ethernet bridges in Linux to support virtual machines using built-in network scripts or NetworkManager. I decided to try my hand with creating a bridge using only systemd-networkd and it was surprisingly easy.
First off, you&amp;rsquo;ll need a version of systemd with networkd support. Fedora 20 and 21 will work just fine. RHEL/CentOS 7 and Arch Linux should also work. Much of the networkd support has been in systemd for quite a while, but if you&amp;rsquo;re looking for fancier network settings, like bonding, you&amp;rsquo;ll want at least systemd 216."><meta name=keywords content=",centos,fedora,network,red hat,systemd"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://major.io/2015/03/26/creating-a-bridge-for-virtual-machines-using-systemd-networkd/><title>Creating a bridge for virtual machines using systemd-networkd :: Major Hayden ðŸ¤  â€” Words of wisdom from a social nerd</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=../../../../main.min.5dcefbf8102eb536dd3e2de53ffebfa58599ab2435c241a0db81728a5e015f2e.css><link rel=apple-touch-icon sizes=180x180 href=../../../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../../favicon-16x16.png><link rel=manifest href=../../../../site.webmanifest><link rel=mask-icon href=../../../../safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=../../../../favicon.ico><meta name=msapplication-TileColor content="#252627"><meta name=theme-color content="#252627"><meta itemprop=name content="Creating a bridge for virtual machines using systemd-networkd"><meta itemprop=description content="There are plenty of guides out there for making ethernet bridges in Linux to support virtual machines using built-in network scripts or NetworkManager. I decided to try my hand with creating a bridge using only systemd-networkd and it was surprisingly easy.
First off, you&rsquo;ll need a version of systemd with networkd support. Fedora 20 and 21 will work just fine. RHEL/CentOS 7 and Arch Linux should also work. Much of the networkd support has been in systemd for quite a while, but if you&rsquo;re looking for fancier network settings, like bonding, you&rsquo;ll want at least systemd 216."><meta itemprop=datePublished content="2015-03-26T13:17:08+00:00"><meta itemprop=dateModified content="2015-03-26T13:17:08+00:00"><meta itemprop=wordCount content="612"><meta itemprop=image content="https://major.io"><meta itemprop=keywords content="centos,fedora,network,red hat,systemd,"><meta property="article:section" content="Blog Posts"><meta property="article:published_time" content="2015-03-26 13:17:08 +0000 UTC"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Creating a bridge for virtual machines using systemd-networkd :: Major Hayden ðŸ¤ "><meta name=twitter:description content><meta name=twitter:site content="https://major.io"><meta name=twitter:creator content="Major Hayden"><meta name=twitter:image content><style type=text/css>html{letter-spacing:unset}</style></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=../../../../ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ echo major.io</span>
<span class=logo__cursor style=visibility:hidden></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://major.io/ham-radio-faq>hamradio</a></li><li><a href=https://major.io/icanhazip-com-faq>icanhazip</a></li><li><a href=https://major.io/posts/>posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://major.io/2015/03/26/creating-a-bridge-for-virtual-machines-using-systemd-networkd/>Creating a bridge for virtual machines using systemd-networkd</a></h2><div class=post-content><p>There are plenty of guides out there for making ethernet bridges in Linux to support virtual machines using built-in network scripts or NetworkManager. I decided to try my hand with creating a bridge using only systemd-networkd and it was surprisingly easy.</p><p>First off, you&rsquo;ll need a version of systemd with networkd support. Fedora 20 and 21 will work just fine. RHEL/CentOS 7 and Arch Linux should also work. Much of the networkd support has been in systemd for quite a while, but if you&rsquo;re looking for fancier network settings, like bonding, you&rsquo;ll want at least systemd 216.</p><h3 id=getting-our-daemons-in-order>Getting our daemons in order</h3><p>Before we get started, ensure that systemd-networkd will run on a reboot and NetworkManager is disabled. We also need to make a config file director for systemd-networkd if it doesn&rsquo;t exist already. In addition, let&rsquo;s enable the caching resolver and make a symlink to systemd&rsquo;s <code>resolv.conf</code>:</p><pre><code>systemctl enable systemd-networkd
systemctl disable NetworkManager
systemctl enable systemd-resolved
ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf
mkdir /etc/systemd/network
</code></pre><h3 id=configure-the-physical-network-adapter>Configure the physical network adapter</h3><p>In my case, the network adapter connected to my external network is <em>enp4s0</em> but yours will vary. Run <code>ip addr</code> to get a list of your network cards. Let&rsquo;s create <code>/etc/systemd/network/uplink.network</code> and put the following in it:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#719e07>[Match]</span>
Name<span style=color:#719e07>=</span><span style=color:#2aa198>enp4s0</span>

<span style=color:#719e07>[Network]</span>
Bridge<span style=color:#719e07>=</span><span style=color:#2aa198>br0</span>
</code></pre></div><p>I&rsquo;m telling systemd to look for a device called <em>enp4s0</em> and then add it to a bridge called <em>br0</em> that we haven&rsquo;t configured yet. Be sure to change <em>enp4s0</em> to match your ethernet card.</p><h3 id=make-the-bridge>Make the bridge</h3><p>We need to tell systemd about our new bridge network device and we also need to specify the IP configuration for it. We start by creating <code>/etc/systemd/network/br0.netdev</code> to specify the device:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#719e07>[NetDev]</span>
Name<span style=color:#719e07>=</span><span style=color:#2aa198>br0</span>
Kind<span style=color:#719e07>=</span><span style=color:#2aa198>bridge</span>
</code></pre></div><p>This file is fairly self-explanatory. We&rsquo;re telling systemd that we want a device called <em>br0</em> that functions as an ethernet bridge. Now create <code>/etc/systemd/network/br0.network</code> to specify the IP configuration for the <em>br0</em> interface:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#719e07>[Match]</span>
Name<span style=color:#719e07>=</span><span style=color:#2aa198>br0</span>

<span style=color:#719e07>[Network]</span>
DNS<span style=color:#719e07>=</span><span style=color:#2aa198>192.168.250.1</span>
Address<span style=color:#719e07>=</span><span style=color:#2aa198>192.168.250.33/24</span>
Gateway<span style=color:#719e07>=</span><span style=color:#2aa198>192.168.250.1</span>
</code></pre></div><p>This file tells systemd that we want to apply a simple static network configuration to <em>br0</em> with a single IPv4 address. If you want to add additional DNS servers or IPv4/IPv6 addresses, just add more <code>DNS=</code> and <code>Address</code> lines right below the ones you see above. Yes, it&rsquo;s just that easy.</p><h3 id=lets-do-this>Let&rsquo;s do this</h3><p>Some folks are brave enough to stop NetworkManager and start all of the systemd services here but I prefer to reboot so that everything comes up cleanly. That will also allow you to verify that future reboots will cause the server to come back online with the right configuration. After the reboot, run <code>networkctl</code> and you&rsquo;ll get something like this (with color):</p><p><img src=../../../../wp-content/uploads/2015/03/networkctl_screenshot.png alt=1></p><p>Here&rsquo;s what&rsquo;s in the screenshot:</p><pre><code>IDX LINK             TYPE               OPERATIONAL SETUP
  1 lo               loopback           carrier     unmanaged
  2 enp2s0           ether              off         unmanaged
  3 enp3s0           ether              off         unmanaged
  4 enp4s0           ether              degraded    configured
  5 enp5s0           ether              off         unmanaged
  6 br0              ether              routable    configured
  7 virbr0           ether              no-carrier  unmanaged

7 links listed.
</code></pre><p>My ethernet card has four ports and only <em>enp4s0</em> is in use. It has a <em>degraded</em> status because there is no IP address assigned to <em>enp4s0</em>. You can ignore that for now but it would be nice to see this made more clear in a future systemd release.</p><p>Look at <em>br0</em> and you&rsquo;ll notice that it&rsquo;s <em>configured</em> and <em>routable</em>. That&rsquo;s the best status you can get for an interface. You&rsquo;ll also see that my other ethernet devices are in the <em>unmanaged</em> state. I could easily add more <code>.network</code> files to <code>/etc/systemd/network</code> to configure those interfaces later.</p><h3 id=further-reading>Further reading</h3><p>As usual, the <a href=https://wiki.archlinux.org/index.php/systemd-networkd>Arch Linux wiki page on systemd-networkd</a> is a phenomenal resource. There&rsquo;s a detailed overview of all of the available systemd-networkd configuration file options over at <a href=http://www.freedesktop.org/software/systemd/man/systemd.network.html>systemd&rsquo;s documentation site</a>.</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://major.io/tags/centos>centos</a></span><span class=tag><a href=https://major.io/tags/fedora>fedora</a></span><span class=tag><a href=https://major.io/tags/network>network</a></span><span class=tag><a href=https://major.io/tags/red-hat>red hat</a></span><span class=tag><a href=https://major.io/tags/systemd>systemd</a></span></p></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span><a href=https://major.io>Major Hayden</a></span>
<span><a href=https://creativecommons.org/licenses/by-sa/2.0/ target=_blank rel=noopener>CC BY-SA 2.0</a></span>
<span><a href=https://major.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>rhazdon</a></span></div></div></footer></div><script type=text/javascript src=../../../../bundle.min.2d5469329143160ae2456a69c3c76dc2d0a3b212b46afe291a51bd68650ed6f8697e001dab54f1c272c77ce08092a8c55e5bb4314e0ee334aab4b927ec896638.js integrity="sha512-LVRpMpFDFgriRWppw8dtwtCjshK0av4pGlG9aGUO1vhpfgAdq1TxwnLHfOCAkqjFXlu0MU4O4zSqtLkn7IlmOA=="></script></body></html>