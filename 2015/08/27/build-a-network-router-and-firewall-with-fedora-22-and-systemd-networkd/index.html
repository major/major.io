<!doctype html><html lang=en-us><head><meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://major.io/favicon.ico><title>Build a network router and firewall with Fedora 22 and systemd-networkd | Major Hayden's Blog ðŸ¤ </title><meta name=title content="Build a network router and firewall with Fedora 22 and systemd-networkd"><meta name=description content="This post originally appeared on the Fedora Magazine blog.
 One of my favorite features of Fedora 22 is systemd-networkd and all of the new features that came with it in recent systemd versions. The configuration files are easy to read, bridging is simple, and tunnels are resilient.
I&rsquo;ve recently started using a small Linux server at home again as a network router and firewall. However, I used systemd-networkd this time and had some great results."><meta name=keywords content="fedora,firewall,networking,security,systemd,"><meta property="og:title" content="Build a network router and firewall with Fedora 22 and systemd-networkd"><meta property="og:description" content="This post originally appeared on the Fedora Magazine blog.
 One of my favorite features of Fedora 22 is systemd-networkd and all of the new features that came with it in recent systemd versions. The configuration files are easy to read, bridging is simple, and tunnels are resilient.
I&rsquo;ve recently started using a small Linux server at home again as a network router and firewall. However, I used systemd-networkd this time and had some great results."><meta property="og:type" content="article"><meta property="og:url" content="https://major.io/2015/08/27/build-a-network-router-and-firewall-with-fedora-22-and-systemd-networkd/"><meta property="og:image" content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-08-27T12:38:43+00:00"><meta property="article:modified_time" content="2015-08-27T12:38:43+00:00"><meta property="og:site_name" content="Major Hayden's Blog ðŸ¤ "><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta name=twitter:title content="Build a network router and firewall with Fedora 22 and systemd-networkd"><meta name=twitter:description content="This post originally appeared on the Fedora Magazine blog.
 One of my favorite features of Fedora 22 is systemd-networkd and all of the new features that came with it in recent systemd versions. The configuration files are easy to read, bridging is simple, and tunnels are resilient.
I&rsquo;ve recently started using a small Linux server at home again as a network router and firewall. However, I used systemd-networkd this time and had some great results."><meta name=twitter:site content="@mhayden"><meta itemprop=name content="Build a network router and firewall with Fedora 22 and systemd-networkd"><meta itemprop=description content="This post originally appeared on the Fedora Magazine blog.
 One of my favorite features of Fedora 22 is systemd-networkd and all of the new features that came with it in recent systemd versions. The configuration files are easy to read, bridging is simple, and tunnels are resilient.
I&rsquo;ve recently started using a small Linux server at home again as a network router and firewall. However, I used systemd-networkd this time and had some great results."><meta itemprop=datePublished content="2015-08-27T12:38:43+00:00"><meta itemprop=dateModified content="2015-08-27T12:38:43+00:00"><meta itemprop=wordCount content="926"><meta itemprop=image content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta itemprop=keywords content="fedora,firewall,networking,security,systemd,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:820px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px}div.highlight code{background-color:unset;color:initial}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style></head><body><header><a href=../../../../ class=title><h2>Major Hayden's Blog ðŸ¤ </h2></a><nav><a href=../../../../>Home</a>
<a href=../../../../ham-radio-faq>Ham Radio</a>
<a href=../../../../icanhazip-com-faq>icanhazip FAQ</a>
<a href=../../../../posts>Posts</a></nav><script async src=https://media.ethicalads.io/media/client/ethicalads.min.js></script><div data-ea-publisher=major-io data-ea-type=text></div></header><main><h1>Build a network router and firewall with Fedora 22 and systemd-networkd</h1><i><time datetime=2015-08-27 pubdate>2015-08-27</time></i>
<content><p><em>This post <a href=http://fedoramagazine.org/build-network-router-firewall-fedora-22-systemd-networkd/>originally appeared</a> on the Fedora Magazine blog.</em></p><hr><p>One of my favorite features of Fedora 22 is <a href=http://www.freedesktop.org/software/systemd/man/systemd-networkd.html>systemd-networkd</a> and all of the new features that came with it in recent systemd versions. The configuration files are easy to read, bridging is simple, and tunnels are resilient.</p><p>I&rsquo;ve recently started using a small Linux server at home again as a network router and firewall. However, I used systemd-networkd this time and had some great results. Let&rsquo;s get started!</p><h2 id=overview>Overview</h2><p>Our example router in this example has two network interfaces:</p><ul><li>eth0: public internet connectivity</li><li>eth1: private LAN (192.168.3.1/24)</li></ul><p>We want machines on the private LAN to route their traffic through the router to the public internet via NAT. Also, we want clients on the LAN to get their IP addresses assigned automatically.</p><h2 id=network-configuration>Network configuration</h2><p>All of the systemd-networkd configuration files live within <code>/etc/systemd/network</code> and we need to create that directory:</p><pre><code>mkdir /etc/systemd/network
</code></pre><p>We need to write a network configuration file for our public interface that systemd-networkd can read. Open up <code>/etc/systemd/network/eth0.network</code> and write these lines:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#859900>[Match]</span>
<span style=color:#268bd2>Name</span>=<span style=color:#2aa198>eth0</span>

<span style=color:#859900>[Network]</span>
<span style=color:#268bd2>Address</span>=<span style=color:#2aa198>PUBLIC_IP_ADDRESS/CIDR</span>
<span style=color:#268bd2>Gateway</span>=<span style=color:#2aa198>GATEWAY</span>
<span style=color:#268bd2>DNS</span>=<span style=color:#2aa198>8.8.8.8</span>
<span style=color:#268bd2>DNS</span>=<span style=color:#2aa198>8.8.4.4</span>
<span style=color:#268bd2>IPForward</span>=<span style=color:#2aa198>yes</span>
</code></pre></div><p>If we break this configuration file down, we&rsquo;re telling systemd-networkd to apply this configuration to any devices that are called <code>eth0</code>. Also, we&rsquo;re specifying a public IP address and CIDR mask (like /24 or /22) so that the interface can be configured. The gateway address will be added to the routing table. We&rsquo;ve also provided DNS servers to use with systemd-resolved (more on that later).</p><p>I added <code>IPForward=yes</code> so that systemd-networkd will automatically enable forwarding for the interface via sysctl. (That always seems to be the step I forget when I build a Linux router.)</p><p>Let&rsquo;s do the same for our LAN interface. Create this configuration file and store it as <code>/etc/systemd/network/eth1.network</code>:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#859900>[Match]</span>
<span style=color:#268bd2>Name</span>=<span style=color:#2aa198>eth1</span>

<span style=color:#859900>[Network]</span>
<span style=color:#268bd2>Address</span>=<span style=color:#2aa198>192.168.3.1/24</span>
<span style=color:#268bd2>IPForward</span>=<span style=color:#2aa198>yes</span>
</code></pre></div><p>We don&rsquo;t need to specify a gateway address here because this interface will be the gateway for the LAN.</p><h2 id=prepare-the-services>Prepare the services</h2><p>If we&rsquo;re planning to use systemd-networkd, we need to ensure that it runs instead of traditional network scripts or NetworkManager:</p><pre><code>systemctl disable network
systemctl disable NetworkManager
systemctl enable systemd-networkd
</code></pre><p>Also, let&rsquo;s be sure to use systemd-resolved to handle our <code>/etc/resolv.conf</code>:</p><pre><code>systemctl enable systemd-resolved
systemctl start systemd-resolved
rm -f /etc/resolv.conf
ln -s /run/systemd/resolve/resolv.conf /etc/resolv.conf
</code></pre><h2 id=reboot>Reboot</h2><p>We&rsquo;re now set to reboot! It&rsquo;s possible to bring up systemd-networkd without rebooting but I&rsquo;d rather verify with a reboot now than get goosed with a broken network after a reboot later.</p><p>Once your router is back up, run <code>networkctl</code> and verify that you have <em>routable</em> in the output for both interfaces:</p><pre><code>[root@router ~]# networkctl
IDX LINK             TYPE               OPERATIONAL SETUP
  1 lo               loopback           carrier     unmanaged
  2 eth0             ether              routable    configured
  3 eth1             ether              routable    configured
</code></pre><h2 id=dhcp>DHCP</h2><p>Now that both network interfaces are online, we need something to tell our clients about the IP configuration they should be using. There are plenty of good options here, but I prefer <a href=http://www.thekelleys.org.uk/dnsmasq/doc.html>dnsmasq</a>. It has served me well over the years and it provides some handy features along with DHCP, such as DNS caching, TFTP and IPv6 router announcements.</p><p>Let&rsquo;s install dnsmasq and enable it at boot:</p><pre><code>dnf -y install dnsmasq
systemctl enable dnsmasq
</code></pre><p>Open <code>/etc/dnsmasq.conf</code> in your favorite text editor and edit a few lines:</p><ul><li>Uncomment <code>dhcp-authoritative</code></li><li>This tells dnsmasq that it&rsquo;s the exclusive DHCP server on the network and that it should answer all requests</li><li>Uncomment <code>interface=</code> and add <code>eth1</code> on the end (should look like <code>interface=eth1</code> when you&rsquo;re done)</li><li>Most ISP&rsquo;s filter DHCP replies on their public networks, but we don&rsquo;t want to take chances here. We need to restrict DHCP to our public interface only.</li><li>Look for the <code>dhcp-range</code> line and change it to <code>dhcp-range=192.168.3.50,192.168.3.150,12h</code></li><li>We&rsquo;re giving clients 12 hour leases on 192.168.3.0/24</li></ul><p>Save the file and start dnsmasq:</p><pre><code>systemctl start dnsmasq
</code></pre><h2 id=firewall>Firewall</h2><p>We&rsquo;re almost done! Now it&rsquo;s time to tell iptables to <a href=https://en.wikipedia.org/wiki/Network_address_translation>masquerade</a> any packets from our LAN to the internet. But wait, it&rsquo;s 2015 and we have tools like <code>firewall-cmd</code> to do that for us in Fedora.</p><p>Let&rsquo;s enable masquerading, allow DNS, and allow DHCP traffic. We can then make the state permanent:</p><pre><code>firewall-cmd --add-masquerade
firewall-cmd --add-service=dns --add-service=dhcp
firewall-cmd --runtime-to-permanent
</code></pre><h2 id=testing>Testing</h2><p>Put a client machine on your LAN network and you should be able to ping some public sites from the client:</p><pre><code>[root@client ~]# ping -c 4 icanhazip.com
PING icanhazip.com (104.238.141.75) 56(84) bytes of data.
64 bytes from lax.icanhazip.com (104.238.141.75): icmp_seq=1 ttl=52 time=69.8 ms
64 bytes from lax.icanhazip.com (104.238.141.75): icmp_seq=2 ttl=52 time=69.7 ms
64 bytes from lax.icanhazip.com (104.238.141.75): icmp_seq=3 ttl=52 time=69.6 ms
64 bytes from lax.icanhazip.com (104.238.141.75): icmp_seq=4 ttl=52 time=69.7 ms

--- icanhazip.com ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3005ms
rtt min/avg/max/mdev = 69.659/69.758/69.874/0.203 ms
</code></pre><h2 id=extras>Extras</h2><p>If you need to adjust your network configuration, just run <code>systemctl restart systemd-networkd</code> afterwards. I&rsquo;ve found that it&rsquo;s quite intelligent about the network devices and it won&rsquo;t reconfigure anything that hasn&rsquo;t changed.</p><p>The <code>networkctl</code> command is very powerful. Check out the <code>status</code> and <code>lldp</code> functions to get more information about your network devices and the networks they&rsquo;re connected to.</p><p>When something goes wrong, look in your systemd journal:</p><pre><code>[root@router ~]# journalctl -u systemd-networkd
-- Logs begin at Fri 2015-07-31 01:22:38 UTC, end at Fri 2015-07-31 02:11:24 UTC. --
Jul 31 01:46:14 router systemd[1]: Starting Network Service...
Jul 31 01:46:14 router systemd-networkd[286]: Enumeration completed
Jul 31 01:46:14 router systemd[1]: Started Network Service.
Jul 31 01:46:15 router systemd-networkd[286]: eth1            : link configured
Jul 31 01:46:15 router systemd-networkd[286]: eth0            : gained carrier
Jul 31 01:46:15 router systemd-networkd[286]: eth0            : link configured
Jul 31 01:46:16 router systemd-networkd[286]: eth1            : gained carrier
</code></pre></content><p><a href=https://major.io/tags/fedora/>#fedora</a>
<a href=https://major.io/tags/firewall/>#firewall</a>
<a href=https://major.io/tags/networking/>#networking</a>
<a href=https://major.io/tags/security/>#security</a>
<a href=https://major.io/tags/systemd/>#systemd</a></p></main><footer><hr>CC-BY-SA 4.0 &#187;
Made with <a href=https://gohugo.io/>Hugo</a> &#187;
Theme based on <a href=https://github.com/janraasch/hugo-bearblog/>Hugo Ê•â€¢á´¥â€¢Ê” Bear</a><br></footer></body></html>