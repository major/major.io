<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Major Hayden"><meta name=description content="This post originally appeared on the Fedora Magazine blog.
 One of my favorite features of Fedora 22 is systemd-networkd and all of the new features that came with it in recent systemd versions. The configuration files are easy to read, bridging is simple, and tunnels are resilient.
I&amp;rsquo;ve recently started using a small Linux server at home again as a network router and firewall. However, I used systemd-networkd this time and had some great results."><meta name=keywords content=",fedora,firewall,networking,security,systemd"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://major.io/2015/08/27/build-a-network-router-and-firewall-with-fedora-22-and-systemd-networkd/><title>Build a network router and firewall with Fedora 22 and systemd-networkd :: Major Hayden ðŸ¤  â€” Words of wisdom from a social nerd</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=../../../../main.min.5dcefbf8102eb536dd3e2de53ffebfa58599ab2435c241a0db81728a5e015f2e.css><link rel=apple-touch-icon sizes=180x180 href=../../../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../../favicon-16x16.png><link rel=manifest href=../../../../site.webmanifest><link rel=mask-icon href=../../../../safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=../../../../favicon.ico><meta name=msapplication-TileColor content="#252627"><meta name=theme-color content="#252627"><meta itemprop=name content="Build a network router and firewall with Fedora 22 and systemd-networkd"><meta itemprop=description content="This post originally appeared on the Fedora Magazine blog.
 One of my favorite features of Fedora 22 is systemd-networkd and all of the new features that came with it in recent systemd versions. The configuration files are easy to read, bridging is simple, and tunnels are resilient.
I&rsquo;ve recently started using a small Linux server at home again as a network router and firewall. However, I used systemd-networkd this time and had some great results."><meta itemprop=datePublished content="2015-08-27T12:38:43+00:00"><meta itemprop=dateModified content="2015-08-27T12:38:43+00:00"><meta itemprop=wordCount content="926"><meta itemprop=image content="https://major.io"><meta itemprop=keywords content="fedora,firewall,networking,security,systemd,"><meta property="article:section" content="Blog Posts"><meta property="article:published_time" content="2015-08-27 12:38:43 +0000 UTC"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Build a network router and firewall with Fedora 22 and systemd-networkd :: Major Hayden ðŸ¤ "><meta name=twitter:description content><meta name=twitter:site content="https://major.io"><meta name=twitter:creator content="Major Hayden"><meta name=twitter:image content><style type=text/css>html{letter-spacing:unset}</style></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=../../../../ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ echo major.io</span>
<span class=logo__cursor style=visibility:hidden></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://major.io/ham-radio-faq>hamradio</a></li><li><a href=https://major.io/icanhazip-com-faq>icanhazip</a></li><li><a href=https://major.io/posts/>posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://major.io/2015/08/27/build-a-network-router-and-firewall-with-fedora-22-and-systemd-networkd/>Build a network router and firewall with Fedora 22 and systemd-networkd</a></h2><div class=post-content><p><em>This post <a href=http://fedoramagazine.org/build-network-router-firewall-fedora-22-systemd-networkd/>originally appeared</a> on the Fedora Magazine blog.</em></p><hr><p>One of my favorite features of Fedora 22 is <a href=http://www.freedesktop.org/software/systemd/man/systemd-networkd.html>systemd-networkd</a> and all of the new features that came with it in recent systemd versions. The configuration files are easy to read, bridging is simple, and tunnels are resilient.</p><p>I&rsquo;ve recently started using a small Linux server at home again as a network router and firewall. However, I used systemd-networkd this time and had some great results. Let&rsquo;s get started!</p><h2 id=overview>Overview</h2><p>Our example router in this example has two network interfaces:</p><ul><li>eth0: public internet connectivity</li><li>eth1: private LAN (192.168.3.1/24)</li></ul><p>We want machines on the private LAN to route their traffic through the router to the public internet via NAT. Also, we want clients on the LAN to get their IP addresses assigned automatically.</p><h2 id=network-configuration>Network configuration</h2><p>All of the systemd-networkd configuration files live within <code>/etc/systemd/network</code> and we need to create that directory:</p><pre><code>mkdir /etc/systemd/network
</code></pre><p>We need to write a network configuration file for our public interface that systemd-networkd can read. Open up <code>/etc/systemd/network/eth0.network</code> and write these lines:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#719e07>[Match]</span>
Name<span style=color:#719e07>=</span><span style=color:#2aa198>eth0</span>

<span style=color:#719e07>[Network]</span>
Address<span style=color:#719e07>=</span><span style=color:#2aa198>PUBLIC_IP_ADDRESS/CIDR</span>
Gateway<span style=color:#719e07>=</span><span style=color:#2aa198>GATEWAY</span>
DNS<span style=color:#719e07>=</span><span style=color:#2aa198>8.8.8.8</span>
DNS<span style=color:#719e07>=</span><span style=color:#2aa198>8.8.4.4</span>
IPForward<span style=color:#719e07>=</span><span style=color:#2aa198>yes</span>
</code></pre></div><p>If we break this configuration file down, we&rsquo;re telling systemd-networkd to apply this configuration to any devices that are called <code>eth0</code>. Also, we&rsquo;re specifying a public IP address and CIDR mask (like /24 or /22) so that the interface can be configured. The gateway address will be added to the routing table. We&rsquo;ve also provided DNS servers to use with systemd-resolved (more on that later).</p><p>I added <code>IPForward=yes</code> so that systemd-networkd will automatically enable forwarding for the interface via sysctl. (That always seems to be the step I forget when I build a Linux router.)</p><p>Let&rsquo;s do the same for our LAN interface. Create this configuration file and store it as <code>/etc/systemd/network/eth1.network</code>:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#719e07>[Match]</span>
Name<span style=color:#719e07>=</span><span style=color:#2aa198>eth1</span>

<span style=color:#719e07>[Network]</span>
Address<span style=color:#719e07>=</span><span style=color:#2aa198>192.168.3.1/24</span>
IPForward<span style=color:#719e07>=</span><span style=color:#2aa198>yes</span>
</code></pre></div><p>We don&rsquo;t need to specify a gateway address here because this interface will be the gateway for the LAN.</p><h2 id=prepare-the-services>Prepare the services</h2><p>If we&rsquo;re planning to use systemd-networkd, we need to ensure that it runs instead of traditional network scripts or NetworkManager:</p><pre><code>systemctl disable network
systemctl disable NetworkManager
systemctl enable systemd-networkd
</code></pre><p>Also, let&rsquo;s be sure to use systemd-resolved to handle our <code>/etc/resolv.conf</code>:</p><pre><code>systemctl enable systemd-resolved
systemctl start systemd-resolved
rm -f /etc/resolv.conf
ln -s /run/systemd/resolve/resolv.conf /etc/resolv.conf
</code></pre><h2 id=reboot>Reboot</h2><p>We&rsquo;re now set to reboot! It&rsquo;s possible to bring up systemd-networkd without rebooting but I&rsquo;d rather verify with a reboot now than get goosed with a broken network after a reboot later.</p><p>Once your router is back up, run <code>networkctl</code> and verify that you have <em>routable</em> in the output for both interfaces:</p><pre><code>[root@router ~]# networkctl
IDX LINK             TYPE               OPERATIONAL SETUP
  1 lo               loopback           carrier     unmanaged
  2 eth0             ether              routable    configured
  3 eth1             ether              routable    configured
</code></pre><h2 id=dhcp>DHCP</h2><p>Now that both network interfaces are online, we need something to tell our clients about the IP configuration they should be using. There are plenty of good options here, but I prefer <a href=http://www.thekelleys.org.uk/dnsmasq/doc.html>dnsmasq</a>. It has served me well over the years and it provides some handy features along with DHCP, such as DNS caching, TFTP and IPv6 router announcements.</p><p>Let&rsquo;s install dnsmasq and enable it at boot:</p><pre><code>dnf -y install dnsmasq
systemctl enable dnsmasq
</code></pre><p>Open <code>/etc/dnsmasq.conf</code> in your favorite text editor and edit a few lines:</p><ul><li>Uncomment <code>dhcp-authoritative</code></li><li>This tells dnsmasq that it&rsquo;s the exclusive DHCP server on the network and that it should answer all requests</li><li>Uncomment <code>interface=</code> and add <code>eth1</code> on the end (should look like <code>interface=eth1</code> when you&rsquo;re done)</li><li>Most ISP&rsquo;s filter DHCP replies on their public networks, but we don&rsquo;t want to take chances here. We need to restrict DHCP to our public interface only.</li><li>Look for the <code>dhcp-range</code> line and change it to <code>dhcp-range=192.168.3.50,192.168.3.150,12h</code></li><li>We&rsquo;re giving clients 12 hour leases on 192.168.3.0/24</li></ul><p>Save the file and start dnsmasq:</p><pre><code>systemctl start dnsmasq
</code></pre><h2 id=firewall>Firewall</h2><p>We&rsquo;re almost done! Now it&rsquo;s time to tell iptables to <a href=https://en.wikipedia.org/wiki/Network_address_translation>masquerade</a> any packets from our LAN to the internet. But wait, it&rsquo;s 2015 and we have tools like <code>firewall-cmd</code> to do that for us in Fedora.</p><p>Let&rsquo;s enable masquerading, allow DNS, and allow DHCP traffic. We can then make the state permanent:</p><pre><code>firewall-cmd --add-masquerade
firewall-cmd --add-service=dns --add-service=dhcp
firewall-cmd --runtime-to-permanent
</code></pre><h2 id=testing>Testing</h2><p>Put a client machine on your LAN network and you should be able to ping some public sites from the client:</p><pre><code>[root@client ~]# ping -c 4 icanhazip.com
PING icanhazip.com (104.238.141.75) 56(84) bytes of data.
64 bytes from lax.icanhazip.com (104.238.141.75): icmp_seq=1 ttl=52 time=69.8 ms
64 bytes from lax.icanhazip.com (104.238.141.75): icmp_seq=2 ttl=52 time=69.7 ms
64 bytes from lax.icanhazip.com (104.238.141.75): icmp_seq=3 ttl=52 time=69.6 ms
64 bytes from lax.icanhazip.com (104.238.141.75): icmp_seq=4 ttl=52 time=69.7 ms

--- icanhazip.com ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3005ms
rtt min/avg/max/mdev = 69.659/69.758/69.874/0.203 ms
</code></pre><h2 id=extras>Extras</h2><p>If you need to adjust your network configuration, just run <code>systemctl restart systemd-networkd</code> afterwards. I&rsquo;ve found that it&rsquo;s quite intelligent about the network devices and it won&rsquo;t reconfigure anything that hasn&rsquo;t changed.</p><p>The <code>networkctl</code> command is very powerful. Check out the <code>status</code> and <code>lldp</code> functions to get more information about your network devices and the networks they&rsquo;re connected to.</p><p>When something goes wrong, look in your systemd journal:</p><pre><code>[root@router ~]# journalctl -u systemd-networkd
-- Logs begin at Fri 2015-07-31 01:22:38 UTC, end at Fri 2015-07-31 02:11:24 UTC. --
Jul 31 01:46:14 router systemd[1]: Starting Network Service...
Jul 31 01:46:14 router systemd-networkd[286]: Enumeration completed
Jul 31 01:46:14 router systemd[1]: Started Network Service.
Jul 31 01:46:15 router systemd-networkd[286]: eth1            : link configured
Jul 31 01:46:15 router systemd-networkd[286]: eth0            : gained carrier
Jul 31 01:46:15 router systemd-networkd[286]: eth0            : link configured
Jul 31 01:46:16 router systemd-networkd[286]: eth1            : gained carrier
</code></pre></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://major.io/tags/fedora>fedora</a></span><span class=tag><a href=https://major.io/tags/firewall>firewall</a></span><span class=tag><a href=https://major.io/tags/networking>networking</a></span><span class=tag><a href=https://major.io/tags/security>security</a></span><span class=tag><a href=https://major.io/tags/systemd>systemd</a></span></p></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span><a href=https://major.io>Major Hayden</a></span>
<span><a href=https://creativecommons.org/licenses/by-sa/2.0/ target=_blank rel=noopener>CC BY-SA 2.0</a></span>
<span><a href=https://major.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>rhazdon</a></span></div></div></footer></div><script type=text/javascript src=../../../../bundle.min.2d5469329143160ae2456a69c3c76dc2d0a3b212b46afe291a51bd68650ed6f8697e001dab54f1c272c77ce08092a8c55e5bb4314e0ee334aab4b927ec896638.js integrity="sha512-LVRpMpFDFgriRWppw8dtwtCjshK0av4pGlG9aGUO1vhpfgAdq1TxwnLHfOCAkqjFXlu0MU4O4zSqtLkn7IlmOA=="></script></body></html>