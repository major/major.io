<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Using systemd-networkd with bonding on Rackspaceâ€™s OnMetal servers &#183; ðŸ¤  Major Hayden</title><meta name=title content="Using systemd-networkd with bonding on Rackspaceâ€™s OnMetal servers &#183; ðŸ¤  Major Hayden"><meta name=description content="A social nerd writing about everything"><link rel=canonical href=https://major.io/2015/08/21/using-systemd-networkd-with-bonding-on-rackspaces-onmetal-servers/><link type=text/css rel=stylesheet href=/css/main.bundle.min.55253fde34a251b02bdc3be052caf9044f977a6d44817f370ad781aed774a2a79759827fd0c3255abb87575848a355a0068eb43b2958172f6c237352069d6cea.css integrity="sha512-VSU/3jSiUbAr3DvgUsr5BE+Xem1EgX83CteBrtd0oqeXWYJ/0MMlWruHV1hIo1WgBo60OylYFy9sI3NSBp1s6g=="><script type=text/javascript src=/js/appearance.min.badab316c9287a5a42a843e4eb45da65bb3d194a5a0f5fa4a3e516160e67df0b8c65f4f19a8e146436e29d583699e6cb41d6bbe99e05e1dbaa877763bad9f8e2.js integrity="sha512-utqzFskoelpCqEPk60XaZbs9GUpaD1+ko+UWFg5n3wuMZfTxmo4UZDbinVg2mebLQda76Z4F4duqh3djutn44g=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.b607eb5ea0f48ef635db6a1c024a35eeff4529157e49461941aac333a158a1f71cae4e530d45ac010598695f823dbe38a63142757e37c2d7b74a309d7296f681.js integrity="sha512-tgfrXqD0jvY122ocAko17v9FKRV+SUYZQarDM6FYofccrk5TDUWsAQWYaV+CPb44pjFCdX43wte3SjCdcpb2gQ==" data-copy=Copy data-copied=Copied></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="Using systemd-networkd with bonding on Rackspaceâ€™s OnMetal servers"><meta property="og:description" content="I&rsquo;ve written about systemd-networkd in the past and how easy it can be to set up new network devices and tunnels."><meta property="og:type" content="article"><meta property="og:url" content="https://major.io/2015/08/21/using-systemd-networkd-with-bonding-on-rackspaces-onmetal-servers/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-08-21T14:00:46+00:00"><meta property="article:modified_time" content="2015-08-21T14:00:46+00:00"><meta property="og:site_name" content="ðŸ¤  Major Hayden"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using systemd-networkd with bonding on Rackspaceâ€™s OnMetal servers"><meta name=twitter:description content="I&rsquo;ve written about systemd-networkd in the past and how easy it can be to set up new network devices and tunnels."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Using systemd-networkd with bonding on Rackspaceâ€™s OnMetal servers","headline":"Using systemd-networkd with bonding on Rackspaceâ€™s OnMetal servers","abstract":"I\u0026rsquo;ve written about systemd-networkd in the past and how easy it can be to set up new network devices and tunnels.","inLanguage":"en","url":"https:\/\/major.io\/2015\/08\/21\/using-systemd-networkd-with-bonding-on-rackspaces-onmetal-servers\/","author":{"@type":"Person","name":"Major Hayden"},"copyrightYear":"2015","dateCreated":"2015-08-21T14:00:46\u002b00:00","datePublished":"2015-08-21T14:00:46\u002b00:00","dateModified":"2015-08-21T14:00:46\u002b00:00","keywords":["bonding","command line","fedora","grub2","json","networking","onmetal","python","rackspace","systemd","systemd-networkd","udev"],"mainEntityOfPage":"true","wordCount":"1546"}]</script><meta name=author content="Major Hayden"><link href=mailto:major@mhtx.net rel=me><link href=https://github.com/major rel=me><link href=https://gitlab.com/majorhayden rel=me><link href=https://linkedin.com/in/majorhayden rel=me><link href=https://t.me/majorhayden rel=me><link href=https://twitter.com/majorhayden rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0" href=#main-content><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold sm:py-10 text-neutral-900 dark:text-neutral print:hidden"><nav class="flex justify-between"><div><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>ðŸ¤  Major Hayden</a></div><ul class="flex flex-col list-none ltr:text-right rtl:text-left sm:flex-row"><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/posts/ title=Posts>Blog</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/tags/ title=Tags>Tags</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/w5wut/ title="W5WUT: My amateur radio station">W5WUT</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/cv/ title="Major's CV">CV</a></li><li class="ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><button id=search-button class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>ðŸ¤  Major Hayden</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/2015/08/21/using-systemd-networkd-with-bonding-on-rackspaces-onmetal-servers/>Using systemd-networkd with bonding on Rackspaceâ€™s OnMetal servers</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Using systemd-networkd with bonding on Rackspaceâ€™s OnMetal servers</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2015-08-21 14:00:46 +0000 UTC">21 August 2015</time><span class="px-2 text-primary-500">&#183;</span><span>1546 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">8 mins</span></div><div class="my-1 text-xs text-neutral-500 dark:text-neutral-400"><a href=/tags/bonding/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">bonding</a>
<a href=/tags/command-line/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">command line</a>
<a href=/tags/fedora/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">fedora</a>
<a href=/tags/grub2/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">grub2</a>
<a href=/tags/json/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">json</a>
<a href=/tags/networking/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">networking</a>
<a href=/tags/onmetal/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">onmetal</a>
<a href=/tags/python/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">python</a>
<a href=/tags/rackspace/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">rackspace</a>
<a href=/tags/systemd/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">systemd</a>
<a href=/tags/systemd-networkd/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">systemd-networkd</a>
<a href=/tags/udev/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">udev</a></div></div></header><section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert"><div class="order-first px-0 lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8 lg:order-last"><div class="ltr:pl-5 rtl:pr-5 toc lg:sticky lg:top-10 print:hidden"><details open class="mt-0 overflow-hidden rounded-lg rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5"><summary class="block py-1 text-lg font-semibold cursor-pointer rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 text-neutral-800 dark:text-neutral-100 lg:hidden bg-neutral-100 dark:bg-neutral-700">Table of Contents</summary><div class="py-2 border-dotted ltr:border-l rtl:border-r rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 border-neutral-300 dark:border-neutral-600"><nav id=TableOfContents><ul><li><ul><li><a href=#network-device-naming>Network device naming</a></li><li><a href=#bond-interface-creation>Bond interface creation</a></li><li><a href=#public-network-vlan>Public network VLAN</a></li><li><a href=#servicenet-vlan>ServiceNet VLAN</a></li><li><a href=#enable-systemd-networkd>Enable systemd-networkd</a></li><li><a href=#reboot>Reboot</a></li><li><a href=#checking-our-work>Checking our work</a></li><li><a href=#extra-credit-switch-to-grub2>Extra credit: Switch to grub2</a></li></ul></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose"><p><figure><img class="my-0 rounded-md" src=/wp-content/uploads/2015/08/OnMetal_Graphic.png alt=1></figure></p><p>I&rsquo;ve written about <a href=/2015/03/26/creating-a-bridge-for-virtual-machines-using-systemd-networkd/>systemd-networkd</a> in the past and how easy it can be to set up new network devices and tunnels. However, the documentation on systemd-networkd with bonding is a bit lacking (but I have a <a href=https://github.com/systemd/systemd/pull/1001>pull request pending</a> for that).</p><p><a href=http://www.rackspace.com/en-us/cloud/servers/onmetal>Rackspace&rsquo;s OnMetal Servers</a> are a good place to test since they have bonded networks configured by default. They&rsquo;re also quite fast and always fun for experiments.</p><p>To get started, head on over to the <a href=https://mycloud.rackspace.com/>Rackspace Cloud control panel</a> and build a <em>compute-1</em> OnMetal server and choose Fedora 22 as your operating system. Once it starts pinging and you&rsquo;re able to log in, start following the guide below.</p><h2 id=network-device-naming class="relative group">Network device naming <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#network-device-naming aria-label=Anchor>#</a></span></h2><p>By default, most images come with <a href=http://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/>systemd&rsquo;s predictable network naming</a> disabled. You can see the kernel command line adjustments here:</p><pre tabindex=0><code># cat /boot/extlinux.conf
TIMEOUT 1
default linux

LABEL Fedora (4.1.5-200.fc22.x86_64) 22 (Twenty Two)
      KERNEL /boot/vmlinuz-4.1.5-200.fc22.x86_64
      APPEND root=/dev/sda1 console=ttyS4,115200n8 8250.nr_uarts=5 modprobe.blacklist=mei_me net.ifnames=0 biosdevname=0 LANG=en_US.UTF-8
      initrd /boot/initramfs-4.1.5-200.fc22.x86_64.img
</code></pre><p>This ensures that both network devices show up as <em>eth0</em> and <em>eth1</em>. Although it isn&rsquo;t my favorite way to configure a server, it does make it easier for most customers to get up an running quickly with some device names that they are familiar with from virtualized products.</p><p>We need to figure out what systemd plans to call these interfaces when we allow udev to name them predictably. The easiest method for figuring out what udev wants to call these devices is to dump the udev database and use <code>grep</code>:</p><pre tabindex=0><code># udevadm info -e | grep -A 9 ^P.*eth0
P: /devices/pci0000:00/0000:00:03.2/0000:08:00.0/net/eth0
E: DEVPATH=/devices/pci0000:00/0000:00:03.2/0000:08:00.0/net/eth0
E: ID_BUS=pci
E: ID_MODEL_FROM_DATABASE=82599ES 10-Gigabit SFI/SFP+ Network Connection (Ethernet OCP Server Adapter X520-2)
E: ID_MODEL_ID=0x10fb
E: ID_NET_DRIVER=ixgbe
E: ID_NET_LINK_FILE=/usr/lib/systemd/network/99-default.link
E: ID_NET_NAME_MAC=enxa0369f2cec90
E: ID_NET_NAME_PATH=enp8s0f0
E: ID_NET_NAME_SLOT=ens9f0
</code></pre><p>Look for those lines that contain <code>ID_NET_NAME_*</code>. Those tell us what udev prefers to call these network devices. The last name you see in the list is what the interface will be called. Here&rsquo;s what you need to look for in that output:</p><pre tabindex=0><code>E: ID_NET_NAME_MAC=enxa0369f2cec90
E: ID_NET_NAME_PATH=enp8s0f0
E: ID_NET_NAME_SLOT=ens9f0
</code></pre><p>We can see that this device is in slot 0 of PCI bus 8. However, since udev is able to dig in a bit further, it decides to name the device <em>ens9f0</em>, which means:</p><ul><li>Hotplug slot 9</li><li>Function index number 0</li></ul><p>Udev rolls through a list of possible network names and uses the very last one as the name of the network device. Gentoo&rsquo;s documentation has a <a href=https://wiki.gentoo.org/wiki/Udev/Upgrade_Guide#Example_interface_IDs>nice explanation</a>. In our case, <code>ID_NET_NAME_SLOT</code> took precedence over the others since this particular device sits in a hotplug PCI-Express slot.</p><p>We can find the slot number here:</p><pre tabindex=0><code># lspci -v -s 08:00.00 | head -n 3
08:00.0 Ethernet controller: Intel Corporation 82599ES 10-Gigabit SFI/SFP+ Network Connection (rev 01)
    Subsystem: Intel Corporation Ethernet OCP Server Adapter X520-2
    Physical Slot: 9
</code></pre><p>Although this is a bit confusing, it can be helpful in servers when parts are added, removed, or replaced. You&rsquo;ll always be assured that the same device in the same slot will never be renamed.</p><p>Our first ethernet device is called <em>ens9f0</em>, but what is the second device called?</p><pre tabindex=0><code># udevadm info -e | grep -A 9 ^P.*eth1
P: /devices/pci0000:00/0000:00:03.2/0000:08:00.1/net/eth1
E: DEVPATH=/devices/pci0000:00/0000:00:03.2/0000:08:00.1/net/eth1
E: ID_BUS=pci
E: ID_MODEL_FROM_DATABASE=82599ES 10-Gigabit SFI/SFP+ Network Connection (Ethernet OCP Server Adapter X520-2)
E: ID_MODEL_ID=0x10fb
E: ID_NET_DRIVER=ixgbe
E: ID_NET_LINK_FILE=/usr/lib/systemd/network/99-default.link
E: ID_NET_NAME_MAC=enxa0369f2cec91
E: ID_NET_NAME_PATH=enp8s0f1
E: ID_NET_NAME_SLOT=ens9f1
</code></pre><p>Now we know our ethernet devices are called <em>ens9f0</em> and <em>ens9f1</em>. It&rsquo;s time to configure systemd-networkd.</p><h2 id=bond-interface-creation class="relative group">Bond interface creation <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#bond-interface-creation aria-label=Anchor>#</a></span></h2><p>Ensure that you have a <code>/etc/systemd/network/</code> directory on your server and create the network device file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=c1># /etc/systemd/network/bond1.netdev</span>
</span></span><span class=line><span class=cl><span class=k>[NetDev]</span>
</span></span><span class=line><span class=cl><span class=na>Name</span><span class=o>=</span><span class=s>bond1</span>
</span></span><span class=line><span class=cl><span class=na>Kind</span><span class=o>=</span><span class=s>bond</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Bond]</span>
</span></span><span class=line><span class=cl><span class=na>Mode</span><span class=o>=</span><span class=s>802.3ad</span>
</span></span><span class=line><span class=cl><span class=na>TransmitHashPolicy</span><span class=o>=</span><span class=s>layer3+4</span>
</span></span><span class=line><span class=cl><span class=na>MIIMonitorSec</span><span class=o>=</span><span class=s>1s</span>
</span></span><span class=line><span class=cl><span class=na>LACPTransmitRate</span><span class=o>=</span><span class=s>fast</span>
</span></span></code></pre></div><p>We&rsquo;re telling systemd-networkd that we want a new bond interface called <em>bond1</em> configured using 802.3ad mode. (Want to geek out on 802.3ad? Check out <a href=http://www.ieee802.org/3/hssg/public/apr07/frazier_01_0407.pdf>IEEE&rsquo;s PDF</a>.) In addition, we specify a transmit hash policy, a monitoring frequency, and a requested rate for LACP updates.</p><p>Now that we have a device defined, we need to provide some network configuration:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=c1># /etc/systemd/network/bond1.network</span>
</span></span><span class=line><span class=cl><span class=k>[Match]</span>
</span></span><span class=line><span class=cl><span class=na>Name</span><span class=o>=</span><span class=s>bond1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Network]</span>
</span></span><span class=line><span class=cl><span class=na>VLAN</span><span class=o>=</span><span class=s>public</span>
</span></span><span class=line><span class=cl><span class=na>VLAN</span><span class=o>=</span><span class=s>servicenet</span>
</span></span><span class=line><span class=cl><span class=na>BindCarrier</span><span class=o>=</span><span class=s>ens9f0 ens9f1</span>
</span></span></code></pre></div><p>This tells systemd-networkd that we have an interface called <em>bond1</em> and it has two VLANs configured on it (more on that later). Also, we specify the interfaces participating in the bond. This ensures that the bond comes up and down cleanly as interfaces change state.</p><p>As one last step, we need to configure the physical interfaces themselves:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=c1># /etc/systemd/network/ens9f0.network</span>
</span></span><span class=line><span class=cl><span class=k>[Match]</span>
</span></span><span class=line><span class=cl><span class=na>Name</span><span class=o>=</span><span class=s>ens9f0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Network]</span>
</span></span><span class=line><span class=cl><span class=na>Bond</span><span class=o>=</span><span class=s>bond1</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=c1># /etc/systemd/network/ens9f1.network</span>
</span></span><span class=line><span class=cl><span class=k>[Match]</span>
</span></span><span class=line><span class=cl><span class=na>Name</span><span class=o>=</span><span class=s>ens9f1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Network]</span>
</span></span><span class=line><span class=cl><span class=na>Bond</span><span class=o>=</span><span class=s>bond1</span>
</span></span></code></pre></div><p>These files help systemd-networkd understand which interfaces are participating in the bond. You can get fancy here with your <code>[Match]</code> sections and use only one interface file with <code>ens9f*</code>, but I prefer to be more explicit. Check the documentation for systemd-networkd for that.</p><h2 id=public-network-vlan class="relative group">Public network VLAN <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#public-network-vlan aria-label=Anchor>#</a></span></h2><p>The public network for your OnMetal server is delivered via a VLAN. Packets are tagged as VLAN 101 and you need to configure your network interface to handle that traffic. We already told systemd-networkd about our VLANs within the <em>bond1.network</em> file, but now we need to explain the configuration for the public network VLAN.</p><p>Start by creating a network device file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=c1># /etc/systemd/network/public.netdev</span>
</span></span><span class=line><span class=cl><span class=k>[NetDev]</span>
</span></span><span class=line><span class=cl><span class=na>Name</span><span class=o>=</span><span class=s>public</span>
</span></span><span class=line><span class=cl><span class=na>Kind</span><span class=o>=</span><span class=s>vlan</span>
</span></span><span class=line><span class=cl><span class=na>MACAddress</span><span class=o>=</span><span class=s>xx:xx:xx:xx:xx:xx</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[VLAN]</span>
</span></span><span class=line><span class=cl><span class=na>Id</span><span class=o>=</span><span class=s>101</span>
</span></span></code></pre></div><p>You can get the correct MAC address from the information in your server&rsquo;s config drive:</p><pre tabindex=0><code>mkdir /mnt/configdrive
mount /dev/sda2 /mnt/configdrive/
python -m json.tool /mnt/configdrive/openstack/latest/vendor_data.json
</code></pre><p>Look inside the <code>network_info</code> section for <code>vlan0</code>. It will look something like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;ethernet_mac_address&#34;</span><span class=p>:</span> <span class=s2>&#34;xx:xx:xx:xx:xx:xx&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;vlan0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;vlan&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;vlan_id&#34;</span><span class=p>:</span> <span class=mi>101</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;vlan_link&#34;</span><span class=p>:</span> <span class=s2>&#34;bond0&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=err>,</span>
</span></span></code></pre></div><p>Take what you see in <em>ethernet_mac_address</em> and use that MAC address on the <code>MACAddress</code> line in your <em>public.netdev</em> file above. <strong>If you skip this part, your packets won&rsquo;t make it onto the network.</strong> For security reasons, the switch strictly checks to ensure that the right VLAN/IP/MAC combination is use when you communicate on the network.</p><p>Now that we have a network device, let&rsquo;s actually configure the network on it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=c1># /etc/systemd/network/public.network</span>
</span></span><span class=line><span class=cl><span class=k>[Match]</span>
</span></span><span class=line><span class=cl><span class=na>Name</span><span class=o>=</span><span class=s>public</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Network]</span>
</span></span><span class=line><span class=cl><span class=na>DNS</span><span class=o>=</span><span class=s>8.8.8.8</span>
</span></span><span class=line><span class=cl><span class=na>DNS</span><span class=o>=</span><span class=s>8.8.4.4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Address]</span>
</span></span><span class=line><span class=cl><span class=na>Address</span><span class=o>=</span><span class=s>xxx.xxx.xxx.xxx/24</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Route]</span>
</span></span><span class=line><span class=cl><span class=na>Destination</span><span class=o>=</span><span class=s>0.0.0.0/0</span>
</span></span><span class=line><span class=cl><span class=na>Gateway</span><span class=o>=</span><span class=s>xxx.xxx.xxx.1</span>
</span></span></code></pre></div><p>To get your IP address and gateway, you can use <code>ip addr</code> and <code>ip route</code>. Or, you can look in your config drive within the <em>networks</em> section for the same data. Ensure that your IP address and gateway are configured correctly. I&rsquo;ve used Google&rsquo;s default DNS servers here but you can use your own if you prefer.</p><h2 id=servicenet-vlan class="relative group">ServiceNet VLAN <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#servicenet-vlan aria-label=Anchor>#</a></span></h2><p>Rackspace&rsquo;s ServiceNet is the backend network that connects you to other servers as well as other Rackspace products, like Cloud Databases and Cloud Files. We will configure this network in the same fashion, starting with the network device file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=c1># /etc/systemd/network/servicenet.netdev</span>
</span></span><span class=line><span class=cl><span class=k>[NetDev]</span>
</span></span><span class=line><span class=cl><span class=na>Name</span><span class=o>=</span><span class=s>servicenet</span>
</span></span><span class=line><span class=cl><span class=na>Kind</span><span class=o>=</span><span class=s>vlan</span>
</span></span><span class=line><span class=cl><span class=na>MACAddress</span><span class=o>=</span><span class=s>xx:xx:xx:xx:xx:xx</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[VLAN]</span>
</span></span><span class=line><span class=cl><span class=na>Id</span><span class=o>=</span><span class=s>401</span>
</span></span></code></pre></div><p>As we did before, go look in your config drive for the right MAC address to use. You&rsquo;ll look in the <em>network_info</em> section again but this time you&rsquo;ll look for <em>vlan1</em></p><p>Now we&rsquo;re ready to create the network file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=c1># /etc/systemd/network/servicenet.network</span>
</span></span><span class=line><span class=cl><span class=k>[Match]</span>
</span></span><span class=line><span class=cl><span class=na>Name</span><span class=o>=</span><span class=s>servicenet</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Network]</span>
</span></span><span class=line><span class=cl><span class=na>Address</span><span class=o>=</span><span class=s>xxx.xxx.xxx.xxx/20</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Route]</span>
</span></span><span class=line><span class=cl><span class=na>Destination</span><span class=o>=</span><span class=s>10.176.0.0/12</span>
</span></span><span class=line><span class=cl><span class=na>Gateway</span><span class=o>=</span><span class=s>10.184.0.1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Route]</span>
</span></span><span class=line><span class=cl><span class=na>Destination</span><span class=o>=</span><span class=s>10.208.0.0/12</span>
</span></span><span class=line><span class=cl><span class=na>Gateway</span><span class=o>=</span><span class=s>10.184.0.1</span>
</span></span></code></pre></div><p>Review your config drive json for the correct IP address and routes. Your routes will likely be the same as mine, but that can change over time.</p><h2 id=enable-systemd-networkd class="relative group">Enable systemd-networkd <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#enable-systemd-networkd aria-label=Anchor>#</a></span></h2><p>All of our configuration files are in place, but now we need to enable systemd-networkd at boot time:</p><pre tabindex=0><code>systemctl disable network
systemctl disable NetworkManager
systemctl enable systemd-networkd
systemctl enable systemd-resolved
</code></pre><p>We also need to let systemd-resolved handle our DNS resolution:</p><pre tabindex=0><code>systemctl start systemd-resolved
rm /etc/resolv.conf
ln -s /run/systemd/resolve/resolv.conf /etc/resolv.conf
</code></pre><p>Finally, there&rsquo;s one last gotcha that is only on OnMetal that needs to be removed. Comment out the second and third line in <code>/etc/rc.d/rc.local</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/usr/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>#sleep 20</span>
</span></span><span class=line><span class=cl><span class=c1>#/etc/init.d/network restart</span>
</span></span><span class=line><span class=cl><span class=nb>exit</span> <span class=m>0</span>
</span></span></code></pre></div><p>That&rsquo;s there as a workaround for some network issues that sometimes appear during first boot. We won&rsquo;t need it with systemd-networkd.</p><h2 id=reboot class="relative group">Reboot <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#reboot aria-label=Anchor>#</a></span></h2><p>We&rsquo;re ready to test our new configuration! First, let&rsquo;s disable the forced old interface names on the kernel command line. Open <code>/boot/extlinux.conf</code> and ensure that the following two items are not in the kernel command line:</p><ul><li><code>net.ifnames=0</code></li><li><code>biosdevname=0</code></li></ul><p>Remove them from any kernel command lines you see and save the file. Reboot and cross your fingers.</p><h2 id=checking-our-work class="relative group">Checking our work <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#checking-our-work aria-label=Anchor>#</a></span></h2><p>If you get pings after a reboot, you did well! If you didn&rsquo;t. you can use OnMetal&rsquo;s rescue mode to hop into a temporary OS and mount your root volume. Be sure to look inside <code>/var/log/messages</code> for signs of typos or other errors.</p><p>We can use some simple tools to review our network status:</p><pre tabindex=0><code># networkctl
IDX LINK             TYPE               OPERATIONAL SETUP
  1 lo               loopback           carrier     unmanaged
  2 bond0            ether              off         unmanaged
  3 bond1            ether              degraded    configured
  4 public           ether              routable    configured
  5 servicenet       ether              routable    configured
  6 ens9f0           ether              carrier     configured
  7 ens9f1           ether              carrier     configured
</code></pre><p>Don&rsquo;t be afraid of the <em>degraded</em> status for <em>bond1</em>. That&rsquo;s there because systemd doesn&rsquo;t have networking configuration for the interface since we do that with our VLANs. Also, both physical network interfaces are listed as <em>carrier</em> because they don&rsquo;t have network configuration, either. They&rsquo;re just participating in the bond.</p><p>Feel free to ignore <em>bond0</em>, too. The bonding module in the Linux kernel automatically creates the interface when it&rsquo;s loaded.</p><h2 id=extra-credit-switch-to-grub2 class="relative group">Extra credit: Switch to grub2 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#extra-credit-switch-to-grub2 aria-label=Anchor>#</a></span></h2><p>Sure, extlinux is fine for most use cases, but I prefer something a little more powerful. Luckily, switching to grub2 is quite painless:</p><pre tabindex=0><code>dnf -y remove syslinux-extlinux
rm -f /boot/extlinux.conf
dnf -y install grubby grub2
grub2-mkconfig -o /boot/grub2/grub.cfg
grub2-install /dev/sda
</code></pre><p>Simply reboot and you&rsquo;ll be booting with grub2!</p></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group" href=/2015/08/14/research-paper-securing-linux-containers/><span class="mr-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Research Paper: Securing Linux Containers</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2015-08-14 20:45:50 +0000 UTC">14 August 2015</time></span></span></a></span>
<span><a class="flex text-right group" href=/2015/08/21/understanding-systemds-predictable-network-device-names/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Understanding systemdâ€™s predictable network device names</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2015-08-21 21:15:36 +0000 UTC">21 August 2015</time></span></span>
<span class="ml-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div class="absolute top-[100vh] ltr:right-0 rtl:left-0 w-12 pointer-events-none bottom-0"><a href=#the-top class="w-12 h-12 sticky pointer-events-auto top-[calc(100vh-5.5rem)] bg-neutral/50 dark:bg-neutral-800/50 backdrop-blur rounded-full text-xl flex items-center justify-center text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">All content licensed <a href=https://creativecommons.org/licenses/by-sa/4.0/>CC-BY-SA</a></p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://git.io/hugo-congo target=_blank rel="noopener noreferrer">Congo</a></p></div></div></footer><div id=search-wrapper class="fixed inset-0 z-50 flex flex-col p-4 sm:p-6 md:p-[10vh] lg:p-[12vh] w-screen h-screen cursor-default bg-neutral-500/50 backdrop-blur-sm dark:bg-neutral-900/50 invisible" data-url=https://major.io/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg border-neutral-200 top-20 bg-neutral dark:bg-neutral-800 dark:border-neutral-700"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-transparent focus:outline-2" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>