<!doctype html><html lang=en-us><head><meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://major.io/favicon.ico><title>GRE tunnels with systemd-networkd | Major Hayden's Blog ðŸ¤ </title><meta name=title content="GRE tunnels with systemd-networkd"><meta name=description content="Switching to systemd-networkd for managing your networking interfaces makes things quite a bit simpler over standard networking scripts or NetworkManager. Aside from being easier to configure, it uses fewer resources on your system, which can be handy for smaller virtual machines or containers.
Managing tunnels between interfaces is also easier with systemd-networkd. This post will show you how to set up a GRE tunnel between two hosts running systemd-networkd.
Getting started You&rsquo;ll need two hosts running a recent version of systemd-networkd."><meta name=keywords content="command line,fedora,firewalld,kernel,networking,systemd,systemd-networkd,"><meta property="og:title" content="GRE tunnels with systemd-networkd"><meta property="og:description" content="Switching to systemd-networkd for managing your networking interfaces makes things quite a bit simpler over standard networking scripts or NetworkManager. Aside from being easier to configure, it uses fewer resources on your system, which can be handy for smaller virtual machines or containers.
Managing tunnels between interfaces is also easier with systemd-networkd. This post will show you how to set up a GRE tunnel between two hosts running systemd-networkd.
Getting started You&rsquo;ll need two hosts running a recent version of systemd-networkd."><meta property="og:type" content="article"><meta property="og:url" content="https://major.io/2015/10/16/gre-tunnels-with-systemd-networkd/"><meta property="og:image" content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-10-16T23:54:52+00:00"><meta property="article:modified_time" content="2015-10-16T23:54:52+00:00"><meta property="og:site_name" content="Major Hayden's Blog ðŸ¤ "><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta name=twitter:title content="GRE tunnels with systemd-networkd"><meta name=twitter:description content="Switching to systemd-networkd for managing your networking interfaces makes things quite a bit simpler over standard networking scripts or NetworkManager. Aside from being easier to configure, it uses fewer resources on your system, which can be handy for smaller virtual machines or containers.
Managing tunnels between interfaces is also easier with systemd-networkd. This post will show you how to set up a GRE tunnel between two hosts running systemd-networkd.
Getting started You&rsquo;ll need two hosts running a recent version of systemd-networkd."><meta name=twitter:site content="@mhayden"><meta itemprop=name content="GRE tunnels with systemd-networkd"><meta itemprop=description content="Switching to systemd-networkd for managing your networking interfaces makes things quite a bit simpler over standard networking scripts or NetworkManager. Aside from being easier to configure, it uses fewer resources on your system, which can be handy for smaller virtual machines or containers.
Managing tunnels between interfaces is also easier with systemd-networkd. This post will show you how to set up a GRE tunnel between two hosts running systemd-networkd.
Getting started You&rsquo;ll need two hosts running a recent version of systemd-networkd."><meta itemprop=datePublished content="2015-10-16T23:54:52+00:00"><meta itemprop=dateModified content="2015-10-16T23:54:52+00:00"><meta itemprop=wordCount content="868"><meta itemprop=image content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta itemprop=keywords content="command line,fedora,firewalld,kernel,networking,systemd,systemd-networkd,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:820px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px}div.highlight code{background-color:unset;color:initial}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style></head><body><header><a href=../../../../ class=title><h2>Major Hayden's Blog ðŸ¤ </h2></a><nav><a href=../../../../>Home</a>
<a href=../../../../ham-radio-faq>Ham Radio</a>
<a href=../../../../icanhazip-com-faq>icanhazip FAQ</a>
<a href=../../../../posts>Posts</a></nav><script async src=https://media.ethicalads.io/media/client/ethicalads.min.js></script><div class="adaptive raised" data-ea-publisher=major-io data-ea-type=text></div></header><main><h1>GRE tunnels with systemd-networkd</h1><i><time datetime=2015-10-16 pubdate>2015-10-16</time></i>
<content><p>Switching to <a href=http://www.freedesktop.org/software/systemd/man/systemd-networkd.service.html>systemd-networkd</a> for managing your networking interfaces makes things quite a bit simpler over standard networking scripts or NetworkManager. Aside from being easier to configure, it uses fewer resources on your system, which can be handy for smaller virtual machines or containers.</p><p>Managing tunnels between interfaces is also easier with systemd-networkd. This post will show you how to set up a <a href=https://en.wikipedia.org/wiki/Generic_Routing_Encapsulation>GRE tunnel</a> between two hosts running systemd-networkd.</p><h2 id=getting-started>Getting started</h2><p>You&rsquo;ll need two hosts running a recent version of systemd-networkd. I&rsquo;d recommend Fedora 22 since it provides very recent versions of systemd which include enhancements to systemd-networkd.</p><p>For this example, I&rsquo;ve built one Rackspace Cloud Server in the DFW datacenter and another in IAD. I&rsquo;ll connect them both together with a simple GRE tunnel.</p><h2 id=switch-to-systemd-networkd>Switch to systemd-networkd</h2><p>I&rsquo;ve <a href=../../../../2015/08/27/build-a-network-router-and-firewall-with-fedora-22-and-systemd-networkd/>detailed out this process before</a> but I&rsquo;ll do it again here. First off, we will need a directory made on both servers to hold systemd-networkd configuration files:</p><pre><code>mkdir /etc/systemd/network
</code></pre><p>Let&rsquo;s add a very simple network configuration for our <code>eth0</code> interface on both hosts:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#93a1a1;font-style:italic># cat /etc/systemd/network/eth0.network</span>
<span style=color:#859900>[Match]</span>
<span style=color:#268bd2>Name</span>=<span style=color:#2aa198>eth0</span>

<span style=color:#859900>[Network]</span>
<span style=color:#268bd2>Address</span>=<span style=color:#2aa198>x.x.x.x/24</span>
<span style=color:#268bd2>Gateway</span>=<span style=color:#2aa198>x.x.x.x</span>
<span style=color:#268bd2>DNS</span>=<span style=color:#2aa198>8.8.8.8</span>
<span style=color:#268bd2>DNS</span>=<span style=color:#2aa198>8.8.4.4</span>
</code></pre></div><p>Do this on <strong>both servers</strong> and be sure to fill in the <code>Address</code> and <code>Gateway</code> lines with the correct data for your servers. Also, feel free to use something other than Google&rsquo;s DNS servers if needed.</p><p>It&rsquo;s time to get our services in order so that systemd-networkd will handle our networking after a reboot:</p><pre><code>systemctl disable network
systemctl disable NetworkManager
systemctl enable systemd-networkd
systemctl enable systemd-resolved
systemctl start systemd-resolved
rm -f /etc/resolv.conf
ln -s /run/systemd/resolve/resolv.conf /etc/resolv.conf
</code></pre><p><strong>Don&rsquo;t start systemd-networkd yet.</strong> Having systemd-networkd and NetworkManager fight over your interfaces can lead to a bad day.</p><p>Reboot both hosts and wait for them to come back online.</p><h2 id=configure-the-gre-tunnel>Configure the GRE tunnel</h2><p>A GRE tunnel is a simple way to encapsulate packets between two hosts and send almost any protocol across the tunnel you build. However, it&rsquo;s not encrypted. (If you&rsquo;re planning to use this long-term, consider only using encrypted streams across the link or add IPSec on top of the GRE tunnel.)</p><p>If we want to route traffic over the GRE tunnel, we will need IP addresses on both sides. I&rsquo;ll use 192.168.254.0/24 for this example, but you&rsquo;re free to use any subnet of any size (except /32!) for this network.</p><p>We need to tell systemd-networkd about a new network device that it doesn&rsquo;t know about. We do this with <code>.netdev</code> files. Create this file on both hosts:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#93a1a1;font-style:italic># cat /etc/systemd/network/gre-example.netdev</span>
<span style=color:#859900>[NetDev]</span>
<span style=color:#268bd2>Name</span>=<span style=color:#2aa198>gre-example</span>
<span style=color:#268bd2>Kind</span>=<span style=color:#2aa198>gre</span>
<span style=color:#268bd2>MTUBytes</span>=<span style=color:#2aa198>1480</span>

<span style=color:#859900>[Tunnel]</span>
<span style=color:#268bd2>Remote</span>=<span style=color:#2aa198>[public ip of remote server]</span>
<span style=color:#268bd2>Local</span>=<span style=color:#2aa198>[public ip of local server]</span>
</code></pre></div><p>We&rsquo;re making a new network device called <code>gre-example</code> here and we&rsquo;re telling systemd-networkd about the servers participating in the link. Add this configuration file to <strong>both hosts</strong> but be sure that your <code>Remote=</code> line is correct. If you&rsquo;re writing the configuration file for the <strong>first</strong> host, then the <code>Remote=</code> line should have the IP address of your <strong>second</strong> host. Do the same thing on the second host, but use the IP address of your first host there.</p><p>Now that we have a network device, we need to tell systemd-networkd how to configure the IP address on these new GRE tunnels. Let&rsquo;s make a <code>.network</code> file for our GRE tunnel.</p><p>On the first host:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#93a1a1;font-style:italic># cat /etc/systemd/network/gre-example.network</span>
<span style=color:#859900>[Match]</span>
<span style=color:#268bd2>Name</span>=<span style=color:#2aa198>gre-example</span>

<span style=color:#859900>[Network]</span>
<span style=color:#268bd2>Address</span>=<span style=color:#2aa198>192.168.254.1/24</span>
</code></pre></div><p>On the second host:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#93a1a1;font-style:italic># cat /etc/systemd/network/gre-example.network</span>
<span style=color:#859900>[Match]</span>
<span style=color:#268bd2>Name</span>=<span style=color:#2aa198>gre-example</span>

<span style=color:#859900>[Network]</span>
<span style=color:#268bd2>Address</span>=<span style=color:#2aa198>192.168.254.2/24</span>
</code></pre></div><h2 id=bringing-up-the-tunnel>Bringing up the tunnel</h2><p>Although systemd-networkd knows we have a tunnel configured now, it&rsquo;s not sure which interface should manage the tunnel. In our case, our public interface (<code>eth0</code>) is required to be up for this tunnel to function. Go back to your original <code>eth0.network</code> files and add one line under the <code>[Network]</code> section for our tunnel:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#859900>[Network]</span>
<span style=color:#268bd2>Tunnel</span>=<span style=color:#2aa198>gre-example</span>
</code></pre></div><p>Restart systemd-networkd on <strong>both hosts</strong> and check the network interfaces:</p><pre><code># systemctl restart systemd-networkd
# networkctl
IDX LINK             TYPE               OPERATIONAL SETUP
  1 lo               loopback           carrier     unmanaged
  2 eth0             ether              routable    configured
  3 eth1             ether              off         unmanaged
  4 gre0             ipgre              off         unmanaged
  5 gretap0          ether              off         unmanaged
  6 gre-example      ipgre              routable    configured

6 links listed.
</code></pre><p>Hooray! Our GRE tunnel is up! However, we have a firewall in the way.</p><h2 id=fixing-the-firewall>Fixing the firewall</h2><p>We need to tell the firewall two things: trust the GRE interface and trust the public IP of the other server. Trusting the GRE interface is easy with firewalld â€” just add this on both hosts:</p><pre><code>firewall-cmd --add-interface=gre-example --zone=trusted
</code></pre><p>Now, we need a rich rule to tell firewalld to trust the public IP of each host. I talked about this <a href=../../../../2014/11/24/trust-ip-address-firewallds-rich-rules/>last year</a> on the blog. Run this command on both hosts:</p><pre><code>firewall-cmd --zone=public --add-rich-rule='rule family=&quot;ipv4&quot; source address=&quot;[IP ADDRESS]&quot; accept'
</code></pre><p>If you run this on your first host, use the public IP address of your second host in the <code>firewall-cmd</code> command. Use the first host&rsquo;s public IP address when you run the command on the second host.</p><p>Save your configuration permanently on <strong>both hosts</strong>:</p><pre><code>firewall-cmd --runtime-to-permanent
</code></pre><p>Try to ping between your servers using the IP addresses we configured on the GRE tunnel and you should get some replies!</p><h2 id=final-words>Final words</h2><p>Remember that GRE tunnels <strong>are not encrypted</strong>. You can add IPSec over the tunnel or you can ensure that you use encrypted streams across the tunnel at all times (SSL, ssh, etc).</p></content><p><a href=https://major.io/tags/command-line/>#command line</a>
<a href=https://major.io/tags/fedora/>#fedora</a>
<a href=https://major.io/tags/firewalld/>#firewalld</a>
<a href=https://major.io/tags/kernel/>#kernel</a>
<a href=https://major.io/tags/networking/>#networking</a>
<a href=https://major.io/tags/systemd/>#systemd</a>
<a href=https://major.io/tags/systemd-networkd/>#systemd-networkd</a></p></main><footer><hr>CC-BY-SA 4.0 &#187;
Made with <a href=https://gohugo.io/>Hugo</a> &#187;
Theme based on <a href=https://github.com/janraasch/hugo-bearblog/>Hugo Ê•â€¢á´¥â€¢Ê” Bear</a><br></footer></body></html>