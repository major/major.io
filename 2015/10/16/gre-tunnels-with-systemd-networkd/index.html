<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Major Hayden"><meta name=description content="Switching to systemd-networkd for managing your networking interfaces makes things quite a bit simpler over standard networking scripts or NetworkManager. Aside from being easier to configure, it uses fewer resources on your system, which can be handy for smaller virtual machines or containers.
Managing tunnels between interfaces is also easier with systemd-networkd. This post will show you how to set up a GRE tunnel between two hosts running systemd-networkd.
Getting started You&amp;rsquo;ll need two hosts running a recent version of systemd-networkd."><meta name=keywords content=",command line,fedora,firewalld,kernel,networking,systemd,systemd-networkd"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://major.io/2015/10/16/gre-tunnels-with-systemd-networkd/><title>GRE tunnels with systemd-networkd :: Major Hayden ðŸ¤  â€” Words of wisdom from a social nerd</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=../../../../main.min.5dcefbf8102eb536dd3e2de53ffebfa58599ab2435c241a0db81728a5e015f2e.css><link rel=apple-touch-icon sizes=180x180 href=../../../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../../favicon-16x16.png><link rel=manifest href=../../../../site.webmanifest><link rel=mask-icon href=../../../../safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=../../../../favicon.ico><meta name=msapplication-TileColor content="#252627"><meta name=theme-color content="#252627"><meta itemprop=name content="GRE tunnels with systemd-networkd"><meta itemprop=description content="Switching to systemd-networkd for managing your networking interfaces makes things quite a bit simpler over standard networking scripts or NetworkManager. Aside from being easier to configure, it uses fewer resources on your system, which can be handy for smaller virtual machines or containers.
Managing tunnels between interfaces is also easier with systemd-networkd. This post will show you how to set up a GRE tunnel between two hosts running systemd-networkd.
Getting started You&rsquo;ll need two hosts running a recent version of systemd-networkd."><meta itemprop=datePublished content="2015-10-16T23:54:52+00:00"><meta itemprop=dateModified content="2015-10-16T23:54:52+00:00"><meta itemprop=wordCount content="863"><meta itemprop=image content="https://major.io"><meta itemprop=keywords content="command line,fedora,firewalld,kernel,networking,systemd,systemd-networkd,"><meta property="article:section" content="Blog Posts"><meta property="article:published_time" content="2015-10-16 23:54:52 +0000 UTC"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="GRE tunnels with systemd-networkd :: Major Hayden ðŸ¤ "><meta name=twitter:description content><meta name=twitter:site content="https://major.io"><meta name=twitter:creator content="Major Hayden"><meta name=twitter:image content><style type=text/css>html{letter-spacing:unset}</style></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=../../../../ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ echo major.io</span>
<span class=logo__cursor style=visibility:hidden></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://major.io/ham-radio-faq>hamradio</a></li><li><a href=https://major.io/icanhazip-com-faq>icanhazip</a></li><li><a href=https://major.io/posts/>posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://major.io/2015/10/16/gre-tunnels-with-systemd-networkd/>GRE tunnels with systemd-networkd</a></h2><div class=post-content><p>Switching to <a href=http://www.freedesktop.org/software/systemd/man/systemd-networkd.service.html>systemd-networkd</a> for managing your networking interfaces makes things quite a bit simpler over standard networking scripts or NetworkManager. Aside from being easier to configure, it uses fewer resources on your system, which can be handy for smaller virtual machines or containers.</p><p>Managing tunnels between interfaces is also easier with systemd-networkd. This post will show you how to set up a <a href=https://en.wikipedia.org/wiki/Generic_Routing_Encapsulation>GRE tunnel</a> between two hosts running systemd-networkd.</p><h2 id=getting-started>Getting started</h2><p>You&rsquo;ll need two hosts running a recent version of systemd-networkd. I&rsquo;d recommend Fedora 22 since it provides very recent versions of systemd which include enhancements to systemd-networkd.</p><p>For this example, I&rsquo;ve built one Rackspace Cloud Server in the DFW datacenter and another in IAD. I&rsquo;ll connect them both together with a simple GRE tunnel.</p><h2 id=switch-to-systemd-networkd>Switch to systemd-networkd</h2><p>I&rsquo;ve <a href=../../../../2015/08/27/build-a-network-router-and-firewall-with-fedora-22-and-systemd-networkd/>detailed out this process before</a> but I&rsquo;ll do it again here. First off, we will need a directory made on both servers to hold systemd-networkd configuration files:</p><pre><code>mkdir /etc/systemd/network
</code></pre><p>Let&rsquo;s add a very simple network configuration for our <code>eth0</code> interface on both hosts:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#586e75># cat /etc/systemd/network/eth0.network</span>
<span style=color:#719e07>[Match]</span>
Name<span style=color:#719e07>=</span><span style=color:#2aa198>eth0</span>

<span style=color:#719e07>[Network]</span>
Address<span style=color:#719e07>=</span><span style=color:#2aa198>x.x.x.x/24</span>
Gateway<span style=color:#719e07>=</span><span style=color:#2aa198>x.x.x.x</span>
DNS<span style=color:#719e07>=</span><span style=color:#2aa198>8.8.8.8</span>
DNS<span style=color:#719e07>=</span><span style=color:#2aa198>8.8.4.4</span>
</code></pre></div><p>Do this on <strong>both servers</strong> and be sure to fill in the <code>Address</code> and <code>Gateway</code> lines with the correct data for your servers. Also, feel free to use something other than Google&rsquo;s DNS servers if needed.</p><p>It&rsquo;s time to get our services in order so that systemd-networkd will handle our networking after a reboot:</p><pre><code>systemctl disable network
systemctl disable NetworkManager
systemctl enable systemd-networkd
systemctl enable systemd-resolved
systemctl start systemd-resolved
rm -f /etc/resolv.conf
ln -s /run/systemd/resolve/resolv.conf /etc/resolv.conf
</code></pre><p><strong>Don&rsquo;t start systemd-networkd yet.</strong> Having systemd-networkd and NetworkManager fight over your interfaces can lead to a bad day.</p><p>Reboot both hosts and wait for them to come back online.</p><h2 id=configure-the-gre-tunnel>Configure the GRE tunnel</h2><p>A GRE tunnel is a simple way to encapsulate packets between two hosts and send almost any protocol across the tunnel you build. However, it&rsquo;s not encrypted. (If you&rsquo;re planning to use this long-term, consider only using encrypted streams across the link or add IPSec on top of the GRE tunnel.)</p><p>If we want to route traffic over the GRE tunnel, we will need IP addresses on both sides. I&rsquo;ll use 192.168.254.0/24 for this example, but you&rsquo;re free to use any subnet of any size (except /32!) for this network.</p><p>We need to tell systemd-networkd about a new network device that it doesn&rsquo;t know about. We do this with <code>.netdev</code> files. Create this file on both hosts:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#586e75># cat /etc/systemd/network/gre-example.netdev</span>
<span style=color:#719e07>[NetDev]</span>
Name<span style=color:#719e07>=</span><span style=color:#2aa198>gre-example</span>
Kind<span style=color:#719e07>=</span><span style=color:#2aa198>gre</span>
MTUBytes<span style=color:#719e07>=</span><span style=color:#2aa198>1480</span>

<span style=color:#719e07>[Tunnel]</span>
Remote<span style=color:#719e07>=</span><span style=color:#2aa198>[public ip of remote server]</span>
</code></pre></div><p>We&rsquo;re making a new network device called <code>gre-example</code> here and we&rsquo;re telling systemd-networkd about the servers participating in the link. Add this configuration file to <strong>both hosts</strong> but be sure that your <code>Remote=</code> line is correct. If you&rsquo;re writing the configuration file for the <strong>first</strong> host, then the <code>Remote=</code> line should have the IP address of your <strong>second</strong> host. Do the same thing on the second host, but use the IP address of your first host there.</p><p>Now that we have a network device, we need to tell systemd-networkd how to configure the IP address on these new GRE tunnels. Let&rsquo;s make a <code>.network</code> file for our GRE tunnel.</p><p>On the first host:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#586e75># cat /etc/systemd/network/gre-example.network</span>
<span style=color:#719e07>[Match]</span>
Name<span style=color:#719e07>=</span><span style=color:#2aa198>gre-example</span>

<span style=color:#719e07>[Network]</span>
Address<span style=color:#719e07>=</span><span style=color:#2aa198>192.168.254.1/24</span>
</code></pre></div><p>On the second host:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#586e75># cat /etc/systemd/network/gre-example.network</span>
<span style=color:#719e07>[Match]</span>
Name<span style=color:#719e07>=</span><span style=color:#2aa198>gre-example</span>

<span style=color:#719e07>[Network]</span>
Address<span style=color:#719e07>=</span><span style=color:#2aa198>192.168.254.2/24</span>
</code></pre></div><h2 id=bringing-up-the-tunnel>Bringing up the tunnel</h2><p>Although systemd-networkd knows we have a tunnel configured now, it&rsquo;s not sure which interface should manage the tunnel. In our case, our public interface (<code>eth0</code>) is required to be up for this tunnel to function. Go back to your original <code>eth0.network</code> files and add one line under the <code>[Network]</code> section for our tunnel:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#719e07>[Network]</span>
Tunnel<span style=color:#719e07>=</span><span style=color:#2aa198>gre-example</span>
</code></pre></div><p>Restart systemd-networkd on <strong>both hosts</strong> and check the network interfaces:</p><pre><code># systemctl restart systemd-networkd
# networkctl
IDX LINK             TYPE               OPERATIONAL SETUP
  1 lo               loopback           carrier     unmanaged
  2 eth0             ether              routable    configured
  3 eth1             ether              off         unmanaged
  4 gre0             ipgre              off         unmanaged
  5 gretap0          ether              off         unmanaged
  6 gre-example      ipgre              routable    configured

6 links listed.
</code></pre><p>Hooray! Our GRE tunnel is up! However, we have a firewall in the way.</p><h2 id=fixing-the-firewall>Fixing the firewall</h2><p>We need to tell the firewall two things: trust the GRE interface and trust the public IP of the other server. Trusting the GRE interface is easy with firewalld â€” just add this on both hosts:</p><pre><code>firewall-cmd --add-interface=gre-example --zone=trusted
</code></pre><p>Now, we need a rich rule to tell firewalld to trust the public IP of each host. I talked about this <a href=../../../../2014/11/24/trust-ip-address-firewallds-rich-rules/>last year</a> on the blog. Run this command on both hosts:</p><pre><code>firewall-cmd --zone=public --add-rich-rule='rule family=&quot;ipv4&quot; source address=&quot;[IP ADDRESS]&quot; accept'
</code></pre><p>If you run this on your first host, use the public IP address of your second host in the <code>firewall-cmd</code> command. Use the first host&rsquo;s public IP address when you run the command on the second host.</p><p>Save your configuration permanently on <strong>both hosts</strong>:</p><pre><code>firewall-cmd --runtime-to-permanent
</code></pre><p>Try to ping between your servers using the IP addresses we configured on the GRE tunnel and you should get some replies!</p><h2 id=final-words>Final words</h2><p>Remember that GRE tunnels <strong>are not encrypted</strong>. You can add IPSec over the tunnel or you can ensure that you use encrypted streams across the tunnel at all times (SSL, ssh, etc).</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://major.io/tags/command-line>command line</a></span><span class=tag><a href=https://major.io/tags/fedora>fedora</a></span><span class=tag><a href=https://major.io/tags/firewalld>firewalld</a></span><span class=tag><a href=https://major.io/tags/kernel>kernel</a></span><span class=tag><a href=https://major.io/tags/networking>networking</a></span><span class=tag><a href=https://major.io/tags/systemd>systemd</a></span><span class=tag><a href=https://major.io/tags/systemd-networkd>systemd-networkd</a></span></p></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span><a href=https://major.io>Major Hayden</a></span>
<span><a href=https://creativecommons.org/licenses/by-sa/2.0/ target=_blank rel=noopener>CC BY-SA 2.0</a></span>
<span><a href=https://major.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>rhazdon</a></span></div></div></footer></div><script type=text/javascript src=../../../../bundle.min.2d5469329143160ae2456a69c3c76dc2d0a3b212b46afe291a51bd68650ed6f8697e001dab54f1c272c77ce08092a8c55e5bb4314e0ee334aab4b927ec896638.js integrity="sha512-LVRpMpFDFgriRWppw8dtwtCjshK0av4pGlG9aGUO1vhpfgAdq1TxwnLHfOCAkqjFXlu0MU4O4zSqtLkn7IlmOA=="></script></body></html>