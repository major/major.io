<!doctype html><html lang=en-us><head><meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://major.io/favicon.ico><title>systemd-networkd and macvlan interfaces | Major Hayden's Blog ðŸ¤ </title><meta name=title content="systemd-networkd and macvlan interfaces"><meta name=description content="I spent some time working with macvlan interfaces on KVM hypervisors last weekend. They&rsquo;re interesting because they&rsquo;re not really a bridge. It allows you to assign multiple MAC addresses to a single interface and then allow the kernel to filter traffic into tap interfaces based on the MAC address in the packet. If you&rsquo;re looking for a highly detailed explanation, head on over to waldner&rsquo;s blog for a deep dive into the technology and the changes that come along with it."><meta name=keywords content="fedora,kvm,macvlan,networking,security,virtualization,"><meta property="og:title" content="systemd-networkd and macvlan interfaces"><meta property="og:description" content="I spent some time working with macvlan interfaces on KVM hypervisors last weekend. They&rsquo;re interesting because they&rsquo;re not really a bridge. It allows you to assign multiple MAC addresses to a single interface and then allow the kernel to filter traffic into tap interfaces based on the MAC address in the packet. If you&rsquo;re looking for a highly detailed explanation, head on over to waldner&rsquo;s blog for a deep dive into the technology and the changes that come along with it."><meta property="og:type" content="article"><meta property="og:url" content="https://major.io/2015/10/26/systemd-networkd-and-macvlan-interfaces/"><meta property="og:image" content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-10-26T13:50:36+00:00"><meta property="article:modified_time" content="2020-02-12T16:36:14-06:00"><meta property="og:site_name" content="Major Hayden's Blog ðŸ¤ "><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta name=twitter:title content="systemd-networkd and macvlan interfaces"><meta name=twitter:description content="I spent some time working with macvlan interfaces on KVM hypervisors last weekend. They&rsquo;re interesting because they&rsquo;re not really a bridge. It allows you to assign multiple MAC addresses to a single interface and then allow the kernel to filter traffic into tap interfaces based on the MAC address in the packet. If you&rsquo;re looking for a highly detailed explanation, head on over to waldner&rsquo;s blog for a deep dive into the technology and the changes that come along with it."><meta name=twitter:site content="@mhayden"><meta itemprop=name content="systemd-networkd and macvlan interfaces"><meta itemprop=description content="I spent some time working with macvlan interfaces on KVM hypervisors last weekend. They&rsquo;re interesting because they&rsquo;re not really a bridge. It allows you to assign multiple MAC addresses to a single interface and then allow the kernel to filter traffic into tap interfaces based on the MAC address in the packet. If you&rsquo;re looking for a highly detailed explanation, head on over to waldner&rsquo;s blog for a deep dive into the technology and the changes that come along with it."><meta itemprop=datePublished content="2015-10-26T13:50:36+00:00"><meta itemprop=dateModified content="2020-02-12T16:36:14-06:00"><meta itemprop=wordCount content="562"><meta itemprop=image content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta itemprop=keywords content="fedora,kvm,macvlan,networking,security,virtualization,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:820px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px}div.highlight code{background-color:unset;color:initial}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style></head><body><header><a href=../../../../ class=title><h2>Major Hayden's Blog ðŸ¤ </h2></a><nav><a href=../../../../>Home</a>
<a href=../../../../ham-radio-faq>Ham Radio</a>
<a href=../../../../icanhazip-com-faq>icanhazip FAQ</a>
<a href=../../../../posts>Posts</a></nav><script async src=https://media.ethicalads.io/media/client/ethicalads.min.js></script><div class="adaptive raised" data-ea-publisher=major-io data-ea-type=text></div></header><main><h1>systemd-networkd and macvlan interfaces</h1><i><time datetime=2015-10-26 pubdate>2015-10-26</time></i>
<content><p>I spent some time working with <a href=http://virt.kernelnewbies.org/MacVTap>macvlan</a> interfaces on KVM hypervisors last weekend. They&rsquo;re interesting because they&rsquo;re not really a <em>bridge</em>. It allows you to assign multiple MAC addresses to a single interface and then allow the kernel to filter traffic into tap interfaces based on the MAC address in the packet. If you&rsquo;re looking for a highly detailed explanation, head on over to <a href=http://backreference.org/2014/03/20/some-notes-on-macvlanmacvtap/>waldner&rsquo;s blog</a> for a deep dive into the technology and the changes that come along with it.</p><h2 id=why-macvlan>Why macvlan?</h2><p>Bridging can become a pain to work with, especially when you&rsquo;re forced to add in creative filtering rules and keep them updated. The macvlan interfaces can help with that (read up on <a href=http://backreference.org/2014/03/20/some-notes-on-macvlanmacvtap/>VEPA</a> mode). There are some <a href=http://www.spinics.net/lists/netdev/msg103457.html>interesting email threads</a> showing that macvlan interfaces can improve network performance for various workloads. Low latency workloads can benefit from the simplicity and low overhead of macvlan interfaces.</p><h2 id=systemd-networkd-and-macvlan-interfaces>systemd-networkd and macvlan interfaces</h2><p>Fortunately for us, systemd-networkd makes configuring a macvlan interface <strong>really</strong> easy. I&rsquo;ve written about <a href=https://major.io/2015/03/26/creating-a-bridge-for-virtual-machines-using-systemd-networkd/>configuring bridges with systemd-networkd</a> and the process for macvlan interfaces is similar.</p><p>In my scenario, I have a 1U server with an ethernet interface called <code>enp4s0</code> (read up on <a href=https://major.io/2015/08/21/understanding-systemds-predictable-network-device-names/>interface naming with systemd-udevd</a>). I want to make a macvlan interface for virtual machines and I&rsquo;ll be attaching VM&rsquo;s to that interface via macvtap interfaces. It&rsquo;s similar to bridging where you make a bridge and then give everyone a port on the bridge.</p><p>Start by creating a network device for our macvlan interface:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#93a1a1;font-style:italic># /etc/systemd/network/vmbridge.netdev</span>
<span style=color:#859900>[NetDev]</span>
<span style=color:#268bd2>Name</span>=<span style=color:#2aa198>vmbridge</span>
<span style=color:#268bd2>Kind</span>=<span style=color:#2aa198>macvlan</span>

<span style=color:#859900>[MACVLAN]</span>
<span style=color:#268bd2>Mode</span>=<span style=color:#2aa198>bridge</span>
</code></pre></div><p>I&rsquo;ve told systemd-networkd that I want a macvlan interface set up in bridge mode. This will allow hosts and virtual machines to talk to one another on the interface. You could choose <code>vepa</code> for the mode if you want additional security. However, this will force traffic out to your upstream switch/router and makes it challenging for hosts and guests to communicate with each other.</p><p>Now that we have a device configured, let&rsquo;s configure the IP address for the macvlan interface (similar to configuring a bridge):</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#93a1a1;font-style:italic># /etc/systemd/network/vmbridge.network</span>
<span style=color:#859900>[Match]</span>
<span style=color:#268bd2>Name</span>=<span style=color:#2aa198>vmbridge</span>

<span style=color:#859900>[Network]</span>
<span style=color:#268bd2>IPForward</span>=<span style=color:#2aa198>yes</span>
<span style=color:#268bd2>Address</span>=<span style=color:#2aa198>192.168.250.33/24</span>
<span style=color:#268bd2>Gateway</span>=<span style=color:#2aa198>192.168.250.1</span>
<span style=color:#268bd2>DNS</span>=<span style=color:#2aa198>192.168.250.1</span>
</code></pre></div><p>Let&rsquo;s tell systemd-networkd that our physical network interface, <code>enp4s0</code>, is part of this interface:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#93a1a1;font-style:italic># /etc/systemd/network/enp4s0.network</span>
<span style=color:#859900>[Match]</span>
<span style=color:#268bd2>Name</span>=<span style=color:#2aa198>enp4s0</span>

<span style=color:#859900>[Network]</span>
<span style=color:#268bd2>MACVLAN</span>=<span style=color:#2aa198>vmbridge</span>
</code></pre></div><p>This is very similar to a configuration for a standard Linux bridge. Once you&rsquo;ve reached this step, you&rsquo;ll most likely want to reboot to ensure all of your network devices come up properly.</p><h2 id=attaching-a-virtual-machine>Attaching a virtual machine</h2><p>Attaching a KVM virtual machine to the macvlan interface is quite easy. When you&rsquo;re creating a new VM using <code>virt-manager</code>, look for this setting in the wizard:</p><p><img src=../../../../wp-content/uploads/2015/10/Selection_036.png alt=6></p><p>If you&rsquo;re installing via <code>virt-install</code> just use the following argument for your network configuration:</p><pre><code>--network type=direct,source=vmbridge,source_mode=bridge
</code></pre><p>You&rsquo;ll end up with interfaces like these after creating multiple virtual machines:</p><pre><code> mtu 1500 qdisc fq_codel state UNKNOWN mode DEFAULT group default qlen 500
    link/ether 52:54:00:83:53:f2 brd ff:ff:ff:ff:ff:ff promiscuity 0
    macvtap  mode bridge addrgenmode eui64
15: macvtap2@enp4s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UNKNOWN mode DEFAULT group default qlen 500
    link/ether 52:54:00:f1:76:0b brd ff:ff:ff:ff:ff:ff promiscuity 0
    macvtap  mode bridge addrgenmode eui64
17: macvtap3@enp4s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UNKNOWN mode DEFAULT group default qlen 500
    link/ether 52:54:00ðŸ’¿53:34 brd ff:ff:ff:ff:ff:ff promiscuity 0
    macvtap  mode bridge addrgenmode eui64
20: macvtap1@enp4s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UNKNOWN mode DEFAULT group default qlen 500
    link/ether 52:54:00:18:79:d3 brd ff:ff:ff:ff:ff:ff promiscuity 0
    macvtap  mode bridge addrgenmode eui64
</code></pre></content><p><a href=https://major.io/tags/fedora/>#fedora</a>
<a href=https://major.io/tags/kvm/>#kvm</a>
<a href=https://major.io/tags/macvlan/>#macvlan</a>
<a href=https://major.io/tags/networking/>#networking</a>
<a href=https://major.io/tags/security/>#security</a>
<a href=https://major.io/tags/virtualization/>#virtualization</a></p></main><footer><hr>CC-BY-SA 4.0 &#187;
Made with <a href=https://gohugo.io/>Hugo</a> &#187;
Theme based on <a href=https://github.com/janraasch/hugo-bearblog/>Hugo Ê•â€¢á´¥â€¢Ê” Bear</a> &#187;
<a href=https://github.com/major/major.io/commit/84372fb2198913a5e498b8d32ffc77fb813f0a48>84372fb2</a></footer></body></html>