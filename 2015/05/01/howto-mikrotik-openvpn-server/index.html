<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Major Hayden"><meta name=description content="Mikrotik firewalls have been good to me over the years and they work well for multiple purposes. Creating an OpenVPN server on the device can allow you to connect into your local network when you&amp;rsquo;re on the road or protect your traffic when you&amp;rsquo;re using untrusted networks.
Although Miktrotik&amp;rsquo;s implementation isn&amp;rsquo;t terribly robust (TCP only, client cert auth is wonky), it works quite well for most users. I&amp;rsquo;ll walk you through the process from importing certificates through testing it out with a client.
"><meta name=keywords content=",mikrotik,networking,openvpn"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://major.io/2015/05/01/howto-mikrotik-openvpn-server/><title>HOWTO: Mikrotik OpenVPN server :: Major Hayden ðŸ¤  â€” Words of wisdom from a social nerd</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=../../../../main.89fa80e2143f71bd5c96a7c94e531dec3276a367e22f87e74a76026ab64680bf.css><link rel=apple-touch-icon sizes=180x180 href=../../../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../../favicon-16x16.png><link rel=manifest href=../../../../site.webmanifest><link rel=mask-icon href=../../../../safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=../../../../favicon.ico><meta name=msapplication-TileColor content="#252627"><meta name=theme-color content="#252627"><meta itemprop=name content="HOWTO: Mikrotik OpenVPN server"><meta itemprop=description content="Mikrotik firewalls have been good to me over the years and they work well for multiple purposes. Creating an OpenVPN server on the device can allow you to connect into your local network when you&rsquo;re on the road or protect your traffic when you&rsquo;re using untrusted networks.
Although Miktrotik&rsquo;s implementation isn&rsquo;t terribly robust (TCP only, client cert auth is wonky), it works quite well for most users. I&rsquo;ll walk you through the process from importing certificates through testing it out with a client."><meta itemprop=datePublished content="2015-05-01T15:33:35+00:00"><meta itemprop=dateModified content="2015-05-01T15:33:35+00:00"><meta itemprop=wordCount content="1074"><meta itemprop=image content="https://major.io"><meta itemprop=keywords content="mikrotik,networking,openvpn,"><meta property="article:section" content="Blog Posts"><meta property="article:published_time" content="2015-05-01 15:33:35 +0000 UTC"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="HOWTO: Mikrotik OpenVPN server :: Major Hayden ðŸ¤ "><meta name=twitter:description content><meta name=twitter:site content="https://major.io"><meta name=twitter:creator content="Major Hayden"><meta name=twitter:image content><style type=text/css>html{letter-spacing:unset}</style></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=../../../../ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ echo major.io</span>
<span class=logo__cursor style=visibility:hidden></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=../../../../ham-radio-faq>hamradio</a></li><li><a href=../../../../icanhazip-com-faq>icanhazip</a></li><li><a href=../../../../posts/>posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://major.io/2015/05/01/howto-mikrotik-openvpn-server/>HOWTO: Mikrotik OpenVPN server</a></h2><div class=post-content><p><a href=../../../../wp-content/uploads/2015/05/rb850_picture.jpg></a>Mikrotik firewalls have been good to me over the years and they work well for multiple purposes. Creating an OpenVPN server on the device can allow you to connect into your local network when you&rsquo;re on the road or protect your traffic when you&rsquo;re using untrusted networks.</p><p>Although Miktrotik&rsquo;s implementation isn&rsquo;t terribly robust (TCP only, client cert auth is wonky), it works quite well for most users. I&rsquo;ll walk you through the process from importing certificates through testing it out with a client.</p><h3 id=import-certificates>Import certificates</h3><p>Creating a CA and signing a certificate and key is outside the scope of this post and there are plenty of sites that cover the basics of creating a <a href=../../../../2007/08/02/generate-self-signed-certificate-and-key-in-one-line/>self-signed certificate</a>. You could also create a certificate signing request (CSR) on the Mikrotik and have that signed by a trusted CA. In my case, I have a simple CA already and I signed a certificate for myself.</p><p>Upload your certificate, key, and CA certificate (if applicable) to the Mikrotik. After that, import those files into the Mikrotik&rsquo;s certificate storage:</p><pre><code> import file-name=firewall.example.com.crt
passphrase:
     certificates-imported: 1
     private-keys-imported: 0
            files-imported: 1
       decryption-failures: 0
  keys-with-no-certificate: 0

[major@home] /certificate&gt; import file-name=firewall.example.com.pem
passphrase:
     certificates-imported: 0
     private-keys-imported: 1
            files-imported: 1
       decryption-failures: 0
  keys-with-no-certificate: 0

[major@home] /certificate&gt; import file-name=My_Personal_CA.crt
passphrase:
     certificates-imported: 1
     private-keys-imported: 0
            files-imported: 1
       decryption-failures: 0
  keys-with-no-certificate: 0
</code></pre><p><strong>Always import the certificate first, then the key.</strong> You should be able to do a <code>/certificate print</code> and see the entries for the files you imported. In the print output, look at the flags column and verify that the line with your certificate has a <strong>T</strong> and a <strong>K</strong>. If the K is missing, import the key one more time. If that still doesn&rsquo;t work, ensure that your certificate and key match.</p><p>The default naming conventions used for certificates is a little confusing. You can rename a certificate by running <code>set name=firewall.example.com number=0</code> (run a <code>/certificate print</code> to get the right number).</p><h3 id=openvpn-server-configuration>OpenVPN server configuration</h3><p>We&rsquo;re now ready to do the first steps of the OpenVPN setup on the Mikrotik. You can do this configuration via the Winbox GUI or via the web interface, but I prefer to use the command line. Let&rsquo;s start:</p><pre><code>/interface ovpn-server server
set certificate=firewall.example.com cipher=blowfish128,aes128,aes192,aes256 default-profile=default-encryption enabled=yes
</code></pre><p>This tells the device that we want to use the certificate we imported earlier along with all of the available ciphers. We&rsquo;re also selecting the <strong>default-encryption</strong> profile that we will configure in more detail later. Feel free to adjust your cipher list later on but I recommend allowing all of them until you&rsquo;re sure that the VPN configuration works.</p><p>We&rsquo;re now ready to add an OpenVPN interface. In Mikrotik terms, you can have multiple OpenVPN server profiles running under the same server. They will all share the same certificate, but each may have different authentication methods or network configurations. Let&rsquo;s define our first profile:</p><pre><code>/interface ovpn-server
add name=openvpn-inbound user=openvpn
</code></pre><p>There&rsquo;s now a profile with a username of <strong>openvpn</strong>. That will be the username that we use to connect to this VPN server.</p><h3 id=secrets>Secrets</h3><p>The router needs a way to identify the user we just created. We can define a secret easily:</p><pre><code>/ppp secret
add name=openvpn password=vpnsarefun profile=default-encryption
</code></pre><p>We&rsquo;ve set a password secret and defined a connection profile that corresponds to the secret.</p><h3 id=profiles>Profiles</h3><p>We&rsquo;ve been referring to this <strong>default-encryption</strong> profile several times and now it&rsquo;s time to configure it. This is one of the things I prefer to configure using the Winbox GUI or the web interface since there are plenty of options to review.</p><p>The most important part is how you connect the VPN connection into your internal network. You have a few options here. You can configure an IP address that will always be assigned to this connection no matter what. There are upsides and downsides with that choice. You&rsquo;ll always get the same IP on the inside network but you won&rsquo;t be able to connect to the same profile with multiple clients.</p><p>I prefer to set the bridge option to my internal network bridge (which I call <strong>lanbridge</strong>). That allows me to use my existing bridge configuration and filtering rules on my OpenVPN tunnels. My configuration looks something like this:</p><pre><code>/ppp profile
set 1 bridge=lanbridge local-address=default-dhcp only-one=no remote-address=default-dhcp
</code></pre><p>I&rsquo;ve told the router that I want VPN connections to be hooked up to my main bridge and it should get local and remote IP addresses from my default DHCP server. In addition, I&rsquo;ve also allowed more than one simultaneous connection to this profile.</p><p>The other defaults are fairly decent to get started. You can go back and adjust them later if needed.</p><h3 id=openvpn-client>OpenVPN client</h3><p>Every client has things configured a bit differently but I&rsquo;ll be working with a basic OpenVPN configuration file here that should work on most systems (or at least show you what to click in your client GUI).</p><p>Here&rsquo;s my OpenVPN client configuration file:</p><pre><code>remote firewall.example.com 1194 tcp-client
persist-key
auth-user-pass /etc/openvpn/firewall-creds.txt
tls-client
pull
ca /home/major/.cert/ca.crt
redirect-gateway def1
dev tun
persist-tun
cert /home/major/.cert/cert.crt
nobind
key /home/major/.cert/key.key
</code></pre><p>In my configuration, I refer to a <strong>/etc/openvpn/firewall-creds.txt</strong> file to hold my credentials. You can store the file anywhere (or this might be configurable in a GUI) but it should look like this:</p><pre><code>username
password
</code></pre><p>That&rsquo;s it - just a two line file with the username, a line feed, and a password.</p><p>At this point, you should be able to test your client.</p><h3 id=troubleshooting>Troubleshooting</h3><p><strong>Firewall</strong> - Ensure that you have a firewall rule set to allow traffic into your OpenVPN port. This could be something as simple as:</p><pre><code>/ip firewall filter add chain=input dst-port=1194 protocol=tcp
</code></pre><p><strong>Certificates</strong> - Check that your certificate and key were imported properly and that your client is configured to trust the self-signed certificate or the CA you used.</p><p><strong>Compression</strong> - For some reason, I have lots of problems if compression is enabled on the client. They range from connection failures to being unable to pass traffic through the tunnel after getting connected. Be sure that anything that mentions compression or LZO is disabled.</p><h3 id=security>Security</h3><p>There are some security improvements that can be made after configuring everything:</p><ul><li>Limit access to your OpenVPN port in your firewall to certain source IP&rsquo;s</li><li>Configure better passwords for your OpenVPN secret</li><li>Consider making a separate bridge or network segment for VPN users when they connect and apply filters to it</li><li>Adjust the list of ciphers in the default-encryption profile so that only the strongest can be used (may cause some clients to be unable to connect)</li></ul></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://major.io/tags/mikrotik/>mikrotik</a></span>
<span class=tag><a href=https://major.io/tags/networking/>networking</a></span>
<span class=tag><a href=https://major.io/tags/openvpn/>openvpn</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span class=tag><a href=https://major.io/categories/blog-posts/>Blog Posts</a></span></p></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span><a href=https://major.io>Major Hayden</a></span>
<span><a href=https://creativecommons.org/licenses/by-sa/2.0/ target=_blank rel=noopener>CC BY-SA 2.0</a></span><span><a href=https://major.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>Djordje Atlialp</a></span></div></div></footer></div><script type=text/javascript src=../../../../bundle.min.e9f93b80e78a22e6f04cbb5f73e0f9c4ba60ff73a2a0ef85965c688f93dd1f2722a282e30e485603e4c65b1b346720e35f213435ec5556e196a97a68d097c80f.js integrity="sha512-6fk7gOeKIubwTLtfc+D5xLpg/3OioO+Fllxoj5PdHyciooLjDkhWA+TGWxs0ZyDjXyE0NexVVuGWqXpo0JfIDw=="></script></body></html>