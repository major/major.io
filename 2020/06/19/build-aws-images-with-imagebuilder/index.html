<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Build AWS images with Image Builder &#183; 🤠 Major Hayden</title><meta name=title content="Build AWS images with Image Builder &#183; 🤠 Major Hayden"><meta name=description content="A social nerd writing about everything"><link rel=canonical href=https://major.io/2020/06/19/build-aws-images-with-imagebuilder/><link type=text/css rel=stylesheet href=/css/main.bundle.min.55253fde34a251b02bdc3be052caf9044f977a6d44817f370ad781aed774a2a79759827fd0c3255abb87575848a355a0068eb43b2958172f6c237352069d6cea.css integrity="sha512-VSU/3jSiUbAr3DvgUsr5BE+Xem1EgX83CteBrtd0oqeXWYJ/0MMlWruHV1hIo1WgBo60OylYFy9sI3NSBp1s6g=="><script type=text/javascript src=/js/appearance.min.badab316c9287a5a42a843e4eb45da65bb3d194a5a0f5fa4a3e516160e67df0b8c65f4f19a8e146436e29d583699e6cb41d6bbe99e05e1dbaa877763bad9f8e2.js integrity="sha512-utqzFskoelpCqEPk60XaZbs9GUpaD1+ko+UWFg5n3wuMZfTxmo4UZDbinVg2mebLQda76Z4F4duqh3djutn44g=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.15ae6e2c9b1ac24a9ccf40003fa689efb1a18db1ee9b73d780b01a6c31b150441415862513e93184f68fe385759e4698b8763cba6a0f79493c1fed99ad5868d4.js integrity="sha512-Fa5uLJsawkqcz0AAP6aJ77GhjbHum3PXgLAabDGxUEQUFYYlE+kxhPaP44V1nkaYuHY8umoPeUk8H+2ZrVho1A==" data-copy=Copy data-copied=Copied></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="Build AWS images with Image Builder"><meta property="og:description" content="Build a customized image for AWS with Image Builder and use the built-in automatic uploader and importer."><meta property="og:type" content="article"><meta property="og:url" content="https://major.io/2020/06/19/build-aws-images-with-imagebuilder/"><meta property="og:image" content="https://major.io/images/2020-06-19-aluminum-factory.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-06-19T00:00:00+00:00"><meta property="article:modified_time" content="2020-06-19T00:00:00+00:00"><meta property="og:site_name" content="🤠 Major Hayden"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://major.io/images/2020-06-19-aluminum-factory.jpg"><meta name=twitter:title content="Build AWS images with Image Builder"><meta name=twitter:description content="Build a customized image for AWS with Image Builder and use the built-in automatic uploader and importer."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Build AWS images with Image Builder","headline":"Build AWS images with Image Builder","abstract":"Build a customized image for AWS with Image Builder and use the built-in automatic uploader and importer.","inLanguage":"en","url":"https:\/\/major.io\/2020\/06\/19\/build-aws-images-with-imagebuilder\/","author":{"@type":"Person","name":"Major Hayden"},"copyrightYear":"2020","dateCreated":"2020-06-19T00:00:00\u002b00:00","datePublished":"2020-06-19T00:00:00\u002b00:00","dateModified":"2020-06-19T00:00:00\u002b00:00","keywords":["aws","cloud","fedora","linux"],"mainEntityOfPage":"true","wordCount":"1394"}]</script><meta name=author content="Major Hayden"><link href=mailto:major@mhtx.net rel=me><link href=https://github.com/major rel=me><link href=https://gitlab.com/majorhayden rel=me><link href=https://linkedin.com/in/majorhayden rel=me><link href=https://t.me/majorhayden rel=me><link href=https://twitter.com/majorhayden rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0" href=#main-content><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold sm:py-10 text-neutral-900 dark:text-neutral print:hidden"><nav class="flex justify-between"><div><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>🤠 Major Hayden</a></div><ul class="flex flex-col list-none ltr:text-right rtl:text-left sm:flex-row"><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/posts/ title=Posts>Blog</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/tags/ title=Tags>Tags</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/w5wut/ title="W5WUT: My amateur radio station">W5WUT</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/cv/ title="Major's CV">CV</a></li><li class="ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><button id=search-button class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>🤠 Major Hayden</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/2020/06/19/build-aws-images-with-imagebuilder/>Build AWS images with Image Builder</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Build AWS images with Image Builder</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2020-06-19 00:00:00 +0000 UTC">19 June 2020</time><span class="px-2 text-primary-500">&#183;</span><span>1394 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">7 mins</span></div><div class="my-1 text-xs text-neutral-500 dark:text-neutral-400"><a href=/tags/aws/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">aws</a>
<a href=/tags/cloud/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">cloud</a>
<a href=/tags/fedora/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">fedora</a>
<a href=/tags/linux/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">linux</a></div></div></header><section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert"><div class="order-first px-0 lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8 lg:order-last"><div class="ltr:pl-5 rtl:pr-5 toc lg:sticky lg:top-10 print:hidden"><details open class="mt-0 overflow-hidden rounded-lg rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5"><summary class="block py-1 text-lg font-semibold cursor-pointer rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 text-neutral-800 dark:text-neutral-100 lg:hidden bg-neutral-100 dark:bg-neutral-700">Table of Contents</summary><div class="py-2 border-dotted ltr:border-l rtl:border-r rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 border-neutral-300 dark:border-neutral-600"><nav id=TableOfContents><ul><li><ul><li><a href=#importing-an-image-into-aws-the-hard-way>Importing an image into AWS (the hard way)</a></li><li><a href=#using-image-builder-to-make-images>Using Image Builder to make images</a></li><li><a href=#preparing-for-automatic-aws-upload>Preparing for automatic AWS upload</a></li><li><a href=#building-an-image-with-automatic-upload>Building an image with automatic upload</a></li><li><a href=#wrapping-up>Wrapping up</a></li></ul></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose"><figure><img class="my-0 rounded-md" src=/images/2020-06-19-aluminum-factory.jpg alt="Aluminum factory"></figure><p>The AMIs provided by most Linux distributions in AWS work well for most use
cases. However, there are those times when you need a customized image to
support a certain configuration or to speed up CI processes.</p><p>You can get a customized image via a few methods:</p><ol><li>Build from an existing AMI, customize it, and snapshot it.</li><li>Use an automated tool, such as Packer, to automate #1.</li><li>Build your own image locally in KVM, VMware, or Virtualbox and upload the
image into S3, import it into an EC2, and create an AMI from the snapshot.</li></ol><p>My preferred option is the last method since the installation happens locally
and the image is first booted in AWS. This ensures that log files and
configurations are clean on first boot. Although this method produces the best
result, it has plenty of steps that can go wrong.</p><h2 id=importing-an-image-into-aws-the-hard-way class="relative group">Importing an image into AWS (the hard way) <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#importing-an-image-into-aws-the-hard-way aria-label=Anchor>#</a></span></h2><p>AWS has <a href=https://docs.aws.amazon.com/vm-import/latest/userguide/vmimport-image-import.html>documentation for importing an image</a> and the basic steps include:</p><ol><li>Install into a VM locally and customize it.</li><li>Snapshot the image and upload it into an S3 bucket.</li><li>Create an IAM role for <code>vmimport</code> so that EC2 can pull the image from S3
and import it.</li><li>Run <code>aws ec2 import-snapshot</code> to tell EC2 to import the image.</li><li>Monitor the output of <code>aws ec2 describe-import-snapshot-tasks</code> until the
snapshot fully imports into EC2. It might fail to import, so you need to be
prepared for that. (If that happens, go back to step 4.)</li><li>Get the snapshot ID from the import.</li><li>Run <code>aws ec2 register-image</code> to create the AMI from the snapshot ID.</li></ol><p>This is a lot of manual work. 😩</p><h2 id=using-image-builder-to-make-images class="relative group">Using Image Builder to make images <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#using-image-builder-to-make-images aria-label=Anchor>#</a></span></h2><p>Image Builder has two main components:</p><ul><li><a href=https://github.com/osbuild/osbuild-composer>osbuild-composer</a> takes an image configuration and generates instructions
for the image build stages (and optionally uploads an image to a cloud)</li><li><a href=https://github.com/osbuild/osbuild>osbuild</a> takes those instructions and builds an image</li></ul><p>The support for uploading to clouds first arrived in Fedora 32 and this post
will use that release for generating images.</p><p>To get started, install <code>osbuild-composer</code> along with <code>composer-cli</code>, a
command line interface to create images. Start the socket for
<code>osbuild-composer</code> as well:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># dnf -y install composer-cli osbuild-composer
</span></span><span class=line><span class=cl># systemctl enable --now osbuild-composer.socket
</span></span></code></pre></div><p>Verify that everything is working:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># composer-cli sources list
</span></span><span class=line><span class=cl>fedora
</span></span><span class=line><span class=cl>updates
</span></span><span class=line><span class=cl>fedora-modular
</span></span><span class=line><span class=cl>updates-modular
</span></span></code></pre></div><p>We now need an image blueprint. A blueprint is a TOML file that provides some
basic specifications for the image, such as which packages to install, which
services should start at boot time, and the system&rsquo;s time zone. Refer to the
<a href=https://weldr.io/lorax/lorax-composer.html#blueprints>Lorax composer documentation</a> for a full list of options.</p><p>In this example, we will build a small image with nginx to serve a website.
Here&rsquo;s the TOML file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=nx>name</span> <span class=p>=</span> <span class=s2>&#34;aws-nginx&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>description</span> <span class=p>=</span> <span class=s2>&#34;AWS nginx image&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>version</span> <span class=p>=</span> <span class=s2>&#34;0.0.1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=nx>packages</span><span class=p>]]</span>
</span></span><span class=line><span class=cl><span class=nx>name</span> <span class=p>=</span> <span class=s2>&#34;chrony&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=nx>packages</span><span class=p>]]</span>
</span></span><span class=line><span class=cl><span class=nx>name</span> <span class=p>=</span> <span class=s2>&#34;cloud-utils-growpart&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=nx>packages</span><span class=p>]]</span>
</span></span><span class=line><span class=cl><span class=nx>name</span> <span class=p>=</span> <span class=s2>&#34;nginx&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>customizations</span><span class=p>.</span><span class=nx>kernel</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>append</span> <span class=p>=</span> <span class=s2>&#34;no_timer_check console=hvc0 LANG=en_US.UTF-8&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>customizations</span><span class=p>.</span><span class=nx>services</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>enabled</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;chronyd&#34;</span><span class=p>,</span> <span class=s2>&#34;nginx&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>customizations</span><span class=p>.</span><span class=nx>timezone</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>timezome</span> <span class=p>=</span> <span class=s2>&#34;UTC&#34;</span>
</span></span></code></pre></div><p>Our specification says:</p><ul><li>Build an image with <code>nginx</code> and ensure it starts at boot time</li><li>Install <code>chrony</code> for time synchronization, set the time zone to UTC, and
start it at boot time.</li><li>Install <code>cloud-utils-growpart</code> so that cloud-init can automatically grow the
root filesystem on the first boot</li><li>Add some kernel boot parameters to ensure the serial console works in AWS</li></ul><p>Push the blueprint into <code>osbuild-composer</code> and ensure the packages are
available. (The <code>depsolve</code> check is optional, but I recommend it so you can
find any typos in your package names.)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># composer-cli blueprints push aws-image.toml
</span></span><span class=line><span class=cl># composer-cli blueprints depsolve aws-nginx
</span></span><span class=line><span class=cl>blueprint: aws-nginx v0.0.1
</span></span><span class=line><span class=cl>    acl-2.2.53-5.fc32.x86_64
</span></span><span class=line><span class=cl>    alternatives-1.11-6.fc32.x86_64
</span></span><span class=line><span class=cl>    audit-libs-3.0-0.19.20191104git1c2f876.fc32.x86_64
</span></span><span class=line><span class=cl>    ...
</span></span></code></pre></div><p>We can now build the image:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># composer-cli --json compose start aws-nginx ami
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    &#34;build_id&#34;: &#34;285c1ee8-6b9e-4725-9c4c-346eafae86de&#34;,
</span></span><span class=line><span class=cl>    &#34;status&#34;: true
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl># composer-cli --json compose status 285c1ee8-6b9e-4725-9c4c-346eafae86de
</span></span><span class=line><span class=cl>[
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl>        &#34;id&#34;: &#34;285c1ee8-6b9e-4725-9c4c-346eafae86de&#34;,
</span></span><span class=line><span class=cl>        &#34;blueprint&#34;: &#34;aws-nginx&#34;,
</span></span><span class=line><span class=cl>        &#34;version&#34;: &#34;0.0.1&#34;,
</span></span><span class=line><span class=cl>        &#34;compose_type&#34;: &#34;ami&#34;,
</span></span><span class=line><span class=cl>        &#34;image_size&#34;: 0,
</span></span><span class=line><span class=cl>        &#34;status&#34;: &#34;RUNNING&#34;,
</span></span><span class=line><span class=cl>        &#34;created&#34;: 1592578852.962228,
</span></span><span class=line><span class=cl>        &#34;started&#34;: 1592578852.987541,
</span></span><span class=line><span class=cl>        &#34;finished&#34;: null
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>]
</span></span></code></pre></div><p>Our image is building! After a few minutes, the image is ready:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># composer-cli --json compose status 285c1ee8-6b9e-4725-9c4c-346eafae86de
</span></span><span class=line><span class=cl>[
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl>        &#34;id&#34;: &#34;285c1ee8-6b9e-4725-9c4c-346eafae86de&#34;,
</span></span><span class=line><span class=cl>        &#34;blueprint&#34;: &#34;aws-nginx&#34;,
</span></span><span class=line><span class=cl>        &#34;version&#34;: &#34;0.0.1&#34;,
</span></span><span class=line><span class=cl>        &#34;compose_type&#34;: &#34;ami&#34;,
</span></span><span class=line><span class=cl>        &#34;image_size&#34;: 6442450944,
</span></span><span class=line><span class=cl>        &#34;status&#34;: &#34;FINISHED&#34;,
</span></span><span class=line><span class=cl>        &#34;created&#34;: 1592578852.962228,
</span></span><span class=line><span class=cl>        &#34;started&#34;: 1592578852.987541,
</span></span><span class=line><span class=cl>        &#34;finished&#34;: 1592579061.3364012
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>]
</span></span><span class=line><span class=cl># composer-cli compose image 285c1ee8-6b9e-4725-9c4c-346eafae86de
</span></span><span class=line><span class=cl>285c1ee8-6b9e-4725-9c4c-346eafae86de-image.vhdx: 1304.00 MB
</span></span><span class=line><span class=cl># ls -alh 285c1ee8-6b9e-4725-9c4c-346eafae86de-image.vhdx
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root 1.3G Jun 19 15:12 285c1ee8-6b9e-4725-9c4c-346eafae86de-image.vhdx
</span></span></code></pre></div><p>We can take this image, upload it to S3 and import it into AWS using the
process mentioned earlier in this post. Or, we can have osbuild-composer do
this for us.</p><h2 id=preparing-for-automatic-aws-upload class="relative group">Preparing for automatic AWS upload <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#preparing-for-automatic-aws-upload aria-label=Anchor>#</a></span></h2><p>Start by making a bucket in S3 in your preferred region. Mine is called
<code>mhayden-image-uploads</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># aws --region us-east-2 s3 mb s3://mhayden-image-uploads
</span></span><span class=line><span class=cl>make_bucket: mhayden-image-uploads
</span></span></code></pre></div><p>Now we need a role that allows EC2 to import images for us. Save this file as
<code>vmimport.json</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;Version&#34;</span><span class=p>:</span> <span class=s2>&#34;2012-10-17&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;Statement&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;Effect&#34;</span><span class=p>:</span> <span class=s2>&#34;Allow&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;Principal&#34;</span><span class=p>:</span> <span class=p>{</span> <span class=nt>&#34;Service&#34;</span><span class=p>:</span> <span class=s2>&#34;vmie.amazonaws.com&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;Action&#34;</span><span class=p>:</span> <span class=s2>&#34;sts:AssumeRole&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;Condition&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;StringEquals&#34;</span><span class=p>:{</span>
</span></span><span class=line><span class=cl>               <span class=nt>&#34;sts:Externalid&#34;</span><span class=p>:</span> <span class=s2>&#34;vmimport&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>We now need a policy to apply to the <code>vmimport</code> role that allows EC2 to use
the role to download the image, import it, and register an AMI <strong>(replace the
bucket name with your S3 bucket)</strong>. Save this as <code>vmimport-policy.json</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;Version&#34;</span><span class=p>:</span><span class=s2>&#34;2012-10-17&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;Statement&#34;</span><span class=p>:[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;Effect&#34;</span><span class=p>:</span> <span class=s2>&#34;Allow&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;Action&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;s3:GetBucketLocation&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;s3:GetObject&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;s3:ListBucket&#34;</span>
</span></span><span class=line><span class=cl>         <span class=p>],</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;Resource&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;arn:aws:s3:::mhayden-image-uploads&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;arn:aws:s3:::mhayden-image-uploads/*&#34;</span>
</span></span><span class=line><span class=cl>         <span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;Effect&#34;</span><span class=p>:</span> <span class=s2>&#34;Allow&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;Action&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;ec2:ModifySnapshotAttribute&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;ec2:CopySnapshot&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;ec2:RegisterImage&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;ec2:Describe*&#34;</span>
</span></span><span class=line><span class=cl>         <span class=p>],</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;Resource&#34;</span><span class=p>:</span> <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Add the role and the policy to IAM:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># aws iam create-role --role-name vmimport \
</span></span><span class=line><span class=cl>    --assume-role-policy-document &#34;file://vmimport.json&#34;
</span></span><span class=line><span class=cl># aws iam put-role-policy --role-name vmimport --policy-name vmimport \
</span></span><span class=line><span class=cl>    --policy-document &#34;file://vmimport-policy.json&#34;
</span></span></code></pre></div><h2 id=building-an-image-with-automatic-upload class="relative group">Building an image with automatic upload <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#building-an-image-with-automatic-upload aria-label=Anchor>#</a></span></h2><p>We can use our same TOML blueprint we created earlier and provide one
additional TOML file that provides AWS configuration and credentials. Create
an <code>aws-config.toml</code> file with the following content:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=nx>provider</span> <span class=p>=</span> <span class=s2>&#34;aws&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>settings</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>accessKeyID</span> <span class=p>=</span> <span class=s2>&#34;***&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>secretAccessKey</span> <span class=p>=</span> <span class=s2>&#34;***&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>bucket</span> <span class=p>=</span> <span class=s2>&#34;mhayden-image-uploads&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>region</span> <span class=p>=</span> <span class=s2>&#34;us-east-2&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>key</span> <span class=p>=</span> <span class=s2>&#34;fedora-32-image-from-my-blog-post&#34;</span>
</span></span></code></pre></div><p>Add your AWS credentials here along with your S3 bucket, preferred AWS region,
and an image key. The image key is the name applied to the snapshot and the
resulting AMI.</p><p>Now we can build our AMI and have it automatically uploaded:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># composer-cli --json compose start aws-nginx ami fedora-32-image-from-my-blog-post aws-config.toml
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    &#34;build_id&#34;: &#34;f343b20d-70f9-467a-9157-f9b4fc90ee87&#34;,
</span></span><span class=line><span class=cl>    &#34;status&#34;: true
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl># composer-cli --json compose info f343b20d-70f9-467a-9157-f9b4fc90ee87
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    &#34;id&#34;: &#34;f343b20d-70f9-467a-9157-f9b4fc90ee87&#34;,
</span></span><span class=line><span class=cl>    &#34;config&#34;: &#34;&#34;,
</span></span><span class=line><span class=cl>    &#34;blueprint&#34;: {
</span></span><span class=line><span class=cl>        &#34;name&#34;: &#34;aws-nginx&#34;,
</span></span><span class=line><span class=cl>        &#34;description&#34;: &#34;AWS nginx image&#34;,
</span></span><span class=line><span class=cl>        &#34;version&#34;: &#34;0.0.1&#34;,
</span></span><span class=line><span class=cl>        &#34;packages&#34;: [
</span></span><span class=line><span class=cl>            {
</span></span><span class=line><span class=cl>                &#34;name&#34;: &#34;chrony&#34;
</span></span><span class=line><span class=cl>            },
</span></span><span class=line><span class=cl>            {
</span></span><span class=line><span class=cl>                &#34;name&#34;: &#34;cloud-utils-growpart&#34;
</span></span><span class=line><span class=cl>            },
</span></span><span class=line><span class=cl>            {
</span></span><span class=line><span class=cl>                &#34;name&#34;: &#34;nginx&#34;
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        ],
</span></span><span class=line><span class=cl>        &#34;modules&#34;: [],
</span></span><span class=line><span class=cl>        &#34;groups&#34;: [],
</span></span><span class=line><span class=cl>        &#34;customizations&#34;: {
</span></span><span class=line><span class=cl>            &#34;kernel&#34;: {
</span></span><span class=line><span class=cl>                &#34;append&#34;: &#34;no_timer_check console=hvc0 LANG=en_US.UTF-8&#34;
</span></span><span class=line><span class=cl>            },
</span></span><span class=line><span class=cl>            &#34;timezone&#34;: {},
</span></span><span class=line><span class=cl>            &#34;services&#34;: {
</span></span><span class=line><span class=cl>                &#34;enabled&#34;: [
</span></span><span class=line><span class=cl>                    &#34;chronyd&#34;,
</span></span><span class=line><span class=cl>                    &#34;nginx&#34;
</span></span><span class=line><span class=cl>                ]
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    },
</span></span><span class=line><span class=cl>    &#34;commit&#34;: &#34;&#34;,
</span></span><span class=line><span class=cl>    &#34;deps&#34;: {
</span></span><span class=line><span class=cl>        &#34;packages&#34;: []
</span></span><span class=line><span class=cl>    },
</span></span><span class=line><span class=cl>    &#34;compose_type&#34;: &#34;ami&#34;,
</span></span><span class=line><span class=cl>    &#34;queue_status&#34;: &#34;RUNNING&#34;,
</span></span><span class=line><span class=cl>    &#34;image_size&#34;: 6442450944,
</span></span><span class=line><span class=cl>    &#34;uploads&#34;: [
</span></span><span class=line><span class=cl>        {
</span></span><span class=line><span class=cl>            &#34;uuid&#34;: &#34;e747be78-87e2-48b9-b0d2-cc1bb393a9e4&#34;,
</span></span><span class=line><span class=cl>            &#34;status&#34;: &#34;RUNNING&#34;,
</span></span><span class=line><span class=cl>            &#34;provider_name&#34;: &#34;aws&#34;,
</span></span><span class=line><span class=cl>            &#34;image_name&#34;: &#34;fedora-32-image-from-my-blog-post&#34;,
</span></span><span class=line><span class=cl>            &#34;creation_time&#34;: 1592580775.438667,
</span></span><span class=line><span class=cl>            &#34;settings&#34;: {
</span></span><span class=line><span class=cl>                &#34;region&#34;: &#34;us-east-2&#34;,
</span></span><span class=line><span class=cl>                &#34;accessKeyID&#34;: &#34;***&#34;,
</span></span><span class=line><span class=cl>                &#34;secretAccessKey&#34;: &#34;***&#34;,
</span></span><span class=line><span class=cl>                &#34;bucket&#34;: &#34;mhayden-image-uploads&#34;,
</span></span><span class=line><span class=cl>                &#34;key&#34;: &#34;fedora-32-image-from-my-blog-post&#34;
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    ]
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>The output now shows an <code>uploads</code> section with the AWS upload details
included. This process may take some time, especially if your upload speed is
low. You can follow along with <code>composer-cli --json compose info</code> or you can
monitor the system journal:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># journalctl -af -o cat -u osbuild-worker@1.service
</span></span><span class=line><span class=cl>Running job f343b20d-70f9-467a-9157-f9b4fc90ee87
</span></span><span class=line><span class=cl>2020/06/19 15:57:37 [AWS] 🚀 Uploading image to S3: mhayden-image-uploads/fedora-32-image-from-my-blog-post
</span></span><span class=line><span class=cl>2020/06/19 15:58:03 [AWS] 📥 Importing snapshot from image: mhayden-image-uploads/fedora-32-image-from-my-blog-post
</span></span><span class=line><span class=cl>2020/06/19 15:58:03 [AWS] ⏱ Waiting for snapshot to finish importing: import-snap-0f4baff3e1eb945a8
</span></span><span class=line><span class=cl>2020/06/19 16:04:50 [AWS] 🧹 Deleting image from S3: mhayden-image-uploads/fedora-32-image-from-my-blog-post
</span></span><span class=line><span class=cl>2020/06/19 16:04:51 [AWS] 📋 Registering AMI from imported snapshot: snap-0cf822f1441f9e407
</span></span><span class=line><span class=cl>2020/06/19 16:04:51 [AWS] 🎉 AMI registered: ami-0d0873cc888ab12a2
</span></span></code></pre></div><p>I ran this job on a small instance at Vultr and the whole process took about
10 minutes. The AWS image import process can vary a bit, but it&rsquo;s usually in
the range of 5-15 minutes.</p><p>At this point, I can take my new AMI (in my case, it&rsquo;s
<code>ami-0d0873cc888ab12a2</code>) and build instances at EC2! 🎉</p><h2 id=wrapping-up class="relative group">Wrapping up <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#wrapping-up aria-label=Anchor>#</a></span></h2><p>Although there is some work involved in laying the groundwork for importing
images into EC2, this work only needs to be done one time. You can re-use your
existing AWS credentials TOML file over and over for new images that are made
from different blueprints.</p><p>You can also do almost all of this work via the <a href=https://cockpit-project.org/>cockpit web interface</a> using
the <code>cockpit-composer</code> package if you prefer. The only downside to that method
is that some image customizations cannot be made through cockpit and some TOML
blueprint editing with <code>composer-cli</code> is needed. Look for that in a future
blog post.</p><p><em>Photo credit: <a href=https://commons.wikimedia.org/wiki/File:Shelekhov-aluminium-factory-4.jpg>Wikimedia Commons</a></em></p></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group" href=/2020/06/11/my-experience-with-keto-so-far/><span class="mr-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">My experience with keto so far</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2020-06-11 00:00:00 +0000 UTC">11 June 2020</time></span></span></a></span>
<span><a class="flex text-right group" href=/2020/12/06/options-trading-introduction/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Options trading introduction</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2020-12-06 00:00:00 +0000 UTC">6 December 2020</time></span></span>
<span class="ml-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div class="absolute top-[100vh] ltr:right-0 rtl:left-0 w-12 pointer-events-none bottom-0"><a href=#the-top class="w-12 h-12 sticky pointer-events-auto top-[calc(100vh-5.5rem)] bg-neutral/50 dark:bg-neutral-800/50 backdrop-blur rounded-full text-xl flex items-center justify-center text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">All content licensed <a href=https://creativecommons.org/licenses/by-sa/4.0/>CC-BY-SA</a></p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://git.io/hugo-congo target=_blank rel="noopener noreferrer">Congo</a></p></div><div class="text-sm cursor-pointer text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-14 rtl:ml-14"><button id=appearance-switcher class="w-12 h-12" type=button title="Switch to dark appearance">
<span class="inline dark:hidden"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></span><span class="hidden dark:inline"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></span></button></div></div></footer><div id=search-wrapper class="fixed inset-0 z-50 flex flex-col p-4 sm:p-6 md:p-[10vh] lg:p-[12vh] w-screen h-screen cursor-default bg-neutral-500/50 backdrop-blur-sm dark:bg-neutral-900/50 invisible" data-url=https://major.io/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg border-neutral-200 top-20 bg-neutral dark:bg-neutral-800 dark:border-neutral-700"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-transparent focus:outline-2" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>