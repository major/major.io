<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Major Hayden"><meta name=description content="Although Citrix recommends against using software RAID with XenServer due to performance issues, I&amp;rsquo;ve had some pretty awful experiences with hardware RAID cards over the last few years. In addition, the price of software RAID makes it a very desirable solution.
Before you get started, go through the steps to disable GPT. That post also explains an optional adjustment to get a larger root partition (which I would recommend). You cannot complete the steps in this post if your XenServer installation uses GPT."><meta name=keywords content=",command line,linux,lvm,mdadm,raid,xen,xenserver"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://major.io/2012/01/16/xenserver-6-storage-repository-on-software-raid/><title>XenServer 6: Storage repository on software RAID :: Major Hayden ðŸ¤  â€” Words of wisdom from a social nerd</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=../../../../main.89fa80e2143f71bd5c96a7c94e531dec3276a367e22f87e74a76026ab64680bf.css><link rel=apple-touch-icon sizes=180x180 href=../../../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../../favicon-16x16.png><link rel=manifest href=../../../../site.webmanifest><link rel=mask-icon href=../../../../safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=../../../../favicon.ico><meta name=msapplication-TileColor content="#252627"><meta name=theme-color content="#252627"><meta itemprop=name content="XenServer 6: Storage repository on software RAID"><meta itemprop=description content="Although Citrix recommends against using software RAID with XenServer due to performance issues, I&rsquo;ve had some pretty awful experiences with hardware RAID cards over the last few years. In addition, the price of software RAID makes it a very desirable solution.
Before you get started, go through the steps to disable GPT. That post also explains an optional adjustment to get a larger root partition (which I would recommend). You cannot complete the steps in this post if your XenServer installation uses GPT."><meta itemprop=datePublished content="2012-01-16T15:00:21+00:00"><meta itemprop=dateModified content="2012-01-16T15:00:21+00:00"><meta itemprop=wordCount content="758"><meta itemprop=image content="https://major.io"><meta itemprop=keywords content="command line,linux,lvm,mdadm,raid,xen,xenserver,"><meta property="article:section" content="Blog Posts"><meta property="article:published_time" content="2012-01-16 15:00:21 +0000 UTC"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="XenServer 6: Storage repository on software RAID :: Major Hayden ðŸ¤ "><meta name=twitter:description content><meta name=twitter:site content="https://major.io"><meta name=twitter:creator content="Major Hayden"><meta name=twitter:image content><style type=text/css>html{letter-spacing:unset}</style></head><body><div class=container><header class=header><span class=header__inner><a href=../../../../ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ echo major.io</span>
<span class=logo__cursor style=visibility:hidden></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=../../../../ham-radio-faq>hamradio</a></li><li><a href=../../../../icanhazip-com-faq>icanhazip</a></li><li><a href=../../../../posts/>posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://major.io/2012/01/16/xenserver-6-storage-repository-on-software-raid/>XenServer 6: Storage repository on software RAID</a></h2><div class=post-content><p>Although Citrix recommends against using software RAID with XenServer due to performance issues, I&rsquo;ve had some pretty awful experiences with hardware RAID cards over the last few years. In addition, the price of software RAID makes it a very desirable solution.</p><p><strong>Before you get started,</strong> <a href=http://rackerhacker.com/2012/01/13/xenserver-6-disable-gpt-and-get-a-larger-root-partition/>go through the steps to disable GPT</a>. That post also explains an optional adjustment to get a larger root partition (which I would recommend). <em>You cannot complete the steps in this post if your XenServer installation uses GPT.</em></p><p>You should have three partitions on your first disk after the installation:</p><pre><code># fdisk -l /dev/sda
-- SNIP --
   Device Boot      Start         End      Blocks   Id  System
/dev/sda1   *           1        2611    20971520   83  Linux
/dev/sda2            2611        5222    20971520   83  Linux
/dev/sda3            5222       19457   114345281   8e  Linux LVM
</code></pre><p>Here&rsquo;s a quick explanation of your partitions:</p><ul><li><strong>/dev/sda1:</strong> the XenServer root partition</li><li><strong>/dev/sda2:</strong> XenServer uses this partition for temporary space during upgrades</li><li><strong>/dev/sda3:</strong> your storage repository should be in this logical volume</li></ul><p>We need to replicate the same partition structure across each of your drives and the software RAID volume will span the across the third partition on each disk. Copying the partition structure from disk to disk is done easily with <code>sfdisk</code>:</p><p>WHOA THERE! NO TURNING BACK! This step is destructive! If your other disks have any data on them, this step will make it (relatively) impossible to retrieve data on those disks again. Back up any data on the other disks in your XenServer machine before running these next commands.</p><pre><code>sfdisk -d /dev/sda | sfdisk --force /dev/sdb
sfdisk -d /dev/sda | sfdisk --force /dev/sdc
sfdisk -d /dev/sda | sfdisk --force /dev/sdd
</code></pre><p>If you have only two disks, stop with <code>/dev/sdb</code> and you&rsquo;ll be making a RAID 1 array. My machine has four disks and I&rsquo;ll be making a RAID 10 array.</p><p>We need to destroy the main storage repository, but we need to unplug the physical block device first. Get the storage repository uuid first, then use it to find the corresponding physical block device. Once the physical block device is unplugged, the storage repository can be destroyed:</p><pre><code># xe sr-list name-label=Local\ storage | head -1
uuid ( RO)                : 75264965-f981-749e-0f9a-e32856c46361
# xe pbd-list sr-uuid=75264965-f981-749e-0f9a-e32856c46361 | head -1
uuid ( RO)                  : ff7e9656-c27c-1889-7a6d-687a561f0ad0
# xe pbd-unplug uuid=ff7e9656-c27c-1889-7a6d-687a561f0ad0
# xe sr-destroy uuid=75264965-f981-749e-0f9a-e32856c46361
</code></pre><p>All of the LVM data from <code>/dev/sda3</code> should now be gone:</p><pre><code># lvdisplay &amp;&amp; vgdisplay &amp;&amp; pvdisplay
#
</code></pre><p>Change the third partition on each physical disk to be a software RAID partition type:</p><pre><code>echo -e &quot;t\n3\nfd\nw\n&quot; | fdisk /dev/sda
echo -e &quot;t\n3\nfd\nw\n&quot; | fdisk /dev/sdb
echo -e &quot;t\n3\nfd\nw\n&quot; | fdisk /dev/sdc
echo -e &quot;t\n3\nfd\nw\n&quot; | fdisk /dev/sdd
</code></pre><p>Stop here and reboot your XenServer box to pick up the new partition changes. Once the server comes back from the reboot, start up a software RAID volume with <code>mdadm</code>:</p><pre><code>// RAID 1 for two drives
mdadm --create /dev/md0 -l 1 -n 2 /dev/sda3 /dev/sdb3
// RAID 10 for four drives
mdadm --create /dev/md0 -l 10 -n 4 /dev/sda3 /dev/sdb3 /dev/sdc3 /dev/sdd3
</code></pre><p>Check to see that your RAID array is building:</p><pre><code># cat /proc/mdstat
Personalities : [raid10]
md0 : active raid10 sdd3[3] sdc3[2] sdb3[1] sda3[0]
      228690432 blocks 64K chunks 2 near-copies [4/4] [UUUU]
      [&gt;....................]  resync =  0.3% (694272/228690432) finish=16.4min speed=231424K/sec
</code></pre><p>Although you don&rsquo;t have to wait for the resync to complete, just be aware that XenServer doesn&rsquo;t do well with a lot of disk I/O within dom0. You may notice unusually slow performance in dom0 until it finishes. Save the array&rsquo;s configuration for reboots:</p><pre><code> /etc/mdadm.conf
</code></pre><p>Edit the <code>/etc/mdadm.conf</code> file and append <code>auto=yes</code> to the end of the line (but leave everything on one line):</p><pre><code>ARRAY /dev/md0 level=raid10 num-devices=4 metadata=0.90 \
  UUID=2876748c:5117eed5:ce4d62d3:9592bd84 auto=yes
</code></pre><p>Create a new storage repository on the RAID volume with thin provisioning (thanks to <a href=http://www.scriptkiddie.org/blog/2010/06/20/xenserver-5-6-thin-provisioning-with-ext3/>Spherical Chicken</a> for the command):</p><pre><code>xe sr-create content-type=user type=ext device-config:device=/dev/md0 shared=false name-label=&quot;Local storage&quot;
</code></pre><p>This command takes some time to complete since it makes logical volumes and then makes an ext3 filesystem for the new storage repository. Bigger RAID arrays will take more time and it&rsquo;s guaranteed to take longer than you&rsquo;d expect if your RAID array is still building. As soon as it completes, you&rsquo;ll be given the uuid of your new storage repository and it should appear within the XenCenter interface.</p><p>TIP: If you run into any problems during reboots, open <code>/boot/extlinux.conf</code> and remove <code>splash</code> and <code>quiet</code> from the <code>label xe</code> boot section. This removes the framebuffer during boot-up and it causes a lot more output to be printed to the console. It won&rsquo;t affect the display once your XenServer box has fully booted.</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://major.io/tags/command-line/>command line</a></span>
<span class=tag><a href=https://major.io/tags/linux/>linux</a></span>
<span class=tag><a href=https://major.io/tags/lvm/>lvm</a></span>
<span class=tag><a href=https://major.io/tags/mdadm/>mdadm</a></span>
<span class=tag><a href=https://major.io/tags/raid/>raid</a></span>
<span class=tag><a href=https://major.io/tags/xen/>xen</a></span>
<span class=tag><a href=https://major.io/tags/xenserver/>xenserver</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span class=tag><a href=https://major.io/categories/blog-posts/>Blog Posts</a></span></p></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span><a href=https://major.io>Major Hayden</a></span>
<span><a href=https://creativecommons.org/licenses/by-sa/2.0/ target=_blank rel=noopener>CC BY-SA 2.0</a></span><span><a href=https://major.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>Djordje Atlialp</a></span></div></div></footer></div><script type=text/javascript src=../../../../bundle.min.e9f93b80e78a22e6f04cbb5f73e0f9c4ba60ff73a2a0ef85965c688f93dd1f2722a282e30e485603e4c65b1b346720e35f213435ec5556e196a97a68d097c80f.js integrity="sha512-6fk7gOeKIubwTLtfc+D5xLpg/3OioO+Fllxoj5PdHyciooLjDkhWA+TGWxs0ZyDjXyE0NexVVuGWqXpo0JfIDw=="></script></body></html>