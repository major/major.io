<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>XenServer 6: Storage repository on software RAID &#183; ðŸ¤  Major Hayden</title><meta name=title content="XenServer 6: Storage repository on software RAID &#183; ðŸ¤  Major Hayden"><meta name=description content="A social nerd writing about everything"><link rel=canonical href=https://major.io/2012/01/16/xenserver-6-storage-repository-on-software-raid/><link type=text/css rel=stylesheet href=/css/main.bundle.min.55253fde34a251b02bdc3be052caf9044f977a6d44817f370ad781aed774a2a79759827fd0c3255abb87575848a355a0068eb43b2958172f6c237352069d6cea.css integrity="sha512-VSU/3jSiUbAr3DvgUsr5BE+Xem1EgX83CteBrtd0oqeXWYJ/0MMlWruHV1hIo1WgBo60OylYFy9sI3NSBp1s6g=="><script type=text/javascript src=/js/appearance.min.badab316c9287a5a42a843e4eb45da65bb3d194a5a0f5fa4a3e516160e67df0b8c65f4f19a8e146436e29d583699e6cb41d6bbe99e05e1dbaa877763bad9f8e2.js integrity="sha512-utqzFskoelpCqEPk60XaZbs9GUpaD1+ko+UWFg5n3wuMZfTxmo4UZDbinVg2mebLQda76Z4F4duqh3djutn44g=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.b607eb5ea0f48ef635db6a1c024a35eeff4529157e49461941aac333a158a1f71cae4e530d45ac010598695f823dbe38a63142757e37c2d7b74a309d7296f681.js integrity="sha512-tgfrXqD0jvY122ocAko17v9FKRV+SUYZQarDM6FYofccrk5TDUWsAQWYaV+CPb44pjFCdX43wte3SjCdcpb2gQ==" data-copy=Copy data-copied=Copied></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="XenServer 6: Storage repository on software RAID"><meta property="og:description" content="Although Citrix recommends against using software RAID with XenServer due to performance issues, I&rsquo;ve had some pretty awful experiences with hardware RAID cards over the last few years."><meta property="og:type" content="article"><meta property="og:url" content="https://major.io/2012/01/16/xenserver-6-storage-repository-on-software-raid/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2012-01-16T15:00:21+00:00"><meta property="article:modified_time" content="2012-01-16T15:00:21+00:00"><meta property="og:site_name" content="ðŸ¤  Major Hayden"><meta name=twitter:card content="summary"><meta name=twitter:title content="XenServer 6: Storage repository on software RAID"><meta name=twitter:description content="Although Citrix recommends against using software RAID with XenServer due to performance issues, I&rsquo;ve had some pretty awful experiences with hardware RAID cards over the last few years."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"XenServer 6: Storage repository on software RAID","headline":"XenServer 6: Storage repository on software RAID","abstract":"Although Citrix recommends against using software RAID with XenServer due to performance issues, I\u0026rsquo;ve had some pretty awful experiences with hardware RAID cards over the last few years.","inLanguage":"en","url":"https:\/\/major.io\/2012\/01\/16\/xenserver-6-storage-repository-on-software-raid\/","author":{"@type":"Person","name":"Major Hayden"},"copyrightYear":"2012","dateCreated":"2012-01-16T15:00:21\u002b00:00","datePublished":"2012-01-16T15:00:21\u002b00:00","dateModified":"2012-01-16T15:00:21\u002b00:00","keywords":["command line","linux","lvm","mdadm","raid","xen","xenserver"],"mainEntityOfPage":"true","wordCount":"760"}]</script><meta name=author content="Major Hayden"><link href=mailto:major@mhtx.net rel=me><link href=https://github.com/major rel=me><link href=https://gitlab.com/majorhayden rel=me><link href=https://linkedin.com/in/majorhayden rel=me><link href=https://t.me/majorhayden rel=me><link href=https://twitter.com/majorhayden rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0" href=#main-content><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold sm:py-10 text-neutral-900 dark:text-neutral print:hidden"><nav class="flex justify-between"><div><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>ðŸ¤  Major Hayden</a></div><ul class="flex flex-col list-none ltr:text-right rtl:text-left sm:flex-row"><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/posts/ title=Posts>Blog</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/tags/ title=Tags>Tags</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/w5wut/ title="W5WUT: My amateur radio station">W5WUT</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/cv/ title="Major's CV">CV</a></li><li class="ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><button id=search-button class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>ðŸ¤  Major Hayden</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/2012/01/16/xenserver-6-storage-repository-on-software-raid/>XenServer 6: Storage repository on software RAID</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">XenServer 6: Storage repository on software RAID</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2012-01-16 15:00:21 +0000 UTC">16 January 2012</time><span class="px-2 text-primary-500">&#183;</span><span>760 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">4 mins</span></div><div class="my-1 text-xs text-neutral-500 dark:text-neutral-400"><a href=/tags/command-line/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">command line</a>
<a href=/tags/linux/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">linux</a>
<a href=/tags/lvm/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">lvm</a>
<a href=/tags/mdadm/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">mdadm</a>
<a href=/tags/raid/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">raid</a>
<a href=/tags/xen/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">xen</a>
<a href=/tags/xenserver/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">xenserver</a></div></div></header><section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert"><div class="min-w-0 min-h-0 max-w-prose"><p>Although Citrix recommends against using software RAID with XenServer due to performance issues, I&rsquo;ve had some pretty awful experiences with hardware RAID cards over the last few years. In addition, the price of software RAID makes it a very desirable solution.</p><p><strong>Before you get started,</strong> <a href=http://rackerhacker.com/2012/01/13/xenserver-6-disable-gpt-and-get-a-larger-root-partition/>go through the steps to disable GPT</a>. That post also explains an optional adjustment to get a larger root partition (which I would recommend). <em>You cannot complete the steps in this post if your XenServer installation uses GPT.</em></p><p>You should have three partitions on your first disk after the installation:</p><pre tabindex=0><code># fdisk -l /dev/sda
-- SNIP --
   Device Boot      Start         End      Blocks   Id  System
/dev/sda1   *           1        2611    20971520   83  Linux
/dev/sda2            2611        5222    20971520   83  Linux
/dev/sda3            5222       19457   114345281   8e  Linux LVM
</code></pre><p>Here&rsquo;s a quick explanation of your partitions:</p><ul><li><strong>/dev/sda1:</strong> the XenServer root partition</li><li><strong>/dev/sda2:</strong> XenServer uses this partition for temporary space during upgrades</li><li><strong>/dev/sda3:</strong> your storage repository should be in this logical volume</li></ul><p>We need to replicate the same partition structure across each of your drives and the software RAID volume will span the across the third partition on each disk. Copying the partition structure from disk to disk is done easily with <code>sfdisk</code>:</p><p><span style=color:#d42020><b>WHOA THERE! NO TURNING BACK!</b> This step is destructive! If your other disks have any data on them, this step will make it (relatively) impossible to retrieve data on those disks again. Back up any data on the other disks in your XenServer machine before running these next commands.</span></p><pre tabindex=0><code>sfdisk -d /dev/sda | sfdisk --force /dev/sdb
sfdisk -d /dev/sda | sfdisk --force /dev/sdc
sfdisk -d /dev/sda | sfdisk --force /dev/sdd
</code></pre><p>If you have only two disks, stop with <code>/dev/sdb</code> and you&rsquo;ll be making a RAID 1 array. My machine has four disks and I&rsquo;ll be making a RAID 10 array.</p><p>We need to destroy the main storage repository, but we need to unplug the physical block device first. Get the storage repository uuid first, then use it to find the corresponding physical block device. Once the physical block device is unplugged, the storage repository can be destroyed:</p><pre tabindex=0><code># xe sr-list name-label=Local\ storage | head -1
uuid ( RO)                : 75264965-f981-749e-0f9a-e32856c46361
# xe pbd-list sr-uuid=75264965-f981-749e-0f9a-e32856c46361 | head -1
uuid ( RO)                  : ff7e9656-c27c-1889-7a6d-687a561f0ad0
# xe pbd-unplug uuid=ff7e9656-c27c-1889-7a6d-687a561f0ad0
# xe sr-destroy uuid=75264965-f981-749e-0f9a-e32856c46361
</code></pre><p>All of the LVM data from <code>/dev/sda3</code> should now be gone:</p><pre tabindex=0><code># lvdisplay &amp;&amp; vgdisplay &amp;&amp; pvdisplay
#
</code></pre><p>Change the third partition on each physical disk to be a software RAID partition type:</p><pre tabindex=0><code>echo -e &#34;t\n3\nfd\nw\n&#34; | fdisk /dev/sda
echo -e &#34;t\n3\nfd\nw\n&#34; | fdisk /dev/sdb
echo -e &#34;t\n3\nfd\nw\n&#34; | fdisk /dev/sdc
echo -e &#34;t\n3\nfd\nw\n&#34; | fdisk /dev/sdd
</code></pre><p>Stop here and reboot your XenServer box to pick up the new partition changes. Once the server comes back from the reboot, start up a software RAID volume with <code>mdadm</code>:</p><pre tabindex=0><code>// RAID 1 for two drives
mdadm --create /dev/md0 -l 1 -n 2 /dev/sda3 /dev/sdb3
// RAID 10 for four drives
mdadm --create /dev/md0 -l 10 -n 4 /dev/sda3 /dev/sdb3 /dev/sdc3 /dev/sdd3
</code></pre><p>Check to see that your RAID array is building:</p><pre tabindex=0><code># cat /proc/mdstat
Personalities : [raid10]
md0 : active raid10 sdd3[3] sdc3[2] sdb3[1] sda3[0]
      228690432 blocks 64K chunks 2 near-copies [4/4] [UUUU]
      [&gt;....................]  resync =  0.3% (694272/228690432) finish=16.4min speed=231424K/sec
</code></pre><p>Although you don&rsquo;t have to wait for the resync to complete, just be aware that XenServer doesn&rsquo;t do well with a lot of disk I/O within dom0. You may notice unusually slow performance in dom0 until it finishes. Save the array&rsquo;s configuration for reboots:</p><pre tabindex=0><code> /etc/mdadm.conf
</code></pre><p>Edit the <code>/etc/mdadm.conf</code> file and append <code>auto=yes</code> to the end of the line (but leave everything on one line):</p><pre tabindex=0><code>ARRAY /dev/md0 level=raid10 num-devices=4 metadata=0.90 \
  UUID=2876748c:5117eed5:ce4d62d3:9592bd84 auto=yes
</code></pre><p>Create a new storage repository on the RAID volume with thin provisioning (thanks to <a href=http://www.scriptkiddie.org/blog/2010/06/20/xenserver-5-6-thin-provisioning-with-ext3/>Spherical Chicken</a> for the command):</p><pre tabindex=0><code>xe sr-create content-type=user type=ext device-config:device=/dev/md0 shared=false name-label=&#34;Local storage&#34;
</code></pre><p>This command takes some time to complete since it makes logical volumes and then makes an ext3 filesystem for the new storage repository. Bigger RAID arrays will take more time and it&rsquo;s guaranteed to take longer than you&rsquo;d expect if your RAID array is still building. As soon as it completes, you&rsquo;ll be given the uuid of your new storage repository and it should appear within the XenCenter interface.</p><p>TIP: If you run into any problems during reboots, open <code>/boot/extlinux.conf</code> and remove <code>splash</code> and <code>quiet</code> from the <code>label xe</code> boot section. This removes the framebuffer during boot-up and it causes a lot more output to be printed to the console. It won&rsquo;t affect the display once your XenServer box has fully booted.</p></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group" href=/2012/01/13/xenserver-6-disable-gpt-and-get-a-larger-root-partition/><span class="mr-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">XenServer 6: Disable GPT and get a larger root partition</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2012-01-13 15:00:10 +0000 UTC">13 January 2012</time></span></span></a></span>
<span><a class="flex text-right group" href=/2012/01/25/getting-started-with-selinux/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Getting started with SELinux</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2012-01-26 04:28:41 +0000 UTC">26 January 2012</time></span></span>
<span class="ml-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div class="absolute top-[100vh] ltr:right-0 rtl:left-0 w-12 pointer-events-none bottom-0"><a href=#the-top class="w-12 h-12 sticky pointer-events-auto top-[calc(100vh-5.5rem)] bg-neutral/50 dark:bg-neutral-800/50 backdrop-blur rounded-full text-xl flex items-center justify-center text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">All content licensed <a href=https://creativecommons.org/licenses/by-sa/4.0/>CC-BY-SA</a></p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://git.io/hugo-congo target=_blank rel="noopener noreferrer">Congo</a></p></div></div></footer><div id=search-wrapper class="fixed inset-0 z-50 flex flex-col p-4 sm:p-6 md:p-[10vh] lg:p-[12vh] w-screen h-screen cursor-default bg-neutral-500/50 backdrop-blur-sm dark:bg-neutral-900/50 invisible" data-url=https://major.io/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg border-neutral-200 top-20 bg-neutral dark:bg-neutral-800 dark:border-neutral-700"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-transparent focus:outline-2" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>