<!doctype html><html lang=en-us><head><meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://major.io/favicon.ico><title>MySQLâ€™s query cache explained | Major Hayden's Blog ðŸ¤ </title><meta name=title content="MySQLâ€™s query cache explained"><meta name=description content="An often misused and misunderstood aspect of MySQL is the query cache. I&rsquo;ve seen blog post after blog post online talking about query caching as the most integral and important feature in MySQL. Many of these same posts advocate cranking the variables to the max to give you &ldquo;ultimate performance.&rdquo; One of the worst things you can do to a MySQL server is crank your variables up and hope for the best."><meta name=keywords content="database,"><meta property="og:title" content="MySQLâ€™s query cache explained"><meta property="og:description" content="An often misused and misunderstood aspect of MySQL is the query cache. I&rsquo;ve seen blog post after blog post online talking about query caching as the most integral and important feature in MySQL. Many of these same posts advocate cranking the variables to the max to give you &ldquo;ultimate performance.&rdquo; One of the worst things you can do to a MySQL server is crank your variables up and hope for the best."><meta property="og:type" content="article"><meta property="og:url" content="https://major.io/2007/08/08/mysqls-query-cache-explained/"><meta property="og:image" content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2007-08-09T01:42:58+00:00"><meta property="article:modified_time" content="2007-08-09T01:42:58+00:00"><meta property="og:site_name" content="Major Hayden's Blog ðŸ¤ "><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta name=twitter:title content="MySQLâ€™s query cache explained"><meta name=twitter:description content="An often misused and misunderstood aspect of MySQL is the query cache. I&rsquo;ve seen blog post after blog post online talking about query caching as the most integral and important feature in MySQL. Many of these same posts advocate cranking the variables to the max to give you &ldquo;ultimate performance.&rdquo; One of the worst things you can do to a MySQL server is crank your variables up and hope for the best."><meta name=twitter:site content="@mhayden"><meta itemprop=name content="MySQLâ€™s query cache explained"><meta itemprop=description content="An often misused and misunderstood aspect of MySQL is the query cache. I&rsquo;ve seen blog post after blog post online talking about query caching as the most integral and important feature in MySQL. Many of these same posts advocate cranking the variables to the max to give you &ldquo;ultimate performance.&rdquo; One of the worst things you can do to a MySQL server is crank your variables up and hope for the best."><meta itemprop=datePublished content="2007-08-09T01:42:58+00:00"><meta itemprop=dateModified content="2007-08-09T01:42:58+00:00"><meta itemprop=wordCount content="885"><meta itemprop=image content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta itemprop=keywords content="database,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:820px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px}div.highlight code{background-color:unset;color:initial}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style></head><body><header><a href=../../../../ class=title><h2>Major Hayden's Blog ðŸ¤ </h2></a><nav><a href=../../../../>Home</a>
<a href=../../../../ham-radio-faq>Ham Radio</a>
<a href=../../../../icanhazip-com-faq>icanhazip FAQ</a>
<a href=../../../../posts>Posts</a></nav><script async src=https://media.ethicalads.io/media/client/ethicalads.min.js></script><div data-ea-publisher=major-io data-ea-type=text></div></header><main><h1>MySQLâ€™s query cache explained</h1><i><time datetime=2007-08-09 pubdate>2007-08-09</time></i>
<content><p>An often misused and misunderstood aspect of MySQL is the query cache. I&rsquo;ve seen blog post after blog post online talking about query caching as the most integral and important feature in MySQL. Many of these same posts advocate cranking the variables to the max to give you &ldquo;ultimate performance.&rdquo; One of the worst things you can do to a MySQL server is crank your variables up and hope for the best. I&rsquo;ll try to clear some things up here.</p><p>The MySQL query cache is available in MySQL 4.0, 4.1, 5.0, 5.1, and 6.0 (3.23 has no query cache). The goal of the query cache is to hold result sets that are retrieved repeatedly. Since the data is held in memory, MySQL only feeds the data from memory (which is fast) into your application without digging into the tables themselves (which is slow). The result set from the query you&rsquo;re running and the query in the query cache must be completely identical, or MySQL will pull the data as it traditionally does from the tables.</p><p>Queries and result sets must meet certain criteria to make it into the query cache:</p><ul><li>Must not be prepared statements (See 12.7. <a href=http://dev.mysql.com/doc/refman/5.0/en/sqlps.html>SQL Syntax for Prepared Statements</a>)</li><li>Subqueries are not cached, only the outer query is cached</li><li>Queries that are run from stored procedures, functions, or triggers are not cached (applies to versions 5.0+ only)</li><li>The result set must be equal to or smaller than the query_cache_limit (more on this below)</li><li>The query cannot refer to the mysql database</li><li>Queries cannot use user variables, user-defined functions, temporary tables or tables with column-level privileges</li></ul><p>Besides these rules, all other queries are approved to enter the query cache. This includes wild things such as views, joins, and queries with subqueries.</p><p>The MySQL query cache is controlled by several variables:</p><ul><li><strong>query_alloc_block_size</strong> (defaults to 8192): the actual size of the memory blocks created for result sets in the query cache (don&rsquo;t adjust)</li><li><strong>query_cache_limit</strong> (defaults to 1048576): queries with result sets larger than this won&rsquo;t make it into the query cache</li><li><strong>query_cache_min_res_unit</strong> (defaults to 4096): the smallest size (in bytes) for blocks in the query cache (don&rsquo;t adjust)</li><li><strong>query_cache_size</strong> (defaults to 0): the total size of the query cache (disables query cache if equal to 0)</li><li><strong>query_cache_type</strong> (defaults to 1): 0 means don&rsquo;t cache, 1 means cache everything, 2 means only cache result sets on demand</li><li><strong>query_cache_wlock_invalidate</strong> (defaults to FALSE): allows SELECTS to run from query cache even though the MyISAM table is locked for writing</li></ul><p>Explaining the query_cache_type is a little rough. If the query_cache_type is 0:</p><ul><li>and the query_cache_size is 0: no memory is allocated and the cache is disabled</li><li>and the query_cache_size is greater than 0: the memory <strong>is</strong> allocated but the cache is disabled</li></ul><p>If the query_cache_type is 1:</p><ul><li>and the query_cache_size is 0: no memory is allocated and the cache is disabled</li><li>and the query_cache_size is greater than 0: the cache is enabled and all queries that don&rsquo;t use <a href=http://dev.mysql.com/doc/refman/5.0/en/query-cache-in-select.html>SQL_NO_CACHE</a> will be cached automatically</li></ul><p>If the query_cache_type is 2:</p><ul><li>and the query_cache_size is 0: no memory is allocated and the cache is disabled</li><li>and the query_cache_size is greater than 0: the cache is enabled and queries must use <a href=http://dev.mysql.com/doc/refman/5.0/en/query-cache-in-select.html>SQL_CACHE</a> to be cached</li></ul><p>Now that we have the variables behind us, how can we tell if we&rsquo;re using the query cache appropriately? Each time a query runs against the query cache, the server will increment the Qcache_hits status variable instead of Com_select (which is incremented when a normal SELECT runs). If the table changes for any reason, its data is rendered invalid and is dropped from the query cache.</p><p>It&rsquo;s vital to understand the performance implications of the query cache:</p><p><strong>Purging the cache</strong></p><p>If the query cache fills completely, it will be flushed entirely - this is a significant performance hit as many memory addresses will have to be adjusted. Check your Qcache_lowmem_prunes in your status variables and increase the query_cache_size if you find yourself pruning the query cache more than a few times per hour.</p><p><strong>Query cache utilization</strong></p><p>There&rsquo;s a simple formula to calculate your query cache efficiency in percentage form:</p><p><code>Qcache_hits / (Com_select + Qcache_hits) x 100</code></p><p>A query cache efficiency percentage of 20% or less points to a performance problem. You may want to shrink your result sets by building more restrictive queries. If that isn&rsquo;t possible, then you can increase your query_cache_limit so that more of your larger result sets actually make it into the cache. Keep in mind, however, that this will increase your prunes (see the previous paragraph) and can reduce performance. Increasing the query_cache_limit by small amounts and then recalculating your efficiency is a good idea.</p><p><strong>Fighting fragmentation</strong></p><p>As queries move in and out of the query cache, the memory may become fragmented. This is normally signified by an increase in slow queries, but your query cache efficiency percentage still remains high. In this situation, run <code>FLUSH QUERY CACHE</code> from the MySQL client and keep monitoring your efficiency. If this doesn&rsquo;t help, you may be better off flushing the cache entirely with <code>RESET QUERY CACHE</code>.</p><blockquote><p>I&rsquo;ve tried to piece quite a bit of documentation and DBA knowledge into this article, but you may benefit from reviewing the following documentation sections on MySQL.com: <a href=http://dev.mysql.com/doc/refman/5.0/en/server-system-variables.html>5.2.3. System Variables</a>, <a href=http://dev.mysql.com/doc/refman/5.0/en/server-status-variables.html>5.2.5 Status Variables</a>, and <a href=http://dev.mysql.com/doc/refman/5.0/en/query-cache.html>6.5.4. The MySQL Query Cache</a>.</p></blockquote></content><p><a href=https://major.io/tags/database/>#database</a></p></main><footer><hr>CC-BY-SA 4.0 &#187;
Made with <a href=https://gohugo.io/>Hugo</a> &#187;
Theme based on <a href=https://github.com/janraasch/hugo-bearblog/>Hugo Ê•â€¢á´¥â€¢Ê” Bear</a><br></footer></body></html>