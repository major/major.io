<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Major Hayden"><meta name=description content="An often misused and misunderstood aspect of MySQL is the query cache. I&amp;rsquo;ve seen blog post after blog post online talking about query caching as the most integral and important feature in MySQL. Many of these same posts advocate cranking the variables to the max to give you &amp;ldquo;ultimate performance.&amp;rdquo; One of the worst things you can do to a MySQL server is crank your variables up and hope for the best."><meta name=keywords content=",database"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://major.io/2007/08/08/mysqls-query-cache-explained/><title>MySQLâ€™s query cache explained :: Major Hayden ðŸ¤  â€” Words of wisdom from a social nerd</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=../../../../main.89fa80e2143f71bd5c96a7c94e531dec3276a367e22f87e74a76026ab64680bf.css><link rel=apple-touch-icon sizes=180x180 href=../../../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../../favicon-16x16.png><link rel=manifest href=../../../../site.webmanifest><link rel=mask-icon href=../../../../safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=../../../../favicon.ico><meta name=msapplication-TileColor content="#252627"><meta name=theme-color content="#252627"><meta itemprop=name content="MySQLâ€™s query cache explained"><meta itemprop=description content="An often misused and misunderstood aspect of MySQL is the query cache. I&rsquo;ve seen blog post after blog post online talking about query caching as the most integral and important feature in MySQL. Many of these same posts advocate cranking the variables to the max to give you &ldquo;ultimate performance.&rdquo; One of the worst things you can do to a MySQL server is crank your variables up and hope for the best."><meta itemprop=datePublished content="2007-08-09T01:42:58+00:00"><meta itemprop=dateModified content="2007-08-09T01:42:58+00:00"><meta itemprop=wordCount content="885"><meta itemprop=image content="https://major.io"><meta itemprop=keywords content="database,"><meta property="article:published_time" content="2007-08-09 01:42:58 +0000 UTC"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="MySQLâ€™s query cache explained :: Major Hayden ðŸ¤ "><meta name=twitter:description content><meta name=twitter:site content="https://major.io"><meta name=twitter:creator content="Major Hayden"><meta name=twitter:image content><style type=text/css>html{letter-spacing:unset}</style></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=../../../../ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ echo major.io</span>
<span class=logo__cursor style=visibility:hidden></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=../../../../ham-radio-faq>hamradio</a></li><li><a href=../../../../icanhazip-com-faq>icanhazip</a></li><li><a href=../../../../posts/>posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://major.io/2007/08/08/mysqls-query-cache-explained/>MySQLâ€™s query cache explained</a></h2><div class=post-content><p>An often misused and misunderstood aspect of MySQL is the query cache. I&rsquo;ve seen blog post after blog post online talking about query caching as the most integral and important feature in MySQL. Many of these same posts advocate cranking the variables to the max to give you &ldquo;ultimate performance.&rdquo; One of the worst things you can do to a MySQL server is crank your variables up and hope for the best. I&rsquo;ll try to clear some things up here.</p><p>The MySQL query cache is available in MySQL 4.0, 4.1, 5.0, 5.1, and 6.0 (3.23 has no query cache). The goal of the query cache is to hold result sets that are retrieved repeatedly. Since the data is held in memory, MySQL only feeds the data from memory (which is fast) into your application without digging into the tables themselves (which is slow). The result set from the query you&rsquo;re running and the query in the query cache must be completely identical, or MySQL will pull the data as it traditionally does from the tables.</p><p>Queries and result sets must meet certain criteria to make it into the query cache:</p><ul><li>Must not be prepared statements (See 12.7. <a href=http://dev.mysql.com/doc/refman/5.0/en/sqlps.html>SQL Syntax for Prepared Statements</a>)</li><li>Subqueries are not cached, only the outer query is cached</li><li>Queries that are run from stored procedures, functions, or triggers are not cached (applies to versions 5.0+ only)</li><li>The result set must be equal to or smaller than the query_cache_limit (more on this below)</li><li>The query cannot refer to the mysql database</li><li>Queries cannot use user variables, user-defined functions, temporary tables or tables with column-level privileges</li></ul><p>Besides these rules, all other queries are approved to enter the query cache. This includes wild things such as views, joins, and queries with subqueries.</p><p>The MySQL query cache is controlled by several variables:</p><ul><li><strong>query_alloc_block_size</strong> (defaults to 8192): the actual size of the memory blocks created for result sets in the query cache (don&rsquo;t adjust)</li><li><strong>query_cache_limit</strong> (defaults to 1048576): queries with result sets larger than this won&rsquo;t make it into the query cache</li><li><strong>query_cache_min_res_unit</strong> (defaults to 4096): the smallest size (in bytes) for blocks in the query cache (don&rsquo;t adjust)</li><li><strong>query_cache_size</strong> (defaults to 0): the total size of the query cache (disables query cache if equal to 0)</li><li><strong>query_cache_type</strong> (defaults to 1): 0 means don&rsquo;t cache, 1 means cache everything, 2 means only cache result sets on demand</li><li><strong>query_cache_wlock_invalidate</strong> (defaults to FALSE): allows SELECTS to run from query cache even though the MyISAM table is locked for writing</li></ul><p>Explaining the query_cache_type is a little rough. If the query_cache_type is 0:</p><ul><li>and the query_cache_size is 0: no memory is allocated and the cache is disabled</li><li>and the query_cache_size is greater than 0: the memory <strong>is</strong> allocated but the cache is disabled</li></ul><p>If the query_cache_type is 1:</p><ul><li>and the query_cache_size is 0: no memory is allocated and the cache is disabled</li><li>and the query_cache_size is greater than 0: the cache is enabled and all queries that don&rsquo;t use <a href=http://dev.mysql.com/doc/refman/5.0/en/query-cache-in-select.html>SQL_NO_CACHE</a> will be cached automatically</li></ul><p>If the query_cache_type is 2:</p><ul><li>and the query_cache_size is 0: no memory is allocated and the cache is disabled</li><li>and the query_cache_size is greater than 0: the cache is enabled and queries must use <a href=http://dev.mysql.com/doc/refman/5.0/en/query-cache-in-select.html>SQL_CACHE</a> to be cached</li></ul><p>Now that we have the variables behind us, how can we tell if we&rsquo;re using the query cache appropriately? Each time a query runs against the query cache, the server will increment the Qcache_hits status variable instead of Com_select (which is incremented when a normal SELECT runs). If the table changes for any reason, its data is rendered invalid and is dropped from the query cache.</p><p>It&rsquo;s vital to understand the performance implications of the query cache:</p><p><strong>Purging the cache</strong></p><p>If the query cache fills completely, it will be flushed entirely - this is a significant performance hit as many memory addresses will have to be adjusted. Check your Qcache_lowmem_prunes in your status variables and increase the query_cache_size if you find yourself pruning the query cache more than a few times per hour.</p><p><strong>Query cache utilization</strong></p><p>There&rsquo;s a simple formula to calculate your query cache efficiency in percentage form:</p><p><code>Qcache_hits / (Com_select + Qcache_hits) x 100</code></p><p>A query cache efficiency percentage of 20% or less points to a performance problem. You may want to shrink your result sets by building more restrictive queries. If that isn&rsquo;t possible, then you can increase your query_cache_limit so that more of your larger result sets actually make it into the cache. Keep in mind, however, that this will increase your prunes (see the previous paragraph) and can reduce performance. Increasing the query_cache_limit by small amounts and then recalculating your efficiency is a good idea.</p><p><strong>Fighting fragmentation</strong></p><p>As queries move in and out of the query cache, the memory may become fragmented. This is normally signified by an increase in slow queries, but your query cache efficiency percentage still remains high. In this situation, run <code>FLUSH QUERY CACHE</code> from the MySQL client and keep monitoring your efficiency. If this doesn&rsquo;t help, you may be better off flushing the cache entirely with <code>RESET QUERY CACHE</code>.</p><blockquote><p>I&rsquo;ve tried to piece quite a bit of documentation and DBA knowledge into this article, but you may benefit from reviewing the following documentation sections on MySQL.com: <a href=http://dev.mysql.com/doc/refman/5.0/en/server-system-variables.html>5.2.3. System Variables</a>, <a href=http://dev.mysql.com/doc/refman/5.0/en/server-status-variables.html>5.2.5 Status Variables</a>, and <a href=http://dev.mysql.com/doc/refman/5.0/en/query-cache.html>6.5.4. The MySQL Query Cache</a>.</p></blockquote></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://major.io/tags/database/>database</a></span></p></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span><a href=https://major.io>Major Hayden</a></span>
<span><a href=https://creativecommons.org/licenses/by-sa/2.0/ target=_blank rel=noopener>CC BY-SA 2.0</a></span><span><a href=https://major.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>Djordje Atlialp</a></span></div></div></footer></div><script type=text/javascript src=../../../../bundle.min.e9f93b80e78a22e6f04cbb5f73e0f9c4ba60ff73a2a0ef85965c688f93dd1f2722a282e30e485603e4c65b1b346720e35f213435ec5556e196a97a68d097c80f.js integrity="sha512-6fk7gOeKIubwTLtfc+D5xLpg/3OioO+Fllxoj5PdHyciooLjDkhWA+TGWxs0ZyDjXyE0NexVVuGWqXpo0JfIDw=="></script></body></html>