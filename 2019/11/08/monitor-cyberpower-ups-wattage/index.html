<!doctype html><html lang=en-us><head><meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://major.io/favicon.ico><title>Monitor CyberPower UPS wattage | Major Hayden's Blog ðŸ¤ </title><meta name=title content="Monitor CyberPower UPS wattage"><meta name=description content="Monitor the power consumption of your CyberPower UPS and display the live output in your Linux desktop's status bar."><meta name=keywords content="fedora,linux,shell,ups,"><meta property="og:title" content="Monitor CyberPower UPS wattage"><meta property="og:description" content="Monitor the power consumption of your CyberPower UPS and display the live output in your Linux desktop's status bar."><meta property="og:type" content="article"><meta property="og:url" content="https://major.io/2019/11/08/monitor-cyberpower-ups-wattage/"><meta property="og:image" content="https://major.io/images/2019-11-08-cyberpower-ups.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-11-08T00:00:00+00:00"><meta property="article:modified_time" content="2019-11-08T00:00:00+00:00"><meta property="og:site_name" content="Major Hayden's Blog ðŸ¤ "><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://major.io/images/2019-11-08-cyberpower-ups.png"><meta name=twitter:title content="Monitor CyberPower UPS wattage"><meta name=twitter:description content="Monitor the power consumption of your CyberPower UPS and display the live output in your Linux desktop's status bar."><meta name=twitter:site content="@mhayden"><meta itemprop=name content="Monitor CyberPower UPS wattage"><meta itemprop=description content="Monitor the power consumption of your CyberPower UPS and display the live output in your Linux desktop's status bar."><meta itemprop=datePublished content="2019-11-08T00:00:00+00:00"><meta itemprop=dateModified content="2019-11-08T00:00:00+00:00"><meta itemprop=wordCount content="603"><meta itemprop=image content="https://major.io/images/2019-11-08-cyberpower-ups.png"><meta itemprop=keywords content="fedora,linux,shell,ups,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:820px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px}div.highlight code{background-color:unset;color:initial}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style></head><body><header><a href=../../../../ class=title><h2>Major Hayden's Blog ðŸ¤ </h2></a><nav><a href=../../../../>Home</a>
<a href=../../../../ham-radio-faq>Ham Radio</a>
<a href=../../../../icanhazip-com-faq>icanhazip FAQ</a>
<a href=../../../../posts>Posts</a></nav></header><main><h1>Monitor CyberPower UPS wattage</h1><i><time datetime=2019-11-08 pubdate>2019-11-08</time></i>
<content><p><img src=../../../../images/2019-11-08-cyberpower-ups.png alt=ups></p><p>I have a CyberPower <a href=https://www.cyberpowersystems.com/product/ups/intelligent-lcd/cp1350avrlcd/>CP1350AVRLCD</a> under my desk at home and I use it to run my
computer, monitors, speakers, and a lamp. My new computer is a little more
power hungry than my old one since I just moved to to a Ryzen 3700x and Nvidia
GeForce 2060 and I like to keep tabs on how much energy it is consuming.</p><p>Some power supplies offer a monitoring interface where you can watch your
power consumption in real time, but I&rsquo;m not willing to spend that much money.
Most CyberPower UPS units offer some pretty decent power monitoring features
right out of the box, and fortunately for us, they work quite well in Linux.</p><p>In this post, we will set up the Linux communication with the UPS and make it
easy to monitor via scripts. Also, we will add it to an existing <a href=https://github.com/polybar/polybar>polybar</a>
configuration so we can monitor it right from the desktop environment.</p><h2 id=installing-powerpanel>Installing powerpanel</h2><p>CyberPower offers software called <a href=https://www.cyberpowersystems.com/products/software/power-panel-personal/>PowerPanel</a> that runs on most Linux
distributions. It has a daemon (<code>pwrstatd</code>) and a client (<code>pwrstat</code>) that
allows you to monitor the UPS and take actions automatically when the power is
disrupted.</p><p>Download the PowerPanel RPM and install it:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>sudo dnf install ~/Downloads/powerpanel-132-0x86_64.rpm
</code></pre></div><p>As I noted in my post called <a href=../../../../2017/07/25/troubleshooting-cyberpower-powerpanel-issues-in-linux/>Troubleshooting CyberPower PowerPanel issues in
Linux</a>, we need to tell <code>pwrstatd</code> where it should communicate with the UPS.
If you skip this step, the daemon hangs without much explanation of what is
happening.</p><p>Open <code>/etc/pwrstatd.conf</code> with your favorite text editor and change the
<code>allowed_device_nodes</code> line to point to the right USB device:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#93a1a1;font-style:italic># For example: restrict to use libusb device.</span>
<span style=color:#93a1a1;font-style:italic># allowed-device-nodes = libusb</span>
<span style=color:#268bd2>allowed-device-nodes</span> = <span style=color:#2aa198>/dev/usb/hiddev0</span>
</code></pre></div><p>Unfortunately, CyberPower doesn&rsquo;t ship a systemd unit file for <code>pwrstatd</code>.
Write this unit file to <code>/etc/systemd/system/pwrstatd.service</code>:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#859900>[Unit]</span>
<span style=color:#268bd2>Description</span>=<span style=color:#2aa198>pwrstatd</span>

<span style=color:#859900>[Service]</span>
<span style=color:#268bd2>Group</span>=<span style=color:#2aa198>wheel</span>
<span style=color:#268bd2>UMask</span>=<span style=color:#2aa198>0002</span>
<span style=color:#268bd2>ExecStart</span>=<span style=color:#2aa198>/usr/sbin/pwrstatd</span>

<span style=color:#859900>[Install]</span>
<span style=color:#268bd2>WantedBy</span>=<span style=color:#2aa198>multi-user.target</span>
</code></pre></div><p>The <code>wheel</code> group should be fine here if your user is already in that group
and uses sudo. You can also change that to a different group, like <code>power</code>,
and then add your user to the <code>power</code> group.</p><p>Now we can reload systemd, start <code>pwrstatd</code>, and ensure it comes up at boot
time:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>systemctl daemon-reload
systemctl enable --now pwrstatd
</code></pre></div><h2 id=testing-the-client>Testing the client</h2><p>The <code>pwrstat</code> client is installed in <code>/usr/sbin</code> by default, but since this is
my home computer and I trust what happens there, I want to be able to run this
command as my regular user. Move the client to <code>/usr/bin</code> instead:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>mv /usr/sbin/pwrstat /usr/bin/pwrstat
</code></pre></div><p>Let&rsquo;s try getting a current status:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>$ pwrstat -status
The UPS information shows as following:

  Properties:
    Model Name...................  CP 1350C
    Firmware Number.............. BFE5107.B23
    Rating Voltage............... 120 V
    Rating Power................. 810 Watt

  Current UPS status:
    State........................ Normal
    Power Supply by.............. Utility Power
    Utility Voltage.............. 124 V
    Output Voltage............... 124 V
    Battery Capacity............. 100 %
    Remaining Runtime............ 38 min.
    Load......................... 137 Watt(17 %)
    Line Interaction............. None
    Test Result.................. Unknown
    Last Power Event............. None
</code></pre></div><h2 id=just-the-wattage-please>Just the wattage, please</h2><p>Awesome! Let&rsquo;s make a really short script that will dump just the wattage for
us:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#93a1a1;font-style:italic>#!/bin/bash
</span><span style=color:#93a1a1;font-style:italic></span>pwrstat -status | grep -oP <span style=color:#2aa198>&#34;Load\.* \K([0-9]+)(?= Watt)&#34;</span>
</code></pre></div><p>Now we can test the script:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>$ ~/bin/ups_wattage.sh
137
</code></pre></div><p>My computer (and accessories) are using 137 watts.</p><h2 id=adding-it-to-polybar>Adding it to polybar</h2><p>I use polybar as my status bar, and it&rsquo;s easy to add a custom command to the
bar. Here&rsquo;s my configuration section for my <code>ups_wattage.sh</code> script:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#859900>[module/wattage]</span>
    <span style=color:#268bd2>type</span> = <span style=color:#2aa198>custom/script
</span><span style=color:#2aa198>    exec = ~/bin/ups_wattage.sh
</span><span style=color:#2aa198>    label = &#34;ïƒ§ %output%W&#34;
</span><span style=color:#2aa198>    interval = 15
</span><span style=color:#2aa198>    format-padding = 1</span>
</code></pre></div><p>Add that to your bar (mine is on the right side):</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#859900>[bar/primary]</span>
    <span style=color:#268bd2>---SNIP---</span>
    <span style=color:#268bd2>modules-right</span> = <span style=color:#2aa198>weather cpu memory gpu filesystem wattage uptime
</span><span style=color:#2aa198>    ---SNIP---</span>
</code></pre></div><p>There&rsquo;s live power monitoring right there in my polybar!</p><p><img src=../../../../images/2019-11-08-polybar-wattage.jpg alt="polybar wattage"></p></content><p><a href=https://major.io/tags/fedora/>#fedora</a>
<a href=https://major.io/tags/linux/>#linux</a>
<a href=https://major.io/tags/shell/>#shell</a>
<a href=https://major.io/tags/ups/>#ups</a></p></main><footer><script async src=https://media.ethicalads.io/media/client/ethicalads.min.js></script><div data-ea-publisher=major-io data-ea-type=text></div><hr>CC-BY-SA 4.0 &#187;
Made with <a href=https://gohugo.io/>Hugo</a> &#187;
Theme based on <a href=https://github.com/janraasch/hugo-bearblog/>Hugo Ê•â€¢á´¥â€¢Ê” Bear</a><br></footer></body></html>