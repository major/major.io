<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Major Hayden"><meta name=description content="I have a CyberPower CP1350AVRLCD under my desk at home and I use it to run my computer, monitors, speakers, and a lamp. My new computer is a little more power hungry than my old one since I just moved to to a Ryzen 3700x and Nvidia GeForce 2060 and I like to keep tabs on how much energy it is consuming.
Some power supplies offer a monitoring interface where you can watch your power consumption in real time, but I&amp;rsquo;m not willing to spend that much money."><meta name=keywords content=",fedora,linux,shell,ups"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://major.io/2019/11/08/monitor-cyberpower-ups-wattage/><title>Monitor CyberPower UPS wattage :: Major Hayden ðŸ¤  â€” Words of wisdom from a social nerd</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=../../../../main.89fa80e2143f71bd5c96a7c94e531dec3276a367e22f87e74a76026ab64680bf.css><link rel=apple-touch-icon sizes=180x180 href=../../../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../../favicon-16x16.png><link rel=manifest href=../../../../site.webmanifest><link rel=mask-icon href=../../../../safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=../../../../favicon.ico><meta name=msapplication-TileColor content="#252627"><meta name=theme-color content="#252627"><meta itemprop=name content="Monitor CyberPower UPS wattage"><meta itemprop=description content="I have a CyberPower CP1350AVRLCD under my desk at home and I use it to run my computer, monitors, speakers, and a lamp. My new computer is a little more power hungry than my old one since I just moved to to a Ryzen 3700x and Nvidia GeForce 2060 and I like to keep tabs on how much energy it is consuming.
Some power supplies offer a monitoring interface where you can watch your power consumption in real time, but I&rsquo;m not willing to spend that much money."><meta itemprop=datePublished content="2019-11-08T00:00:00+00:00"><meta itemprop=dateModified content="2019-11-08T00:00:00+00:00"><meta itemprop=wordCount content="603"><meta itemprop=image content="https://major.io"><meta itemprop=keywords content="fedora,linux,shell,ups,"><meta property="article:section" content="Blog Posts"><meta property="article:published_time" content="2019-11-08 00:00:00 +0000 UTC"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Monitor CyberPower UPS wattage :: Major Hayden ðŸ¤ "><meta name=twitter:description content="Monitor the power consumption of your CyberPower UPS and display the live output in your Linux desktop's status bar."><meta name=twitter:site content="https://major.io"><meta name=twitter:creator content="Major Hayden"><meta name=twitter:image content="https://major.io/images/2019-11-08-cyberpower-ups.png"><style type=text/css>html{letter-spacing:unset}</style></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=../../../../ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ echo major.io</span>
<span class=logo__cursor style=visibility:hidden></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=../../../../ham-radio-faq>hamradio</a></li><li><a href=../../../../icanhazip-com-faq>icanhazip</a></li><li><a href=../../../../posts/>posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://major.io/2019/11/08/monitor-cyberpower-ups-wattage/>Monitor CyberPower UPS wattage</a></h2><div class=post-content><p><img src=../../../../images/2019-11-08-cyberpower-ups.png alt=ups></p><p>I have a CyberPower <a href=https://www.cyberpowersystems.com/product/ups/intelligent-lcd/cp1350avrlcd/>CP1350AVRLCD</a> under my desk at home and I use it to run my
computer, monitors, speakers, and a lamp. My new computer is a little more
power hungry than my old one since I just moved to to a Ryzen 3700x and Nvidia
GeForce 2060 and I like to keep tabs on how much energy it is consuming.</p><p>Some power supplies offer a monitoring interface where you can watch your
power consumption in real time, but I&rsquo;m not willing to spend that much money.
Most CyberPower UPS units offer some pretty decent power monitoring features
right out of the box, and fortunately for us, they work quite well in Linux.</p><p>In this post, we will set up the Linux communication with the UPS and make it
easy to monitor via scripts. Also, we will add it to an existing <a href=https://github.com/polybar/polybar>polybar</a>
configuration so we can monitor it right from the desktop environment.</p><h2 id=installing-powerpanel>Installing powerpanel</h2><p>CyberPower offers software called <a href=https://www.cyberpowersystems.com/products/software/power-panel-personal/>PowerPanel</a> that runs on most Linux
distributions. It has a daemon (<code>pwrstatd</code>) and a client (<code>pwrstat</code>) that
allows you to monitor the UPS and take actions automatically when the power is
disrupted.</p><p>Download the PowerPanel RPM and install it:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>sudo dnf install ~/Downloads/powerpanel-132-0x86_64.rpm
</code></pre></div><p>As I noted in my post called <a href=../../../../2017/07/25/troubleshooting-cyberpower-powerpanel-issues-in-linux/>Troubleshooting CyberPower PowerPanel issues in
Linux</a>, we need to tell <code>pwrstatd</code> where it should communicate with the UPS.
If you skip this step, the daemon hangs without much explanation of what is
happening.</p><p>Open <code>/etc/pwrstatd.conf</code> with your favorite text editor and change the
<code>allowed_device_nodes</code> line to point to the right USB device:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#586e75># For example: restrict to use libusb device.</span>
<span style=color:#586e75># allowed-device-nodes = libusb</span>
allowed-device-nodes <span style=color:#719e07>=</span> <span style=color:#2aa198>/dev/usb/hiddev0</span>
</code></pre></div><p>Unfortunately, CyberPower doesn&rsquo;t ship a systemd unit file for <code>pwrstatd</code>.
Write this unit file to <code>/etc/systemd/system/pwrstatd.service</code>:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#719e07>[Unit]</span>
Description<span style=color:#719e07>=</span><span style=color:#2aa198>pwrstatd</span>

<span style=color:#719e07>[Service]</span>
Group<span style=color:#719e07>=</span><span style=color:#2aa198>wheel</span>
UMask<span style=color:#719e07>=</span><span style=color:#2aa198>0002</span>
ExecStart<span style=color:#719e07>=</span><span style=color:#2aa198>/usr/sbin/pwrstatd</span>

<span style=color:#719e07>[Install]</span>
WantedBy<span style=color:#719e07>=</span><span style=color:#2aa198>multi-user.target</span>
</code></pre></div><p>The <code>wheel</code> group should be fine here if your user is already in that group
and uses sudo. You can also change that to a different group, like <code>power</code>,
and then add your user to the <code>power</code> group.</p><p>Now we can reload systemd, start <code>pwrstatd</code>, and ensure it comes up at boot
time:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>systemctl daemon-reload
systemctl enable --now pwrstatd
</code></pre></div><h2 id=testing-the-client>Testing the client</h2><p>The <code>pwrstat</code> client is installed in <code>/usr/sbin</code> by default, but since this is
my home computer and I trust what happens there, I want to be able to run this
command as my regular user. Move the client to <code>/usr/bin</code> instead:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>mv /usr/sbin/pwrstat /usr/bin/pwrstat
</code></pre></div><p>Let&rsquo;s try getting a current status:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>$ pwrstat -status
The UPS information shows as following:

  Properties:
    Model Name...................  CP 1350C
    Firmware Number.............. BFE5107.B23
    Rating Voltage............... 120 V
    Rating Power................. 810 Watt

  Current UPS status:
    State........................ Normal
    Power Supply by.............. Utility Power
    Utility Voltage.............. 124 V
    Output Voltage............... 124 V
    Battery Capacity............. 100 %
    Remaining Runtime............ 38 min.
    Load......................... 137 Watt(17 %)
    Line Interaction............. None
    Test Result.................. Unknown
    Last Power Event............. None
</code></pre></div><h2 id=just-the-wattage-please>Just the wattage, please</h2><p>Awesome! Let&rsquo;s make a really short script that will dump just the wattage for
us:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#719e07>#!/bin/bash
</span><span style=color:#719e07></span>pwrstat -status | grep -oP <span style=color:#2aa198>&#34;Load\.* \K([0-9]+)(?= Watt)&#34;</span>
</code></pre></div><p>Now we can test the script:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>$ ~/bin/ups_wattage.sh
137
</code></pre></div><p>My computer (and accessories) are using 137 watts.</p><h2 id=adding-it-to-polybar>Adding it to polybar</h2><p>I use polybar as my status bar, and it&rsquo;s easy to add a custom command to the
bar. Here&rsquo;s my configuration section for my <code>ups_wattage.sh</code> script:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#719e07>[module/wattage]</span>
    type <span style=color:#719e07>=</span> <span style=color:#2aa198>custom/script
</span><span style=color:#2aa198>    exec = ~/bin/ups_wattage.sh
</span><span style=color:#2aa198>    label = &#34;ïƒ§ %output%W&#34;
</span><span style=color:#2aa198>    interval = 15
</span><span style=color:#2aa198>    format-padding = 1</span>
</code></pre></div><p>Add that to your bar (mine is on the right side):</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#719e07>[bar/primary]</span>
    ---SNIP---
    modules-right <span style=color:#719e07>=</span> <span style=color:#2aa198>weather cpu memory gpu filesystem wattage uptime
</span><span style=color:#2aa198>    ---SNIP---</span>
</code></pre></div><p>There&rsquo;s live power monitoring right there in my polybar!</p><p><img src=../../../../images/2019-11-08-polybar-wattage.jpg alt="polybar wattage"></p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://major.io/tags/fedora/>fedora</a></span>
<span class=tag><a href=https://major.io/tags/linux/>linux</a></span>
<span class=tag><a href=https://major.io/tags/shell/>shell</a></span>
<span class=tag><a href=https://major.io/tags/ups/>ups</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span class=tag><a href=https://major.io/categories/blog-posts/>Blog Posts</a></span></p></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span><a href=https://major.io>Major Hayden</a></span>
<span><a href=https://creativecommons.org/licenses/by-sa/2.0/ target=_blank rel=noopener>CC BY-SA 2.0</a></span><span><a href=https://major.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>Djordje Atlialp</a></span></div></div></footer></div><script type=text/javascript src=../../../../bundle.min.9dd6c4fd1eb55000d257db1269676cdb26bfcc9ab1b1dc8885a54f94b97fa86e6d72e435907d76f8662e0f65472e78ab8ad69c36624d8d4a96c04c42e029d957.js integrity="sha512-ndbE/R61UADSV9sSaWds2ya/zJqxsdyIhaVPlLl/qG5tcuQ1kH12+GYuD2VHLniritacNmJNjUqWwExC4CnZVw=="></script></body></html>