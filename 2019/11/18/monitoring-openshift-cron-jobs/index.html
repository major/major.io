<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Major Hayden"><meta name=description content="Moving applications into an entirely containerized deployment, such as OpenShift or Kubernetes, requires care and attention. One aspect of both that is often overlooked is scheduled jobs, or cron jobs. ‚è∞
Cron jobs in OpenShift allow you to run certain containers on a regular basis and execute certain applications or scripts in those containers. You can use them to trigger GitLab CI pipelines, run certain housekeeping tasks in web applications, or run backups."><meta name=keywords content=",linux,kubernetes,openshift,shell"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://major.io/2019/11/18/monitoring-openshift-cron-jobs/><title>Monitoring OpenShift cron jobs :: Major Hayden ü§† ‚Äî Words of wisdom from a social nerd</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=../../../../main.min.5dcefbf8102eb536dd3e2de53ffebfa58599ab2435c241a0db81728a5e015f2e.css><link rel=apple-touch-icon sizes=180x180 href=../../../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../../favicon-16x16.png><link rel=manifest href=../../../../site.webmanifest><link rel=mask-icon href=../../../../safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=../../../../favicon.ico><meta name=msapplication-TileColor content="#252627"><meta name=theme-color content="#252627"><meta itemprop=name content="Monitoring OpenShift cron jobs"><meta itemprop=description content="Moving applications into an entirely containerized deployment, such as OpenShift or Kubernetes, requires care and attention. One aspect of both that is often overlooked is scheduled jobs, or cron jobs. ‚è∞
Cron jobs in OpenShift allow you to run certain containers on a regular basis and execute certain applications or scripts in those containers. You can use them to trigger GitLab CI pipelines, run certain housekeeping tasks in web applications, or run backups."><meta itemprop=datePublished content="2019-11-18T00:00:00+00:00"><meta itemprop=dateModified content="2019-11-18T00:00:00+00:00"><meta itemprop=wordCount content="521"><meta itemprop=image content="https://major.io"><meta itemprop=keywords content="linux,kubernetes,openshift,shell,"><meta property="article:section" content="Blog Posts"><meta property="article:published_time" content="2019-11-18 00:00:00 +0000 UTC"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Monitoring OpenShift cron jobs :: Major Hayden ü§†"><meta name=twitter:description content="Openshift (and Kubernetes) allow you to run jobs on schedule, but these jobs can fail from time to time. You can monitor them from bash!"><meta name=twitter:site content="https://major.io"><meta name=twitter:creator content="Major Hayden"><meta name=twitter:image content="https://major.io/images/2019-11-18-clock.png"><style type=text/css>html{letter-spacing:unset}</style></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=../../../../ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ echo major.io</span>
<span class=logo__cursor style=visibility:hidden></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://major.io/ham-radio-faq>hamradio</a></li><li><a href=https://major.io/icanhazip-com-faq>icanhazip</a></li><li><a href=https://major.io/posts/>posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://major.io/2019/11/18/monitoring-openshift-cron-jobs/>Monitoring OpenShift cron jobs</a></h2><div class=post-content><p><img src=../../../../images/2019-11-18-clock.jpg alt=clock></p><p>Moving applications into an entirely containerized deployment, such as
OpenShift or Kubernetes, requires care and attention. One aspect of both that
is often overlooked is scheduled jobs, or cron jobs. ‚è∞</p><p>Cron jobs in OpenShift allow you to run certain containers on a regular basis
and execute certain applications or scripts in those containers. You can use
them to trigger GitLab CI pipelines, run certain housekeeping tasks in web
applications, or run backups.</p><p>This post will cover a quick example of a cron job and how to monitor it.</p><p><em>Note: Almost all of these commands will work in a Kubernetes deployment by
changing <code>oc</code> to <code>kubectl</code>, but your mileage may vary based on your Kubernetes
version. All of these commands were tested on OpenShift 3.11.</em></p><h2 id=add-a-job>Add a job</h2><p>Here is a really simple cron job that gets the current date:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#586e75># cronjob.yml</span>
<span style=color:#268bd2>apiVersion</span>: batch/v1beta1
<span style=color:#268bd2>kind</span>: CronJob
<span style=color:#268bd2>metadata</span>:
  <span style=color:#268bd2>name</span>: get-date
<span style=color:#268bd2>spec</span>:
  <span style=color:#268bd2>schedule</span>: <span style=color:#2aa198>&#34;*/1 * * * *&#34;</span>
  <span style=color:#268bd2>jobTemplate</span>:
    <span style=color:#268bd2>spec</span>:
      <span style=color:#268bd2>template</span>:
        <span style=color:#268bd2>spec</span>:
          <span style=color:#268bd2>containers</span>:
          - <span style=color:#268bd2>name</span>: get-date
            <span style=color:#268bd2>image</span>: docker.io/library/fedora:31
            <span style=color:#268bd2>command</span>:
              - date
</code></pre></div><p>The job definition says:</p><ul><li>Start a Fedora 31 container every minute</li><li>Run <code>date</code> in the container</li><li>Kill the container</li></ul><p>Load this into OpenShift with: <code>oc apply -f cronjob.yml</code></p><p>If you want to make more complex jobs, review the <a href=https://docs.openshift.com/container-platform/3.11/dev_guide/cron_jobs.html>OpenShift documentation on
cron job objects</a>. The <a href=https://docs.openshift.com/container-platform/3.11/rest_api/apis-batch/v2alpha1.CronJob.html>cron job API documentation</a> has much more detail.</p><h2 id=bad-things-happen-to-good-cron-jobs>Bad things happen to good cron jobs</h2><p>Cron jobs come with certain limitations and these are explained in the
<a href=https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/>Kuberntes documentation on cron jobs</a>. If a cron job is <em>missed</em> for a
certain period of time, the scheduler will think something has gone horribly
wrong and it won&rsquo;t schedule new jobs.</p><p>These situations include:</p><ul><li><p>the container takes too long to start
(check <code>.spec.startingDeadlineSeconds</code>)</p></li><li><p>one run of the job takes a very long time and another job can&rsquo;t start
(usually when <code>concurrencyPolicy</code> is set to <code>Forbid</code>)</p></li></ul><p>If 100 of the jobs are missed, the scheduler will not start any new jobs. This
could be a disaster for your application and it&rsquo;s a good place to add
monitoring.</p><h2 id=monitor-missed-cron-jobs-with-bash>Monitor missed cron jobs with bash</h2><p>Luckily, OpenShift makes an API available for checking on these situations
where cron jobs are missed. The API sits under the following URI:
<code>/apis/batch/v1beta1/namespaces/$NAMESPACE/cronjobs/$JOBNAME</code></p><p>For our <code>get-date</code> example above, this would be:
<code>/apis/batch/v1beta1/namespaces/$NAMESPACE/cronjobs/get-date</code></p><p>We can monitor this job using two handy tools: <code>curl</code> and <code>jq</code>.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#719e07>#!/bin/bash
</span><span style=color:#719e07></span>
<span style=color:#586e75># Get unix time stamp of a last job run.</span>
<span style=color:#268bd2>LAST_RUN_DATE</span><span style=color:#719e07>=</span><span style=color:#719e07>$(</span>
  curl -s -H <span style=color:#2aa198>&#34;Authorization: Bearer </span><span style=color:#268bd2>$YOUR_BEARER_TOKEN</span><span style=color:#2aa198>&#34;</span> <span style=color:#cb4b16>\
</span><span style=color:#cb4b16></span>    https://openshift.example.com/apis/batch/v1beta1/namespaces/<span style=color:#268bd2>$NAMESPACE</span>/cronjobs/get-date | <span style=color:#cb4b16>\
</span><span style=color:#cb4b16></span>    jq  <span style=color:#2aa198>&#34;.status.lastScheduleTime | strptime(\&#34;%Y-%m-%dT%H:%M:%SZ\&#34;) | mktime&#34;</span>
<span style=color:#719e07>)</span>

<span style=color:#586e75># Get current unix time stamp</span>
<span style=color:#268bd2>CURRENT_DATE</span><span style=color:#719e07>=</span><span style=color:#719e07>$(</span>date +%s<span style=color:#719e07>)</span>

<span style=color:#586e75># How many minutes since the last run?</span>
<span style=color:#268bd2>MINUTES_SINCE_LAST_RUN</span><span style=color:#719e07>=</span><span style=color:#719e07>$((</span><span style=color:#719e07>(</span><span style=color:#268bd2>$CURRENT_DATE</span> <span style=color:#719e07>-</span> <span style=color:#268bd2>$LAST_RUN_DATE</span><span style=color:#719e07>)</span> <span style=color:#719e07>/</span> <span style=color:#2aa198>60</span><span style=color:#719e07>))</span>

<span style=color:#268bd2>DETAIL</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#34;(last run </span><span style=color:#268bd2>$MINUTES_SINCE_LAST_RUN</span><span style=color:#2aa198> minute(s) ago)&#34;</span>
<span style=color:#719e07>if</span> <span style=color:#719e07>[[</span> <span style=color:#268bd2>$MINUTES_SINCE_LAST_RUN</span> -ge <span style=color:#2aa198>2</span> <span style=color:#719e07>]]</span>; <span style=color:#719e07>then</span>
  <span style=color:#b58900>echo</span> -n <span style=color:#2aa198>&#34;FAIL </span><span style=color:#2aa198>${</span><span style=color:#268bd2>DETAIL</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>
  <span style=color:#b58900>exit</span> <span style=color:#2aa198>1</span>
<span style=color:#719e07>else</span>
  <span style=color:#b58900>echo</span> -n <span style=color:#2aa198>&#34;OK </span><span style=color:#2aa198>${</span><span style=color:#268bd2>DETAIL</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>
  <span style=color:#b58900>exit</span> <span style=color:#2aa198>0</span>
<span style=color:#719e07>fi</span>
</code></pre></div><p><em>Note: Getting tokens for the curl request is covered in <a href=https://docs.openshift.com/container-platform/3.11/rest_api/index.html#rest-api-authentication>OpenShift&rsquo;s
Authentication documentation</a>.</em></p><p>If the cron job is running normally, the script output should be:</p><pre><code class=language-test data-lang=test>$ ./check-cron-job.sh
OK (last run 0 minute(s) ago)
$ echo $?
0
</code></pre><p>And when things go wrong:</p><pre><code class=language-test data-lang=test>$ ./check-cron-job.sh
FAIL (last run 22 minute(s) ago)
$ echo $?
1
</code></pre><p><em>Photo credit: <a href=https://pxhere.com/en/photo/757871>pxhere</a></em></p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://major.io/tags/linux>linux</a></span><span class=tag><a href=https://major.io/tags/kubernetes>kubernetes</a></span><span class=tag><a href=https://major.io/tags/openshift>openshift</a></span><span class=tag><a href=https://major.io/tags/shell>shell</a></span></p></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span><a href=https://major.io>Major Hayden</a></span>
<span><a href=https://creativecommons.org/licenses/by-sa/2.0/ target=_blank rel=noopener>CC BY-SA 2.0</a></span>
<span><a href=https://major.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>rhazdon</a></span></div></div></footer></div><script type=text/javascript src=../../../../bundle.min.2d5469329143160ae2456a69c3c76dc2d0a3b212b46afe291a51bd68650ed6f8697e001dab54f1c272c77ce08092a8c55e5bb4314e0ee334aab4b927ec896638.js integrity="sha512-LVRpMpFDFgriRWppw8dtwtCjshK0av4pGlG9aGUO1vhpfgAdq1TxwnLHfOCAkqjFXlu0MU4O4zSqtLkn7IlmOA=="></script></body></html>