<!doctype html><html lang=en-us><head><meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://major.io/favicon.ico><title>Monitoring OpenShift cron jobs | Major Hayden's Blog ü§†</title><meta name=title content="Monitoring OpenShift cron jobs"><meta name=description content="Openshift (and Kubernetes) allow you to run jobs on schedule, but these jobs can fail from time to time. You can monitor them from bash!"><meta name=keywords content="linux,kubernetes,openshift,shell,"><meta property="og:title" content="Monitoring OpenShift cron jobs"><meta property="og:description" content="Openshift (and Kubernetes) allow you to run jobs on schedule, but these jobs can fail from time to time. You can monitor them from bash!"><meta property="og:type" content="article"><meta property="og:url" content="https://major.io/2019/11/18/monitoring-openshift-cron-jobs/"><meta property="og:image" content="https://major.io/images/2019-11-18-clock.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-11-18T00:00:00+00:00"><meta property="article:modified_time" content="2019-11-18T00:00:00+00:00"><meta property="og:site_name" content="Major Hayden's Blog ü§†"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://major.io/images/2019-11-18-clock.png"><meta name=twitter:title content="Monitoring OpenShift cron jobs"><meta name=twitter:description content="Openshift (and Kubernetes) allow you to run jobs on schedule, but these jobs can fail from time to time. You can monitor them from bash!"><meta name=twitter:site content="@mhayden"><meta itemprop=name content="Monitoring OpenShift cron jobs"><meta itemprop=description content="Openshift (and Kubernetes) allow you to run jobs on schedule, but these jobs can fail from time to time. You can monitor them from bash!"><meta itemprop=datePublished content="2019-11-18T00:00:00+00:00"><meta itemprop=dateModified content="2019-11-18T00:00:00+00:00"><meta itemprop=wordCount content="521"><meta itemprop=image content="https://major.io/images/2019-11-18-clock.png"><meta itemprop=keywords content="linux,kubernetes,openshift,shell,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:820px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px}div.highlight code{background-color:unset;color:initial}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style></head><body><header><a href=../../../../ class=title><h2>Major Hayden's Blog ü§†</h2></a><nav><a href=../../../../>Home</a>
<a href=../../../../ham-radio-faq>Ham Radio</a>
<a href=../../../../icanhazip-com-faq>icanhazip FAQ</a>
<a href=../../../../posts>Posts</a></nav></header><main><h1>Monitoring OpenShift cron jobs</h1><i><time datetime=2019-11-18 pubdate>2019-11-18</time></i>
<content><p><img src=../../../../images/2019-11-18-clock.jpg alt=clock></p><p>Moving applications into an entirely containerized deployment, such as
OpenShift or Kubernetes, requires care and attention. One aspect of both that
is often overlooked is scheduled jobs, or cron jobs. ‚è∞</p><p>Cron jobs in OpenShift allow you to run certain containers on a regular basis
and execute certain applications or scripts in those containers. You can use
them to trigger GitLab CI pipelines, run certain housekeeping tasks in web
applications, or run backups.</p><p>This post will cover a quick example of a cron job and how to monitor it.</p><p><em>Note: Almost all of these commands will work in a Kubernetes deployment by
changing <code>oc</code> to <code>kubectl</code>, but your mileage may vary based on your Kubernetes
version. All of these commands were tested on OpenShift 3.11.</em></p><h2 id=add-a-job>Add a job</h2><p>Here is a really simple cron job that gets the current date:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#93a1a1;font-style:italic># cronjob.yml</span>
<span style=color:#268bd2;font-weight:700>apiVersion</span>: <span style=color:#2aa198>batch/v1beta1</span>
<span style=color:#268bd2;font-weight:700>kind</span>: <span style=color:#2aa198>CronJob</span>
<span style=color:#268bd2;font-weight:700>metadata</span>:
  <span style=color:#268bd2;font-weight:700>name</span>: <span style=color:#2aa198>get-date</span>
<span style=color:#268bd2;font-weight:700>spec</span>:
  <span style=color:#268bd2;font-weight:700>schedule</span>: <span style=color:#2aa198>&#34;*/1 * * * *&#34;</span>
  <span style=color:#268bd2;font-weight:700>jobTemplate</span>:
    <span style=color:#268bd2;font-weight:700>spec</span>:
      <span style=color:#268bd2;font-weight:700>template</span>:
        <span style=color:#268bd2;font-weight:700>spec</span>:
          <span style=color:#268bd2;font-weight:700>containers</span>:
          - <span style=color:#268bd2;font-weight:700>name</span>: <span style=color:#2aa198>get-date</span>
            <span style=color:#268bd2;font-weight:700>image</span>: <span style=color:#2aa198>docker.io/library/fedora:31</span>
            <span style=color:#268bd2;font-weight:700>command</span>:
              - <span style=color:#2aa198>date</span>
</code></pre></div><p>The job definition says:</p><ul><li>Start a Fedora 31 container every minute</li><li>Run <code>date</code> in the container</li><li>Kill the container</li></ul><p>Load this into OpenShift with: <code>oc apply -f cronjob.yml</code></p><p>If you want to make more complex jobs, review the <a href=https://docs.openshift.com/container-platform/3.11/dev_guide/cron_jobs.html>OpenShift documentation on
cron job objects</a>. The <a href=https://docs.openshift.com/container-platform/3.11/dev_guide/cron_jobs.html>cron job API documentation</a> has much more detail.</p><h2 id=bad-things-happen-to-good-cron-jobs>Bad things happen to good cron jobs</h2><p>Cron jobs come with certain limitations and these are explained in the
<a href=https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/>Kuberntes documentation on cron jobs</a>. If a cron job is <em>missed</em> for a
certain period of time, the scheduler will think something has gone horribly
wrong and it won&rsquo;t schedule new jobs.</p><p>These situations include:</p><ul><li><p>the container takes too long to start
(check <code>.spec.startingDeadlineSeconds</code>)</p></li><li><p>one run of the job takes a very long time and another job can&rsquo;t start
(usually when <code>concurrencyPolicy</code> is set to <code>Forbid</code>)</p></li></ul><p>If 100 of the jobs are missed, the scheduler will not start any new jobs. This
could be a disaster for your application and it&rsquo;s a good place to add
monitoring.</p><h2 id=monitor-missed-cron-jobs-with-bash>Monitor missed cron jobs with bash</h2><p>Luckily, OpenShift makes an API available for checking on these situations
where cron jobs are missed. The API sits under the following URI:
<code>/apis/batch/v1beta1/namespaces/$NAMESPACE/cronjobs/$JOBNAME</code></p><p>For our <code>get-date</code> example above, this would be:
<code>/apis/batch/v1beta1/namespaces/$NAMESPACE/cronjobs/get-date</code></p><p>We can monitor this job using two handy tools: <code>curl</code> and <code>jq</code>.</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#93a1a1;font-style:italic>#!/bin/bash
</span><span style=color:#93a1a1;font-style:italic></span>
<span style=color:#93a1a1;font-style:italic># Get unix time stamp of a last job run.</span>
<span style=color:#268bd2>LAST_RUN_DATE</span>=<span style=color:#859900>$(</span>
  curl -s -H <span style=color:#2aa198>&#34;Authorization: Bearer </span><span style=color:#268bd2>$YOUR_BEARER_TOKEN</span><span style=color:#2aa198>&#34;</span> <span style=color:#2aa198>\
</span><span style=color:#2aa198></span>    https://openshift.example.com/apis/batch/v1beta1/namespaces/<span style=color:#268bd2>$NAMESPACE</span>/cronjobs/get-date | <span style=color:#2aa198>\
</span><span style=color:#2aa198></span>    jq  <span style=color:#2aa198>&#34;.status.lastScheduleTime | strptime(\&#34;%Y-%m-%dT%H:%M:%SZ\&#34;) | mktime&#34;</span>
<span style=color:#859900>)</span>

<span style=color:#93a1a1;font-style:italic># Get current unix time stamp</span>
<span style=color:#268bd2>CURRENT_DATE</span>=<span style=color:#859900>$(</span>date +%s<span style=color:#859900>)</span>

<span style=color:#93a1a1;font-style:italic># How many minutes since the last run?</span>
<span style=color:#268bd2>MINUTES_SINCE_LAST_RUN</span>=<span style=color:#859900>$((</span>(<span style=color:#268bd2>$CURRENT_DATE</span> - <span style=color:#268bd2>$LAST_RUN_DATE</span>) / <span style=color:#2aa198;font-weight:700>60</span><span style=color:#859900>))</span>

<span style=color:#268bd2>DETAIL</span>=<span style=color:#2aa198>&#34;(last run </span><span style=color:#268bd2>$MINUTES_SINCE_LAST_RUN</span><span style=color:#2aa198> minute(s) ago)&#34;</span>
<span style=color:#859900>if</span> [[ <span style=color:#268bd2>$MINUTES_SINCE_LAST_RUN</span> -ge <span style=color:#2aa198;font-weight:700>2</span> ]]; <span style=color:#859900>then</span>
  <span style=color:#cb4b16>echo</span> -n <span style=color:#2aa198>&#34;FAIL </span><span style=color:#2aa198>${</span><span style=color:#268bd2>DETAIL</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>
  <span style=color:#cb4b16>exit</span> <span style=color:#2aa198;font-weight:700>1</span>
<span style=color:#859900>else</span>
  <span style=color:#cb4b16>echo</span> -n <span style=color:#2aa198>&#34;OK </span><span style=color:#2aa198>${</span><span style=color:#268bd2>DETAIL</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>
  <span style=color:#cb4b16>exit</span> <span style=color:#2aa198;font-weight:700>0</span>
<span style=color:#859900>fi</span>
</code></pre></div><p><em>Note: Getting tokens for the curl request is covered in <a href=https://docs.openshift.com/container-platform/3.11/rest_api/index.html#rest-api-authentication>OpenShift&rsquo;s
Authentication documentation</a>.</em></p><p>If the cron job is running normally, the script output should be:</p><pre><code class=language-test data-lang=test>$ ./check-cron-job.sh
OK (last run 0 minute(s) ago)
$ echo $?
0
</code></pre><p>And when things go wrong:</p><pre><code class=language-test data-lang=test>$ ./check-cron-job.sh
FAIL (last run 22 minute(s) ago)
$ echo $?
1
</code></pre><p><em>Photo credit: <a href=https://pxhere.com/en/photo/757871>pxhere</a></em></p></content><p><a href=https://major.io/tags/linux/>#linux</a>
<a href=https://major.io/tags/kubernetes/>#kubernetes</a>
<a href=https://major.io/tags/openshift/>#openshift</a>
<a href=https://major.io/tags/shell/>#shell</a></p></main><footer><hr>CC-BY-SA 4.0 &#187;
Made with <a href=https://gohugo.io/>Hugo</a> &#187;
Theme based on <a href=https://github.com/janraasch/hugo-bearblog/>Hugo  ï‚Ä¢·¥•‚Ä¢ î Bear</a><br><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "aca54cb1322647b89c43a40751f02ce4"}'></script></footer></body></html>