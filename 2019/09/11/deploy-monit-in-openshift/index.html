<!doctype html><html lang=en-us><head><meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://major.io/favicon.ico><title>Deploy monit in OpenShift | Major Hayden's Blog ü§†</title><meta name=title content="Deploy monit in OpenShift"><meta name=description content="Monit is a tried-and-true monitoring daemon that is easy to deploy. Add it to OpenShift to make monitoring even easier."><meta name=keywords content="linux,monit,monitoring,openshift,"><meta property="og:title" content="Deploy monit in OpenShift"><meta property="og:description" content="Monit is a tried-and-true monitoring daemon that is easy to deploy. Add it to OpenShift to make monitoring even easier."><meta property="og:type" content="article"><meta property="og:url" content="https://major.io/2019/09/11/deploy-monit-in-openshift/"><meta property="og:image" content="https://major.io/images/2019-09-11-cctv-cameras.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-09-11T00:00:00+00:00"><meta property="article:modified_time" content="2019-09-11T00:00:00+00:00"><meta property="og:site_name" content="Major Hayden's Blog ü§†"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://major.io/images/2019-09-11-cctv-cameras.jpg"><meta name=twitter:title content="Deploy monit in OpenShift"><meta name=twitter:description content="Monit is a tried-and-true monitoring daemon that is easy to deploy. Add it to OpenShift to make monitoring even easier."><meta name=twitter:site content="@mhayden"><meta itemprop=name content="Deploy monit in OpenShift"><meta itemprop=description content="Monit is a tried-and-true monitoring daemon that is easy to deploy. Add it to OpenShift to make monitoring even easier."><meta itemprop=datePublished content="2019-09-11T00:00:00+00:00"><meta itemprop=dateModified content="2019-09-11T00:00:00+00:00"><meta itemprop=wordCount content="1115"><meta itemprop=image content="https://major.io/images/2019-09-11-cctv-cameras.jpg"><meta itemprop=keywords content="linux,monit,monitoring,openshift,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:820px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px}div.highlight code{background-color:unset;color:initial}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style></head><body><header><a href=../../../../ class=title><h2>Major Hayden's Blog ü§†</h2></a><nav><a href=../../../../>Home</a>
<a href=../../../../ham-radio-faq>Ham Radio</a>
<a href=../../../../icanhazip-com-faq>icanhazip FAQ</a>
<a href=../../../../posts>Posts</a></nav></header><main><h1>Deploy monit in OpenShift</h1><i><time datetime=2019-09-11 pubdate>2019-09-11</time></i>
<content><p><img src=../../../../images/2019-09-11-cctv-cameras.jpg alt="cctv cameras"></p><p><a href=https://mmonit.com/monit/>Monit</a> is a tried-and-true method for monitoring all kinds of systems,
services, and network endpoints. Deploying monit is easy. There&rsquo;s only one
binary daemon to run and it reads monitoring configuration from files in a
directory you specify.</p><p>Most Linux distributions have a package for monit and the package usually
contains some basic configuration along with a systemd unit file to run the
daemon reliably.</p><p>However, this post is all about how to deploy it inside OpenShift. Deploying
monit inside OpenShift allows you to monitor services inside OpenShift that
might not have a route or a NodePort configured, but you can monitor systems
outside OpenShift, too.</p><h2 id=monit-in-a-container>Monit in a container</h2><p>Before we can put monit into a container, we need to think about what it
requires. At the most basic level, we will need:</p><ul><li>the monit daemon binary</li><li>a very basic config, the <code>.monitrc</code></li><li>a directory to hold lots of additional monitoring configs</li><li>any packages needed for running monitoring scripts</li></ul><p>In my case, some of the scripts I want to run require <code>curl</code>, <code>httpie</code> (for
complex HTTP/JSON requests), and <code>jq</code> (for parsing json). I&rsquo;ve added those,
along with some requirements for the monit binary, to my container build file:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=color:#859900>FROM</span><span style=color:#2aa198> fedora:latest</span>

<span style=color:#93a1a1;font-style:italic># Upgrade packages and install monit.</span>
<span style=color:#859900>RUN</span> dnf -y upgrade
<span style=color:#859900>RUN</span> dnf -y install coreutils httpie jq libnsl libxcrypt-compat
<span style=color:#859900>RUN</span> dnf clean all

<span style=color:#93a1a1;font-style:italic># Install monit.</span>
<span style=color:#859900>RUN</span> curl -Lso /tmp/monit.tgz https://bitbucket.org/tildeslash/monit/downloads/monit-5.26.0-linux-x64.tar.gz
<span style=color:#859900>RUN</span> <span style=color:#cb4b16>cd</span> /tmp &amp;&amp; tar xf monit.tgz
<span style=color:#859900>RUN</span> mv /tmp/monit-*/bin/monit /usr/local/bin/monit
<span style=color:#859900>RUN</span> rm -rf /tmp/monit*

<span style=color:#93a1a1;font-style:italic># Remove monit user/group.</span>
<span style=color:#859900>RUN</span> sed -i <span style=color:#2aa198>&#39;/^monit/d&#39;</span> /etc/passwd
<span style=color:#859900>RUN</span> sed -i <span style=color:#2aa198>&#39;/^monit/d&#39;</span> /etc/group

<span style=color:#93a1a1;font-style:italic># Work around OpenShift&#39;s arbitrary UID/GIDs.</span>
<span style=color:#859900>RUN</span> chmod <span style=color:#268bd2>g</span>=u /etc/passwd /etc/group

<span style=color:#93a1a1;font-style:italic># The monit server listens on 2812.</span>
<span style=color:#859900>EXPOSE</span><span style=color:#2aa198> 2812</span>

<span style=color:#93a1a1;font-style:italic># Set up a volume for /config.</span>
<span style=color:#859900>VOLUME</span> [<span style=color:#2aa198>&#34;/config&#34;</span>]

<span style=color:#93a1a1;font-style:italic># Start monit when the container starts.</span>
<span style=color:#859900>ENV</span> <span style=color:#268bd2>HOME</span>=/tmp
<span style=color:#859900>COPY</span> extras/start.sh /opt/start.sh
<span style=color:#859900>RUN</span> chmod +x /opt/start.sh
<span style=color:#859900>CMD</span> [<span style=color:#2aa198>&#34;/opt/start.sh&#34;</span>]
</code></pre></div><p>Let&rsquo;s break down what&rsquo;s here in the container build file:</p><ul><li>Install some basic packages that we need in the container</li><li>Download monit and install it to <code>/usr/local/bin/monit</code></li><li>Remove the <code>monit</code> user/group <em>(more on this later)</em></li><li>Make <code>/etc/passwd</code> and <code>/etc/group</code> writable by the root group <em>(more on this later)</em></li><li>Expose the default monit port</li><li>Run our special startup script</li></ul><p>The last three parts help us run with OpenShift&rsquo;s strict security requirements.</p><h2 id=startup-script>Startup script</h2><p>Monit has some strict security requirements for startup. It requires that the
monit daemon is started with the same user/group combination that owns the
initial configuration file (<code>.monitrc</code>). That&rsquo;s why we removed the <code>monit</code>
user/group <em>and</em> made <code>/etc/passwd</code> and <code>/etc/shadow</code> writable during the build
step. We need to add those back in once the container starts and we&rsquo;ve received
our arbitrary UID from OpenShift.</p><p><em>(For more on OpenShift&rsquo;s arbitrary UIDs, read my other post about <a href=../../../../2019/03/22/running-ansible-in-openshift-with-arbitrary-uids/>Running
Ansible in OpenShift with arbitrary UIDs</a>.)</em></p><p>Here&rsquo;s the startup script:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#93a1a1;font-style:italic>#!/bin/bash
</span><span style=color:#93a1a1;font-style:italic></span><span style=color:#cb4b16>set</span> -euxo pipefail

<span style=color:#cb4b16>echo</span> <span style=color:#2aa198>&#34;The home directory is: </span><span style=color:#2aa198>${</span><span style=color:#268bd2>HOME</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>

<span style=color:#93a1a1;font-style:italic># Work around OpenShift&#39;s arbitrary UID/GIDs.</span>
<span style=color:#859900>if</span> [ -w <span style=color:#2aa198>&#39;/etc/passwd&#39;</span> ]; <span style=color:#859900>then</span>
    <span style=color:#cb4b16>echo</span> <span style=color:#2aa198>&#34;monit‚ùå`id -u`:`id -g`:,,,:</span><span style=color:#2aa198>${</span><span style=color:#268bd2>HOME</span><span style=color:#2aa198>}</span><span style=color:#2aa198>:/bin/bash&#34;</span> &gt;&gt; /etc/passwd
<span style=color:#859900>fi</span>
<span style=color:#859900>if</span> [ -w <span style=color:#2aa198>&#39;/etc/group&#39;</span> ]; <span style=color:#859900>then</span>
    <span style=color:#cb4b16>echo</span> <span style=color:#2aa198>&#34;monit‚ùå</span><span style=color:#859900>$(</span>id -G | cut -d<span style=color:#2aa198>&#39; &#39;</span> -f 2<span style=color:#859900>)</span><span style=color:#2aa198>&#34;</span> &gt;&gt; /etc/group
<span style=color:#859900>fi</span>

<span style=color:#93a1a1;font-style:italic># Make a basic monitrc.</span>
<span style=color:#cb4b16>echo</span> <span style=color:#2aa198>&#34;set daemon 30&#34;</span> &gt;&gt; <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>HOME</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/monitrc
<span style=color:#cb4b16>echo</span> <span style=color:#2aa198>&#34;include /config/*&#34;</span> &gt;&gt; <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>HOME</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/monitrc
chmod <span style=color:#2aa198;font-weight:700>0700</span> <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>HOME</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/monitrc

<span style=color:#93a1a1;font-style:italic># Ensure the UID/GID mapping works.</span>
id

<span style=color:#93a1a1;font-style:italic># Run monit.</span>
/usr/local/bin/monit -v -I -c <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>HOME</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/monitrc
</code></pre></div><p>Let&rsquo;s talk about what is happening in the script:</p><ol><li>Add the <code>monit</code> user to <code>/etc/passwd</code> with the arbitrary UID</li><li>Do the same for the <code>monit</code> group in <code>/etc/group</code></li><li>Create a very basic <code>.monitrc</code> that is owned by the <code>monit</code> user and group</li><li>Run <code>monit</code> in verbose mode in the foreground with our <code>.monitrc</code></li></ol><p>OpenShift will make an emptyDir volume in <code>/config</code> that we can modify since we
specified a volume in the container build file.</p><h2 id=deploying-monit>Deploying monit</h2><p>Now that we have a container and a startup script, it&rsquo;s time to deploy monit in
OpenShift.</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2;font-weight:700>apiVersion</span>: <span style=color:#2aa198>apps.openshift.io/v1</span>
<span style=color:#268bd2;font-weight:700>kind</span>: <span style=color:#2aa198>DeploymentConfig</span>
<span style=color:#268bd2;font-weight:700>metadata</span>:
  <span style=color:#268bd2;font-weight:700>generation</span>: <span style=color:#2aa198;font-weight:700>1</span>
  <span style=color:#268bd2;font-weight:700>labels</span>:
    <span style=color:#268bd2;font-weight:700>app</span>: <span style=color:#2aa198>monit</span>
  <span style=color:#268bd2;font-weight:700>name</span>: <span style=color:#2aa198>monit</span>
<span style=color:#268bd2;font-weight:700>spec</span>:
  <span style=color:#268bd2;font-weight:700>replicas</span>: <span style=color:#2aa198;font-weight:700>1</span>
  <span style=color:#268bd2;font-weight:700>revisionHistoryLimit</span>: <span style=color:#2aa198;font-weight:700>10</span>
  <span style=color:#268bd2;font-weight:700>selector</span>:
    <span style=color:#268bd2;font-weight:700>app</span>: <span style=color:#2aa198>monit</span>
    <span style=color:#268bd2;font-weight:700>deploymentconfig</span>: <span style=color:#2aa198>monit</span>
  <span style=color:#268bd2;font-weight:700>strategy</span>:
    <span style=color:#268bd2;font-weight:700>activeDeadlineSeconds</span>: <span style=color:#2aa198;font-weight:700>21600</span>
    <span style=color:#268bd2;font-weight:700>resources</span>: {}
    <span style=color:#268bd2;font-weight:700>rollingParams</span>:
      <span style=color:#268bd2;font-weight:700>intervalSeconds</span>: <span style=color:#2aa198;font-weight:700>1</span>
      <span style=color:#268bd2;font-weight:700>maxSurge</span>: <span style=color:#2aa198;font-weight:700>25</span><span style=color:#2aa198>%</span>
      <span style=color:#268bd2;font-weight:700>maxUnavailable</span>: <span style=color:#2aa198;font-weight:700>25</span><span style=color:#2aa198>%</span>
      <span style=color:#268bd2;font-weight:700>timeoutSeconds</span>: <span style=color:#2aa198;font-weight:700>600</span>
      <span style=color:#268bd2;font-weight:700>updatePeriodSeconds</span>: <span style=color:#2aa198;font-weight:700>1</span>
    <span style=color:#268bd2;font-weight:700>type</span>: <span style=color:#2aa198>Rolling</span>
  <span style=color:#268bd2;font-weight:700>template</span>:
    <span style=color:#268bd2;font-weight:700>metadata</span>:
      <span style=color:#268bd2;font-weight:700>labels</span>:
        <span style=color:#268bd2;font-weight:700>app</span>: <span style=color:#2aa198>monit</span>
        <span style=color:#268bd2;font-weight:700>deploymentconfig</span>: <span style=color:#2aa198>monit</span>
    <span style=color:#268bd2;font-weight:700>spec</span>:
      <span style=color:#268bd2;font-weight:700>containers</span>:
      - <span style=color:#268bd2;font-weight:700>image</span>: <span style=color:#2aa198>registry.gitlab.com/majorhayden/container-monit/monit:latest</span>
        <span style=color:#268bd2;font-weight:700>imagePullPolicy</span>: <span style=color:#2aa198>Always</span>
        <span style=color:#268bd2;font-weight:700>name</span>: <span style=color:#2aa198>monit</span>
        <span style=color:#268bd2;font-weight:700>resources</span>:
          <span style=color:#268bd2;font-weight:700>limits</span>:
            <span style=color:#268bd2;font-weight:700>cpu</span>: <span style=color:#2aa198>100m</span>
            <span style=color:#268bd2;font-weight:700>memory</span>: <span style=color:#2aa198>512Mi</span>
          <span style=color:#268bd2;font-weight:700>requests</span>:
            <span style=color:#268bd2;font-weight:700>cpu</span>: <span style=color:#2aa198>100m</span>
            <span style=color:#268bd2;font-weight:700>memory</span>: <span style=color:#2aa198>512Mi</span>
        <span style=color:#268bd2;font-weight:700>terminationMessagePath</span>: <span style=color:#2aa198>/dev/termination-log</span>
        <span style=color:#268bd2;font-weight:700>terminationMessagePolicy</span>: <span style=color:#2aa198>File</span>
        <span style=color:#268bd2;font-weight:700>volumeMounts</span>:
        - <span style=color:#268bd2;font-weight:700>mountPath</span>: <span style=color:#2aa198>/config</span>
          <span style=color:#268bd2;font-weight:700>name</span>: <span style=color:#2aa198>monit-config</span>
        - <span style=color:#268bd2;font-weight:700>mountPath</span>: <span style=color:#2aa198>/scripts</span>
          <span style=color:#268bd2;font-weight:700>name</span>: <span style=color:#2aa198>monit-scripts</span>
      <span style=color:#268bd2;font-weight:700>dnsPolicy</span>: <span style=color:#2aa198>ClusterFirst</span>
      <span style=color:#268bd2;font-weight:700>hostname</span>: <span style=color:#2aa198>monit-in-openshift</span>
      <span style=color:#268bd2;font-weight:700>restartPolicy</span>: <span style=color:#2aa198>Always</span>
      <span style=color:#268bd2;font-weight:700>schedulerName</span>: <span style=color:#2aa198>default-scheduler</span>
      <span style=color:#268bd2;font-weight:700>securityContext</span>: {}
      <span style=color:#268bd2;font-weight:700>terminationGracePeriodSeconds</span>: <span style=color:#2aa198;font-weight:700>30</span>
      <span style=color:#268bd2;font-weight:700>volumes</span>:
      - <span style=color:#268bd2;font-weight:700>configMap</span>:
          <span style=color:#268bd2;font-weight:700>defaultMode</span>: <span style=color:#2aa198;font-weight:700>0420</span>
          <span style=color:#268bd2;font-weight:700>name</span>: <span style=color:#2aa198>monit-config</span>
        <span style=color:#268bd2;font-weight:700>name</span>: <span style=color:#2aa198>monit-config</span>
      - <span style=color:#268bd2;font-weight:700>configMap</span>:
          <span style=color:#268bd2;font-weight:700>defaultMode</span>: <span style=color:#2aa198;font-weight:700>0755</span>
          <span style=color:#268bd2;font-weight:700>name</span>: <span style=color:#2aa198>monit-scripts</span>
        <span style=color:#268bd2;font-weight:700>name</span>: <span style=color:#2aa198>monit-scripts</span>
  <span style=color:#268bd2;font-weight:700>test</span>: <span style=color:#859900;font-weight:700>false</span>
  <span style=color:#268bd2;font-weight:700>triggers</span>:
  - <span style=color:#268bd2;font-weight:700>type</span>: <span style=color:#2aa198>ConfigChange</span>
</code></pre></div><p>There is a lot of text here, but there are two important parts:</p><ul><li>The container <code>image</code> is pre-built from my <a href=https://gitlab.com/majorhayden/container-monit>monit GitLab repository</a>
(feel free to use it!)</li><li>The <code>volumes</code> refer to the OpenShift configmaps that hold the monit
configurations as well as the scripts that are called for monitoring</li></ul><p>Next comes the service (which allows the monit web port to be exposed inside
the OpenShift cluster):</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2;font-weight:700>apiVersion</span>: <span style=color:#2aa198>v1</span>
<span style=color:#268bd2;font-weight:700>kind</span>: <span style=color:#2aa198>Service</span>
<span style=color:#268bd2;font-weight:700>metadata</span>:
  <span style=color:#268bd2;font-weight:700>labels</span>:
    <span style=color:#268bd2;font-weight:700>app</span>: <span style=color:#2aa198>monit</span>
  <span style=color:#268bd2;font-weight:700>name</span>: <span style=color:#2aa198>monit</span>
<span style=color:#268bd2;font-weight:700>spec</span>:
  <span style=color:#268bd2;font-weight:700>ports</span>:
  - <span style=color:#268bd2;font-weight:700>port</span>: <span style=color:#2aa198;font-weight:700>2812</span>
    <span style=color:#268bd2;font-weight:700>protocol</span>: <span style=color:#2aa198>TCP</span>
    <span style=color:#268bd2;font-weight:700>targetPort</span>: <span style=color:#2aa198;font-weight:700>2812</span>
  <span style=color:#268bd2;font-weight:700>selector</span>:
    <span style=color:#268bd2;font-weight:700>app</span>: <span style=color:#2aa198>monit</span>
    <span style=color:#268bd2;font-weight:700>deploymentconfig</span>: <span style=color:#2aa198>monit</span>
  <span style=color:#268bd2;font-weight:700>sessionAffinity</span>: <span style=color:#2aa198>None</span>
  <span style=color:#268bd2;font-weight:700>type</span>: <span style=color:#2aa198>ClusterIP</span>
</code></pre></div><p>And finally, the route (which exposes the monit web port service <em>outside</em> the
OpenShift cluster):</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2;font-weight:700>apiVersion</span>: <span style=color:#2aa198>route.openshift.io/v1</span>
<span style=color:#268bd2;font-weight:700>kind</span>: <span style=color:#2aa198>Route</span>
<span style=color:#268bd2;font-weight:700>metadata</span>:
  <span style=color:#268bd2;font-weight:700>labels</span>:
    <span style=color:#268bd2;font-weight:700>app</span>: <span style=color:#2aa198>monit</span>
  <span style=color:#268bd2;font-weight:700>name</span>: <span style=color:#2aa198>monit</span>
<span style=color:#268bd2;font-weight:700>spec</span>:
  <span style=color:#268bd2;font-weight:700>tls</span>:
    <span style=color:#268bd2;font-weight:700>insecureEdgeTerminationPolicy</span>: <span style=color:#2aa198>Redirect</span>
    <span style=color:#268bd2;font-weight:700>termination</span>: <span style=color:#2aa198>edge</span>
  <span style=color:#268bd2;font-weight:700>host</span>: <span style=color:#2aa198>monit.openshift.example.com</span>
  <span style=color:#268bd2;font-weight:700>to</span>:
    <span style=color:#268bd2;font-weight:700>kind</span>: <span style=color:#2aa198>Service</span>
    <span style=color:#268bd2;font-weight:700>name</span>: <span style=color:#2aa198>monit</span>
    <span style=color:#268bd2;font-weight:700>weight</span>: <span style=color:#2aa198;font-weight:700>100</span>
  <span style=color:#268bd2;font-weight:700>wildcardPolicy</span>: <span style=color:#2aa198>None</span>
</code></pre></div><h2 id=monitoring-configuration-and-scripts>Monitoring configuration and scripts</h2><p>The deploymentConfig for monit refers to a configMap called <code>monit-config</code>.
This config map contains all of the additional monitoring configuration for
monit outside of the <code>.monitrc</code>. Here is a basic configMap for checking that
<code>icanhazheaders.com</code> is accessible:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2;font-weight:700>apiVersion</span>: <span style=color:#2aa198>v1</span>
<span style=color:#268bd2;font-weight:700>kind</span>: <span style=color:#2aa198>ConfigMap</span>
<span style=color:#268bd2;font-weight:700>metadata</span>:
  <span style=color:#268bd2;font-weight:700>name</span>: <span style=color:#2aa198>monit-config</span>
<span style=color:#268bd2;font-weight:700>data</span>:
  <span style=color:#268bd2;font-weight:700>config</span>: |<span style=color:#2aa198>
</span><span style=color:#2aa198>    set daemon 30
</span><span style=color:#2aa198>    set httpd port 2812
</span><span style=color:#2aa198>      allow 0.0.0.0/0
</span><span style=color:#2aa198>    set alert me@example.com
</span><span style=color:#2aa198>    set mailserver smtp.example.com
</span><span style=color:#2aa198>
</span><span style=color:#2aa198>    check host &#34;icanhazheaders responding&#34; with address icanhazheaders.com
</span><span style=color:#2aa198>      if failed
</span><span style=color:#2aa198>        port 80
</span><span style=color:#2aa198>        for 2 cycles
</span><span style=color:#2aa198>      then alert
</span><span style=color:#2aa198>
</span><span style=color:#2aa198>    check program &#34;icanhazheaders header check&#34;
</span><span style=color:#2aa198>      with path &#34;/scripts/header-check.sh ACCEPT-ENCODING &#39;gzip&#39;&#34;
</span><span style=color:#2aa198>      if status gt 0
</span><span style=color:#2aa198>        then exec &#34;/scripts/irc-notification.sh&#34;
</span><span style=color:#2aa198>        else if succeeded then exec &#34;/scripts/irc-notification.sh&#34;</span>    

</code></pre></div><p>This configuration will check <code>icanhazheaders.com</code> and only alert if the check
fails for two check periods. Each check period is 30 seconds, so the site would
need to be inaccessible for 60 seconds before an alert would be sent.</p><p>Also, there is a second check that runs a script. Let&rsquo;s deploy the script to
OpenShift as well:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2;font-weight:700>apiVersion</span>: <span style=color:#2aa198>v1</span>
<span style=color:#268bd2;font-weight:700>kind</span>: <span style=color:#2aa198>ConfigMap</span>
<span style=color:#268bd2;font-weight:700>metadata</span>:
  <span style=color:#268bd2;font-weight:700>name</span>: <span style=color:#2aa198>monit-scripts</span>
<span style=color:#268bd2;font-weight:700>data</span>:
  <span style=color:#268bd2;font-weight:700>header-check.sh</span>: |<span style=color:#2aa198>
</span><span style=color:#2aa198>    #!/bin/bash
</span><span style=color:#2aa198>    set -euo pipefail
</span><span style=color:#2aa198>
</span><span style=color:#2aa198>    URL=&#34;http://icanhazheaders.com&#34;
</span><span style=color:#2aa198>    HEADER=$1
</span><span style=color:#2aa198>    EXPECTED_VALUE=$2
</span><span style=color:#2aa198>
</span><span style=color:#2aa198>    HEADER_VALUE=$(curl -s ${URL} | jq -r ${HEADER})
</span><span style=color:#2aa198>
</span><span style=color:#2aa198>    if [[ $HEADER_VALUE == $EXPECTED_VALUE ]]; then
</span><span style=color:#2aa198>      exit 0
</span><span style=color:#2aa198>    else
</span><span style=color:#2aa198>      exit 1
</span><span style=color:#2aa198>    fi</span>    
</code></pre></div><p>Use <code>oc apply</code> to deploy all of these YAML files to your OpenShift cluster and
monit should be up and running within seconds!</p><p><a href=https://commons.wikimedia.org/wiki/File:CCTV_cameras_in_Mumbai.jpg><em>Photo credit</em></a></p></content><p><a href=https://major.io/tags/linux/>#linux</a>
<a href=https://major.io/tags/monit/>#monit</a>
<a href=https://major.io/tags/monitoring/>#monitoring</a>
<a href=https://major.io/tags/openshift/>#openshift</a></p></main><footer><hr>CC-BY-SA 4.0 &#187;
Made with <a href=https://gohugo.io/>Hugo</a> &#187;
Theme based on <a href=https://github.com/janraasch/hugo-bearblog/>Hugo  ï‚Ä¢·¥•‚Ä¢ î Bear</a><br></footer></body></html>