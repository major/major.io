<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Major Hayden"><meta name=description content="We have two Google Pixel phones in our house: a Pixel 2 and a Pixel 3. Both of them drop off our home wireless network regularly. It causes lots of problems with various applications on the phones, especially casting video via Chromecast.
At the time when I first noticed the drops, I was using a pair of wireless access points (APs) from Engenius:
 EAP600 EAP1200H  Also, here&amp;rsquo;s what I knew at the time:"><meta name=keywords content=",android,networking"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://major.io/2019/03/17/pixel-3-wifi-drops-constantly/><title>Pixel 3 Wi-Fi drops constantly :: Major Hayden ðŸ¤  â€” Words of wisdom from a social nerd</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=../../../../main.min.5dcefbf8102eb536dd3e2de53ffebfa58599ab2435c241a0db81728a5e015f2e.css><link rel=apple-touch-icon sizes=180x180 href=../../../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../../favicon-16x16.png><link rel=manifest href=../../../../site.webmanifest><link rel=mask-icon href=../../../../safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=../../../../favicon.ico><meta name=msapplication-TileColor content="#252627"><meta name=theme-color content="#252627"><meta itemprop=name content="Pixel 3 Wi-Fi drops constantly"><meta itemprop=description content="We have two Google Pixel phones in our house: a Pixel 2 and a Pixel 3. Both of them drop off our home wireless network regularly. It causes lots of problems with various applications on the phones, especially casting video via Chromecast.
At the time when I first noticed the drops, I was using a pair of wireless access points (APs) from Engenius:
 EAP600 EAP1200H  Also, here&rsquo;s what I knew at the time:"><meta itemprop=datePublished content="2019-03-17T00:00:00+00:00"><meta itemprop=dateModified content="2019-03-17T00:00:00+00:00"><meta itemprop=wordCount content="1283"><meta itemprop=image content="https://major.io"><meta itemprop=keywords content="android,networking,"><meta property="article:section" content="Blog Posts"><meta property="article:published_time" content="2019-03-17 00:00:00 +0000 UTC"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Pixel 3 Wi-Fi drops constantly :: Major Hayden ðŸ¤ "><meta name=twitter:description content><meta name=twitter:site content="https://major.io"><meta name=twitter:creator content="Major Hayden"><meta name=twitter:image content="https://major.io/images/2019-03-17-google-pixel-phones.jpg"><style type=text/css>html{letter-spacing:unset}</style></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=../../../../ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ echo major.io</span>
<span class=logo__cursor style=visibility:hidden></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://major.io/ham-radio-faq>hamradio</a></li><li><a href=https://major.io/icanhazip-com-faq>icanhazip</a></li><li><a href=https://major.io/posts/>posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://major.io/2019/03/17/pixel-3-wifi-drops-constantly/>Pixel 3 Wi-Fi drops constantly</a></h2><div class=post-content><p><img src=../../../../images/2019-03-17-google-pixel-phones.jpg alt=pixel_phones></p><p>We have two Google Pixel phones in our house: a Pixel 2 and a Pixel 3. Both
of them drop off our home wireless network regularly. It causes lots of
problems with various applications on the phones, especially casting video
via Chromecast.</p><p>At the time when I first noticed the drops, I was using a pair of wireless
access points (APs) from Engenius:</p><ul><li><a href=https://www.engeniustech.com/engenius-products/indoor-wireless-ceiling-ap-eap600/>EAP600</a></li><li><a href=https://www.engeniustech.com/engenius-products/indoor-wireless-ceiling-ap-eap1200h/>EAP1200H</a></li></ul><p>Also, here&rsquo;s what I knew at the time:</p><ul><li>Mac and Linux computers had no Wi-Fi issues at all</li><li>The signal level from both APs was strong</li><li>Disabling one AP made no improvement</li><li>Disabling one band (2.4 or 5GHz) on the APs made no improvement</li><li>Clearing the bluetooth/Wi-Fi data on the Pixel had no effect</li><li>Assigning a static IP address on the Pixel made no improvement</li><li>Using unencrypted SSIDs made no improvement</li></ul><p>At this point, I felt strongly that the APs had nothing to do with it. I
ordered a new <a href=https://www.netgear.com/support/product/RBR50.aspx>NetGear Orbi</a> mesh router and satellite anyway. The Pixels
still dropped off the wireless network even with the new Orbi APs.</p><h2 id=reading-logs>Reading logs</h2><p>I started reading logs from every source I could find:</p><ul><li>dhcpd logs from my router</li><li>syslogs from my APs (which forwarded into the router)</li><li>output from tcpdump on my router</li></ul><p>Several things became apparent after reading the logs:</p><ul><li>The Wi-Fi drop occurred usually every 30-60 seconds</li><li>The DHCP server received requests for a new IP address after every drop</li><li>None of the network traffic from the phones was being blocked at the router</li><li>The logs from the APs showed the phone disconnecting itself from the
network; the APs were not forcing the phones off the network</li></ul><p>All of the wireless and routing systems in my house seemed to point to a
problem in the phones themselves. They were voluntarily dropping from the
network without being bumped off by APs or the router.</p><h2 id=getting-logs-from-the-phone>Getting logs from the phone</h2><p>It was time to get some logs from the phone itself. That would require
connecting the phone via USB to a computer and enabling USB debugging on the
phone.</p><p>First, I downloaded the <a href=https://developer.android.com/studio>Android SDK</a>. The full studio release isn&rsquo;t needed
&ndash; scroll down and find the <em>Command line tools only</em> section. Unzip the
download and find the <code>tools/bin/sdkmanager</code> executable. Run it like this:</p><pre><code># Fedora 29 systems may need to choose the older Java version for sdkmanager
# to run properly.
export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.201.b09-2.fc29.x86_64/jre
# Install the android-28 platform tools
./sdkmanager &quot;platform-tools&quot; &quot;platforms;android-28&quot;
</code></pre><p>Now we need to enable USB debugging on the phone itself. <strong>Be sure to disable
USB debugging when you are done!</strong> Follow these steps:</p><ol><li>Go into the phone&rsquo;s settings and choose <em>About Phone</em> from the bottom of
the list.</li><li>Scroll to the bottom and tap the <em>Build number</em> section repeatedly until
a message appears saying that you are now a developer.</li><li>Go back one screen and tap <em>System</em>.</li><li>Click <em>Advanced</em> to show the additional options and tap <em>Developer Options</em>.</li><li>In the <em>Debugging</em> section, tap <em>USB Debugging</em> to enable USB debugging.</li></ol><p>Connect the phone to your computer via USB and run:</p><pre><code>sudo platform-tools/adb logcat
</code></pre><p>Your screen will fill with logs from your phone.</p><h2 id=nuggets-in-the-log>Nuggets in the log</h2><p>I watched the logs and waited for the Wi-Fi to drop. As soon as it dropped, I
saw some interesting log messages:</p><pre><code>I wpa_supplicant: wlan0: CTRL-EVENT-AVOID-FREQ ranges=5785-5825
I chatty  : uid=1000(system) IpClient.wlan0 expire 3 lines
I chatty  : uid=1000 system_server expire 1 line
D CommandListener: Setting iface cfg
E cnss-daemon: wlan_service_update_sys_param: unable to open /proc/sys/net/ipv4/tcp_use_userconfig
I chatty  : uid=1000(system) android.fg expire 1 line
I wpa_supplicant: wlan0: CTRL-EVENT-DISCONNECTED bssid=88:dc:96:4a:b6:75 reason=3 locally_generated=1
I chatty  : uid=10025 com.google.android.gms.persistent expire 7 lines
V NativeCrypto: Read error: ssl=0x7b349e2d08: I/O error during system call, Software caused connection abort
V NativeCrypto: Write error: ssl=0x7b349e2d08: I/O error during system call, Broken pipe
V NativeCrypto: Write error: ssl=0x7b349e2d08: I/O error during system call, Broken pipe
V NativeCrypto: SSL shutdown failed: ssl=0x7b349e2d08: I/O error during system call, Success
D ConnectivityService: reportNetworkConnectivity(158, false) by 10025
</code></pre><p>The line with <code>CTRL-EVENT-AVOID-FREQ</code> isn&rsquo;t relevant because it&rsquo;s simply a
hint to the wireless drivers to avoid certain frequencies not used in the
USA. The <code>CTRL-EVENT-DISCONNECTED</code> shows where wpa_supplicant received the
disconnection message. The last line with <code>ConnectivityService</code> was very
interesting. Something in the phone believes there is a network connectivity
issue. That could be why the Pixel is hopping off the wireless network.</p><p>From there, I decided to examine only the <code>ConnectivityService</code> logs:</p><pre><code>sudo platform-tools/adb logcat 'ConnectivityService:* *:S'
</code></pre><p>This logcat line tells adb that I want all logs from all log levels about the
<code>ConnectivityService</code>, but all of the other logs should be silenced. I
started seeing some interesting details:</p><pre><code>D ConnectivityService: NetworkAgentInfo [WIFI () - 148] validation failed
D ConnectivityService: Switching to new default network: NetworkAgentInfo{ ni{[type: MOBILE[LTE]...
D ConnectivityService: Sending DISCONNECTED broadcast for type 1 NetworkAgentInfo [WIFI () - 148] isDefaultNetwork=true
D ConnectivityService: Sending CONNECTED broadcast for type 0 NetworkAgentInfo [MOBILE (LTE) - 100] isDefaultNetwork=true
D ConnectivityService: handleNetworkUnvalidated NetworkAgentInfo [WIFI () - 148] ...
</code></pre><p>Wait, what is this &ldquo;validation failed&rdquo; message? The Pixel was making network
connections successfully the entire time as shown by tcpdump. This is part of
Android&rsquo;s [network connecivity checks] for various networks.</p><p>The last few connections just before the disconnect were to
<code>connectivitycheck.gstatic.com</code> (based on tcpdump logs) and that&rsquo;s Google&rsquo;s
way of verifying that the wireless network is usable and that there are no
captive portals. I connected to it from my desktop on IPv4 and IPv6 to verify:</p><pre><code>$ curl -4 -i https://connectivitycheck.gstatic.com/generate_204
HTTP/2 204
date: Sun, 17 Mar 2019 15:00:30 GMT
alt-svc: quic=&quot;:443&quot;; ma=2592000; v=&quot;46,44,43,39&quot;
$ curl -6 -i https://connectivitycheck.gstatic.com/generate_204
HTTP/2 204
date: Sun, 17 Mar 2019 15:00:30 GMT
alt-svc: quic=&quot;:443&quot;; ma=2592000; v=&quot;46,44,43,39&quot;
</code></pre><p>Everything looked fine.</p><h2 id=heading-to-google>Heading to Google</h2><p>After a bunch of searching on Google, I kept finding posts talking about
disabling IPv6 to fix the Wi-Fi drop issues. I shrugged it off and kept
searching. Finally, I decided to disable IPv6 and see if that helped.</p><p>I stopped <code>radvd</code> on the router, disabled Wi-Fi on the phone, and then
re-enabled it. As I watched, the phone stayed on the wireless network for two
minutes. Three minutes. Ten minutes. <strong>There were no drops.</strong></p><p>At this point, this is still an unsolved mystery for me. Disabling IPv6 is a
terrible idea, but it keeps my phones online. I plan to put the phones on
their own VLAN without IPv6 so I can still keep IPv6 addresses for my other
computers, but this is not a good long term fix. If anyone has any input on
why this helps and how I can get IPv6 re-enabled, please <a href=mailto:major@mhtx.net>let me know</a>!</p><h2 id=update-2019-03-18>Update 2019-03-18</h2><p>Several readers wanted to see what was happening just before the Wi-Fi drop,
so here&rsquo;s a small snippet from tcpdump:</p><pre><code>07:26:06.736900 IP6 2607:f8b0:4000:80d::2003.443 &gt; phone.41310: Flags [F.], seq 3863, ack 511, win 114, options [nop,nop,TS val 1288800272 ecr 66501414], length 0
07:26:06.743101 IP6 2607:f8b0:4000:80d::2003.443 &gt; phone.41312: Flags [F.], seq 3864, ack 511, win 114, options [nop,nop,TS val 1778536228 ecr 66501414], length 0
07:26:06.765444 IP6 phone.41312 &gt; 2607:f8b0:4000:80d::2003.443: Flags [R], seq 4183481455, win 0, length 0
07:26:06.765454 IP6 phone.41310 &gt; 2607:f8b0:4000:80d::2003.443: Flags [R], seq 3279990707, win 0, length 0
07:26:07.487180 IP6 2607:f8b0:4000:80d::2003.443 &gt; phone.41316: Flags [F.], seq 3863, ack 511, win 114, options [nop,nop,TS val 4145292968 ecr 66501639], length 0
07:26:07.537080 IP6 phone.41316 &gt; 2607:f8b0:4000:80d::2003.443: Flags [R], seq 4188442452, win 0, length 0
</code></pre><p>That IPv6 address is at a Google PoP in Dallas, TX:</p><pre><code>$ host 2607:f8b0:4000:80d::2003
3.0.0.2.0.0.0.0.0.0.0.0.0.0.0.0.d.0.8.0.0.0.0.4.0.b.8.f.7.0.6.2.ip6.arpa domain name pointer dfw06s49-in-x03.1e100.net.
</code></pre><p>I haven&rsquo;t been able to intercept the traffic via man-in-the-middle since
Google&rsquo;s certificate checks are very strict. However, checks from my own
computer work without an issue:</p><pre><code>$ curl -ki &quot;https://[2607:f8b0:4000:80d::2003]/generate_204&quot;
HTTP/2 204
date: Mon, 18 Mar 2019 12:35:18 GMT
alt-svc: quic=&quot;:443&quot;; ma=2592000; v=&quot;46,44,43,39&quot;
</code></pre></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://major.io/tags/android>android</a></span><span class=tag><a href=https://major.io/tags/networking>networking</a></span></p></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span><a href=https://major.io>Major Hayden</a></span>
<span><a href=https://creativecommons.org/licenses/by-sa/2.0/ target=_blank rel=noopener>CC BY-SA 2.0</a></span>
<span><a href=https://major.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>rhazdon</a></span></div></div></footer></div><script type=text/javascript src=../../../../bundle.min.2d5469329143160ae2456a69c3c76dc2d0a3b212b46afe291a51bd68650ed6f8697e001dab54f1c272c77ce08092a8c55e5bb4314e0ee334aab4b927ec896638.js integrity="sha512-LVRpMpFDFgriRWppw8dtwtCjshK0av4pGlG9aGUO1vhpfgAdq1TxwnLHfOCAkqjFXlu0MU4O4zSqtLkn7IlmOA=="></script></body></html>