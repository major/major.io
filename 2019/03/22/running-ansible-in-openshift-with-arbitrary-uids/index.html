<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Major Hayden"><meta name=description content="My work at Red Hat involves testing lots and lots of kernels from various sources and we use GitLab CE to manage many of our repositories and run our CI jobs. Those jobs run in thousands of OpenShift containers that we spawn every day.
OpenShift has some handy security features that we like. First, each container is mounted read-only with some writable temporary space (and any volumes that you mount). Also, OpenShift uses arbitrarily assigned user IDs (UIDs) for each container."><meta name=keywords content=",openshift,ansible,security,gitlab"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://major.io/2019/03/22/running-ansible-in-openshift-with-arbitrary-uids/><title>Running Ansible in OpenShift with arbitrary UIDs :: Major Hayden ü§† ‚Äî Words of wisdom from a social nerd</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=../../../../main.89fa80e2143f71bd5c96a7c94e531dec3276a367e22f87e74a76026ab64680bf.css><link rel=apple-touch-icon sizes=180x180 href=../../../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../../favicon-16x16.png><link rel=manifest href=../../../../site.webmanifest><link rel=mask-icon href=../../../../safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=../../../../favicon.ico><meta name=msapplication-TileColor content="#252627"><meta name=theme-color content="#252627"><meta itemprop=name content="Running Ansible in OpenShift with arbitrary UIDs"><meta itemprop=description content="My work at Red Hat involves testing lots and lots of kernels from various sources and we use GitLab CE to manage many of our repositories and run our CI jobs. Those jobs run in thousands of OpenShift containers that we spawn every day.
OpenShift has some handy security features that we like. First, each container is mounted read-only with some writable temporary space (and any volumes that you mount). Also, OpenShift uses arbitrarily assigned user IDs (UIDs) for each container."><meta itemprop=datePublished content="2019-03-22T00:00:00+00:00"><meta itemprop=dateModified content="2019-03-22T00:00:00+00:00"><meta itemprop=wordCount content="590"><meta itemprop=image content="https://major.io"><meta itemprop=keywords content="openshift,ansible,security,gitlab,"><meta property="article:section" content="Blog Posts"><meta property="article:published_time" content="2019-03-22 00:00:00 +0000 UTC"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Running Ansible in OpenShift with arbitrary UIDs :: Major Hayden ü§†"><meta name=twitter:description content><meta name=twitter:site content="https://major.io"><meta name=twitter:creator content="Major Hayden"><meta name=twitter:image content="https://major.io/images/2019-03-22-blacksmith-anvil-hammer.jpg"><style type=text/css>html{letter-spacing:unset}</style></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=../../../../ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ echo major.io</span>
<span class=logo__cursor style=visibility:hidden></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=../../../../ham-radio-faq>hamradio</a></li><li><a href=../../../../icanhazip-com-faq>icanhazip</a></li><li><a href=../../../../posts/>posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://major.io/2019/03/22/running-ansible-in-openshift-with-arbitrary-uids/>Running Ansible in OpenShift with arbitrary UIDs</a></h2><div class=post-content><p><img src=../../../../images/2019-03-22-blacksmith-anvil-hammer.jpg alt=blacksmith_anvil_hammer></p><p>My work at Red Hat involves testing lots and lots of kernels from various
sources and we use <a href=https://gitlab.com/gitlab-org/gitlab-ce/>GitLab CE</a> to manage many of our repositories and run our
CI jobs. Those jobs run in <em>thousands</em> of <a href=https://www.openshift.com/>OpenShift</a> containers that we
spawn every day.</p><p>OpenShift has some handy security features that we like. First, each
container is mounted read-only with some writable temporary space (and any
volumes that you mount). Also, OpenShift uses <a href=https://docs.openshift.com/container-platform/3.11/creating_images/guidelines.html#openshift-specific-guidelines>arbitrarily assigned user IDs</a>
(UIDs) for each container.</p><p>Constantly changing UIDs provide some good protection against container
engine vulnerabilities, but they can be a pain if you have a script or
application that depends on being able to resolve a UID or GID back to a real
user or group account.</p><h2 id=ansible-and-uids>Ansible and UIDs</h2><p>If you run an Ansible playbook within OpenShift, you will likely run into a
problem during the fact gathering process:</p><pre><code>$ ansible-playbook -i hosts playbook.yml

PLAY [all] *********************************************************************

TASK [Gathering Facts] *********************************************************
An exception occurred during task execution. To see the full traceback, use -vvv.
The error was: KeyError: 'getpwuid(): uid not found: 1000220000'
fatal: [localhost]: FAILED! =&gt; {&quot;msg&quot;: &quot;Unexpected failure during module execution.&quot;, &quot;stdout&quot;: &quot;&quot;}
	to retry, use: --limit @/major-ansible-messaround/playbook.retry

PLAY RECAP *********************************************************************
localhost                  : ok=0    changed=0    unreachable=0    failed=1
</code></pre><p>This exception is telling us that <a href=https://linux.die.net/man/3/getpwuid>getpwuid()</a> was not able to find an entry
in <code>/etc/passwd</code> for our UID (<code>1000220000</code> in this container).</p><p>One option would be to adjust the playbook so that we skip the fact gathering
process:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#268bd2>hosts</span>: all
  <span style=color:#268bd2>gather_facts</span>: <span style=color:#cb4b16>no</span>
  <span style=color:#268bd2>tasks</span>:

    - <span style=color:#268bd2>name</span>: Run tests
      <span style=color:#268bd2>command</span>: ./run_tests.sh
</code></pre></div><p>However, this might not be helpful if you need facts to be gathered for your
playbook to run. In that case, you need to make some adjustments to your
container image first.</p><h2 id=updating-the-container>Updating the container</h2><p>Nothing in the container image is writable within OpenShift, but we can change
certain files to be group writable for the root user since every OpenShift
user has an effective GID of <code>0</code>.</p><p>When you build your container, add a line to your Dockerfile to allow the
container user to have group write access to <code>/etc/passwd</code> and <code>/etc/group</code>:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=color:#586e75># Make Ansible happy with arbitrary UID/GID in OpenShift.</span>
<span style=color:#719e07>RUN</span> chmod <span style=color:#268bd2>g</span><span style=color:#719e07>=</span>u /etc/passwd /etc/group
</code></pre></div><p>Once your container has finished building, the permissions on both files
should look like this:</p><pre><code>$ ls -al /etc/passwd /etc/group
-rw-rw-r--. 1 root root 514 Mar 20 18:12 /etc/group
-rw-rw-r--. 1 root root 993 Mar 20 18:12 /etc/passwd
</code></pre><h2 id=make-a-user-account>Make a user account</h2><p>Now that we&rsquo;ve made these files writable for our user in OpenShift, it&rsquo;s time
to change how we run our GitLab CI job. My job YAML currently looks like this:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>ansible_test</span>:
  <span style=color:#268bd2>image</span>: docker.io/major/ansible:fedora29
  <span style=color:#268bd2>script</span>:
    - ansible-playbook -i hosts playbook.yml
</code></pre></div><p>We can add two lines that allow us to make a temporary user and group account
for our OpenShift user:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>ansible_test</span>:
  <span style=color:#268bd2>image</span>: docker.io/major/ansible:fedora29
  <span style=color:#268bd2>script</span>:
    - echo &#34;tempuser‚ùå$(id -u):$(id -g):,,,:${HOME}:/bin/bash&#34; &gt;&gt; /etc/passwd
    - echo &#34;tempuser‚ùå$(id -G | cut -d&#39; &#39; -f 2)&#34; &gt;&gt; /etc/group
    - id
    - ansible-playbook -i hosts playbook.yml
</code></pre></div><p>Note that we want the second GID returned by <code>id</code> since the first one is <code>0</code>.
The <code>id</code> command helps us check our work when the container starts. When the
CI job starts, we should see some better output:</p><pre><code>$ echo &quot;tempuser‚ùå$(id -u):$(id -g):,,,:${HOME}:/bin/bash&quot; &gt;&gt; /etc/passwd
$ echo &quot;tempuser‚ùå$(id -G | cut -d' ' -f 2)&quot; &gt;&gt; /etc/group
$ id
uid=1000220000(tempuser) gid=0(root) groups=0(root),1000220000(tempuser)
$ ansible-playbook -i hosts playbook.yml

PLAY [all] *********************************************************************

TASK [Gathering Facts] *********************************************************
ok: [localhost]

TASK [Download kernel source] **************************************************
changed: [localhost]

PLAY RECAP *********************************************************************
localhost                  : ok=2    changed=1    unreachable=0    failed=0
</code></pre><p>Success!</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://major.io/tags/openshift/>openshift</a></span>
<span class=tag><a href=https://major.io/tags/ansible/>ansible</a></span>
<span class=tag><a href=https://major.io/tags/security/>security</a></span>
<span class=tag><a href=https://major.io/tags/gitlab/>gitlab</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span class=tag><a href=https://major.io/categories/blog-posts/>Blog Posts</a></span></p></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span><a href=https://major.io>Major Hayden</a></span>
<span><a href=https://creativecommons.org/licenses/by-sa/2.0/ target=_blank rel=noopener>CC BY-SA 2.0</a></span><span><a href=https://major.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>Djordje Atlialp</a></span></div></div></footer></div><script type=text/javascript src=../../../../bundle.min.e9f93b80e78a22e6f04cbb5f73e0f9c4ba60ff73a2a0ef85965c688f93dd1f2722a282e30e485603e4c65b1b346720e35f213435ec5556e196a97a68d097c80f.js integrity="sha512-6fk7gOeKIubwTLtfc+D5xLpg/3OioO+Fllxoj5PdHyciooLjDkhWA+TGWxs0ZyDjXyE0NexVVuGWqXpo0JfIDw=="></script></body></html>