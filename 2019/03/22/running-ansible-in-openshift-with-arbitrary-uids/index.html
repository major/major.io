<!doctype html><html lang=en-us><head><meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://major.io/favicon.ico><title>Running Ansible in OpenShift with arbitrary UIDs | Major Hayden's Blog 🤠</title><meta name=title content="Running Ansible in OpenShift with arbitrary UIDs"><meta name=description content="My work at Red Hat involves testing lots and lots of kernels from various sources and we use GitLab CE to manage many of our repositories and run our CI jobs. Those jobs run in thousands of OpenShift containers that we spawn every day.
OpenShift has some handy security features that we like. First, each container is mounted read-only with some writable temporary space (and any volumes that you mount). Also, OpenShift uses arbitrarily assigned user IDs (UIDs) for each container."><meta name=keywords content="openshift,ansible,security,gitlab,"><meta property="og:title" content="Running Ansible in OpenShift with arbitrary UIDs"><meta property="og:description" content="My work at Red Hat involves testing lots and lots of kernels from various sources and we use GitLab CE to manage many of our repositories and run our CI jobs. Those jobs run in thousands of OpenShift containers that we spawn every day.
OpenShift has some handy security features that we like. First, each container is mounted read-only with some writable temporary space (and any volumes that you mount). Also, OpenShift uses arbitrarily assigned user IDs (UIDs) for each container."><meta property="og:type" content="article"><meta property="og:url" content="https://major.io/2019/03/22/running-ansible-in-openshift-with-arbitrary-uids/"><meta property="og:image" content="https://major.io/images/2019-03-22-blacksmith-anvil-hammer.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-03-22T00:00:00+00:00"><meta property="article:modified_time" content="2019-03-22T00:00:00+00:00"><meta property="og:site_name" content="Major Hayden's Blog 🤠"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://major.io/images/2019-03-22-blacksmith-anvil-hammer.jpg"><meta name=twitter:title content="Running Ansible in OpenShift with arbitrary UIDs"><meta name=twitter:description content="My work at Red Hat involves testing lots and lots of kernels from various sources and we use GitLab CE to manage many of our repositories and run our CI jobs. Those jobs run in thousands of OpenShift containers that we spawn every day.
OpenShift has some handy security features that we like. First, each container is mounted read-only with some writable temporary space (and any volumes that you mount). Also, OpenShift uses arbitrarily assigned user IDs (UIDs) for each container."><meta name=twitter:site content="@mhayden"><meta itemprop=name content="Running Ansible in OpenShift with arbitrary UIDs"><meta itemprop=description content="My work at Red Hat involves testing lots and lots of kernels from various sources and we use GitLab CE to manage many of our repositories and run our CI jobs. Those jobs run in thousands of OpenShift containers that we spawn every day.
OpenShift has some handy security features that we like. First, each container is mounted read-only with some writable temporary space (and any volumes that you mount). Also, OpenShift uses arbitrarily assigned user IDs (UIDs) for each container."><meta itemprop=datePublished content="2019-03-22T00:00:00+00:00"><meta itemprop=dateModified content="2019-03-22T00:00:00+00:00"><meta itemprop=wordCount content="590"><meta itemprop=image content="https://major.io/images/2019-03-22-blacksmith-anvil-hammer.jpg"><meta itemprop=keywords content="openshift,ansible,security,gitlab,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:820px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px}div.highlight code{background-color:unset;color:initial}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style></head><body><header><a href=../../../../ class=title><h2>Major Hayden's Blog 🤠</h2></a><nav><a href=../../../../>Home</a>
<a href=../../../../ham-radio-faq>Ham Radio</a>
<a href=../../../../icanhazip-com-faq>icanhazip FAQ</a>
<a href=../../../../posts>Posts</a></nav></header><main><h1>Running Ansible in OpenShift with arbitrary UIDs</h1><i><time datetime=2019-03-22 pubdate>2019-03-22</time></i>
<content><p><img src=../../../../images/2019-03-22-blacksmith-anvil-hammer.jpg alt=blacksmith_anvil_hammer></p><p>My work at Red Hat involves testing lots and lots of kernels from various
sources and we use <a href=https://gitlab.com/gitlab-org/gitlab-ce/>GitLab CE</a> to manage many of our repositories and run our
CI jobs. Those jobs run in <em>thousands</em> of <a href=https://www.openshift.com/>OpenShift</a> containers that we
spawn every day.</p><p>OpenShift has some handy security features that we like. First, each
container is mounted read-only with some writable temporary space (and any
volumes that you mount). Also, OpenShift uses <a href=https://docs.openshift.com/container-platform/3.11/creating_images/guidelines.html#openshift-specific-guidelines>arbitrarily assigned user IDs</a>
(UIDs) for each container.</p><p>Constantly changing UIDs provide some good protection against container
engine vulnerabilities, but they can be a pain if you have a script or
application that depends on being able to resolve a UID or GID back to a real
user or group account.</p><h2 id=ansible-and-uids>Ansible and UIDs</h2><p>If you run an Ansible playbook within OpenShift, you will likely run into a
problem during the fact gathering process:</p><pre><code>$ ansible-playbook -i hosts playbook.yml

PLAY [all] *********************************************************************

TASK [Gathering Facts] *********************************************************
An exception occurred during task execution. To see the full traceback, use -vvv.
The error was: KeyError: 'getpwuid(): uid not found: 1000220000'
fatal: [localhost]: FAILED! =&gt; {&quot;msg&quot;: &quot;Unexpected failure during module execution.&quot;, &quot;stdout&quot;: &quot;&quot;}
	to retry, use: --limit @/major-ansible-messaround/playbook.retry

PLAY RECAP *********************************************************************
localhost                  : ok=0    changed=0    unreachable=0    failed=1
</code></pre><p>This exception is telling us that <a href=https://linux.die.net/man/3/getpwuid>getpwuid()</a> was not able to find an entry
in <code>/etc/passwd</code> for our UID (<code>1000220000</code> in this container).</p><p>One option would be to adjust the playbook so that we skip the fact gathering
process:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#268bd2;font-weight:700>hosts</span>: <span style=color:#2aa198>all</span>
  <span style=color:#268bd2;font-weight:700>gather_facts</span>: <span style=color:#859900;font-weight:700>no</span>
  <span style=color:#268bd2;font-weight:700>tasks</span>:

    - <span style=color:#268bd2;font-weight:700>name</span>: <span style=color:#2aa198>Run tests</span>
      <span style=color:#268bd2;font-weight:700>command</span>: <span style=color:#2aa198>./run_tests.sh</span>
</code></pre></div><p>However, this might not be helpful if you need facts to be gathered for your
playbook to run. In that case, you need to make some adjustments to your
container image first.</p><h2 id=updating-the-container>Updating the container</h2><p>Nothing in the container image is writable within OpenShift, but we can change
certain files to be group writable for the root user since every OpenShift
user has an effective GID of <code>0</code>.</p><p>When you build your container, add a line to your Dockerfile to allow the
container user to have group write access to <code>/etc/passwd</code> and <code>/etc/group</code>:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=color:#93a1a1;font-style:italic># Make Ansible happy with arbitrary UID/GID in OpenShift.</span>
<span style=color:#859900>RUN</span> chmod <span style=color:#268bd2>g</span>=u /etc/passwd /etc/group
</code></pre></div><p>Once your container has finished building, the permissions on both files
should look like this:</p><pre><code>$ ls -al /etc/passwd /etc/group
-rw-rw-r--. 1 root root 514 Mar 20 18:12 /etc/group
-rw-rw-r--. 1 root root 993 Mar 20 18:12 /etc/passwd
</code></pre><h2 id=make-a-user-account>Make a user account</h2><p>Now that we&rsquo;ve made these files writable for our user in OpenShift, it&rsquo;s time
to change how we run our GitLab CI job. My job YAML currently looks like this:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2;font-weight:700>ansible_test</span>:
  <span style=color:#268bd2;font-weight:700>image</span>: <span style=color:#2aa198>docker.io/major/ansible:fedora29</span>
  <span style=color:#268bd2;font-weight:700>script</span>:
    - <span style=color:#2aa198>ansible-playbook -i hosts playbook.yml</span>
</code></pre></div><p>We can add two lines that allow us to make a temporary user and group account
for our OpenShift user:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2;font-weight:700>ansible_test</span>:
  <span style=color:#268bd2;font-weight:700>image</span>: <span style=color:#2aa198>docker.io/major/ansible:fedora29</span>
  <span style=color:#268bd2;font-weight:700>script</span>:
    - <span style=color:#2aa198>echo &#34;tempuser❌$(id -u):$(id -g):,,,:${HOME}:/bin/bash&#34; &gt;&gt; /etc/passwd</span>
    - <span style=color:#2aa198>echo &#34;tempuser❌$(id -G | cut -d&#39; &#39; -f 2)&#34; &gt;&gt; /etc/group</span>
    - <span style=color:#2aa198>id</span>
    - <span style=color:#2aa198>ansible-playbook -i hosts playbook.yml</span>
</code></pre></div><p>Note that we want the second GID returned by <code>id</code> since the first one is <code>0</code>.
The <code>id</code> command helps us check our work when the container starts. When the
CI job starts, we should see some better output:</p><pre><code>$ echo &quot;tempuser❌$(id -u):$(id -g):,,,:${HOME}:/bin/bash&quot; &gt;&gt; /etc/passwd
$ echo &quot;tempuser❌$(id -G | cut -d' ' -f 2)&quot; &gt;&gt; /etc/group
$ id
uid=1000220000(tempuser) gid=0(root) groups=0(root),1000220000(tempuser)
$ ansible-playbook -i hosts playbook.yml

PLAY [all] *********************************************************************

TASK [Gathering Facts] *********************************************************
ok: [localhost]

TASK [Download kernel source] **************************************************
changed: [localhost]

PLAY RECAP *********************************************************************
localhost                  : ok=2    changed=1    unreachable=0    failed=0
</code></pre><p>Success!</p></content><p><a href=https://major.io/tags/openshift/>#openshift</a>
<a href=https://major.io/tags/ansible/>#ansible</a>
<a href=https://major.io/tags/security/>#security</a>
<a href=https://major.io/tags/gitlab/>#gitlab</a></p></main><footer><script async src=https://media.ethicalads.io/media/client/ethicalads.min.js></script><div data-ea-publisher=major-io data-ea-type=text></div><hr>CC-BY-SA 4.0 &#187;
Made with <a href=https://gohugo.io/>Hugo</a> &#187;
Theme based on <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a><br></footer></body></html>