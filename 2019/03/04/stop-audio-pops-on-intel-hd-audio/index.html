<!doctype html><html lang=en-us><head><meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://major.io/favicon.ico><title>Stop audio pops on Intel HD Audio | Major Hayden's Blog ðŸ¤ </title><meta name=title content="Stop audio pops on Intel HD Audio"><meta name=description content="I recently picked up a Dell Optiplex 7060 and I&rsquo;m using it as my main workstation now. The Fedora installation was easy, but I noticed a variety of &ldquo;pop&rdquo; or clicking sounds when audio played, especially terminal bells.
If everything was quiet and I triggered a terminal bell, I would hear a loud pop just before the terminal bell sound. However, if I played music and then triggered a terminal bell, the pop was gone."><meta name=keywords content="linux,fedora,sound,"><meta property="og:title" content="Stop audio pops on Intel HD Audio"><meta property="og:description" content="I recently picked up a Dell Optiplex 7060 and I&rsquo;m using it as my main workstation now. The Fedora installation was easy, but I noticed a variety of &ldquo;pop&rdquo; or clicking sounds when audio played, especially terminal bells.
If everything was quiet and I triggered a terminal bell, I would hear a loud pop just before the terminal bell sound. However, if I played music and then triggered a terminal bell, the pop was gone."><meta property="og:type" content="article"><meta property="og:url" content="https://major.io/2019/03/04/stop-audio-pops-on-intel-hd-audio/"><meta property="og:image" content="https://major.io/images/2019-03-04-headphones.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-03-04T00:00:00+00:00"><meta property="article:modified_time" content="2019-03-04T00:00:00+00:00"><meta property="og:site_name" content="Major Hayden's Blog ðŸ¤ "><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://major.io/images/2019-03-04-headphones.jpg"><meta name=twitter:title content="Stop audio pops on Intel HD Audio"><meta name=twitter:description content="I recently picked up a Dell Optiplex 7060 and I&rsquo;m using it as my main workstation now. The Fedora installation was easy, but I noticed a variety of &ldquo;pop&rdquo; or clicking sounds when audio played, especially terminal bells.
If everything was quiet and I triggered a terminal bell, I would hear a loud pop just before the terminal bell sound. However, if I played music and then triggered a terminal bell, the pop was gone."><meta name=twitter:site content="@mhayden"><meta itemprop=name content="Stop audio pops on Intel HD Audio"><meta itemprop=description content="I recently picked up a Dell Optiplex 7060 and I&rsquo;m using it as my main workstation now. The Fedora installation was easy, but I noticed a variety of &ldquo;pop&rdquo; or clicking sounds when audio played, especially terminal bells.
If everything was quiet and I triggered a terminal bell, I would hear a loud pop just before the terminal bell sound. However, if I played music and then triggered a terminal bell, the pop was gone."><meta itemprop=datePublished content="2019-03-04T00:00:00+00:00"><meta itemprop=dateModified content="2019-03-04T00:00:00+00:00"><meta itemprop=wordCount content="634"><meta itemprop=image content="https://major.io/images/2019-03-04-headphones.jpg"><meta itemprop=keywords content="linux,fedora,sound,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:820px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px}div.highlight code{background-color:unset;color:initial}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style></head><body><header><a href=../../../../ class=title><h2>Major Hayden's Blog ðŸ¤ </h2></a><nav><a href=../../../../>Home</a>
<a href=../../../../ham-radio-faq>Ham Radio</a>
<a href=../../../../icanhazip-com-faq>icanhazip FAQ</a>
<a href=../../../../posts>Posts</a></nav></header><main><h1>Stop audio pops on Intel HD Audio</h1><i><time datetime=2019-03-04 pubdate>2019-03-04</time></i>
<content><p><img src=../../../../images/2019-03-04-headphones.jpg alt=headphones></p><p>I recently picked up a Dell Optiplex 7060 and I&rsquo;m using it as my main
workstation now. The Fedora installation was easy, but I noticed a variety of
&ldquo;pop&rdquo; or clicking sounds when audio played, especially terminal bells.</p><p>If everything was quiet and I triggered a terminal bell, I would hear a loud
pop just before the terminal bell sound. However, if I played music and then
triggered a terminal bell, the pop was gone.</p><p>A quick Google search told me that the likely culprit was power saving
settings on my Intel HD Audio chipset:</p><pre><code>$ lspci | grep Audio
00:1f.3 Audio device: Intel Corporation Cannon Lake PCH cAVS (rev 10)
</code></pre><h2 id=fixing-it>Fixing it</h2><p>There&rsquo;s a handy power saving tunable available at
<code>/sys/module/snd_hda_intel/parameters/power_save</code> that can be usd to adjust
the timeout or disable power savings entirely. In my case, the delay was set
to one second.</p><pre><code>$ cat /sys/module/snd_hda_intel/parameters/power_save
1
</code></pre><p>That would be good for a laptop use case, but my workstation is always
plugged in. I disabled it by setting it to zero:</p><pre><code># echo 0 &gt; /sys/module/snd_hda_intel/parameters/power_save
$ cat /sys/module/snd_hda_intel/parameters/power_save
0
</code></pre><p>And the pops are gone! My Klipsch speakers have a built in amplifier and it
was likely the abrupt changes in current that was causing the popping noises.</p><p>This setting will last until you reboot. You can make it permanent by adding
this text to <code>/etc/modprobe.d/audio_disable_powersave.conf</code>:</p><pre><code>options snd_hda_intel power_save=0
</code></pre><p>If you&rsquo;re a laptop user and you want power savings but fewer pops, you could
increase the delay to a more acceptable number. For example, setting it to
<code>60</code> would mean that the card will power down after 60 seconds of silence.
Just remember that you&rsquo;ll get a nice pop when the 60 seconds has passed and a
new sound is played.</p><h2 id=learning-more>Learning more</h2><p>Diving into the kernel code reveals the tunable in
<code>/sound/pci/hda/hda_intel.c</code>:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#859900>static</span> <span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>power_save</span> = <span style=color:#268bd2>CONFIG_SND_HDA_POWER_SAVE_DEFAULT</span>;
<span style=color:#268bd2>module_param</span>(<span style=color:#268bd2>power_save</span>, <span style=color:#268bd2>xint</span>, <span style=color:#2aa198;font-weight:700>0644</span>);
<span style=color:#268bd2>MODULE_PARM_DESC</span>(<span style=color:#268bd2>power_save</span>, <span style=color:#2aa198>&#34;Automatic power-saving timeout &#34;</span>
		 <span style=color:#2aa198>&#34;(in second, 0 = disable).&#34;</span>);
</code></pre></div><p>The default comes from a kernel config option:
<code>CONFIG_SND_HDA_POWER_SAVE_DEFAULT</code>. Most kernel packages on most
distributions provide access to the kernel config file that was used to build
the kernel originally. It&rsquo;s often found in <code>/boot</code> (named the same as the
kernel version) or it might be available at <code>/proc/config.gz</code>.</p><p>For Fedora, the kernel config is provided in <code>/boot</code> whenever a new kernel is
is installed. I inspected mine and found:</p><pre><code>$ grep HDA_POWER_SAVE_DEFAULT /boot/config-4.20.13-200.fc29.x86_64
CONFIG_SND_HDA_POWER_SAVE_DEFAULT=1
</code></pre><p>The <code>power_save</code> setting is applied in <code>/sound/pci/hda/hda_codec.c</code>:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#93a1a1;font-style:italic>/**
</span><span style=color:#93a1a1;font-style:italic> * snd_hda_set_power_save - reprogram autosuspend for the given delay
</span><span style=color:#93a1a1;font-style:italic> * @bus: HD-audio bus
</span><span style=color:#93a1a1;font-style:italic> * @delay: autosuspend delay in msec, 0 = off
</span><span style=color:#93a1a1;font-style:italic> *
</span><span style=color:#93a1a1;font-style:italic> * Synchronize the runtime PM autosuspend state from the power_save option.
</span><span style=color:#93a1a1;font-style:italic> */</span>
<span style=color:#859900;font-weight:700>void</span> <span style=color:#268bd2>snd_hda_set_power_save</span>(<span style=color:#859900>struct</span> <span style=color:#268bd2>hda_bus</span> *<span style=color:#268bd2>bus</span>, <span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>delay</span>)
{
	<span style=color:#859900>struct</span> <span style=color:#268bd2>hda_codec</span> *<span style=color:#268bd2>c</span>;

	<span style=color:#268bd2>list_for_each_codec</span>(<span style=color:#268bd2>c</span>, <span style=color:#268bd2>bus</span>)
		<span style=color:#268bd2>codec_set_power_save</span>(<span style=color:#268bd2>c</span>, <span style=color:#268bd2>delay</span>);
}
<span style=color:#268bd2>EXPORT_SYMBOL_GPL</span>(<span style=color:#268bd2>snd_hda_set_power_save</span>);
</code></pre></div><p>We can look where <code>codec_set_power_save</code> is defined in the same file to learn
more:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#93a1a1;font-style:italic>#ifdef CONFIG_PM
</span><span style=color:#93a1a1;font-style:italic></span><span style=color:#859900>static</span> <span style=color:#859900;font-weight:700>void</span> <span style=color:#268bd2>codec_set_power_save</span>(<span style=color:#859900>struct</span> <span style=color:#268bd2>hda_codec</span> *<span style=color:#268bd2>codec</span>, <span style=color:#859900;font-weight:700>int</span> <span style=color:#268bd2>delay</span>)
{
	<span style=color:#859900>struct</span> <span style=color:#268bd2>device</span> *<span style=color:#268bd2>dev</span> = <span style=color:#268bd2>hda_codec_dev</span>(<span style=color:#268bd2>codec</span>);

	<span style=color:#859900>if</span> (<span style=color:#268bd2>delay</span> == <span style=color:#2aa198;font-weight:700>0</span> &amp;&amp; <span style=color:#268bd2>codec</span>-&gt;<span style=color:#268bd2>auto_runtime_pm</span>)
		<span style=color:#268bd2>delay</span> = <span style=color:#2aa198;font-weight:700>3000</span>;

	<span style=color:#859900>if</span> (<span style=color:#268bd2>delay</span> &gt; <span style=color:#2aa198;font-weight:700>0</span>) {
		<span style=color:#268bd2>pm_runtime_set_autosuspend_delay</span>(<span style=color:#268bd2>dev</span>, <span style=color:#268bd2>delay</span>);
		<span style=color:#268bd2>pm_runtime_use_autosuspend</span>(<span style=color:#268bd2>dev</span>);
		<span style=color:#268bd2>pm_runtime_allow</span>(<span style=color:#268bd2>dev</span>);
		<span style=color:#859900>if</span> (!<span style=color:#268bd2>pm_runtime_suspended</span>(<span style=color:#268bd2>dev</span>))
			<span style=color:#268bd2>pm_runtime_mark_last_busy</span>(<span style=color:#268bd2>dev</span>);
	} <span style=color:#859900>else</span> {
		<span style=color:#268bd2>pm_runtime_dont_use_autosuspend</span>(<span style=color:#268bd2>dev</span>);
		<span style=color:#268bd2>pm_runtime_forbid</span>(<span style=color:#268bd2>dev</span>);
	}
}
</code></pre></div><p>This logic looks to see if <code>CONFIG_PM</code> is set to know if power management is
desired at all. From there, it checks if we disabled power saving but there&rsquo;s
a discrete graphics card involved (<code>codec->auto_runtime_pm</code>). This check is
important because the discrete graphics card cannot power down unless the HDA
card suspends at the same time.</p><p>Next, there&rsquo;s a check to see if the delay is greater than 0. This would be
the case if <code>CONFIG_SND_HDA_POWER_SAVE_DEFAULT</code> was set to <code>1</code> (Fedora&rsquo;s
default). If so, the proper auto suspend delays are set.</p><p>If the delay is 0, then autosuspend is disabled and removed from power
management entirely. This is the option I chose and it&rsquo;s working great.</p><p><em>Photo source: <a href=https://www.maxpixel.net/Headphone-Caption-Music-Sound-Listing-Music-2694489>Max Pixel</a></em></p></content><p><a href=https://major.io/tags/linux/>#linux</a>
<a href=https://major.io/tags/fedora/>#fedora</a>
<a href=https://major.io/tags/sound/>#sound</a></p></main><footer><hr>CC-BY-SA 4.0 &#187;
Made with <a href=https://gohugo.io/>Hugo</a> &#187;
Theme based on <a href=https://github.com/janraasch/hugo-bearblog/>Hugo Ê•â€¢á´¥â€¢Ê” Bear</a><br><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "aca54cb1322647b89c43a40751f02ce4"}'></script></footer></body></html>