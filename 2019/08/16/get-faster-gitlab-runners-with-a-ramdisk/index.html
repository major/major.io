<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Major Hayden"><meta name=description content="When you build tons of kernels every day like my team does, you look for speed improvements anywhere you can. Caching repositories, artifacts, and compiled objects makes kernel builds faster and it reduces infrastructure costs.
Need for speed We use GitLab CI in plenty of places, and that means we have a lot of gitlab-runner configurations for OpenShift (using the kubernetes executor) and AWS (using the docker-machine executor). The runner&amp;rsquo;s built-in caching makes it easy to upload and download cached items from object storage repositories like Google Cloud Storage or Amazon S3."><meta name=keywords content=",buildah,containers,fedora,gitlab,linux,podman"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://major.io/2019/08/16/get-faster-gitlab-runners-with-a-ramdisk/><title>Get faster GitLab runners with a ramdisk :: Major Hayden ü§† ‚Äî Words of wisdom from a social nerd</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=../../../../main.89fa80e2143f71bd5c96a7c94e531dec3276a367e22f87e74a76026ab64680bf.css><link rel=apple-touch-icon sizes=180x180 href=../../../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../../favicon-16x16.png><link rel=manifest href=../../../../site.webmanifest><link rel=mask-icon href=../../../../safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=../../../../favicon.ico><meta name=msapplication-TileColor content="#252627"><meta name=theme-color content="#252627"><meta itemprop=name content="Get faster GitLab runners with a ramdisk"><meta itemprop=description content="When you build tons of kernels every day like my team does, you look for speed improvements anywhere you can. Caching repositories, artifacts, and compiled objects makes kernel builds faster and it reduces infrastructure costs.
Need for speed We use GitLab CI in plenty of places, and that means we have a lot of gitlab-runner configurations for OpenShift (using the kubernetes executor) and AWS (using the docker-machine executor). The runner&rsquo;s built-in caching makes it easy to upload and download cached items from object storage repositories like Google Cloud Storage or Amazon S3."><meta itemprop=datePublished content="2019-08-16T00:00:00+00:00"><meta itemprop=dateModified content="2019-08-16T00:00:00+00:00"><meta itemprop=wordCount content="591"><meta itemprop=image content="https://major.io"><meta itemprop=keywords content="buildah,containers,fedora,gitlab,linux,podman,"><meta property="article:section" content="Blog Posts"><meta property="article:published_time" content="2019-08-16 00:00:00 +0000 UTC"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Get faster GitLab runners with a ramdisk :: Major Hayden ü§†"><meta name=twitter:description content="Many cloud providers give you lots of memory with each instance and you can speed up tests and builds by using a ramdisk."><meta name=twitter:site content="https://major.io"><meta name=twitter:creator content="Major Hayden"><meta name=twitter:image content="https://major.io/images/2019-08-16-jet-ski.jpg"><style type=text/css>html{letter-spacing:unset}</style></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=../../../../ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ echo major.io</span>
<span class=logo__cursor style=visibility:hidden></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=../../../../ham-radio-faq>hamradio</a></li><li><a href=../../../../icanhazip-com-faq>icanhazip</a></li><li><a href=../../../../posts/>posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://major.io/2019/08/16/get-faster-gitlab-runners-with-a-ramdisk/>Get faster GitLab runners with a ramdisk</a></h2><div class=post-content><p><img src=../../../../images/2019-08-16-jet-ski.jpg alt="Jet ski moving fast"></p><p>When you build tons of kernels every day like my team does, you look for
speed improvements anywhere you can. Caching repositories, artifacts, and
compiled objects makes kernel builds faster and it reduces infrastructure
costs.</p><h2 id=need-for-speed>Need for speed</h2><p>We use GitLab CI in plenty of places, and that means we have a lot of
gitlab-runner configurations for OpenShift (using the kubernetes executor)
and AWS (using the docker-machine executor). The runner&rsquo;s built-in <a href=https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runnerscache-section>caching</a>
makes it easy to upload and download cached items from object storage
repositories like Google Cloud Storage or Amazon S3.</p><p>However, there&rsquo;s an often overlooked feature hiding in the <a href=https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runnersdocker-section>configuration for
the docker executor</a> that provides a great performance boost: mounting tmpfs
inside your container. Not familiar with tmpfs? Arch Linux has a <a href=https://wiki.archlinux.org/index.php/Tmpfs>great wiki
page for tmpfs</a> and James Coyle has a <a href=https://www.jamescoyle.net/knowledge/951-the-difference-between-a-tmpfs-and-ramfs-ram-disk>well-written blog post</a> about what
makes it unique from the older ramfs.</p><p>RAM is much faster than your average cloud provider&rsquo;s block storage. It also
has incredibly low latency relative to most storage media. There&rsquo;s a <a href=https://people.eecs.berkeley.edu/~rcs/research/interactive_latency.html>great
interactive latency page</a> that allows you to use a slider to travel back in
time to 1990 and compare all kinds of storage performance numbers. <em>(It&rsquo;s
really fun! Go drag the slider and be amazed.)</em></p><p>Better yet, many cloud providers give you lots of RAM per CPU on their
instances, so if your work isn&rsquo;t terribly memory intensive, you can use a lot
of this RAM for faster storage.</p><h2 id=enabling-tmpfs-in-docker-containers>Enabling tmpfs in Docker containers</h2><p>‚ö†Ô∏è <strong>Beware of the dangers of tmpfs before adjusting your runner
configuration!</strong> See the warnings at the end of this post.</p><p>This configuration is buried in the middle of the <a href=https://docs.gitlab.com/runner/executors/docker.html#mounting-a-directory-in-ram>docker executor
documentation</a>. You will need to add some extra configuration to your
<code>[runners.docker]</code> section to make it work:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml>[runners.docker]
  [runners.docker.tmpfs]
      <span style=color:#2aa198>&#34;/ramdisk&#34;</span> = <span style=color:#2aa198>&#34;rw,noexec&#34;</span>
</code></pre></div><p>This configuration mounts a tmpfs volume underneath <code>/ramdisk</code> inside the
container. By default, this directory will be mounted with <code>noexec</code>, but if
you need to execute scripts from that directory, change <code>noexec</code> to <code>exec</code>:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml>[runners.docker]
  [runners.docker.tmpfs]
      <span style=color:#2aa198>&#34;/ramdisk&#34;</span> = <span style=color:#2aa198>&#34;rw,exec&#34;</span>
</code></pre></div><p>In our case, compiling kernels requires executing scripts, so we use <code>exec</code>
for our tmpfs mounts.</p><p><strong>You must be specific for <code>exec</code>!</strong> As an example, this tmpfs volume will be
mounted with <code>noexec</code> since that is the default:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml>[runners.docker]
  [runners.docker.tmpfs]
      <span style=color:#2aa198>&#34;/ramdisk&#34;</span> = <span style=color:#2aa198>&#34;rw&#34;</span>
</code></pre></div><h2 id=extra-speed>Extra speed</h2><p>For even more speed, we moved the objects generated by <code>ccache</code> to the
ramdisk. The seek times are much lower and this allows <code>ccache</code> to look for
its cached objects much more quickly.</p><p>Git repositories are also great things to stash on tmpfs. Big kernel
repositories are usually 1.5GB to 2GB in size with tons of files. Checkouts
are really fast when they&rsquo;re done in tmpfs.</p><h2 id=dangers-are-lurking>Dangers are lurking</h2><p>‚ö†Ô∏è As mentioned earlier, <strong>beware of the dangers of tmpfs.</strong></p><ul><li><p>All of the containers on the machine will share the same amount of RAM for
their tmpfs volumes. Be sure to account for how much each container will use
and how many containers <em>could</em> be present on the same machine.</p></li><li><p>Be aware of how much memory your tests will use when they run. In our case,
kernel compiles can consume 2-4GB of RAM, depending on configuration, so we
try our best to leave some memory free.</p></li><li><p>These volumes also have no limits on how much data can go into the volume.
However, if you put too much data into the tmpfs volume and your system runs
critically low on available RAM, you could see a huge drop in performance,
system instability, or even a crash. üî•</p></li></ul><p><em><a href=https://www.maxpixel.net/Water-Jet-Ski-Fast-Speed-Summer-Fun-Sport-1470072>Photo credit</a></em></p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://major.io/tags/buildah/>buildah</a></span>
<span class=tag><a href=https://major.io/tags/containers/>containers</a></span>
<span class=tag><a href=https://major.io/tags/fedora/>fedora</a></span>
<span class=tag><a href=https://major.io/tags/gitlab/>gitlab</a></span>
<span class=tag><a href=https://major.io/tags/linux/>linux</a></span>
<span class=tag><a href=https://major.io/tags/podman/>podman</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span class=tag><a href=https://major.io/categories/blog-posts/>Blog Posts</a></span></p></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span><a href=https://major.io>Major Hayden</a></span>
<span><a href=https://creativecommons.org/licenses/by-sa/2.0/ target=_blank rel=noopener>CC BY-SA 2.0</a></span><span><a href=https://major.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>Djordje Atlialp</a></span></div></div></footer></div><script type=text/javascript src=../../../../bundle.min.9dd6c4fd1eb55000d257db1269676cdb26bfcc9ab1b1dc8885a54f94b97fa86e6d72e435907d76f8662e0f65472e78ab8ad69c36624d8d4a96c04c42e029d957.js integrity="sha512-ndbE/R61UADSV9sSaWds2ya/zJqxsdyIhaVPlLl/qG5tcuQ1kH12+GYuD2VHLniritacNmJNjUqWwExC4CnZVw=="></script></body></html>