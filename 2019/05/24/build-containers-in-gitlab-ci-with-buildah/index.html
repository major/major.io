<!doctype html><html lang=en-us><head><meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://major.io/favicon.ico><title>Build containers in GitLab CI with buildah | Major Hayden's Blog ðŸ¤ </title><meta name=title content="Build containers in GitLab CI with buildah"><meta name=description content="My team at Red Hat depends heavily on GitLab CI and we build containers often to run all kinds of tests. Fortunately, GitLab offers up CI to build containers and a container registry in every repository to hold the containers we build.
This is really handy because it keeps everything together in one place: your container build scripts, your container build infrastructure, and the registry that holds your containers. Better yet, you can put multiple types of containers underneath a single git repository if you need to build containers based on different Linux distributions."><meta name=keywords content="buildah,containers,docker,gitlab,linux,podman,"><meta property="og:title" content="Build containers in GitLab CI with buildah"><meta property="og:description" content="My team at Red Hat depends heavily on GitLab CI and we build containers often to run all kinds of tests. Fortunately, GitLab offers up CI to build containers and a container registry in every repository to hold the containers we build.
This is really handy because it keeps everything together in one place: your container build scripts, your container build infrastructure, and the registry that holds your containers. Better yet, you can put multiple types of containers underneath a single git repository if you need to build containers based on different Linux distributions."><meta property="og:type" content="article"><meta property="og:url" content="https://major.io/2019/05/24/build-containers-in-gitlab-ci-with-buildah/"><meta property="og:image" content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-05-24T00:00:00+00:00"><meta property="article:modified_time" content="2019-05-24T00:00:00+00:00"><meta property="og:site_name" content="Major Hayden's Blog ðŸ¤ "><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta name=twitter:title content="Build containers in GitLab CI with buildah"><meta name=twitter:description content="My team at Red Hat depends heavily on GitLab CI and we build containers often to run all kinds of tests. Fortunately, GitLab offers up CI to build containers and a container registry in every repository to hold the containers we build.
This is really handy because it keeps everything together in one place: your container build scripts, your container build infrastructure, and the registry that holds your containers. Better yet, you can put multiple types of containers underneath a single git repository if you need to build containers based on different Linux distributions."><meta name=twitter:site content="@mhayden"><meta itemprop=name content="Build containers in GitLab CI with buildah"><meta itemprop=description content="My team at Red Hat depends heavily on GitLab CI and we build containers often to run all kinds of tests. Fortunately, GitLab offers up CI to build containers and a container registry in every repository to hold the containers we build.
This is really handy because it keeps everything together in one place: your container build scripts, your container build infrastructure, and the registry that holds your containers. Better yet, you can put multiple types of containers underneath a single git repository if you need to build containers based on different Linux distributions."><meta itemprop=datePublished content="2019-05-24T00:00:00+00:00"><meta itemprop=dateModified content="2019-05-24T00:00:00+00:00"><meta itemprop=wordCount content="884"><meta itemprop=image content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta itemprop=keywords content="buildah,containers,docker,gitlab,linux,podman,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:820px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px}div.highlight code{background-color:unset;color:initial}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style></head><body><header><a href=../../../../ class=title><h2>Major Hayden's Blog ðŸ¤ </h2></a><nav><a href=../../../../>Home</a>
<a href=../../../../ham-radio-faq>Ham Radio</a>
<a href=../../../../icanhazip-com-faq>icanhazip FAQ</a>
<a href=../../../../posts>Posts</a></nav></header><main><h1>Build containers in GitLab CI with buildah</h1><i><time datetime=2019-05-24 pubdate>2019-05-24</time></i>
<content><p><img src=../../../../images/2019-05-24-cranes-skycrapers.jpg alt="cranes and skyscrapers"></p><p>My team at Red Hat depends heavily on <a href=https://about.gitlab.com/product/continuous-integration/>GitLab CI</a> and we build containers
often to run all kinds of tests. Fortunately, GitLab offers up CI to build
containers and a <a href=https://about.gitlab.com/2016/05/23/gitlab-container-registry/>container registry</a> in every repository to hold the
containers we build.</p><p>This is really handy because it keeps everything together in one place: your
container build scripts, your container build infrastructure, and the
registry that holds your containers. Better yet, you can put multiple types
of containers underneath a single git repository if you need to build
containers based on different Linux distributions.</p><h2 id=building-with-docker-in-gitlab-ci>Building with Docker in GitLab CI</h2><p>By default, GitLab offers up a <a href=https://docs.gitlab.com/ee/ci/docker/using_docker_build.html>Docker builder</a> that works just fine. The CI
system clones your repository, builds your containers and pushes them
wherever you want. There&rsquo;s even a <a href=https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#using-docker-caching>simple CI YAML file</a> that does everything
end-to-end for you.</p><p>However, I have two issues with the Docker builder:</p><ul><li><p><strong>Larger images:</strong> The Docker image layering is handy, but the images end up
being a bit larger, especially if you don&rsquo;t do a little cleanup in each
stage.</p></li><li><p><strong>Additional service:</strong> It requires an additional service inside the CI
runner for the <code>dind</code> (&ldquo;Docker in Docker&rdquo;) builder. This has caused some CI
delays for me several times.</p></li></ul><h2 id=building-with-buildah-in-gitlab-ci>Building with buildah in GitLab CI</h2><p>On my local workstation, I use <a href=https://podman.io/>podman</a> and <a href=https://buildah.io/>buildah</a> all the time to build,
run, and test containers. These tools are handy because I don&rsquo;t need to
remember to start the Docker daemon each time I want to mess with a
container. I also don&rsquo;t need sudo.</p><p>All of my containers are stored beneath my home directory. That&rsquo;s good for
keeping disk space in check, but it&rsquo;s especially helpful on shared servers
since each user has their own unique storage. My container pulls and builds
won&rsquo;t disrupt anyone else&rsquo;s work on the server and their work won&rsquo;t disrupt
mine.</p><p>Finally, buildah offers some nice options out of the box. First, when you
build a container with <code>buildah bud</code>, you end up with only three layers by
default:</p><ol><li>Original OS layer (example: <code>fedora:30</code>)</li><li>Everything you added on top of the OS layer</li><li>Tiny bit of metadata</li></ol><p>This is incredibly helpful if you use package managers like <code>dnf</code>, <code>apt</code>, and
<code>yum</code> that download a bunch of metadata before installing packages. You would
normally have to clear the metadata carefully for the package manager so that
your container wouldn&rsquo;t grow in size. Buildah takes care of that by squashing
all the stuff you add into one layer.</p><p>Of course, if you want to be more aggressive, buildah offers the <code>--squash</code>
option which squashes the whole image down into one layer. This can be
helpful if disk space is at a premium and you change the layers often.</p><h2 id=getting-started>Getting started</h2><p>I have a repository called <a href=https://gitlab.com/majorhayden/os-containers>os-containers</a> in GitLab that maintains fully
updated containers for Fedora 29 and 30. The <code>.gitlab-ci.yml</code> file calls
<code>build.sh</code> for two containers: <em>fedora29</em> and <em>fedora30</em>. Open the <code>build.sh</code>
file and follow along here:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#93a1a1;font-style:italic># Use vfs with buildah. Docker offers overlayfs as a default, but buildah</span>
<span style=color:#93a1a1;font-style:italic># cannot stack overlayfs on top of another overlayfs filesystem.</span>
<span style=color:#cb4b16>export</span> <span style=color:#268bd2>STORAGE_DRIVER</span>=vfs
</code></pre></div><p>First off, we need to tell buildah to use the vfs storage driver. Docker uses
overlayfs by default and stacking overlay filesystems will definitely lead to
problems. Buildah won&rsquo;t let you try it.</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#93a1a1;font-style:italic># Write all image metadata in the docker format, not the standard OCI format.</span>
<span style=color:#93a1a1;font-style:italic># Newer versions of docker can handle the OCI format, but older versions, like</span>
<span style=color:#93a1a1;font-style:italic># the one shipped with Fedora 30, cannot handle the format.</span>
<span style=color:#cb4b16>export</span> <span style=color:#268bd2>BUILDAH_FORMAT</span>=docker
</code></pre></div><p>By default, buildah uses the <a href=https://github.com/opencontainers/image-spec><em>oci</em> container format</a>. This sometimes causes
issues with older versions of Docker that don&rsquo;t understand how to parse that
type of metadata. By setting the format to <code>docker</code>, we&rsquo;re using a format
that almost all container runtimes can understand.</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#93a1a1;font-style:italic># Log into GitLab&#39;s container repository.</span>
<span style=color:#cb4b16>export</span> <span style=color:#268bd2>REGISTRY_AUTH_FILE</span>=<span style=color:#2aa198>${</span><span style=color:#268bd2>HOME</span><span style=color:#2aa198>}</span>/auth.json
<span style=color:#cb4b16>echo</span> <span style=color:#2aa198>&#34;</span><span style=color:#268bd2>$CI_REGISTRY_PASSWORD</span><span style=color:#2aa198>&#34;</span> | buildah login -u <span style=color:#2aa198>&#34;</span><span style=color:#268bd2>$CI_REGISTRY_USER</span><span style=color:#2aa198>&#34;</span> --password-stdin <span style=color:#268bd2>$CI_REGISTRY</span>
</code></pre></div><p>Here we set a path for the <code>auth.json</code> that contains the credentials for
talking to the container repository. We also use buildah to authenticate to
GitLab&rsquo;s built-in container repository. GitLab automatically exports these
variables for us (and hides them in the job output), so we can use them here.</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>buildah bud -f builds/<span style=color:#2aa198>${</span><span style=color:#268bd2>IMAGE_NAME</span><span style=color:#2aa198>}</span> -t <span style=color:#2aa198>${</span><span style=color:#268bd2>IMAGE_NAME</span><span style=color:#2aa198>}</span> .
</code></pre></div><p>We&rsquo;re now building the container and storing it temporarily as the bare image
name, such as <em>fedora30</em>. This is roughly equivalent to <code>docker build</code>.</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#268bd2>CONTAINER_ID</span>=<span style=color:#859900>$(</span>buildah from <span style=color:#2aa198>${</span><span style=color:#268bd2>IMAGE_NAME</span><span style=color:#2aa198>}</span><span style=color:#859900>)</span>
buildah commit --squash <span style=color:#268bd2>$CONTAINER_ID</span> <span style=color:#268bd2>$FQ_IMAGE_NAME</span>
</code></pre></div><p>Now we are making a reference to our container with <code>buildah from</code> and using
that reference to squash that container down into a single layer. This keeps
the container as small as possible.</p><p>The <code>commit</code> step also tags the resulting image using our fully qualified
image name (in this case, it&rsquo;s
<code>registry.gitlab.com/majorhayden/os-containers/fedora30:latest</code>)</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>buildah push <span style=color:#2aa198>${</span><span style=color:#268bd2>FQ_IMAGE_NAME</span><span style=color:#2aa198>}</span>
</code></pre></div><p>This is the same as <code>docker push</code>. There&rsquo;s not much special to see here.</p><h2 id=maintaining-containers>Maintaining containers</h2><p>GitLab allows you to take things to the next level with CI schedules. In my
repository, there is a schedule to build my containers once a day to catch
the latest updates. I use these containers a lot and they need to be up to
date before I can run tests.</p><p>If the container build fails for some reason, GitLab will send me an email to
let me know.</p><p><a href=https://pxhere.com/en/photo/942096><em>Photo Source</em></a></p></content><p><a href=https://major.io/tags/buildah/>#buildah</a>
<a href=https://major.io/tags/containers/>#containers</a>
<a href=https://major.io/tags/docker/>#docker</a>
<a href=https://major.io/tags/gitlab/>#gitlab</a>
<a href=https://major.io/tags/linux/>#linux</a>
<a href=https://major.io/tags/podman/>#podman</a></p></main><footer><script async src=https://media.ethicalads.io/media/client/ethicalads.min.js></script><div data-ea-publisher=major-io data-ea-type=text></div><hr>CC-BY-SA 4.0 &#187;
Made with <a href=https://gohugo.io/>Hugo</a> &#187;
Theme based on <a href=https://github.com/janraasch/hugo-bearblog/>Hugo Ê•â€¢á´¥â€¢Ê” Bear</a><br></footer></body></html>