<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Encrypted gitops secrets with flux and age &#183; 🤠 Major Hayden</title><meta name=title content="Encrypted gitops secrets with flux and age &#183; 🤠 Major Hayden"><meta name=description content="A social nerd writing about everything"><link rel=canonical href=https://major.io/2022/04/19/encrypted-gitops-secrets-with-flux-and-age/><link type=text/css rel=stylesheet href=/css/main.bundle.min.55253fde34a251b02bdc3be052caf9044f977a6d44817f370ad781aed774a2a79759827fd0c3255abb87575848a355a0068eb43b2958172f6c237352069d6cea.css integrity="sha512-VSU/3jSiUbAr3DvgUsr5BE+Xem1EgX83CteBrtd0oqeXWYJ/0MMlWruHV1hIo1WgBo60OylYFy9sI3NSBp1s6g=="><script type=text/javascript src=/js/appearance.min.badab316c9287a5a42a843e4eb45da65bb3d194a5a0f5fa4a3e516160e67df0b8c65f4f19a8e146436e29d583699e6cb41d6bbe99e05e1dbaa877763bad9f8e2.js integrity="sha512-utqzFskoelpCqEPk60XaZbs9GUpaD1+ko+UWFg5n3wuMZfTxmo4UZDbinVg2mebLQda76Z4F4duqh3djutn44g=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.15ae6e2c9b1ac24a9ccf40003fa689efb1a18db1ee9b73d780b01a6c31b150441415862513e93184f68fe385759e4698b8763cba6a0f79493c1fed99ad5868d4.js integrity="sha512-Fa5uLJsawkqcz0AAP6aJ77GhjbHum3PXgLAabDGxUEQUFYYlE+kxhPaP44V1nkaYuHY8umoPeUk8H+2ZrVho1A==" data-copy=Copy data-copied=Copied></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="Encrypted gitops secrets with flux and age"><meta property="og:description" content="Store encrypted kubernetes secrets safely in your gitops repository with easy-to-use age encryption. 🔐"><meta property="og:type" content="article"><meta property="og:url" content="https://major.io/2022/04/19/encrypted-gitops-secrets-with-flux-and-age/"><meta property="og:image" content="https://major.io/2022/04/19/encrypted-gitops-secrets-with-flux-and-age/cover.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-19T00:00:00+00:00"><meta property="article:modified_time" content="2022-04-19T00:00:00+00:00"><meta property="og:site_name" content="🤠 Major Hayden"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://major.io/2022/04/19/encrypted-gitops-secrets-with-flux-and-age/cover.jpg"><meta name=twitter:title content="Encrypted gitops secrets with flux and age"><meta name=twitter:description content="Store encrypted kubernetes secrets safely in your gitops repository with easy-to-use age encryption. 🔐"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Encrypted gitops secrets with flux and age","headline":"Encrypted gitops secrets with flux and age","abstract":"Store encrypted kubernetes secrets safely in your gitops repository with easy-to-use age encryption. 🔐","inLanguage":"en","url":"https:\/\/major.io\/2022\/04\/19\/encrypted-gitops-secrets-with-flux-and-age\/","author":{"@type":"Person","name":"Major Hayden"},"copyrightYear":"2022","dateCreated":"2022-04-19T00:00:00\u002b00:00","datePublished":"2022-04-19T00:00:00\u002b00:00","dateModified":"2022-04-19T00:00:00\u002b00:00","keywords":["flux","gitops","kubernetes","linux","security"],"mainEntityOfPage":"true","wordCount":"1640"}]</script><meta name=author content="Major Hayden"><link href=mailto:major@mhtx.net rel=me><link href=https://github.com/major rel=me><link href=https://gitlab.com/majorhayden rel=me><link href=https://linkedin.com/in/majorhayden rel=me><link href=https://t.me/majorhayden rel=me><link href=https://twitter.com/majorhayden rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0" href=#main-content><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold sm:py-10 text-neutral-900 dark:text-neutral print:hidden"><nav class="flex justify-between"><div><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>🤠 Major Hayden</a></div><ul class="flex flex-col list-none ltr:text-right rtl:text-left sm:flex-row"><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/posts/ title=Posts>Blog</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/tags/ title=Tags>Tags</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/w5wut/ title="W5WUT: My amateur radio station">W5WUT</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/cv/ title="Major's CV">CV</a></li><li class="ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><button id=search-button class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>🤠 Major Hayden</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/2022/04/19/encrypted-gitops-secrets-with-flux-and-age/>Encrypted gitops secrets with flux and age</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Encrypted gitops secrets with flux and age</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2022-04-19 00:00:00 +0000 UTC">19 April 2022</time><span class="px-2 text-primary-500">&#183;</span><span>1640 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">8 mins</span></div><div class="my-1 text-xs text-neutral-500 dark:text-neutral-400"><a href=/tags/flux/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">flux</a>
<a href=/tags/gitops/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">gitops</a>
<a href=/tags/kubernetes/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">kubernetes</a>
<a href=/tags/linux/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">linux</a>
<a href=/tags/security/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">security</a></div></div></header><section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert"><div class="order-first px-0 lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8 lg:order-last"><div class="ltr:pl-5 rtl:pr-5 toc lg:sticky lg:top-10 print:hidden"><details open class="mt-0 overflow-hidden rounded-lg rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5"><summary class="block py-1 text-lg font-semibold cursor-pointer rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 text-neutral-800 dark:text-neutral-100 lg:hidden bg-neutral-100 dark:bg-neutral-700">Table of Contents</summary><div class="py-2 border-dotted ltr:border-l rtl:border-r rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 border-neutral-300 dark:border-neutral-600"><nav id=TableOfContents><ul><li><ul><li><a href=#what-about-this-gitops-thing>What about this gitops thing?</a></li><li><a href=#about-secrets>About secrets</a></li><li><a href=#secrets-in-git>Secrets in git</a></li><li><a href=#decrypting-secrets-with-flux>Decrypting secrets with flux</a></li><li><a href=#secrets-backend-bonanza>Secrets backend bonanza</a></li><li><a href=#generating-a-key>Generating a key</a></li><li><a href=#decryption-in-flux>Decryption in flux</a></li><li><a href=#epilogue>Epilogue</a></li></ul></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose"><figure><img class="my-0 rounded-md" srcset="/2022/04/19/encrypted-gitops-secrets-with-flux-and-age/cover_hu0712d76e78e30dbf644129ff0ba1349f_76084_330x0_resize_q75_box.jpg 330w,
/2022/04/19/encrypted-gitops-secrets-with-flux-and-age/cover_hu0712d76e78e30dbf644129ff0ba1349f_76084_660x0_resize_q75_box.jpg 660w,
/2022/04/19/encrypted-gitops-secrets-with-flux-and-age/cover_hu0712d76e78e30dbf644129ff0ba1349f_76084_1024x0_resize_q75_box.jpg 1024w,
/2022/04/19/encrypted-gitops-secrets-with-flux-and-age/cover_hu0712d76e78e30dbf644129ff0ba1349f_76084_1320x0_resize_q75_box.jpg 2x" src=/2022/04/19/encrypted-gitops-secrets-with-flux-and-age/cover_hu0712d76e78e30dbf644129ff0ba1349f_76084_660x0_resize_q75_box.jpg alt="Castle wall with turrets in front of a light blue sky background"><figcaption>Photo credit: <a href=https://unsplash.com/photos/uoU9NySvCks>Mert Kahveci</a></figcaption></figure><p>Kubernetes has always felt like an enigma to me. On one hand, I love containers and I
use them daily for personal and work projects. On the other hand, kubernetes feels like
a heavy, burdensome set of tools that can be difficult to maintain over time. Keeping
things organized in kubernetes deployments always felt challenging and unwieldy.</p><h2 id=what-about-this-gitops-thing class="relative group">What about this gitops thing? <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-about-this-gitops-thing aria-label=Anchor>#</a></span></h2><p>A friend suggested looking into the gitops realm as a way to tame container deployments.
Quick Google searches revealed that gitops is a <strong>mindset shift</strong> <em>(like DevOps)</em> and
not a product that a vendor can sell you.</p><p>At its core, gitops involves tracking the state of a deployment through version control.
Nothing updates the deployment unless it comes through version control first, and the
deployment should deploy itself based on the state specified in version control.</p><p>I found a few things intriguing:</p><ol><li>The gitops mindset forces you to get organized <strong>before you deploy</strong>, not after.</li><li>Gitops favors smaller change sets with better notes on each change.</li><li>CI can tell you how a change will work (or not work).</li><li>You can look at other people&rsquo;s gitops repositories for how they accomplished certain
automation tasks. <em>(Sometimes these include best practices and sometimes they most
definitely do not.)</em> 🤭</li></ol><p>This sounds great! My kubernetes manifests and configuration lives in one place in an
organized way. But wait &ndash; how do I handle secrets? 😱</p><h2 id=about-secrets class="relative group">About secrets <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#about-secrets aria-label=Anchor>#</a></span></h2><p>Kubernetes offers a resource type called <a href=https://kubernetes.io/docs/concepts/configuration/secret/>secrets</a>. Although secrets and <a href=https://kubernetes.io/docs/concepts/configuration/configmap/>ConfigMaps</a>
both do similar jobs of providing configuration data for various kubernetes resources,
secrets exist to hold sensitive information such as passwords, API keys, or TLS
certificate data. Bear in mind that neither are encrypted within the cluster itself.</p><p>In the past, I loaded kubernetes secrets by hand with <code>kubectl apply</code> and kept them out
of any shared storage, including git repositories. However, in my quest to follow the
gitops way, I wanted a better option with much less manual work. My goal is to build a
kubernetes deployment that could be redeployed from the git repository at a moment&rsquo;s
notice with the least amount of work required.</p><h2 id=secrets-in-git class="relative group">Secrets in git <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#secrets-in-git aria-label=Anchor>#</a></span></h2><p>Everyone knows that one should never store secrets in git. GitHub even has a special bot
that roams around repositories to find accidentally committed keys and tokens. The bot
notifies you about these problems within moments of your <code>git push</code> and it even takes
steps to disable certain API or SSH keys if they&rsquo;re attached to your repository
somewhere.</p><p>What about a private GitHub repository? Sure, that&rsquo;s one way to keep secrets away from
prying eyes, but if you ever want to open up the repository later, you have some secrets
in your history that must be cleaned. You also need deploy keys so that your cluster can
access the code in your private repository. It&rsquo;s a hassle.</p><p>What about encrypting the secrets before uploading? On the plus side, you can use a
public repository and share your code with someone else. No secrets appear in your git
history, either. However, your kubernetes cluster must have a way to decrypt these
secrets on the fly so it can reconcile any changes you make in the git repository.</p><h2 id=decrypting-secrets-with-flux class="relative group">Decrypting secrets with flux <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#decrypting-secrets-with-flux aria-label=Anchor>#</a></span></h2><p>After lots of reading and poking through git repositories, I settled on <a href=https://fluxcd.io/>flux</a> as my
gitops tool for kubernetes. It has an easy bootstrap process and it takes care of
configuring git repositories for you. It supports various decryption tools, including
the very popular <a href=https://github.com/mozilla/sops>SOPS</a> from Mozilla.</p><p>SOPS takes a kubernetes secret and encrypts it while maintaining the original structure
of the secrets file itself. This is handy because it encrypts the secret <em>value</em> but
leaves the <em>keys</em> as plain text. Troubleshooting gets easier when you know an
environment variable is present even if you can&rsquo;t see the value.</p><p>Flux provides great documentation for <a href=https://fluxcd.io/docs/guides/mozilla-sops/>using SOPS to manage secrets</a>.</p><p>But wait, SOPS supports PGP, age, Google Cloud&rsquo;s KMS, Azure&rsquo;s Key Vault, Hashicorp
Vault, and others. How do we decide?</p><h2 id=secrets-backend-bonanza class="relative group">Secrets backend bonanza <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#secrets-backend-bonanza aria-label=Anchor>#</a></span></h2><p>I want to keep my kubernetes deployment as lean and simple as possible, so that
eliminated the SOPS backends that require additional services, such as the Google Cloud,
Azure, or Hashicorp Vault options.</p><p>That leaves me with PGP and age. I&rsquo;ve used PGP a million times and it seemed like the
obvious choice. But then I thought: <strong>what the heck is age?</strong></p><p>A friend told me that <a href=https://github.com/FiloSottile/age>age</a> <em>(pronounced AHH-gey</em>) saved him plenty of headaches because
it&rsquo;s so much simpler than dealing with gnupg keyrings and PGP keys. It has smaller keys
that alleviate copy/paste issues and it&rsquo;s designed for encrypting files. Sensible
defaults also eliminate the need for complex configuration.</p><p>Let&rsquo;s combine SOPS with an age backend for storing our secrets in GitHub with flux
decrypting those secrets on the fly!</p><h2 id=generating-a-key class="relative group">Generating a key <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#generating-a-key aria-label=Anchor>#</a></span></h2><p>Start by installing SOPS and age using their documentation:</p><ul><li><a href=https://github.com/mozilla/sops#download>Install SOPS</a></li><li><a href=https://github.com/FiloSottile/age#installation>Install age</a></li></ul><p>Enjoy the hilariously brief <code>age-keygen</code> help text:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> age-keygen --help
</span></span><span class=line><span class=cl><span class=go>Usage:
</span></span></span><span class=line><span class=cl><span class=go>    age-keygen [-o OUTPUT]
</span></span></span><span class=line><span class=cl><span class=go>    age-keygen -y [-o OUTPUT] [INPUT]
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Options:
</span></span></span><span class=line><span class=cl><span class=go>    -o, --output OUTPUT       Write the result to the file at path OUTPUT.
</span></span></span><span class=line><span class=cl><span class=go>    -y                        Convert an identity file to a recipients file.
</span></span></span></code></pre></div><p>Let&rsquo;s make a key!</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> age-keygen -o sops-key.txt
</span></span><span class=line><span class=cl><span class=go>Public key: age1wnvnq64tpze4zjdmq2n44eh7jzkxf5ra7mxjvjld6cjwtaddffqqc54w23
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> cat sops-key.txt
</span></span><span class=line><span class=cl><span class=gp>#</span> created: 2022-04-19T14:41:19-05:00
</span></span><span class=line><span class=cl><span class=gp>#</span> public key: age1wnvnq64tpze4zjdmq2n44eh7jzkxf5ra7mxjvjld6cjwtaddffqqc54w23
</span></span><span class=line><span class=cl><span class=go>AGE-SECRET-KEY-13T0N7N0W9NZKDXEFYYPWU7GN65W3UPV6LRERXUZ3ZGED8SUAAQ4SK6SMDL
</span></span></span></code></pre></div><p>As you might expect with any other encryption scheme, the public key is the one we use
to encrypt (and it&rsquo;s okay to share), while the secret key decrypts data (and must be
kept private).</p><p>Next, make encryption easier by creating a small configuration file for SOPS. This
allows you to encrypt quickly without telling SOPS which key you want to use. Create a
<code>.sops.yaml</code> file like this one in the root directory of your flux repository:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>creation_rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>encrypted_regex</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;^(data|stringData)$&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>age</span><span class=p>:</span><span class=w> </span><span class=l>age1wnvnq64tpze4zjdmq2n44eh7jzkxf5ra7mxjvjld6cjwtaddffqqc54w23</span><span class=w>
</span></span></span></code></pre></div><p>Add your <em>public key</em> to the <code>age</code> key above in the YAML file.</p><p>Let&rsquo;s test it to ensure SOPS and age are working together:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> kubectl create secret generic sopstest --from-literal<span class=o>=</span><span class=nv>foo</span><span class=o>=</span>bar -o yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=go>    --dry-run=client | tee sops-test-secret.yaml
</span></span></span><span class=line><span class=cl><span class=go>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=go>data:
</span></span></span><span class=line><span class=cl><span class=go>  foo: YmFy
</span></span></span><span class=line><span class=cl><span class=go>kind: Secret
</span></span></span><span class=line><span class=cl><span class=go>metadata:
</span></span></span><span class=line><span class=cl><span class=go>  creationTimestamp: null
</span></span></span><span class=line><span class=cl><span class=go>  name: sopstest
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> sops -e sops-test-secret.yaml <span class=p>|</span> tee sops-test-secret-encrypted.yaml
</span></span><span class=line><span class=cl><span class=go>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=go>data:
</span></span></span><span class=line><span class=cl><span class=go>    foo: ENC[AES256_GCM,data:UZY1VQ==,iv:54ce6xcRc28sjBQU4OjvbBUkvFhs4UKxaM8lOQtsbI4=,tag:Ms906PUkzSgNVpV2A2oG9Q==,type:str]
</span></span></span><span class=line><span class=cl><span class=go>kind: Secret
</span></span></span><span class=line><span class=cl><span class=go>metadata:
</span></span></span><span class=line><span class=cl><span class=go>    creationTimestamp: null
</span></span></span><span class=line><span class=cl><span class=go>    name: sopstest
</span></span></span><span class=line><span class=cl><span class=go>sops:
</span></span></span><span class=line><span class=cl><span class=go>    kms: []
</span></span></span><span class=line><span class=cl><span class=go>    gcp_kms: []
</span></span></span><span class=line><span class=cl><span class=go>    azure_kv: []
</span></span></span><span class=line><span class=cl><span class=go>    hc_vault: []
</span></span></span><span class=line><span class=cl><span class=go>    age:
</span></span></span><span class=line><span class=cl><span class=go>        - recipient: age1w8dts3ptgqsqac60z8v2asney6akyktad43k5reguj5suj6y83rstgyh8v
</span></span></span><span class=line><span class=cl><span class=go>          enc: |
</span></span></span><span class=line><span class=cl><span class=go>            -----BEGIN AGE ENCRYPTED FILE-----
</span></span></span><span class=line><span class=cl><span class=go>            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBCM2prVitpS09wY3Q4NFpZ
</span></span></span><span class=line><span class=cl><span class=go>            eVlEc0xnOHRxT0poSk0wSWwrMDM2QVRJbjJRCjBMTjhiU1BwYWYwbVo5bWZlTjVF
</span></span></span><span class=line><span class=cl><span class=go>            c3Z6QXdNekM4Y0wrcGVNZ052VUR3MDgKLS0tIFo5dGNyM2Nxb2NVNm5odzkwNVJs
</span></span></span><span class=line><span class=cl><span class=go>            T1BXK0JhN3lKK0VaZTZTWUhyTHF0aWMKZtB5/fOeyjTy4FCkmlfn15OPabe0VKeZ
</span></span></span><span class=line><span class=cl><span class=go>            rJMdx3MyF+RDQZHjs9nk9drb2bnAZ2ew1uwx31DkayhGDGF3rpk+oA==
</span></span></span><span class=line><span class=cl><span class=go>            -----END AGE ENCRYPTED FILE-----
</span></span></span><span class=line><span class=cl><span class=go>    lastmodified: &#34;2022-04-19T19:50:20Z&#34;
</span></span></span><span class=line><span class=cl><span class=go>    mac: ENC[AES256_GCM,data:Hhu+4TxpI5Vpi4ZSXI79Lw+wEaZ6HxwfCTyRg6kExCBLHLJbULEfug11VTMrbMz6hpLnaRqBkq/FqLWqcxphzwTJ37p7OMeEtm7c7fN//t1sGjF96TP3MyqRypDbIFQCOPXEpnegASpis5HHLCLkvELXwyd/ucHlQs7gTUTzT4g=,iv:ssAD21AJ+wZr+XqrdZlRKmJeHbF5Sop5SGC8kAlQF+E=,tag:xZQvQltcb3wSnS5nQOjBFg==,type:str]
</span></span></span><span class=line><span class=cl><span class=go>    pgp: []
</span></span></span><span class=line><span class=cl><span class=go>    encrypted_regex: ^(data|stringData)$
</span></span></span><span class=line><span class=cl><span class=go>    version: 3.7.2
</span></span></span></code></pre></div><p>So what did we just do?</p><ul><li>We created a generic secret containing <code>foo: bar</code> and dumped it into a file without
sending it to kubernetes.</li><li>You might notice that <code>bar</code> became <code>YmFy</code> there. This is because kubernetes uses
base64 to <strong>encode</strong> <em>(not encrypt)</em> secret values to avoid YAML parsing issues.</li><li>Finally, we told SOPS to encrypt our secret to stdout, which we placed into a new
file. SOPS knew which key to use because of our <code>.sops.yaml</code> configuration file.</li></ul><blockquote><p>💣 Use caution with raw, unencrypted secret files in your local repository. Ensure
they cannot be committed to a repository accidentally via some sort of mechanism, such
as listing them in your <code>.gitignore</code> or removing them as soon as you&rsquo;ve finished
encrypting them.</p></blockquote><p>If we need to check or update our secret, we can always decrypt it using <code>sops -d</code>.</p><h2 id=decryption-in-flux class="relative group">Decryption in flux <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#decryption-in-flux aria-label=Anchor>#</a></span></h2><p>In one of the earlier sections, I talked about that the system that reconciles the
deployment with the repository (flux in this case), must be able to decrypt secrets all
by itself. But wait, how do we give flux the key?</p><p>I have not found a good automated way to get this done (yet), so this step is manual for
now. Luckily, this is a once per cluster task.</p><p>Our original key generation step created a <code>sops-key.txt</code> file and we need to create a
secret from that file that only flux can see:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl -n flux-system create secret generic sops-age <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --from-file<span class=o>=</span>age.agekey<span class=o>=</span>sops-key.txt
</span></span></code></pre></div><p>This command creates a generic secret called <code>sops-age</code> with our key text stored in the
<code>age.ageKey</code> YAML key. The secret exists only inside the <code>flux-system</code> namespace so that
only the pods in that namespace have permission to read it.</p><p>Finally, we must tell flux that it needs to decrypt secrets and we must provide the
location of the decryption key. Flux is built heavily on <a href=https://kustomize.io/>kustomize</a> manifests and
that&rsquo;s where our key configuration belongs.</p><p>Here&rsquo;s an example from my kustomization file for deploying <a href=https://traefik.io/>traefik</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kustomize.toolkit.fluxcd.io/v1beta2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Kustomization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>traefik</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>flux-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>10m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./apps/traefik</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prune</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dependsOn</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cert-manager-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>sourceRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>GitRepository</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flux-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Decryption configuration starts here</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>decryption</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>provider</span><span class=p>:</span><span class=w> </span><span class=l>sops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sops-age</span><span class=w>
</span></span></span></code></pre></div><p>The last four lines tell flux about our <code>sops-age</code> secret and that we&rsquo;re using the SOPS
backend for decryption. Commit this change and push it to your git repository.</p><p>So what happens when you commit and push an encrypted secrets file like the one we made
above for <code>foo: bar</code>?</p><ul><li>Flux sees the change in the git repository.</li><li>When it reaches the encrypted secret, it digs up the decryption configuration.</li><li>From there, it retrieves the <code>sops-age</code> secret, reads the key, and uses SOPS with age
to decrypt the secret.</li><li>Flux applies the secret resource in kubernetes.</li></ul><p>At this point, if you retrieve the secret with <code>kubectl -n my_namespace get secret/mysecret -o yaml</code>, you get the unencrypted secret. Flux decrypts the secret from
your git repository and adds it to kubernetes, but it remains unencrypted in the
kubernetes cluster. This allows pods in the namespace to read data from the secret
without any further decryption.</p><h2 id=epilogue class="relative group">Epilogue <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#epilogue aria-label=Anchor>#</a></span></h2><p>You might be asking: <em>&ldquo;How does this whole flux thing work? How do I set up flux and
fully embrace the gitops lifestyle?&rdquo;</em></p><p>Don&rsquo;t worry. You didn&rsquo;t miss anything. That&rsquo;s a post I have yet to write. 😉</p></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group" href=/2022/04/08/mount-nfs-shares-in-kubernetes/><span class="mr-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Mount NFS shares in kubernetes</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2022-04-08 00:00:00 +0000 UTC">8 April 2022</time></span></span></a></span>
<span><a class="flex text-right group" href=/2022/04/20/basic-authentication-with-traefik-on-kubernetes/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Basic authentication with Traefik on kubernetes</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2022-04-20 00:00:00 +0000 UTC">20 April 2022</time></span></span>
<span class="ml-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div class="absolute top-[100vh] ltr:right-0 rtl:left-0 w-12 pointer-events-none bottom-0"><a href=#the-top class="w-12 h-12 sticky pointer-events-auto top-[calc(100vh-5.5rem)] bg-neutral/50 dark:bg-neutral-800/50 backdrop-blur rounded-full text-xl flex items-center justify-center text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">All content licensed <a href=https://creativecommons.org/licenses/by-sa/4.0/>CC-BY-SA</a></p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://git.io/hugo-congo target=_blank rel="noopener noreferrer">Congo</a></p></div><div class="text-sm cursor-pointer text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-14 rtl:ml-14"><button id=appearance-switcher class="w-12 h-12" type=button title="Switch to dark appearance">
<span class="inline dark:hidden"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></span><span class="hidden dark:inline"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></span></button></div></div></footer><div id=search-wrapper class="fixed inset-0 z-50 flex flex-col p-4 sm:p-6 md:p-[10vh] lg:p-[12vh] w-screen h-screen cursor-default bg-neutral-500/50 backdrop-blur-sm dark:bg-neutral-900/50 invisible" data-url=https://major.io/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg border-neutral-200 top-20 bg-neutral dark:bg-neutral-800 dark:border-neutral-700"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-transparent focus:outline-2" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>