<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Reducing locking delays in MySQL &#183; ðŸ¤  Major Hayden</title><meta name=title content="Reducing locking delays in MySQL &#183; ðŸ¤  Major Hayden"><meta name=description content="A social nerd writing about everything"><link rel=canonical href=https://major.io/2008/04/16/reducing-locking-delays-in-mysql/><link type=text/css rel=stylesheet href=/css/main.bundle.min.55253fde34a251b02bdc3be052caf9044f977a6d44817f370ad781aed774a2a79759827fd0c3255abb87575848a355a0068eb43b2958172f6c237352069d6cea.css integrity="sha512-VSU/3jSiUbAr3DvgUsr5BE+Xem1EgX83CteBrtd0oqeXWYJ/0MMlWruHV1hIo1WgBo60OylYFy9sI3NSBp1s6g=="><script type=text/javascript src=/js/appearance.min.badab316c9287a5a42a843e4eb45da65bb3d194a5a0f5fa4a3e516160e67df0b8c65f4f19a8e146436e29d583699e6cb41d6bbe99e05e1dbaa877763bad9f8e2.js integrity="sha512-utqzFskoelpCqEPk60XaZbs9GUpaD1+ko+UWFg5n3wuMZfTxmo4UZDbinVg2mebLQda76Z4F4duqh3djutn44g=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.b607eb5ea0f48ef635db6a1c024a35eeff4529157e49461941aac333a158a1f71cae4e530d45ac010598695f823dbe38a63142757e37c2d7b74a309d7296f681.js integrity="sha512-tgfrXqD0jvY122ocAko17v9FKRV+SUYZQarDM6FYofccrk5TDUWsAQWYaV+CPb44pjFCdX43wte3SjCdcpb2gQ==" data-copy=Copy data-copied=Copied></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="Reducing locking delays in MySQL"><meta property="og:description" content="Before getting started, it&rsquo;s important to understand why MySQL uses locks."><meta property="og:type" content="article"><meta property="og:url" content="https://major.io/2008/04/16/reducing-locking-delays-in-mysql/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2008-04-16T17:32:50+00:00"><meta property="article:modified_time" content="2008-04-16T17:32:50+00:00"><meta property="og:site_name" content="ðŸ¤  Major Hayden"><meta name=twitter:card content="summary"><meta name=twitter:title content="Reducing locking delays in MySQL"><meta name=twitter:description content="Before getting started, it&rsquo;s important to understand why MySQL uses locks."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Reducing locking delays in MySQL","headline":"Reducing locking delays in MySQL","abstract":"Before getting started, it\u0026rsquo;s important to understand why MySQL uses locks.","inLanguage":"en","url":"https:\/\/major.io\/2008\/04\/16\/reducing-locking-delays-in-mysql\/","author":{"@type":"Person","name":"Major Hayden"},"copyrightYear":"2008","dateCreated":"2008-04-16T17:32:50\u002b00:00","datePublished":"2008-04-16T17:32:50\u002b00:00","dateModified":"2008-04-16T17:32:50\u002b00:00","keywords":["database"],"mainEntityOfPage":"true","wordCount":"801"}]</script><meta name=author content="Major Hayden"><link href=mailto:major@mhtx.net rel=me><link href=https://github.com/major rel=me><link href=https://gitlab.com/majorhayden rel=me><link href=https://linkedin.com/in/majorhayden rel=me><link href=https://t.me/majorhayden rel=me><link href=https://twitter.com/majorhayden rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0" href=#main-content><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold sm:py-10 text-neutral-900 dark:text-neutral print:hidden"><nav class="flex justify-between"><div><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>ðŸ¤  Major Hayden</a></div><ul class="flex flex-col list-none ltr:text-right rtl:text-left sm:flex-row"><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/posts/ title=Posts>Blog</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/tags/ title=Tags>Tags</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/w5wut/ title="W5WUT: My amateur radio station">W5WUT</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/cv/ title="Major's CV">CV</a></li><li class="ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><button id=search-button class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>ðŸ¤  Major Hayden</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/2008/04/16/reducing-locking-delays-in-mysql/>Reducing locking delays in MySQL</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Reducing locking delays in MySQL</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2008-04-16 17:32:50 +0000 UTC">16 April 2008</time><span class="px-2 text-primary-500">&#183;</span><span>801 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">4 mins</span></div><div class="my-1 text-xs text-neutral-500 dark:text-neutral-400"><a href=/tags/database/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">database</a></div></div></header><section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert"><div class="min-w-0 min-h-0 max-w-prose"><p>Before getting started, it&rsquo;s important to understand why <a href=http://dev.mysql.com/>MySQL</a> uses <a href=http://dev.mysql.com/doc/refman/5.0/en/locking-issues.html>locks</a>. In short - MySQL uses locks to prevent multiple clients from corrupting data due to simultaneous writes while also protecting clients from reading partially-written data.</p><p>Some of you may be thinking, &ldquo;Okay, this makes sense.&rdquo; If that&rsquo;s you, skip the next two paragraphs. If not, keep reading.</p><p>Analogies can help understand topics like these. Here&rsquo;s one that I came up with during a training class. Consider two people sitting in front of a notepad on a table. Let&rsquo;s say that a sentence like &ldquo;The quick brown fox jumps over the lazy dog&rdquo; is already written on the notepad. If both people want to read the sentence simultaneously, they can do so without getting in each other&rsquo;s way. A third or fourth person could show up and they could all read it at the same time.</p><p>Well, let&rsquo;s say one of the people at the table is writing a screenplay for <a href=http://www.imdb.com/title/tt0085382/>Cujo</a>, and they want to change &ldquo;lazy&rdquo; to &ldquo;crazy&rdquo;. That person erases the &ldquo;l&rdquo; in &ldquo;lazy&rdquo; and then adds a &ldquo;cr&rdquo; to the front to spell &ldquo;crazy&rdquo;. So if the other person is reading the sentence while the first person is writing, they will see &ldquo;lazy&rdquo; turn into &ldquo;azy&rdquo;, then &ldquo;c_azy&rdquo;, and then finally, &ldquo;crazy&rdquo;. This isn&rsquo;t a big issue in real life, but on the database level, this could be dangerous. If the person who was reading the sentence showed up during the middle of the letter changes, they would think that the dog was &ldquo;azy&rdquo;, and they&rsquo;d walk away wondering what the adjective &ldquo;azy&rdquo; means. To get around this, MySQL uses locking to block clients from reading data while it&rsquo;s being written and it blocks clients from writing data simultaneously.</p><p>Now that we&rsquo;re all familiar with what locks are, and why MySQL uses them, let&rsquo;s talk about some ways to reduce the delays caused by locking. Here&rsquo;s some situations you might be running up against:</p><p><strong>Writes are delayed because reads have locked the tables</strong></p><p>This is the most common occurrence from the servers that I have seen. When you run a <code>SHOW PROCESSLIST</code>, you may see a few reads at the top of the queue that are in the status of &ldquo;Copying to tmp table&rdquo; and/or &ldquo;Sending data&rdquo;. On optimized servers running optimized queries, these should clear out quickly. If you&rsquo;re finding that they are not clearing out quickly, try the following:</p><ul><li>Use <code>EXPLAIN</code> on your queries to be sure that they are optimized</li><li>Add indexes to tables that you query often</li><li>Reduce the amount of rows that are being returned per query</li><li>Upgrade the networking equipment between web and database servers (if applicable)</li><li>Consider faster hardware with larger amounts of RAM</li><li>Use <a href=http://rackerhacker.com/mysqltuner/>MySQLTuner</a> to check your current server&rsquo;s configuration for issues</li><li>Consider moving to InnoDB to utilize row-based locking</li></ul><p><strong>Reads and writes are delayed because writes have locked the tables</strong></p><p>Situations like these are a little different. There&rsquo;s two main factors to consider here: either MySQL cannot write data to the disk fast enough, or your write queries (or tables) are not optimized. If you suspect a hardware issue, check your iowait with <code>sar</code> and see if it stays at about 10-20% or higher during the day. If it does, slow hardware may be the culprit. Try moving to SCSI disks and be sure to use RAID 5 or 10 for additional reliability and speed. SAN or DAS units may also help due to higher throughput and more disk spindles.</p><p>If you already have state-of-the-art hardware, be sure that your tables and queries are optimized. Run <code>OPTIMIZE TABLES</code> regularly if your data changes often to defragment the tables and clear out any holes from removed or updated data. Slow <code>UPDATE</code> queries suggest that you are updating too many rows, or you may be using a column in the WHERE clause that is not indexed. If you do a large amount of <code>INSERT</code> queries, use this syntax to enter multiple rows simultaneously:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=p>(</span><span class=n>col1</span><span class=p>,</span><span class=n>col2</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;b&#39;</span><span class=p>,</span><span class=s1>&#39;2&#39;</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;c&#39;</span><span class=p>,</span><span class=s1>&#39;3&#39;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>This syntax tells MySQL to hold off on updating indexes until the entire query is complete. If you are updating a <strong>very large</strong> amount of rows, and you need to use multiple queries to avoid reaching the <a href=http://dev.mysql.com/doc/refman/5.0/en/server-system-variables.html#option_mysqld_max_allowed_packet>max_allowed_packet</a> directive, you can do something like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>DISABLE</span><span class=w> </span><span class=n>KEYS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=p>(</span><span class=n>col1</span><span class=p>,</span><span class=n>col2</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;b&#39;</span><span class=p>,</span><span class=s1>&#39;2&#39;</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;c&#39;</span><span class=p>,</span><span class=s1>&#39;3&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>~~~</span><span class=w> </span><span class=n>many</span><span class=w> </span><span class=k>more</span><span class=w> </span><span class=n>inserts</span><span class=w> </span><span class=o>~~~</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>ENABLE</span><span class=w> </span><span class=n>KEYS</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>This forces MySQL to not calculate any new index information until you re-enable the keys or run <code>OPTIMIZE TABLE</code>. If all of this does not help, consider using InnoDB as your storage engine. You can benefit from the row-level locking, which reduces locking in mixed read/write scenarios. In addition, InnoDB is able to write data much more efficiently than MyISAM.</p></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group" href=/2008/04/14/mchk-unable-to-initialize-quota-settings-for-someusersomedomaincom/><span class="mr-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">mchk: Unable to initialize quota settings for someuser@somedomain.com</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2008-04-14 17:00:21 +0000 UTC">14 April 2008</time></span></span></a></span>
<span><a class="flex text-right group" href=/2008/04/23/plesk-disabling-tracetrack-methods-globally/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Plesk: Disabling TRACE/TRACK methods globally</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2008-04-23 23:40:50 +0000 UTC">23 April 2008</time></span></span>
<span class="ml-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div class="absolute top-[100vh] ltr:right-0 rtl:left-0 w-12 pointer-events-none bottom-0"><a href=#the-top class="w-12 h-12 sticky pointer-events-auto top-[calc(100vh-5.5rem)] bg-neutral/50 dark:bg-neutral-800/50 backdrop-blur rounded-full text-xl flex items-center justify-center text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">All content licensed <a href=https://creativecommons.org/licenses/by-sa/4.0/>CC-BY-SA</a></p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://git.io/hugo-congo target=_blank rel="noopener noreferrer">Congo</a></p></div></div></footer><div id=search-wrapper class="fixed inset-0 z-50 flex flex-col p-4 sm:p-6 md:p-[10vh] lg:p-[12vh] w-screen h-screen cursor-default bg-neutral-500/50 backdrop-blur-sm dark:bg-neutral-900/50 invisible" data-url=https://major.io/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg border-neutral-200 top-20 bg-neutral dark:bg-neutral-800 dark:border-neutral-700"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-transparent focus:outline-2" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>