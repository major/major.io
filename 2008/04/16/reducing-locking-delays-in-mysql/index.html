<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Major Hayden"><meta name=description content="Before getting started, it&amp;rsquo;s important to understand why MySQL uses locks. In short - MySQL uses locks to prevent multiple clients from corrupting data due to simultaneous writes while also protecting clients from reading partially-written data.
Some of you may be thinking, &amp;ldquo;Okay, this makes sense.&amp;rdquo; If that&amp;rsquo;s you, skip the next two paragraphs. If not, keep reading.
Analogies can help understand topics like these. Here&amp;rsquo;s one that I came up with during a training class."><meta name=keywords content=",database"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://major.io/2008/04/16/reducing-locking-delays-in-mysql/><title>Reducing locking delays in MySQL :: Major Hayden ðŸ¤  â€” Words of wisdom from a social nerd</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=../../../../main.min.5dcefbf8102eb536dd3e2de53ffebfa58599ab2435c241a0db81728a5e015f2e.css><link rel=apple-touch-icon sizes=180x180 href=../../../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../../favicon-16x16.png><link rel=manifest href=../../../../site.webmanifest><link rel=mask-icon href=../../../../safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=../../../../favicon.ico><meta name=msapplication-TileColor content="#252627"><meta name=theme-color content="#252627"><meta itemprop=name content="Reducing locking delays in MySQL"><meta itemprop=description content="Before getting started, it&rsquo;s important to understand why MySQL uses locks. In short - MySQL uses locks to prevent multiple clients from corrupting data due to simultaneous writes while also protecting clients from reading partially-written data.
Some of you may be thinking, &ldquo;Okay, this makes sense.&rdquo; If that&rsquo;s you, skip the next two paragraphs. If not, keep reading.
Analogies can help understand topics like these. Here&rsquo;s one that I came up with during a training class."><meta itemprop=datePublished content="2008-04-16T17:32:50+00:00"><meta itemprop=dateModified content="2008-04-16T17:32:50+00:00"><meta itemprop=wordCount content="801"><meta itemprop=image content="https://major.io"><meta itemprop=keywords content="database,"><meta property="article:published_time" content="2008-04-16 17:32:50 +0000 UTC"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Reducing locking delays in MySQL :: Major Hayden ðŸ¤ "><meta name=twitter:description content><meta name=twitter:site content="https://major.io"><meta name=twitter:creator content="Major Hayden"><meta name=twitter:image content><style type=text/css>html{letter-spacing:unset}</style></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=../../../../ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ echo major.io</span>
<span class=logo__cursor style=visibility:hidden></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://major.io/ham-radio-faq>hamradio</a></li><li><a href=https://major.io/icanhazip-com-faq>icanhazip</a></li><li><a href=https://major.io/posts/>posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://major.io/2008/04/16/reducing-locking-delays-in-mysql/>Reducing locking delays in MySQL</a></h2><div class=post-content><p>Before getting started, it&rsquo;s important to understand why <a href=http://dev.mysql.com/>MySQL</a> uses <a href=http://dev.mysql.com/doc/refman/5.0/en/locking-issues.html>locks</a>. In short - MySQL uses locks to prevent multiple clients from corrupting data due to simultaneous writes while also protecting clients from reading partially-written data.</p><p>Some of you may be thinking, &ldquo;Okay, this makes sense.&rdquo; If that&rsquo;s you, skip the next two paragraphs. If not, keep reading.</p><p>Analogies can help understand topics like these. Here&rsquo;s one that I came up with during a training class. Consider two people sitting in front of a notepad on a table. Let&rsquo;s say that a sentence like &ldquo;The quick brown fox jumps over the lazy dog&rdquo; is already written on the notepad. If both people want to read the sentence simultaneously, they can do so without getting in each other&rsquo;s way. A third or fourth person could show up and they could all read it at the same time.</p><p>Well, let&rsquo;s say one of the people at the table is writing a screenplay for <a href=http://www.imdb.com/title/tt0085382/>Cujo</a>, and they want to change &ldquo;lazy&rdquo; to &ldquo;crazy&rdquo;. That person erases the &ldquo;l&rdquo; in &ldquo;lazy&rdquo; and then adds a &ldquo;cr&rdquo; to the front to spell &ldquo;crazy&rdquo;. So if the other person is reading the sentence while the first person is writing, they will see &ldquo;lazy&rdquo; turn into &ldquo;azy&rdquo;, then &ldquo;c_azy&rdquo;, and then finally, &ldquo;crazy&rdquo;. This isn&rsquo;t a big issue in real life, but on the database level, this could be dangerous. If the person who was reading the sentence showed up during the middle of the letter changes, they would think that the dog was &ldquo;azy&rdquo;, and they&rsquo;d walk away wondering what the adjective &ldquo;azy&rdquo; means. To get around this, MySQL uses locking to block clients from reading data while it&rsquo;s being written and it blocks clients from writing data simultaneously.</p><p>Now that we&rsquo;re all familiar with what locks are, and why MySQL uses them, let&rsquo;s talk about some ways to reduce the delays caused by locking. Here&rsquo;s some situations you might be running up against:</p><p><strong>Writes are delayed because reads have locked the tables</strong></p><p>This is the most common occurrence from the servers that I have seen. When you run a <code>SHOW PROCESSLIST</code>, you may see a few reads at the top of the queue that are in the status of &ldquo;Copying to tmp table&rdquo; and/or &ldquo;Sending data&rdquo;. On optimized servers running optimized queries, these should clear out quickly. If you&rsquo;re finding that they are not clearing out quickly, try the following:</p><ul><li>Use <code>EXPLAIN</code> on your queries to be sure that they are optimized</li><li>Add indexes to tables that you query often</li><li>Reduce the amount of rows that are being returned per query</li><li>Upgrade the networking equipment between web and database servers (if applicable)</li><li>Consider faster hardware with larger amounts of RAM</li><li>Use <a href=http://rackerhacker.com/mysqltuner/>MySQLTuner</a> to check your current server&rsquo;s configuration for issues</li><li>Consider moving to InnoDB to utilize row-based locking</li></ul><p><strong>Reads and writes are delayed because writes have locked the tables</strong></p><p>Situations like these are a little different. There&rsquo;s two main factors to consider here: either MySQL cannot write data to the disk fast enough, or your write queries (or tables) are not optimized. If you suspect a hardware issue, check your iowait with <code>sar</code> and see if it stays at about 10-20% or higher during the day. If it does, slow hardware may be the culprit. Try moving to SCSI disks and be sure to use RAID 5 or 10 for additional reliability and speed. SAN or DAS units may also help due to higher throughput and more disk spindles.</p><p>If you already have state-of-the-art hardware, be sure that your tables and queries are optimized. Run <code>OPTIMIZE TABLES</code> regularly if your data changes often to defragment the tables and clear out any holes from removed or updated data. Slow <code>UPDATE</code> queries suggest that you are updating too many rows, or you may be using a column in the WHERE clause that is not indexed. If you do a large amount of <code>INSERT</code> queries, use this syntax to enter multiple rows simultaneously:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#719e07>INSERT</span> <span style=color:#719e07>INTO</span> <span style=color:#719e07>table</span> (col1,col2) <span style=color:#719e07>VALUES</span> (<span style=color:#2aa198>&#39;a&#39;</span>,<span style=color:#2aa198>&#39;1&#39;</span>), (<span style=color:#2aa198>&#39;b&#39;</span>,<span style=color:#2aa198>&#39;2&#39;</span>), (<span style=color:#2aa198>&#39;c&#39;</span>,<span style=color:#2aa198>&#39;3&#39;</span>);
</code></pre></div><p>This syntax tells MySQL to hold off on updating indexes until the entire query is complete. If you are updating a <strong>very large</strong> amount of rows, and you need to use multiple queries to avoid reaching the <a href=http://dev.mysql.com/doc/refman/5.0/en/server-system-variables.html#option_mysqld_max_allowed_packet>max_allowed_packet</a> directive, you can do something like this:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#719e07>ALTER</span> <span style=color:#719e07>TABLE</span> <span style=color:#719e07>table</span> DISABLE KEYS;
<span style=color:#719e07>INSERT</span> <span style=color:#719e07>INTO</span> <span style=color:#719e07>table</span> (col1,col2) <span style=color:#719e07>VALUES</span> (<span style=color:#2aa198>&#39;a&#39;</span>,<span style=color:#2aa198>&#39;1&#39;</span>), (<span style=color:#2aa198>&#39;b&#39;</span>,<span style=color:#2aa198>&#39;2&#39;</span>), (<span style=color:#2aa198>&#39;c&#39;</span>,<span style=color:#2aa198>&#39;3&#39;</span>);
<span style=color:#719e07>~~~</span> many <span style=color:#719e07>more</span> inserts <span style=color:#719e07>~~~</span>
<span style=color:#719e07>ALTER</span> <span style=color:#719e07>TABLE</span> <span style=color:#719e07>table</span> ENABLE KEYS;
</code></pre></div><p>This forces MySQL to not calculate any new index information until you re-enable the keys or run <code>OPTIMIZE TABLE</code>. If all of this does not help, consider using InnoDB as your storage engine. You can benefit from the row-level locking, which reduces locking in mixed read/write scenarios. In addition, InnoDB is able to write data much more efficiently than MyISAM.</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://major.io/tags/database>database</a></span></p></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span><a href=https://major.io>Major Hayden</a></span>
<span><a href=https://creativecommons.org/licenses/by-sa/2.0/ target=_blank rel=noopener>CC BY-SA 2.0</a></span>
<span><a href=https://major.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>rhazdon</a></span></div></div></footer></div><script type=text/javascript src=../../../../bundle.min.2d5469329143160ae2456a69c3c76dc2d0a3b212b46afe291a51bd68650ed6f8697e001dab54f1c272c77ce08092a8c55e5bb4314e0ee334aab4b927ec896638.js integrity="sha512-LVRpMpFDFgriRWppw8dtwtCjshK0av4pGlG9aGUO1vhpfgAdq1TxwnLHfOCAkqjFXlu0MU4O4zSqtLkn7IlmOA=="></script></body></html>