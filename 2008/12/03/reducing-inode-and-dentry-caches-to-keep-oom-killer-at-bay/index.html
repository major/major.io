<!doctype html><html lang=en-us><head><meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://major.io/favicon.ico><title>Reducing inode and dentry caches to keep OOM killer at bay | Major Hayden's Blog ü§†</title><meta name=title content="Reducing inode and dentry caches to keep OOM killer at bay"><meta name=description content="When it comes to frustrating parts of the Linux kernel, OOM killer takes the cake. If it finds that applications are using too much memory on the server, it will kill process abruptly to free up memory for the system to use. I spent much of this week wrestling with a server that was in the clutches of OOM killer.
There are a few processes on the server that keep it fairly busy."><meta name=keywords content="emergency,kernel,"><meta property="og:title" content="Reducing inode and dentry caches to keep OOM killer at bay"><meta property="og:description" content="When it comes to frustrating parts of the Linux kernel, OOM killer takes the cake. If it finds that applications are using too much memory on the server, it will kill process abruptly to free up memory for the system to use. I spent much of this week wrestling with a server that was in the clutches of OOM killer.
There are a few processes on the server that keep it fairly busy."><meta property="og:type" content="article"><meta property="og:url" content="https://major.io/2008/12/03/reducing-inode-and-dentry-caches-to-keep-oom-killer-at-bay/"><meta property="og:image" content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2008-12-04T00:44:20+00:00"><meta property="article:modified_time" content="2008-12-04T00:44:20+00:00"><meta property="og:site_name" content="Major Hayden's Blog ü§†"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta name=twitter:title content="Reducing inode and dentry caches to keep OOM killer at bay"><meta name=twitter:description content="When it comes to frustrating parts of the Linux kernel, OOM killer takes the cake. If it finds that applications are using too much memory on the server, it will kill process abruptly to free up memory for the system to use. I spent much of this week wrestling with a server that was in the clutches of OOM killer.
There are a few processes on the server that keep it fairly busy."><meta name=twitter:site content="@mhayden"><meta itemprop=name content="Reducing inode and dentry caches to keep OOM killer at bay"><meta itemprop=description content="When it comes to frustrating parts of the Linux kernel, OOM killer takes the cake. If it finds that applications are using too much memory on the server, it will kill process abruptly to free up memory for the system to use. I spent much of this week wrestling with a server that was in the clutches of OOM killer.
There are a few processes on the server that keep it fairly busy."><meta itemprop=datePublished content="2008-12-04T00:44:20+00:00"><meta itemprop=dateModified content="2008-12-04T00:44:20+00:00"><meta itemprop=wordCount content="577"><meta itemprop=image content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta itemprop=keywords content="emergency,kernel,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:820px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px}div.highlight code{background-color:unset;color:initial}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style></head><body><header><a href=../../../../ class=title><h2>Major Hayden's Blog ü§†</h2></a><nav><a href=../../../../>Home</a>
<a href=../../../../ham-radio-faq>Ham Radio</a>
<a href=../../../../icanhazip-com-faq>icanhazip FAQ</a>
<a href=../../../../posts>Posts</a></nav><script async src=https://media.ethicalads.io/media/client/ethicalads.min.js></script><div data-ea-publisher=major-io data-ea-type=text></div></header><main><h1>Reducing inode and dentry caches to keep OOM killer at bay</h1><i><time datetime=2008-12-04 pubdate>2008-12-04</time></i>
<content><p>When it comes to frustrating parts of the Linux kernel, <a href=http://linux-mm.org/OOM_Killer>OOM killer</a> takes the cake. If it finds that applications are using too much memory on the server, it will kill process abruptly to free up memory for the system to use. I spent much of this week wrestling with a server that was in the clutches of OOM killer.</p><p>There are a few processes on the server that keep it fairly busy. Two of the processes are vital to the server&rsquo;s operation ‚Äì if they are stopped, lots of work is required to get them running properly again. I found that a certain java process was being killed by OOM killer regularly, and another perl process was being killed occasionally.</p><p>Naturally, my disdain for java made me think that the java process was the source of the issue. The process was configured to use a small amount of RAM, so it was ruled out. The other perl process used even less memory, so it was ruled out as well. When I checked the sysstat data with sar, I found that the server was only using about 2-3GB out of 4GB of physical memory at the time when OOM killer was started. <em>At this point, I was utterly perplexed.</em></p><p>I polled some folks around the office and gathered some ideas. After putting some ideas together, I found that the server was actually caching too much data in the <code>ext3_inode_cache</code> and <code>dentry_cache</code>. These caches hold recently accessed files and directories on the server, and they&rsquo;re purged as the files and directories become stale. Since the operations on the server read and write large amounts of data locally and via NFS, I knew these caches had to be gigantic. If you want to check your own caches, you can use the <code>slabtop</code> command. For those who like things more difficult, you can also <code>cat</code> the contents of <code>/proc/slabinfo</code> and grep for the caches that are important to you.</p><p>An immense amount of Googling revealed very little, but I discovered a <a href=http://www.linuxinsight.com/proc_sys_vm_drop_caches.html>dirty hack</a> to fix the issue <strong>(don&rsquo;t run this yet)</strong>:</p><p><strong>There are huge consequences to dumping these caches and running <code>sync</code>.</strong> If you are writing data at the time you run these commands, you&rsquo;ll actually be dumping the data out of the filesystem cache before it reaches the disk, which could lead to very bad things.</p><p>While discussing the issue with a coworker, he <a href=http://www.linuxinsight.com/proc_sys_vm_vfs_cache_pressure.html>found a different method</a> for correcting the issue that was <strong>much</strong> safer. You can echo values into <strong>/proc/sys/vm/vfs_cache_pressure</strong> to tell the kernel what priority it should take when clearing out the inode/dentry caches. LinuxInsight explains the range of values well:</p><blockquote><p>At the default value of vfs_cache_pressure = 100 the kernel will attempt to reclaim dentries and inodes at a ‚Äúfair‚Äù rate with respect to pagecache and swapcache reclaim. Decreasing vfs_cache_pressure causes the kernel to prefer to retain dentry and inode caches. Increasing vfs_cache_pressure beyond 100 causes the kernel to prefer to reclaim dentries and inodes.</p></blockquote><p>In short, values less than 100 won&rsquo;t reduce the caches very much as all. Values over 100 will signal to the kernel that you want to clear out the caches at a higher priority. I found that no matter what value you use, the kernel clears the caches at a slow rate. I&rsquo;ve been using a value of 10000 on the server I talked about earlier in the article, and it has kept the caches down to a reasonable level.</p></content><p><a href=https://major.io/tags/emergency/>#emergency</a>
<a href=https://major.io/tags/kernel/>#kernel</a></p></main><footer><hr>CC-BY-SA 4.0 &#187;
Made with <a href=https://gohugo.io/>Hugo</a> &#187;
Theme based on <a href=https://github.com/janraasch/hugo-bearblog/>Hugo  ï‚Ä¢·¥•‚Ä¢ î Bear</a><br></footer></body></html>