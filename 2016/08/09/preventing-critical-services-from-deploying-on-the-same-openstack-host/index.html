<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Major Hayden"><meta name=description content="OpenStack&amp;rsquo;s compute service, nova, manages all of the virtual machines within a OpenStack cloud. When you ask nova to build an instance, or a group of instances, nova&amp;rsquo;s scheduler system determines which hypervisors should run each instance. The scheduler uses filters to figure out where each instance belongs.
However, there are situations where the scheduler might put more than one of your instances on the same host, especially when resources are constrained."><meta name=keywords content=",database,fedora,general advice,openstack,python"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://major.io/2016/08/09/preventing-critical-services-from-deploying-on-the-same-openstack-host/><title>Preventing critical services from deploying on the same OpenStack host :: Major Hayden ðŸ¤  â€” Words of wisdom from a social nerd</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=../../../../main.89fa80e2143f71bd5c96a7c94e531dec3276a367e22f87e74a76026ab64680bf.css><link rel=apple-touch-icon sizes=180x180 href=../../../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../../favicon-16x16.png><link rel=manifest href=../../../../site.webmanifest><link rel=mask-icon href=../../../../safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=../../../../favicon.ico><meta name=msapplication-TileColor content="#252627"><meta name=theme-color content="#252627"><meta itemprop=name content="Preventing critical services from deploying on the same OpenStack host"><meta itemprop=description content="OpenStack&rsquo;s compute service, nova, manages all of the virtual machines within a OpenStack cloud. When you ask nova to build an instance, or a group of instances, nova&rsquo;s scheduler system determines which hypervisors should run each instance. The scheduler uses filters to figure out where each instance belongs.
However, there are situations where the scheduler might put more than one of your instances on the same host, especially when resources are constrained."><meta itemprop=datePublished content="2016-08-09T17:07:35+00:00"><meta itemprop=dateModified content="2016-08-09T17:07:35+00:00"><meta itemprop=wordCount content="579"><meta itemprop=image content="https://major.io"><meta itemprop=keywords content="database,fedora,general advice,openstack,python,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://major.io"><meta name=twitter:title content="Preventing critical services from deploying on the same OpenStack host"><meta name=twitter:description content="OpenStack&rsquo;s compute service, nova, manages all of the virtual machines within a OpenStack cloud. When you ask nova to build an instance, or a group of instances, nova&rsquo;s scheduler system determines which hypervisors should run each instance. The scheduler uses filters to figure out where each instance belongs.
However, there are situations where the scheduler might put more than one of your instances on the same host, especially when resources are constrained."><meta name=twitter:site content="@mhayden"><meta property="article:section" content="Blog Posts"><meta property="article:published_time" content="2016-08-09 17:07:35 +0000 UTC"><style type=text/css>html{letter-spacing:unset}</style></head><body><div class=container><header class=header><span class=header__inner><a href=../../../../ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ echo major.io</span>
<span class=logo__cursor style=visibility:hidden></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=../../../../ham-radio-faq>hamradio</a></li><li><a href=../../../../icanhazip-com-faq>icanhazip</a></li><li><a href=../../../../posts/>posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://major.io/2016/08/09/preventing-critical-services-from-deploying-on-the-same-openstack-host/>Preventing critical services from deploying on the same OpenStack host</a></h2><div class=post-content><p><img src=../../../../wp-content/uploads/2016/08/6312423035_2c53fe78e7_b-e1470762211193.jpg alt=1></p><p>OpenStack&rsquo;s compute service, nova, manages all of the virtual machines within a OpenStack cloud. When you ask nova to build an instance, or a group of instances, nova&rsquo;s scheduler system determines which hypervisors should run each instance. The scheduler uses <a href=http://docs.openstack.org/mitaka/config-reference/compute/scheduler.html#filters>filters</a> to figure out where each instance belongs.</p><p>However, there are situations where the scheduler might put more than one of your instances on the same host, especially when resources are constrained. This can be a problem when you deploy certain highly available applications, like MariaDB and Galera. If more than one of your database instances landed on the same physical host, a failure of that physical host could take down more than one database instance.</p><h2 id=filters-to-the-rescue>Filters to the rescue</h2><p>The scheduler offers the <a href=http://docs.openstack.org/mitaka/config-reference/compute/scheduler.html#servergroupantiaffinityfilter>ServerGroupAntiAffinityFilter</a> filter for these deployments. This allows a user to create a server group, apply a policy to the group, and then begin adding servers to that group.</p><p>If the scheduler filter can&rsquo;t find a way to fulfill the anti-affinity request (which often happens if the hosts are low on resources), it will fail the entire build transaction with an error. In other words, unless the entire request can be fulfilled, it won&rsquo;t be deployed.</p><p>Let&rsquo;s see how this works in action on an OpenStack Mitaka cloud deployed with <a href=http://docs.openstack.org/developer/openstack-ansible/>OpenStack-Ansible</a>.</p><h2 id=creating-a-server-group>Creating a server group</h2><p>We can use the <a href=http://docs.openstack.org/user-guide/common/cli-install-openstack-command-line-clients.html>openstackclient</a> tool to create our server group:</p><pre><code>$ openstack server group create --policy anti-affinity db-production
+----------+--------------------------------------+
| Field    | Value                                |
+----------+--------------------------------------+
| id       | cd234914-980a-42f2-b77c-602a7cc0080f |
| members  |                                      |
| name     | db-production                        |
| policies | anti-affinity                        |
+----------+--------------------------------------+
</code></pre><p>We&rsquo;ve told nova that we want all of the instances in the <code>db-production</code> group to land on different OpenStack hosts. I&rsquo;ll copy the <code>id</code> to my clipboard since I&rsquo;ll need that UUID for the next step.</p><h2 id=adding-hosts-to-the-group>Adding hosts to the group</h2><p>My small OpenStack cloud has four hypervisors, so I can add four instances to this server group:</p><pre><code>$ openstack server create \
  --flavor m1.small \
  --image &quot;Fedora 24&quot; \
  --nic net-id=bc8895ab-98f7-478f-a54a-36b121f7bb3f \
  --key-name personal_servers \
  --hint &quot;group=cd234914-980a-42f2-b77c-602a7cc0080f&quot; \
  --max 4
  prod-db
</code></pre><p>This <code>server create</code> command looks fairly standard, but I&rsquo;ve added the <code>--hint</code> parameter to specify that we want these servers scheduled as part of the group we just created. Also, I&rsquo;ve requested for four servers to be built at the same time. After a few moments, we should have four servers active:</p><pre><code>$ openstack server list --name prod-db -c ID -c Name -c Status
+--------------------------------------+-----------+--------+
| ID                                   | Name      | Status |
+--------------------------------------+-----------+--------+
| 7e7a81f3-eb02-4751-93c1-a0de999b8423 | prod-db-4 | ACTIVE |
| b742fb58-8ea4-4e26-bfbf-645a698fbb26 | prod-db-3 | ACTIVE |
| 78c7a43c-4deb-40da-a419-e62db37ab41a | prod-db-2 | ACTIVE |
| 7b8af038-6441-40c0-87c8-0a1acced17a6 | prod-db-1 | ACTIVE |
+--------------------------------------+-----------+--------+
</code></pre><p>If we check the instances, they should be on different hosts:</p><pre><code>$ for i in {1..4}; do openstack server show prod-db-${i} -c hostId -f shell; done
hostid=&quot;5fea4e5862f82f051e26caf926fe34bd3a9f1439b08a464f817b4c61&quot;
hostid=&quot;65d87faf6d9baa110afa5f2e0308781dde4629142170b2c9af1f090b&quot;
hostid=&quot;243f833055303efe838b3233f7ba6e1993fb28895ae11c724f10cc73&quot;
hostid=&quot;54df76a1e66bd8585cc3c1f8f38e8f4937456394f2409daf2a8b4c2e&quot;
</code></pre><p>Success!</p><p>If we try to build one more instance, it should fail since the scheduler cannot fulfill the anti-affinity policy applied to server group:</p><pre><code>$ openstack server create \
  --flavor m1.small \
  --image &quot;Fedora 24&quot; \
  --nic net-id=bc8895ab-98f7-478f-a54a-36b121f7bb3f \
  --key-name personal_servers \
  --hint &quot;group=cd234914-980a-42f2-b77c-602a7cc0080f&quot; \
  --wait \
  prod-db-5
Error creating server: prod-db-5
Error creating server
$ openstack server show prod-db-5 -c fault -f shell
fault=&quot;{u'message': u'No valid host was found. There are not enough hosts available.', u'code': 500...
</code></pre><p>The scheduler couldn&rsquo;t find a valid host for a fifth server in the anti-affinity group.</p><p><em>Photo credit: <a href=https://flic.kr/p/aBNPrV>&ldquo;crowded houses&rdquo; from jesuscm on Flickr</a></em></p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://major.io/tags/database/>database</a></span>
<span class=tag><a href=https://major.io/tags/fedora/>fedora</a></span>
<span class=tag><a href=https://major.io/tags/general-advice/>general advice</a></span>
<span class=tag><a href=https://major.io/tags/openstack/>openstack</a></span>
<span class=tag><a href=https://major.io/tags/python/>python</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span class=tag><a href=https://major.io/categories/blog-posts/>Blog Posts</a></span></p></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span><a href=https://major.io>Major Hayden</a></span>
<span><a href=https://creativecommons.org/licenses/by-sa/2.0/ target=_blank rel=noopener>CC BY-SA 2.0</a></span><span><a href=https://major.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>Djordje Atlialp</a></span></div></div></footer></div><script type=text/javascript src=../../../../bundle.min.e9f93b80e78a22e6f04cbb5f73e0f9c4ba60ff73a2a0ef85965c688f93dd1f2722a282e30e485603e4c65b1b346720e35f213435ec5556e196a97a68d097c80f.js integrity="sha512-6fk7gOeKIubwTLtfc+D5xLpg/3OioO+Fllxoj5PdHyciooLjDkhWA+TGWxs0ZyDjXyE0NexVVuGWqXpo0JfIDw=="></script></body></html>