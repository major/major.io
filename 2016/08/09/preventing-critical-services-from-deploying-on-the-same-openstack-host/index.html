<!doctype html><html lang=en-us><head><meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://major.io/favicon.ico><title>Preventing critical services from deploying on the same OpenStack host | Major Hayden's Blog ðŸ¤ </title><meta name=title content="Preventing critical services from deploying on the same OpenStack host"><meta name=description content="OpenStack&rsquo;s compute service, nova, manages all of the virtual machines within a OpenStack cloud. When you ask nova to build an instance, or a group of instances, nova&rsquo;s scheduler system determines which hypervisors should run each instance. The scheduler uses filters to figure out where each instance belongs.
However, there are situations where the scheduler might put more than one of your instances on the same host, especially when resources are constrained."><meta name=keywords content="database,fedora,general advice,openstack,python,"><meta property="og:title" content="Preventing critical services from deploying on the same OpenStack host"><meta property="og:description" content="OpenStack&rsquo;s compute service, nova, manages all of the virtual machines within a OpenStack cloud. When you ask nova to build an instance, or a group of instances, nova&rsquo;s scheduler system determines which hypervisors should run each instance. The scheduler uses filters to figure out where each instance belongs.
However, there are situations where the scheduler might put more than one of your instances on the same host, especially when resources are constrained."><meta property="og:type" content="article"><meta property="og:url" content="https://major.io/2016/08/09/preventing-critical-services-from-deploying-on-the-same-openstack-host/"><meta property="og:image" content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-08-09T17:07:35+00:00"><meta property="article:modified_time" content="2016-08-09T17:07:35+00:00"><meta property="og:site_name" content="Major Hayden's Blog ðŸ¤ "><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta name=twitter:title content="Preventing critical services from deploying on the same OpenStack host"><meta name=twitter:description content="OpenStack&rsquo;s compute service, nova, manages all of the virtual machines within a OpenStack cloud. When you ask nova to build an instance, or a group of instances, nova&rsquo;s scheduler system determines which hypervisors should run each instance. The scheduler uses filters to figure out where each instance belongs.
However, there are situations where the scheduler might put more than one of your instances on the same host, especially when resources are constrained."><meta name=twitter:site content="@mhayden"><meta itemprop=name content="Preventing critical services from deploying on the same OpenStack host"><meta itemprop=description content="OpenStack&rsquo;s compute service, nova, manages all of the virtual machines within a OpenStack cloud. When you ask nova to build an instance, or a group of instances, nova&rsquo;s scheduler system determines which hypervisors should run each instance. The scheduler uses filters to figure out where each instance belongs.
However, there are situations where the scheduler might put more than one of your instances on the same host, especially when resources are constrained."><meta itemprop=datePublished content="2016-08-09T17:07:35+00:00"><meta itemprop=dateModified content="2016-08-09T17:07:35+00:00"><meta itemprop=wordCount content="579"><meta itemprop=image content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta itemprop=keywords content="database,fedora,general advice,openstack,python,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:820px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px}div.highlight code{background-color:unset;color:initial}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style></head><body><header><a href=../../../../ class=title><h2>Major Hayden's Blog ðŸ¤ </h2></a><nav><a href=../../../../>Home</a>
<a href=../../../../ham-radio-faq>Ham Radio</a>
<a href=../../../../icanhazip-com-faq>icanhazip FAQ</a>
<a href=../../../../posts>Posts</a></nav></header><main><h1>Preventing critical services from deploying on the same OpenStack host</h1><i><time datetime=2016-08-09 pubdate>2016-08-09</time></i>
<content><p><img src=../../../../wp-content/uploads/2016/08/6312423035_2c53fe78e7_b-e1470762211193.jpg alt=1></p><p>OpenStack&rsquo;s compute service, nova, manages all of the virtual machines within a OpenStack cloud. When you ask nova to build an instance, or a group of instances, nova&rsquo;s scheduler system determines which hypervisors should run each instance. The scheduler uses <a href=http://docs.openstack.org/mitaka/config-reference/compute/scheduler.html#filters>filters</a> to figure out where each instance belongs.</p><p>However, there are situations where the scheduler might put more than one of your instances on the same host, especially when resources are constrained. This can be a problem when you deploy certain highly available applications, like MariaDB and Galera. If more than one of your database instances landed on the same physical host, a failure of that physical host could take down more than one database instance.</p><h2 id=filters-to-the-rescue>Filters to the rescue</h2><p>The scheduler offers the <a href=http://docs.openstack.org/mitaka/config-reference/compute/scheduler.html#servergroupantiaffinityfilter>ServerGroupAntiAffinityFilter</a> filter for these deployments. This allows a user to create a server group, apply a policy to the group, and then begin adding servers to that group.</p><p>If the scheduler filter can&rsquo;t find a way to fulfill the anti-affinity request (which often happens if the hosts are low on resources), it will fail the entire build transaction with an error. In other words, unless the entire request can be fulfilled, it won&rsquo;t be deployed.</p><p>Let&rsquo;s see how this works in action on an OpenStack Mitaka cloud deployed with <a href=http://docs.openstack.org/developer/openstack-ansible/>OpenStack-Ansible</a>.</p><h2 id=creating-a-server-group>Creating a server group</h2><p>We can use the <a href=http://docs.openstack.org/user-guide/common/cli-install-openstack-command-line-clients.html>openstackclient</a> tool to create our server group:</p><pre><code>$ openstack server group create --policy anti-affinity db-production
+----------+--------------------------------------+
| Field    | Value                                |
+----------+--------------------------------------+
| id       | cd234914-980a-42f2-b77c-602a7cc0080f |
| members  |                                      |
| name     | db-production                        |
| policies | anti-affinity                        |
+----------+--------------------------------------+
</code></pre><p>We&rsquo;ve told nova that we want all of the instances in the <code>db-production</code> group to land on different OpenStack hosts. I&rsquo;ll copy the <code>id</code> to my clipboard since I&rsquo;ll need that UUID for the next step.</p><h2 id=adding-hosts-to-the-group>Adding hosts to the group</h2><p>My small OpenStack cloud has four hypervisors, so I can add four instances to this server group:</p><pre><code>$ openstack server create \
  --flavor m1.small \
  --image &quot;Fedora 24&quot; \
  --nic net-id=bc8895ab-98f7-478f-a54a-36b121f7bb3f \
  --key-name personal_servers \
  --hint &quot;group=cd234914-980a-42f2-b77c-602a7cc0080f&quot; \
  --max 4
  prod-db
</code></pre><p>This <code>server create</code> command looks fairly standard, but I&rsquo;ve added the <code>--hint</code> parameter to specify that we want these servers scheduled as part of the group we just created. Also, I&rsquo;ve requested for four servers to be built at the same time. After a few moments, we should have four servers active:</p><pre><code>$ openstack server list --name prod-db -c ID -c Name -c Status
+--------------------------------------+-----------+--------+
| ID                                   | Name      | Status |
+--------------------------------------+-----------+--------+
| 7e7a81f3-eb02-4751-93c1-a0de999b8423 | prod-db-4 | ACTIVE |
| b742fb58-8ea4-4e26-bfbf-645a698fbb26 | prod-db-3 | ACTIVE |
| 78c7a43c-4deb-40da-a419-e62db37ab41a | prod-db-2 | ACTIVE |
| 7b8af038-6441-40c0-87c8-0a1acced17a6 | prod-db-1 | ACTIVE |
+--------------------------------------+-----------+--------+
</code></pre><p>If we check the instances, they should be on different hosts:</p><pre><code>$ for i in {1..4}; do openstack server show prod-db-${i} -c hostId -f shell; done
hostid=&quot;5fea4e5862f82f051e26caf926fe34bd3a9f1439b08a464f817b4c61&quot;
hostid=&quot;65d87faf6d9baa110afa5f2e0308781dde4629142170b2c9af1f090b&quot;
hostid=&quot;243f833055303efe838b3233f7ba6e1993fb28895ae11c724f10cc73&quot;
hostid=&quot;54df76a1e66bd8585cc3c1f8f38e8f4937456394f2409daf2a8b4c2e&quot;
</code></pre><p>Success!</p><p>If we try to build one more instance, it should fail since the scheduler cannot fulfill the anti-affinity policy applied to server group:</p><pre><code>$ openstack server create \
  --flavor m1.small \
  --image &quot;Fedora 24&quot; \
  --nic net-id=bc8895ab-98f7-478f-a54a-36b121f7bb3f \
  --key-name personal_servers \
  --hint &quot;group=cd234914-980a-42f2-b77c-602a7cc0080f&quot; \
  --wait \
  prod-db-5
Error creating server: prod-db-5
Error creating server
$ openstack server show prod-db-5 -c fault -f shell
fault=&quot;{u'message': u'No valid host was found. There are not enough hosts available.', u'code': 500...
</code></pre><p>The scheduler couldn&rsquo;t find a valid host for a fifth server in the anti-affinity group.</p><p><em>Photo credit: <a href=https://flic.kr/p/aBNPrV>&ldquo;crowded houses&rdquo; from jesuscm on Flickr</a></em></p></content><p><a href=https://major.io/tags/database/>#database</a>
<a href=https://major.io/tags/fedora/>#fedora</a>
<a href=https://major.io/tags/general-advice/>#general advice</a>
<a href=https://major.io/tags/openstack/>#openstack</a>
<a href=https://major.io/tags/python/>#python</a></p></main><footer><hr>CC-BY-SA 4.0 &#187;
Made with <a href=https://gohugo.io/>Hugo</a> &#187;
Theme based on <a href=https://github.com/janraasch/hugo-bearblog/>Hugo Ê•â€¢á´¥â€¢Ê” Bear</a><br><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "aca54cb1322647b89c43a40751f02ce4"}'></script></footer></body></html>