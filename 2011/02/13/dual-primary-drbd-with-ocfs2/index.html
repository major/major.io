<!doctype html><html lang=en-us><head><meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://major.io/favicon.ico><title>Dual-primary DRBD with OCFS2 | Major Hayden's Blog 🤠</title><meta name=title content="Dual-primary DRBD with OCFS2"><meta name=description content="As promised in one of my previous posts about dual-primary DRBD and OCFS2, I&rsquo;ve compiled a step-by-step guide for Fedora. These instructions should be somewhat close to what you would use on CentOS or Red Hat Enterprise Linux. However, CentOS and Red Hat don&rsquo;t provide some of the packages needed, so you will need to use other software repositories like RPMFusion or EPEL.
In this guide, I&rsquo;ll be using two Fedora 14 instances in the Rackspace Cloud with separate public and private networks."><meta name=keywords content="centos,cluster,command line,fedora,filesystem,high availability,linux,ocfs2,red hat,storage,sysadmin,"><meta property="og:title" content="Dual-primary DRBD with OCFS2"><meta property="og:description" content="As promised in one of my previous posts about dual-primary DRBD and OCFS2, I&rsquo;ve compiled a step-by-step guide for Fedora. These instructions should be somewhat close to what you would use on CentOS or Red Hat Enterprise Linux. However, CentOS and Red Hat don&rsquo;t provide some of the packages needed, so you will need to use other software repositories like RPMFusion or EPEL.
In this guide, I&rsquo;ll be using two Fedora 14 instances in the Rackspace Cloud with separate public and private networks."><meta property="og:type" content="article"><meta property="og:url" content="https://major.io/2011/02/13/dual-primary-drbd-with-ocfs2/"><meta property="og:image" content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2011-02-14T02:12:58+00:00"><meta property="article:modified_time" content="2011-02-14T02:12:58+00:00"><meta property="og:site_name" content="Major Hayden's Blog 🤠"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta name=twitter:title content="Dual-primary DRBD with OCFS2"><meta name=twitter:description content="As promised in one of my previous posts about dual-primary DRBD and OCFS2, I&rsquo;ve compiled a step-by-step guide for Fedora. These instructions should be somewhat close to what you would use on CentOS or Red Hat Enterprise Linux. However, CentOS and Red Hat don&rsquo;t provide some of the packages needed, so you will need to use other software repositories like RPMFusion or EPEL.
In this guide, I&rsquo;ll be using two Fedora 14 instances in the Rackspace Cloud with separate public and private networks."><meta name=twitter:site content="@mhayden"><meta itemprop=name content="Dual-primary DRBD with OCFS2"><meta itemprop=description content="As promised in one of my previous posts about dual-primary DRBD and OCFS2, I&rsquo;ve compiled a step-by-step guide for Fedora. These instructions should be somewhat close to what you would use on CentOS or Red Hat Enterprise Linux. However, CentOS and Red Hat don&rsquo;t provide some of the packages needed, so you will need to use other software repositories like RPMFusion or EPEL.
In this guide, I&rsquo;ll be using two Fedora 14 instances in the Rackspace Cloud with separate public and private networks."><meta itemprop=datePublished content="2011-02-14T02:12:58+00:00"><meta itemprop=dateModified content="2011-02-14T02:12:58+00:00"><meta itemprop=wordCount content="735"><meta itemprop=image content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta itemprop=keywords content="centos,cluster,command line,fedora,filesystem,high availability,linux,ocfs2,red hat,storage,sysadmin,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:820px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px}div.highlight code{background-color:unset;color:initial}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style></head><body><header><a href=../../../../ class=title><h2>Major Hayden's Blog 🤠</h2></a><nav><a href=../../../../>Home</a>
<a href=../../../../ham-radio-faq>Ham Radio</a>
<a href=../../../../icanhazip-com-faq>icanhazip FAQ</a>
<a href=../../../../posts>Posts</a></nav><script async src=https://media.ethicalads.io/media/client/ethicalads.min.js></script><div class="adaptive raised" data-ea-publisher=major-io data-ea-type=text></div></header><main><h1>Dual-primary DRBD with OCFS2</h1><i><time datetime=2011-02-14 pubdate>2011-02-14</time></i>
<content><p>As promised in one of my <a href=../../../../2010/12/02/keep-web-servers-in-sync-with-drbd-and-ocfs2/>previous posts</a> about dual-primary DRBD and OCFS2, I&rsquo;ve compiled a step-by-step guide for Fedora. These instructions should be somewhat close to what you would use on CentOS or Red Hat Enterprise Linux. However, CentOS and Red Hat don&rsquo;t provide some of the packages needed, so you will need to use other software repositories like <a href=http://rpmfusion.org/>RPMFusion</a> or <a href=http://fedoraproject.org/wiki/EPEL>EPEL</a>.</p><p>In this guide, I&rsquo;ll be using two Fedora 14 instances in the <a href=http://rackspacecloud.com/>Rackspace Cloud</a> with separate public and private networks. The instances are called server1 and server2 to make things easier to follow.</p><p><strong>NOTE: All of the instructions below should be done on both servers unless otherwise specified.</strong></p><ul><li><ul><li>*First, we need to set up DRBD with two primary nodes. I&rsquo;ll be using loop files for this setup since I don&rsquo;t have access to raw partitions.</li></ul></li></ul><p>Put this <a href=../../../../wp-content/uploads/2011/02/loop-for-drbd.txt>loop file initialization init script</a> in /etc/init.d/loop-for-drbd and finish setting it up:</p><p>Place this DRBD resource file in <code>/etc/drbd.d/r0.res</code>. Be sure to adjust the server names and IP addresses for your servers.</p><p>The <code>net</code> section is telling DRBD to do the following:</p><ul><li><em>allow-two-primaries</em> – Generally, DRBD has a primary and a secondary node. In this case, we will allow both nodes to have the filesystem mounted at the same time. <strong>Do this only with a clustered filesystem. If you do this with a non-clustered filesystem like ext2/ext3/ext4 or reiserfs, <em>you will have data corruption</em>. Seriously!</strong></li><li><em>after-sb-0pri discard-zero-changes</em> – DRBD detected a split-brain scenario, but none of the nodes think they&rsquo;re a primary. DRBD will take the newest modifications and apply them to the node that didn&rsquo;t have any changes.</li><li><em>after-sb-1pri discard-secondary</em> – DRBD detected a split-brain scenario, but one node is the primary and the other is the secondary. In this case, DRBD will decide that the secondary node is the victim and it will sync data from the primary to the secondary automatically.</li><li><em>after-sb-2pri disconnect</em> – DRBD detected a split-brain scenario, but it can&rsquo;t figure out which node has the right data. It tries to protect the consistency of both nodes by disconnecting the DRBD volume entirely. You&rsquo;ll have to tell DRBD which node has the valid data in order to reconnect the volume. <strong>Use extreme caution if you find yourself in this scenario.</strong></li></ul><p>If you&rsquo;d like to read about DRBD split-brain behavior in more detail, <a href=http://www.drbd.org/users-guide/s-configure-split-brain-behavior.html>review the documentation</a>.</p><p>I generally turn off the usage reporting functionality in DRBD within <code>/etc/drbd.d/global_common.conf</code>:</p><p>Now we can create the volume and start DRBD:</p><p>You may see some errors thrown about having two primaries but neither are up to date. That can be fixed by running the following command on the <strong>primary node only</strong>:</p><p>If you run <code>cat /proc/drbd</code> on the secondary node, you should see the DRBD sync running:</p><p>Before you go any further, wait for the DRBD sync to fully finish. When it completes, it should look like this:</p><p>Now, <strong>on the secondary node only</strong> make it a primary node as well:</p><p>You should see this on the secondary node if you&rsquo;ve done everything properly:</p><p>We&rsquo;re now ready to move on to configuring OCFS2. Only one package is needed:</p><p>Ensure that you have your servers and their private IP addresses in <code>/etc/hosts</code> before proceeding. Create the <code>/etc/ocfs2</code> directory and place the following configuration in <code>/etc/ocfs2/cluster.conf</code> (adjust the server names and IP addresses):</p><p>Now it&rsquo;s time to configure OCFS2. Run <code>service o2cb configure</code> and follow the prompts. Use the defaults for all of the responses except for two questions:</p><ul><li>Answer “y” to “Load O2CB driver on boot”</li><li>Answer “web” to “Cluster to start on boot”</li></ul><p>Start OCFS2 and enable it at boot up:</p><p>Create an OCFS2 partition <strong>on the primary node only</strong>:</p><p>Mount the volumes and configure them to automatically mount at boot time. You might be wondering why I do the mounting within <code>/etc/rc.local</code>. I chose to go that route since mounting via fstab was often unreliable for me due to the incorrect ordering of events at boot time. Using rc.local allows the mounts to work properly upon every reboot.</p><p>At this point, you should be all done. If you want to test OCFS2, copy a file into your /mnt/storage mount on one node and check that it appears on the other node. If you remove it, it should be gone instantly on both nodes. This is a great opportunity to test reboots of both machines to ensure that everything comes up properly at boot time.</p></content><p><a href=https://major.io/tags/centos/>#centos</a>
<a href=https://major.io/tags/cluster/>#cluster</a>
<a href=https://major.io/tags/command-line/>#command line</a>
<a href=https://major.io/tags/fedora/>#fedora</a>
<a href=https://major.io/tags/filesystem/>#filesystem</a>
<a href=https://major.io/tags/high-availability/>#high availability</a>
<a href=https://major.io/tags/linux/>#linux</a>
<a href=https://major.io/tags/ocfs2/>#ocfs2</a>
<a href=https://major.io/tags/red-hat/>#red hat</a>
<a href=https://major.io/tags/storage/>#storage</a>
<a href=https://major.io/tags/sysadmin/>#sysadmin</a></p></main><footer><hr>CC-BY-SA 4.0 &#187;
Made with <a href=https://gohugo.io/>Hugo</a> &#187;
Theme based on <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a><br></footer></body></html>