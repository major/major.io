<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Major Hayden"><meta name=description content="As promised in one of my previous posts about dual-primary DRBD and OCFS2, I&amp;rsquo;ve compiled a step-by-step guide for Fedora. These instructions should be somewhat close to what you would use on CentOS or Red Hat Enterprise Linux. However, CentOS and Red Hat don&amp;rsquo;t provide some of the packages needed, so you will need to use other software repositories like RPMFusion or EPEL.
In this guide, I&amp;rsquo;ll be using two Fedora 14 instances in the Rackspace Cloud with separate public and private networks."><meta name=keywords content=",centos,cluster,command line,fedora,filesystem,high availability,linux,ocfs2,red hat,storage,sysadmin"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://major.io/2011/02/13/dual-primary-drbd-with-ocfs2/><title>Dual-primary DRBD with OCFS2 :: Major Hayden ü§† ‚Äî Words of wisdom from a social nerd</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=../../../../main.89fa80e2143f71bd5c96a7c94e531dec3276a367e22f87e74a76026ab64680bf.css><link rel=apple-touch-icon sizes=180x180 href=../../../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../../favicon-16x16.png><link rel=manifest href=../../../../site.webmanifest><link rel=mask-icon href=../../../../safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=../../../../favicon.ico><meta name=msapplication-TileColor content="#252627"><meta name=theme-color content="#252627"><meta itemprop=name content="Dual-primary DRBD with OCFS2"><meta itemprop=description content="As promised in one of my previous posts about dual-primary DRBD and OCFS2, I&rsquo;ve compiled a step-by-step guide for Fedora. These instructions should be somewhat close to what you would use on CentOS or Red Hat Enterprise Linux. However, CentOS and Red Hat don&rsquo;t provide some of the packages needed, so you will need to use other software repositories like RPMFusion or EPEL.
In this guide, I&rsquo;ll be using two Fedora 14 instances in the Rackspace Cloud with separate public and private networks."><meta itemprop=datePublished content="2011-02-14T02:12:58+00:00"><meta itemprop=dateModified content="2011-02-14T02:12:58+00:00"><meta itemprop=wordCount content="735"><meta itemprop=image content="https://major.io"><meta itemprop=keywords content="centos,cluster,command line,fedora,filesystem,high availability,linux,ocfs2,red hat,storage,sysadmin,"><meta property="article:section" content="Blog Posts"><meta property="article:published_time" content="2011-02-14 02:12:58 +0000 UTC"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Dual-primary DRBD with OCFS2 :: Major Hayden ü§†"><meta name=twitter:description content><meta name=twitter:site content="https://major.io"><meta name=twitter:creator content="Major Hayden"><meta name=twitter:image content><style type=text/css>html{letter-spacing:unset}</style></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=../../../../ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ echo major.io</span>
<span class=logo__cursor style=visibility:hidden></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=../../../../ham-radio-faq>hamradio</a></li><li><a href=../../../../icanhazip-com-faq>icanhazip</a></li><li><a href=../../../../posts/>posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://major.io/2011/02/13/dual-primary-drbd-with-ocfs2/>Dual-primary DRBD with OCFS2</a></h2><div class=post-content><p>As promised in one of my <a href=../../../../2010/12/02/keep-web-servers-in-sync-with-drbd-and-ocfs2/>previous posts</a> about dual-primary DRBD and OCFS2, I&rsquo;ve compiled a step-by-step guide for Fedora. These instructions should be somewhat close to what you would use on CentOS or Red Hat Enterprise Linux. However, CentOS and Red Hat don&rsquo;t provide some of the packages needed, so you will need to use other software repositories like <a href=http://rpmfusion.org/>RPMFusion</a> or <a href=http://fedoraproject.org/wiki/EPEL>EPEL</a>.</p><p>In this guide, I&rsquo;ll be using two Fedora 14 instances in the <a href=http://rackspacecloud.com/>Rackspace Cloud</a> with separate public and private networks. The instances are called server1 and server2 to make things easier to follow.</p><p><strong>NOTE: All of the instructions below should be done on both servers unless otherwise specified.</strong></p><ul><li><ul><li>*First, we need to set up DRBD with two primary nodes. I&rsquo;ll be using loop files for this setup since I don&rsquo;t have access to raw partitions.</li></ul></li></ul><p>Put this <a href=../../../../wp-content/uploads/2011/02/loop-for-drbd.txt>loop file initialization init script</a> in /etc/init.d/loop-for-drbd and finish setting it up:</p><p>Place this DRBD resource file in <code>/etc/drbd.d/r0.res</code>. Be sure to adjust the server names and IP addresses for your servers.</p><p>The <code>net</code> section is telling DRBD to do the following:</p><ul><li><em>allow-two-primaries</em> ‚Äì Generally, DRBD has a primary and a secondary node. In this case, we will allow both nodes to have the filesystem mounted at the same time. <strong>Do this only with a clustered filesystem. If you do this with a non-clustered filesystem like ext2/ext3/ext4 or reiserfs, <em>you will have data corruption</em>. Seriously!</strong></li><li><em>after-sb-0pri discard-zero-changes</em> ‚Äì DRBD detected a split-brain scenario, but none of the nodes think they&rsquo;re a primary. DRBD will take the newest modifications and apply them to the node that didn&rsquo;t have any changes.</li><li><em>after-sb-1pri discard-secondary</em> ‚Äì DRBD detected a split-brain scenario, but one node is the primary and the other is the secondary. In this case, DRBD will decide that the secondary node is the victim and it will sync data from the primary to the secondary automatically.</li><li><em>after-sb-2pri disconnect</em> ‚Äì DRBD detected a split-brain scenario, but it can&rsquo;t figure out which node has the right data. It tries to protect the consistency of both nodes by disconnecting the DRBD volume entirely. You&rsquo;ll have to tell DRBD which node has the valid data in order to reconnect the volume. <strong>Use extreme caution if you find yourself in this scenario.</strong></li></ul><p>If you&rsquo;d like to read about DRBD split-brain behavior in more detail, <a href=http://www.drbd.org/users-guide/s-configure-split-brain-behavior.html>review the documentation</a>.</p><p>I generally turn off the usage reporting functionality in DRBD within <code>/etc/drbd.d/global_common.conf</code>:</p><p>Now we can create the volume and start DRBD:</p><p>You may see some errors thrown about having two primaries but neither are up to date. That can be fixed by running the following command on the <strong>primary node only</strong>:</p><p>If you run <code>cat /proc/drbd</code> on the secondary node, you should see the DRBD sync running:</p><p>Before you go any further, wait for the DRBD sync to fully finish. When it completes, it should look like this:</p><p>Now, <strong>on the secondary node only</strong> make it a primary node as well:</p><p>You should see this on the secondary node if you&rsquo;ve done everything properly:</p><p>We&rsquo;re now ready to move on to configuring OCFS2. Only one package is needed:</p><p>Ensure that you have your servers and their private IP addresses in <code>/etc/hosts</code> before proceeding. Create the <code>/etc/ocfs2</code> directory and place the following configuration in <code>/etc/ocfs2/cluster.conf</code> (adjust the server names and IP addresses):</p><p>Now it&rsquo;s time to configure OCFS2. Run <code>service o2cb configure</code> and follow the prompts. Use the defaults for all of the responses except for two questions:</p><ul><li>Answer ‚Äúy‚Äù to ‚ÄúLoad O2CB driver on boot‚Äù</li><li>Answer ‚Äúweb‚Äù to ‚ÄúCluster to start on boot‚Äù</li></ul><p>Start OCFS2 and enable it at boot up:</p><p>Create an OCFS2 partition <strong>on the primary node only</strong>:</p><p>Mount the volumes and configure them to automatically mount at boot time. You might be wondering why I do the mounting within <code>/etc/rc.local</code>. I chose to go that route since mounting via fstab was often unreliable for me due to the incorrect ordering of events at boot time. Using rc.local allows the mounts to work properly upon every reboot.</p><p>At this point, you should be all done. If you want to test OCFS2, copy a file into your /mnt/storage mount on one node and check that it appears on the other node. If you remove it, it should be gone instantly on both nodes. This is a great opportunity to test reboots of both machines to ensure that everything comes up properly at boot time.</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://major.io/tags/centos/>centos</a></span>
<span class=tag><a href=https://major.io/tags/cluster/>cluster</a></span>
<span class=tag><a href=https://major.io/tags/command-line/>command line</a></span>
<span class=tag><a href=https://major.io/tags/fedora/>fedora</a></span>
<span class=tag><a href=https://major.io/tags/filesystem/>filesystem</a></span>
<span class=tag><a href=https://major.io/tags/high-availability/>high availability</a></span>
<span class=tag><a href=https://major.io/tags/linux/>linux</a></span>
<span class=tag><a href=https://major.io/tags/ocfs2/>ocfs2</a></span>
<span class=tag><a href=https://major.io/tags/red-hat/>red hat</a></span>
<span class=tag><a href=https://major.io/tags/storage/>storage</a></span>
<span class=tag><a href=https://major.io/tags/sysadmin/>sysadmin</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span class=tag><a href=https://major.io/categories/blog-posts/>Blog Posts</a></span></p></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span><a href=https://major.io>Major Hayden</a></span>
<span><a href=https://creativecommons.org/licenses/by-sa/2.0/ target=_blank rel=noopener>CC BY-SA 2.0</a></span><span><a href=https://major.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>Djordje Atlialp</a></span></div></div></footer></div><script type=text/javascript src=../../../../bundle.min.e9f93b80e78a22e6f04cbb5f73e0f9c4ba60ff73a2a0ef85965c688f93dd1f2722a282e30e485603e4c65b1b346720e35f213435ec5556e196a97a68d097c80f.js integrity="sha512-6fk7gOeKIubwTLtfc+D5xLpg/3OioO+Fllxoj5PdHyciooLjDkhWA+TGWxs0ZyDjXyE0NexVVuGWqXpo0JfIDw=="></script></body></html>