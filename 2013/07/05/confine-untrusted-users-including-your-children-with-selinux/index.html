<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Confine untrusted users (including your children) with SELinux &#183; ðŸ¤  Major Hayden</title><meta name=title content="Confine untrusted users (including your children) with SELinux &#183; ðŸ¤  Major Hayden"><meta name=description content="A social nerd writing about everything"><link rel=canonical href=https://major.io/2013/07/05/confine-untrusted-users-including-your-children-with-selinux/><link type=text/css rel=stylesheet href=/css/main.bundle.min.55253fde34a251b02bdc3be052caf9044f977a6d44817f370ad781aed774a2a79759827fd0c3255abb87575848a355a0068eb43b2958172f6c237352069d6cea.css integrity="sha512-VSU/3jSiUbAr3DvgUsr5BE+Xem1EgX83CteBrtd0oqeXWYJ/0MMlWruHV1hIo1WgBo60OylYFy9sI3NSBp1s6g=="><script type=text/javascript src=/js/appearance.min.badab316c9287a5a42a843e4eb45da65bb3d194a5a0f5fa4a3e516160e67df0b8c65f4f19a8e146436e29d583699e6cb41d6bbe99e05e1dbaa877763bad9f8e2.js integrity="sha512-utqzFskoelpCqEPk60XaZbs9GUpaD1+ko+UWFg5n3wuMZfTxmo4UZDbinVg2mebLQda76Z4F4duqh3djutn44g=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.b607eb5ea0f48ef635db6a1c024a35eeff4529157e49461941aac333a158a1f71cae4e530d45ac010598695f823dbe38a63142757e37c2d7b74a309d7296f681.js integrity="sha512-tgfrXqD0jvY122ocAko17v9FKRV+SUYZQarDM6FYofccrk5TDUWsAQWYaV+CPb44pjFCdX43wte3SjCdcpb2gQ==" data-copy=Copy data-copied=Copied></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="Confine untrusted users (including your children) with SELinux"><meta property="og:description" content="The confined user support in SELinux is handy for ensuring that users aren&rsquo;t able to do something that they shouldn&rsquo;t."><meta property="og:type" content="article"><meta property="og:url" content="https://major.io/2013/07/05/confine-untrusted-users-including-your-children-with-selinux/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2013-07-05T18:50:43+00:00"><meta property="article:modified_time" content="2013-07-05T18:50:43+00:00"><meta property="og:site_name" content="ðŸ¤  Major Hayden"><meta name=twitter:card content="summary"><meta name=twitter:title content="Confine untrusted users (including your children) with SELinux"><meta name=twitter:description content="The confined user support in SELinux is handy for ensuring that users aren&rsquo;t able to do something that they shouldn&rsquo;t."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Confine untrusted users (including your children) with SELinux","headline":"Confine untrusted users (including your children) with SELinux","abstract":"The confined user support in SELinux is handy for ensuring that users aren\u0026rsquo;t able to do something that they shouldn\u0026rsquo;t.","inLanguage":"en","url":"https:\/\/major.io\/2013\/07\/05\/confine-untrusted-users-including-your-children-with-selinux\/","author":{"@type":"Person","name":"Major Hayden"},"copyrightYear":"2013","dateCreated":"2013-07-05T18:50:43\u002b00:00","datePublished":"2013-07-05T18:50:43\u002b00:00","dateModified":"2013-07-05T18:50:43\u002b00:00","keywords":["centos","command line","fedora","redhat","security","selinux","sysadmin"],"mainEntityOfPage":"true","wordCount":"735"}]</script><meta name=author content="Major Hayden"><link href=mailto:major@mhtx.net rel=me><link href=https://github.com/major rel=me><link href=https://gitlab.com/majorhayden rel=me><link href=https://linkedin.com/in/majorhayden rel=me><link href=https://t.me/majorhayden rel=me><link href=https://twitter.com/majorhayden rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0" href=#main-content><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold sm:py-10 text-neutral-900 dark:text-neutral print:hidden"><nav class="flex justify-between"><div><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>ðŸ¤  Major Hayden</a></div><ul class="flex flex-col list-none ltr:text-right rtl:text-left sm:flex-row"><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/posts/ title=Posts>Blog</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/tags/ title=Tags>Tags</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/w5wut/ title="W5WUT: My amateur radio station">W5WUT</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/cv/ title="Major's CV">CV</a></li><li class="ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><button id=search-button class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>ðŸ¤  Major Hayden</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/2013/07/05/confine-untrusted-users-including-your-children-with-selinux/>Confine untrusted users (including your children) with SELinux</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Confine untrusted users (including your children) with SELinux</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2013-07-05 18:50:43 +0000 UTC">5 July 2013</time><span class="px-2 text-primary-500">&#183;</span><span>735 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">4 mins</span></div><div class="my-1 text-xs text-neutral-500 dark:text-neutral-400"><a href=/tags/centos/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">centos</a>
<a href=/tags/command-line/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">command line</a>
<a href=/tags/fedora/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">fedora</a>
<a href=/tags/redhat/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">redhat</a>
<a href=/tags/security/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">security</a>
<a href=/tags/selinux/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">selinux</a>
<a href=/tags/sysadmin/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">sysadmin</a></div></div></header><section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert"><div class="min-w-0 min-h-0 max-w-prose"><p><a href=http://major.io/wp-content/uploads/2011/09/selinux-penguin-125.png><img src=http://major.io/wp-content/uploads/2011/09/selinux-penguin-125.png alt="SELinux Penguin" width=125 height=113 class="alignright size-full wp-image-2532"></a>The <a href="http://danwalsh.livejournal.com/10461.html?thread=88029">confined user support in SELinux</a> is handy for ensuring that users aren&rsquo;t able to do something that they shouldn&rsquo;t. It seems more effective and easier to use than most of the other methods I&rsquo;ve seen before. Thanks to Dan for reminding me about this during his <a href=http://rhsummit.files.wordpress.com/2013/06/summitselinuxenterprise.pdf>SELinux in the Enterprise</a> talk from this year&rsquo;s Red Hat Summit.</p><p>There are five main SELinux user types (and a <a href=https://docs.fedoraproject.org/en-US/Fedora/12/html/Security-Enhanced_Linux/sect-Security-Enhanced_Linux-Targeted_Policy-Confined_and_Unconfined_Users.html>handy chart</a> in the Fedora documentation):</p><ul><li><strong>guest_u:</strong> - no X windows, no sudo, and no networking</li><li><strong>xguest_u:</strong> - same as guest_u, but X is allowed and connectivity is allowed to web ports only (handy for kiosks)</li><li><strong>user_u:</strong> - same as xguest_u, but networking isn&rsquo;t restricted</li><li><strong>staff_u:</strong> - same as user_u, but sudo is allowed (su isn&rsquo;t allowed)</li><li><strong>unconfined_u:</strong> - full access (this is the default)</li></ul><p>One interesting thing to note is that all users are allowed to execute binary applications within their home directories by default. This can be switch off via some booleans (which I&rsquo;ll demonstrate in a moment).</p><p>Let&rsquo;s kick off a demonstration to show the power of these restrictions. First off, let&rsquo;s get a list of the default configuration:</p><pre tabindex=0><code># semanage login -l

Login Name           SELinux User         MLS/MCS Range        Service

__default__          unconfined_u         s0-s0:c0.c1023       *
root                 unconfined_u         s0-s0:c0.c1023       *
system_u             system_u             s0-s0:c0.c1023       *
</code></pre><p>By default, all new users come with no restrictions (as shown by unconfined_u). I&rsquo;ll create a new user called selinuxtest and set a password. If I ssh to the server as the selinuxtest user, I see that I&rsquo;m unconfined:</p><pre tabindex=0><code>$ id -Z
unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
</code></pre><p>That&rsquo;s what we expected. Let&rsquo;s apply the strongest restrictions to this user and apply guest_u:</p><pre tabindex=0><code># semanage login -a -s guest_u selinuxtest
</code></pre><p>I&rsquo;ll start a new ssh session as selinuxtest and try out some commands that I&rsquo;d normally expect to work on a Linux server:</p><pre tabindex=0><code>$ ping google.com
ping: icmp open socket: Permission denied
$ curl google.com
curl: (7) Failed to connect to 74.125.225.129: Permission denied
$ sudo su -
sudo: unable to change to sudoers gid: Operation not permitted
$  ./hello
Hello world
$ file hello
hello: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.32, BuildID[sha1]=0x5ffb25a7171c3338d6c76147cccc666ddc752dde, not stripped
</code></pre><p>The networking and sudo restrictions applied as we expected. However, I was able to compile a small &ldquo;Hello World&rdquo; binary in C and run it. That could become a problem for some servers. Let&rsquo;s adjust a boolean that will restrict this activity:</p><pre tabindex=0><code># getsebool -a | grep exec_content
auditadm_exec_content --&gt; on
guest_exec_content --&gt; on
secadm_exec_content --&gt; on
staff_exec_content --&gt; on
sysadm_exec_content --&gt; on
user_exec_content --&gt; on
xguest_exec_content --&gt; on
# setsebool guest_exec_content off
</code></pre><p>Now I try running the binary again as my selinuxtest user:</p><pre tabindex=0><code>$ ./hello
-bash: ./hello: Permission denied
</code></pre><p>I can&rsquo;t execute binary content in my home directory or in /tmp any longer after adjusting the boolean. Let&rsquo;s switch selinuxtest to xguest_u:</p><pre tabindex=0><code># semanage login -a -s xguest_u selinuxtest
</code></pre><p>And now I&rsquo;ll re-test as the selinuxtest user:</p><pre tabindex=0><code>$ curl -si google.com | head -1
HTTP/1.1 301 Moved Permanently
$ ping google.com
ping: icmp open socket: Permission denied
</code></pre><p>I have full web connectivity but I can&rsquo;t do anything else on the network. Now for a switch to user_u:</p><pre tabindex=0><code># semanage login -a -s user_u selinuxtest
</code></pre><p>And testing user_u with selinuxtest reveals:</p><pre tabindex=0><code>$ ping -c 1 google.com
PING google.com (74.125.225.134) 56(84) bytes of data.
64 bytes from ord08s09-in-f6.1e100.net (74.125.225.134): icmp_seq=1 ttl=57 time=29.3 ms

--- google.com ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 29.332/29.332/29.332/0.000 ms
$ curl -si google.com | head -n1
HTTP/1.1 301 Moved Permanently
$ sudo su -
sudo: PERM_SUDOERS: setresuid(-1, 1, -1): Operation not permitted
</code></pre><p>Networking is wide open but I still don&rsquo;t have sudo. Let&rsquo;s try staff_u:</p><pre tabindex=0><code># semanage login -a -s staff_u selinuxtest
</code></pre><p>Testing staff_u with selinuxtest gives me the expected results:</p><pre tabindex=0><code>$ sudo su -
[sudo] password for selinuxtest:
</code></pre><p>I didn&rsquo;t add selinuxtest to sudoers, so this command would fail. However, I&rsquo;m actually allowed to execute it now.</p><p>These restrictions could be very helpful when dealing with users that you don&rsquo;t fully trust on your system. You could use these restrictions to add a kiosk user to a Linux machine and allow family members or coworkers to surf the web using your device. In addition, you could use the restrictions as an extra layer of protection on heavily shared servers to prevent users from consuming resources or generating malicious traffic.</p></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group" href=/2013/06/19/my-interview-on-the-dave-and-gunnar-show/><span class="mr-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">My interview on the Dave and Gunnar Show</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2013-06-19 12:04:06 +0000 UTC">19 June 2013</time></span></span></a></span>
<span><a class="flex text-right group" href=/2013/07/06/boot-vms-with-virt-manager-and-libvirt-with-isos-stored-remotely-via-sambacifs/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Boot VMâ€™s with virt-manager and libvirt with ISOâ€™s stored remotely via samba/cifs</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2013-07-07 01:51:10 +0000 UTC">7 July 2013</time></span></span>
<span class="ml-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div class="absolute top-[100vh] ltr:right-0 rtl:left-0 w-12 pointer-events-none bottom-0"><a href=#the-top class="w-12 h-12 sticky pointer-events-auto top-[calc(100vh-5.5rem)] bg-neutral/50 dark:bg-neutral-800/50 backdrop-blur rounded-full text-xl flex items-center justify-center text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">All content licensed <a href=https://creativecommons.org/licenses/by-sa/4.0/>CC-BY-SA</a></p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://git.io/hugo-congo target=_blank rel="noopener noreferrer">Congo</a></p></div></div></footer><div id=search-wrapper class="fixed inset-0 z-50 flex flex-col p-4 sm:p-6 md:p-[10vh] lg:p-[12vh] w-screen h-screen cursor-default bg-neutral-500/50 backdrop-blur-sm dark:bg-neutral-900/50 invisible" data-url=https://major.io/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg border-neutral-200 top-20 bg-neutral dark:bg-neutral-800 dark:border-neutral-700"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-transparent focus:outline-2" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>