<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Major Hayden"><meta name=description content="The confined user support in SELinux is handy for ensuring that users aren&amp;rsquo;t able to do something that they shouldn&amp;rsquo;t. It seems more effective and easier to use than most of the other methods I&amp;rsquo;ve seen before. Thanks to Dan for reminding me about this during his SELinux in the Enterprise talk from this year&amp;rsquo;s Red Hat Summit.
There are five main SELinux user types (and a handy chart in the Fedora documentation):"><meta name=keywords content=",centos,command line,fedora,redhat,security,selinux,sysadmin"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://major.io/2013/07/05/confine-untrusted-users-including-your-children-with-selinux/><title>Confine untrusted users (including your children) with SELinux :: Major Hayden ðŸ¤  â€” Words of wisdom from a social nerd</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=../../../../main.89fa80e2143f71bd5c96a7c94e531dec3276a367e22f87e74a76026ab64680bf.css><link rel=apple-touch-icon sizes=180x180 href=../../../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../../favicon-16x16.png><link rel=manifest href=../../../../site.webmanifest><link rel=mask-icon href=../../../../safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=../../../../favicon.ico><meta name=msapplication-TileColor content="#252627"><meta name=theme-color content="#252627"><meta itemprop=name content="Confine untrusted users (including your children) with SELinux"><meta itemprop=description content="The confined user support in SELinux is handy for ensuring that users aren&rsquo;t able to do something that they shouldn&rsquo;t. It seems more effective and easier to use than most of the other methods I&rsquo;ve seen before. Thanks to Dan for reminding me about this during his SELinux in the Enterprise talk from this year&rsquo;s Red Hat Summit.
There are five main SELinux user types (and a handy chart in the Fedora documentation):"><meta itemprop=datePublished content="2013-07-05T18:50:43+00:00"><meta itemprop=dateModified content="2013-07-05T18:50:43+00:00"><meta itemprop=wordCount content="735"><meta itemprop=image content="https://major.io"><meta itemprop=keywords content="centos,command line,fedora,redhat,security,selinux,sysadmin,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://major.io"><meta name=twitter:title content="Confine untrusted users (including your children) with SELinux"><meta name=twitter:description content="The confined user support in SELinux is handy for ensuring that users aren&rsquo;t able to do something that they shouldn&rsquo;t. It seems more effective and easier to use than most of the other methods I&rsquo;ve seen before. Thanks to Dan for reminding me about this during his SELinux in the Enterprise talk from this year&rsquo;s Red Hat Summit.
There are five main SELinux user types (and a handy chart in the Fedora documentation):"><meta name=twitter:site content="@mhayden"><meta property="article:section" content="Blog Posts"><meta property="article:published_time" content="2013-07-05 18:50:43 +0000 UTC"><style type=text/css>html{letter-spacing:unset}</style></head><body><div class=container><header class=header><span class=header__inner><a href=../../../../ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ echo major.io</span>
<span class=logo__cursor style=visibility:hidden></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=../../../../ham-radio-faq>hamradio</a></li><li><a href=../../../../icanhazip-com-faq>icanhazip</a></li><li><a href=../../../../posts/>posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://major.io/2013/07/05/confine-untrusted-users-including-your-children-with-selinux/>Confine untrusted users (including your children) with SELinux</a></h2><div class=post-content><p><a href=http://major.io/wp-content/uploads/2011/09/selinux-penguin-125.png></a>The <a href="http://danwalsh.livejournal.com/10461.html?thread=88029">confined user support in SELinux</a> is handy for ensuring that users aren&rsquo;t able to do something that they shouldn&rsquo;t. It seems more effective and easier to use than most of the other methods I&rsquo;ve seen before. Thanks to Dan for reminding me about this during his <a href=http://rhsummit.files.wordpress.com/2013/06/summitselinuxenterprise.pdf>SELinux in the Enterprise</a> talk from this year&rsquo;s Red Hat Summit.</p><p>There are five main SELinux user types (and a <a href=https://docs.fedoraproject.org/en-US/Fedora/12/html/Security-Enhanced_Linux/sect-Security-Enhanced_Linux-Targeted_Policy-Confined_and_Unconfined_Users.html>handy chart</a> in the Fedora documentation):</p><ul><li><strong>guest_u:</strong> - no X windows, no sudo, and no networking</li><li><strong>xguest_u:</strong> - same as guest_u, but X is allowed and connectivity is allowed to web ports only (handy for kiosks)</li><li><strong>user_u:</strong> - same as xguest_u, but networking isn&rsquo;t restricted</li><li><strong>staff_u:</strong> - same as user_u, but sudo is allowed (su isn&rsquo;t allowed)</li><li><strong>unconfined_u:</strong> - full access (this is the default)</li></ul><p>One interesting thing to note is that all users are allowed to execute binary applications within their home directories by default. This can be switch off via some booleans (which I&rsquo;ll demonstrate in a moment).</p><p>Let&rsquo;s kick off a demonstration to show the power of these restrictions. First off, let&rsquo;s get a list of the default configuration:</p><pre><code># semanage login -l

Login Name           SELinux User         MLS/MCS Range        Service

__default__          unconfined_u         s0-s0:c0.c1023       *
root                 unconfined_u         s0-s0:c0.c1023       *
system_u             system_u             s0-s0:c0.c1023       *
</code></pre><p>By default, all new users come with no restrictions (as shown by unconfined_u). I&rsquo;ll create a new user called selinuxtest and set a password. If I ssh to the server as the selinuxtest user, I see that I&rsquo;m unconfined:</p><pre><code>$ id -Z
unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
</code></pre><p>That&rsquo;s what we expected. Let&rsquo;s apply the strongest restrictions to this user and apply guest_u:</p><pre><code># semanage login -a -s guest_u selinuxtest
</code></pre><p>I&rsquo;ll start a new ssh session as selinuxtest and try out some commands that I&rsquo;d normally expect to work on a Linux server:</p><pre><code>$ ping google.com
ping: icmp open socket: Permission denied
$ curl google.com
curl: (7) Failed to connect to 74.125.225.129: Permission denied
$ sudo su -
sudo: unable to change to sudoers gid: Operation not permitted
$  ./hello
Hello world
$ file hello
hello: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.32, BuildID[sha1]=0x5ffb25a7171c3338d6c76147cccc666ddc752dde, not stripped
</code></pre><p>The networking and sudo restrictions applied as we expected. However, I was able to compile a small &ldquo;Hello World&rdquo; binary in C and run it. That could become a problem for some servers. Let&rsquo;s adjust a boolean that will restrict this activity:</p><pre><code># getsebool -a | grep exec_content
auditadm_exec_content --&gt; on
guest_exec_content --&gt; on
secadm_exec_content --&gt; on
staff_exec_content --&gt; on
sysadm_exec_content --&gt; on
user_exec_content --&gt; on
xguest_exec_content --&gt; on
# setsebool guest_exec_content off
</code></pre><p>Now I try running the binary again as my selinuxtest user:</p><pre><code>$ ./hello
-bash: ./hello: Permission denied
</code></pre><p>I can&rsquo;t execute binary content in my home directory or in /tmp any longer after adjusting the boolean. Let&rsquo;s switch selinuxtest to xguest_u:</p><pre><code># semanage login -a -s xguest_u selinuxtest
</code></pre><p>And now I&rsquo;ll re-test as the selinuxtest user:</p><pre><code>$ curl -si google.com | head -1
HTTP/1.1 301 Moved Permanently
$ ping google.com
ping: icmp open socket: Permission denied
</code></pre><p>I have full web connectivity but I can&rsquo;t do anything else on the network. Now for a switch to user_u:</p><pre><code># semanage login -a -s user_u selinuxtest
</code></pre><p>And testing user_u with selinuxtest reveals:</p><pre><code>$ ping -c 1 google.com
PING google.com (74.125.225.134) 56(84) bytes of data.
64 bytes from ord08s09-in-f6.1e100.net (74.125.225.134): icmp_seq=1 ttl=57 time=29.3 ms

--- google.com ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 29.332/29.332/29.332/0.000 ms
$ curl -si google.com | head -n1
HTTP/1.1 301 Moved Permanently
$ sudo su -
sudo: PERM_SUDOERS: setresuid(-1, 1, -1): Operation not permitted
</code></pre><p>Networking is wide open but I still don&rsquo;t have sudo. Let&rsquo;s try staff_u:</p><pre><code># semanage login -a -s staff_u selinuxtest
</code></pre><p>Testing staff_u with selinuxtest gives me the expected results:</p><pre><code>$ sudo su -
[sudo] password for selinuxtest:
</code></pre><p>I didn&rsquo;t add selinuxtest to sudoers, so this command would fail. However, I&rsquo;m actually allowed to execute it now.</p><p>These restrictions could be very helpful when dealing with users that you don&rsquo;t fully trust on your system. You could use these restrictions to add a kiosk user to a Linux machine and allow family members or coworkers to surf the web using your device. In addition, you could use the restrictions as an extra layer of protection on heavily shared servers to prevent users from consuming resources or generating malicious traffic.</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://major.io/tags/centos/>centos</a></span>
<span class=tag><a href=https://major.io/tags/command-line/>command line</a></span>
<span class=tag><a href=https://major.io/tags/fedora/>fedora</a></span>
<span class=tag><a href=https://major.io/tags/redhat/>redhat</a></span>
<span class=tag><a href=https://major.io/tags/security/>security</a></span>
<span class=tag><a href=https://major.io/tags/selinux/>selinux</a></span>
<span class=tag><a href=https://major.io/tags/sysadmin/>sysadmin</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span class=tag><a href=https://major.io/categories/blog-posts/>Blog Posts</a></span></p></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span><a href=https://major.io>Major Hayden</a></span>
<span><a href=https://creativecommons.org/licenses/by-sa/2.0/ target=_blank rel=noopener>CC BY-SA 2.0</a></span><span><a href=https://major.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>Djordje Atlialp</a></span></div></div></footer></div><script type=text/javascript src=../../../../bundle.min.e9f93b80e78a22e6f04cbb5f73e0f9c4ba60ff73a2a0ef85965c688f93dd1f2722a282e30e485603e4c65b1b346720e35f213435ec5556e196a97a68d097c80f.js integrity="sha512-6fk7gOeKIubwTLtfc+D5xLpg/3OioO+Fllxoj5PdHyciooLjDkhWA+TGWxs0ZyDjXyE0NexVVuGWqXpo0JfIDw=="></script></body></html>