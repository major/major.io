<!doctype html><html lang=en-us><head><meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://major.io/favicon.ico><title>Fixing broken DNS lookups in spamassassin | Major Hayden's Blog ðŸ¤ </title><meta name=title content="Fixing broken DNS lookups in spamassassin"><meta name=description content="I talked about the joys of running my own mail server last week only to find that my mail server was broken yesterday. Spamassassin stopped doing DNS lookups for RBL and SPF checks.
I had one of these moments:

My logs looked like this:
plugin: eval failed: available_nameservers: No DNS servers available! plugin: eval failed: available_nameservers: No DNS servers available! rules: failed to run NO_DNS_FOR_FROM RBL test, skipping: (available_nameservers: [."><meta name=keywords content="dns,fedora,mail,perl,postfix,selinux,spamassassin,"><meta property="og:title" content="Fixing broken DNS lookups in spamassassin"><meta property="og:description" content="I talked about the joys of running my own mail server last week only to find that my mail server was broken yesterday. Spamassassin stopped doing DNS lookups for RBL and SPF checks.
I had one of these moments:

My logs looked like this:
plugin: eval failed: available_nameservers: No DNS servers available! plugin: eval failed: available_nameservers: No DNS servers available! rules: failed to run NO_DNS_FOR_FROM RBL test, skipping: (available_nameservers: [."><meta property="og:type" content="article"><meta property="og:url" content="https://major.io/2014/06/20/fixing-broken-dns-lookups-in-spamassassin/"><meta property="og:image" content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2014-06-20T13:20:56+00:00"><meta property="article:modified_time" content="2014-06-20T13:20:56+00:00"><meta property="og:site_name" content="Major Hayden's Blog ðŸ¤ "><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta name=twitter:title content="Fixing broken DNS lookups in spamassassin"><meta name=twitter:description content="I talked about the joys of running my own mail server last week only to find that my mail server was broken yesterday. Spamassassin stopped doing DNS lookups for RBL and SPF checks.
I had one of these moments:

My logs looked like this:
plugin: eval failed: available_nameservers: No DNS servers available! plugin: eval failed: available_nameservers: No DNS servers available! rules: failed to run NO_DNS_FOR_FROM RBL test, skipping: (available_nameservers: [."><meta name=twitter:site content="@mhayden"><meta itemprop=name content="Fixing broken DNS lookups in spamassassin"><meta itemprop=description content="I talked about the joys of running my own mail server last week only to find that my mail server was broken yesterday. Spamassassin stopped doing DNS lookups for RBL and SPF checks.
I had one of these moments:

My logs looked like this:
plugin: eval failed: available_nameservers: No DNS servers available! plugin: eval failed: available_nameservers: No DNS servers available! rules: failed to run NO_DNS_FOR_FROM RBL test, skipping: (available_nameservers: [."><meta itemprop=datePublished content="2014-06-20T13:20:56+00:00"><meta itemprop=dateModified content="2014-06-20T13:20:56+00:00"><meta itemprop=wordCount content="311"><meta itemprop=image content="https://major.io/images/2019-05-24-cranes-skycrapers.jpg"><meta itemprop=keywords content="dns,fedora,mail,perl,postfix,selinux,spamassassin,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:820px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px}div.highlight code{background-color:unset;color:initial}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style></head><body><header><a href=../../../../ class=title><h2>Major Hayden's Blog ðŸ¤ </h2></a><nav><a href=../../../../>Home</a>
<a href=../../../../ham-radio-faq>Ham Radio</a>
<a href=../../../../icanhazip-com-faq>icanhazip FAQ</a>
<a href=../../../../posts>Posts</a></nav><script async src=https://media.ethicalads.io/media/client/ethicalads.min.js></script><div class="adaptive raised" data-ea-publisher=major-io data-ea-type=text></div></header><main><h1>Fixing broken DNS lookups in spamassassin</h1><i><time datetime=2014-06-20 pubdate>2014-06-20</time></i>
<content><p>I talked about the <a href=https://twitter.com/majorhayden/status/479250665311457281>joys of running my own mail server</a> last week only to find that my mail server was broken yesterday. Spamassassin stopped doing DNS lookups for <a href=https://en.wikipedia.org/wiki/DNSBL>RBL</a> and <a href=https://en.wikipedia.org/wiki/Sender_Policy_Framework>SPF</a> checks.</p><p>I had one of these moments:</p><p><a href=../../../../wp-content/uploads/2014/06/neil_patrick_harris_sigh.gif></a></p><p>My logs looked like this:</p><pre><code>plugin: eval failed: available_nameservers: No DNS servers available!
plugin: eval failed: available_nameservers: No DNS servers available!
rules: failed to run NO_DNS_FOR_FROM RBL test, skipping:
 (available_nameservers: [...] No DNS servers available!)
 (available_nameservers: [...] No DNS servers available!
</code></pre><p>My /etc/resolv.conf was correct and had two valid DNS servers listed. Also, the permissions set on /etc/resolv.conf were reasonable (0644) and the SELinux context applied to the file was appropriate (net_conf_t). Everything else on the system was able to resolve DNS records properly. Even an strace on the spamd process showed it reading /etc/resolv.conf successfully!</p><p>It was Google time. I put some snippets of my error output into the search bar and found a <a href="https://issues.apache.org/SpamAssassin/show_bug.cgi?id=7057">spamassassin bug report</a>. Mark Martinec found the root cause of the bug:</p><blockquote><p>Net::DNS version 0.76 changed the field name holding a set of nameservers in a Net::DNS::Resolver object: it used to be &lsquo;nameservers&rsquo;, but is now split into two fields: &lsquo;nameserver4&rsquo; and &lsquo;nameserver6&rsquo;.</p><p>Mail/SpamAssassin/DnsResolver.pm relied on the internal field name of a Net::DNS::Resolver object to obtain a default list of recursive name servers, so the change in Net::DNS broke that.</p></blockquote><p>The <a href="https://svn.apache.org/viewvc/spamassassin/trunk/lib/Mail/SpamAssassin/DnsResolver.pm?r1=1603518&r2=1603517&pathrev=1603518">patch from the bug report</a> worked just fine on my Fedora 20 mail server. Be sure to restart spamd after making the change.</p><p>There&rsquo;s a <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1111586">Fedora bug report</a> as well.</p><p><em>If anyone is interested, I plan to write up my email configuration on Fedora soon for other folks to use. I might even make some ansible playbooks for it. ;)</em></p><p><em>Fedora update: Fedora&rsquo;s spamassassin package has been <a href=https://admin.fedoraproject.org/updates/spamassassin-3.4.0-7.fc20>updated to 3.4.0-7 and it fixes two bugs</a>. You&rsquo;ll find it in the stable repositories in a few days.</em></p></content><p><a href=https://major.io/tags/dns/>#dns</a>
<a href=https://major.io/tags/fedora/>#fedora</a>
<a href=https://major.io/tags/mail/>#mail</a>
<a href=https://major.io/tags/perl/>#perl</a>
<a href=https://major.io/tags/postfix/>#postfix</a>
<a href=https://major.io/tags/selinux/>#selinux</a>
<a href=https://major.io/tags/spamassassin/>#spamassassin</a></p></main><footer><hr>CC-BY-SA 4.0 &#187;
Made with <a href=https://gohugo.io/>Hugo</a> &#187;
Theme based on <a href=https://github.com/janraasch/hugo-bearblog/>Hugo Ê•â€¢á´¥â€¢Ê” Bear</a><br></footer></body></html>